<!DOCTYPE html>
<!-- saved from url=(0069)https://developer.android.com/topic/libraries/architecture/guide.html -->
<html itemscope="" itemtype="http://schema.org/Article" class="gr__developer_android_com"
  lang="en">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <script async="" src="./Guide%20to%20App%20Architecture%20_%20Android%20Developers_files/async-ads.js"></script>
    <script type="text/javascript" async="" src="./Guide%20to%20App%20Architecture%20_%20Android%20Developers_files/linkid.js"></script>
    <script async="" src="./Guide%20to%20App%20Architecture%20_%20Android%20Developers_files/analytics.js"></script>
    <script type="text/javascript" async="" src="./Guide%20to%20App%20Architecture%20_%20Android%20Developers_files/recaptcha__en.js"></script>
    <script>var a=window.devsite||{};window.devsite=a;a.readyCallbacks=[];window.devsite.readyCallbacks=a.readyCallbacks;a.ready=function(b){a.readyCallbacks.push(b)};window.devsite.ready=a.ready;
</script> <meta name="xsrf_token" content="KkdxRXUG6pb7R0A8iJsLH4OltPp4OWfjRB6a7TqDdXI6MTUxNjgwNDIwMzQyMTcxMA">
    <link rel="canonical" href="https://developer.android.com/topic/libraries/architecture/guide.html">
    <link rel="alternate" href="https://developer.android.com/topic/libraries/architecture/guide.html"
      hreflang="en">
    <link rel="alternate" href="https://developer.android.google.cn/topic/libraries/architecture/guide.html"
      hreflang="en-cn">
    <link rel="alternate" href="https://developer.android.com/topic/libraries/architecture/guide.html"
      hreflang="x-default">
    <link rel="shortcut icon" href="https://developer.android.com/_static/0cbca55952/images/android/favicon.png">
    <link rel="apple-touch-icon" href="https://developer.android.com/_static/0cbca55952/images/android/touchicon-180.png">
    <title> Guide to App Architecture | Android Developers </title>
    <meta name="description" content="Guide to App Architecture">
    <meta itemprop="dateModified" content="2017-11-06T20:52:22.123090">
    <!-- STYLESHEETS -->
    <link rel="stylesheet" href="./Guide%20to%20App%20Architecture%20_%20Android%20Developers_files/css">
    <link rel="stylesheet" href="./Guide%20to%20App%20Architecture%20_%20Android%20Developers_files/css%281%29"
      title="roboto">
    <link rel="stylesheet" href="./Guide%20to%20App%20Architecture%20_%20Android%20Developers_files/dac-devsite.css">
    <link href="./Guide%20to%20App%20Architecture%20_%20Android%20Developers_files/default.css"
      rel="stylesheet" type="text/css">
    <!-- JAVASCRIPT -->
    <script src="./Guide%20to%20App%20Architecture%20_%20Android%20Developers_files/android_3p-bundle.js"
type="text/javascript"></script>
    <script src="./Guide%20to%20App%20Architecture%20_%20Android%20Developers_files/script_foot_closure_android.js"></script>
    <script src="./Guide%20to%20App%20Architecture%20_%20Android%20Developers_files/script_foot_android.js"></script>
    <script type="text/javascript">
  var toRoot = '/';
  devsite.permissions.init({"f62218c009ec029abef196bba5aa34cf": true, "098dafe57affddc137df300142652cfd": false, "8e03e230de0bd8a6fe173fdf172e8b3f": true, "cb025a64a50094835616312f4774a53d": true, "51470233c56fc1fde50f00b73c52b216": false, "d169d485cf24243a263783dbe42029b1": true, "039e5d84b87fd75807ffb37b7f1bbf2c": true, "752953480de00a336d911a46966cc16d": false, "700def1a83e356c06c0925afb05de4b0": false, "6749dcb526ce9bde6993550c7d928d24": true});

  var replaceBlog = false;
  var replaceYouTube = false;
  var siteDefaultLocale = 'en';

  var ANDROID_LANGUAGES = [
      'id','de','en','es','es-419','fr','pt-br','vi','tr','ru','th','ja','zh-cn','zh-tw','ko'
  ];
</script> <script src="./Guide%20to%20App%20Architecture%20_%20Android%20Developers_files/docs.js"
type="text/javascript"></script>
    <script src="./Guide%20to%20App%20Architecture%20_%20Android%20Developers_files/jsapi"
type="text/javascript"></script>
    <link type="text/css" href="./Guide%20to%20App%20Architecture%20_%20Android%20Developers_files/default+en.css"
      rel="stylesheet">
    <link type="text/css" href="./Guide%20to%20App%20Architecture%20_%20Android%20Developers_files/default%281%29.css"
      rel="stylesheet">
    <script type="text/javascript" src="./Guide%20to%20App%20Architecture%20_%20Android%20Developers_files/default+en.I.js"></script>
    <style type="text/css">.gsc-control-cse{font-family:Arial, sans-serif;border-color:#ECEFF1;background-color:#ECEFF1}.gsc-control-cse .gsc-table-result{font-family:Arial, sans-serif}input.gsc-input,.gsc-input-box,.gsc-input-box-hover,.gsc-input-box-focus{border-color:#D9D9D9}input.gsc-search-button,input.gsc-search-button:hover,input.gsc-search-button:focus{border-color:#2F5BB7;background-color:#357AE8;background-image:none;filter:none}.gsc-tabHeader.gsc-tabhInactive{border-color:#CCCCCC;background-color:#FFFFFF}.gsc-tabHeader.gsc-tabhActive{border-color:#CCCCCC;border-bottom-color:#FFFFFF;background-color:#FFFFFF}.gsc-tabsArea{border-color:#CCCCCC}.gsc-webResult.gsc-result,.gsc-results .gsc-imageResult{border-color:#ECEFF1;background-color:#ECEFF1}.gsc-webResult.gsc-result:hover,.gsc-imageResult:hover{border-color:#ECEFF1;background-color:#ECEFF1}.gs-webResult.gs-result a.gs-title:link,.gs-webResult.gs-result a.gs-title:link b,.gs-imageResult a.gs-title:link,.gs-imageResult a.gs-title:link b{color:#039BE5}.gs-webResult.gs-result a.gs-title:visited,.gs-webResult.gs-result a.gs-title:visited b,.gs-imageResult a.gs-title:visited,.gs-imageResult a.gs-title:visited b{color:#039BE5}.gs-webResult.gs-result a.gs-title:hover,.gs-webResult.gs-result a.gs-title:hover b,.gs-imageResult a.gs-title:hover,.gs-imageResult a.gs-title:hover b{color:#039BE5}.gs-webResult.gs-result a.gs-title:active,.gs-webResult.gs-result a.gs-title:active b,.gs-imageResult a.gs-title:active,.gs-imageResult a.gs-title:active b{color:#039BE5}.gsc-cursor-page{color:#039BE5}a.gsc-trailing-more-results:link{color:#039BE5}.gs-webResult .gs-snippet,.gs-imageResult .gs-snippet,.gs-fileFormatType{color:#333333}.gs-webResult div.gs-visibleUrl,.gs-imageResult div.gs-visibleUrl{color:#333333}.gs-webResult div.gs-visibleUrl-short{color:#333333}.gs-webResult div.gs-visibleUrl-short{display:none}.gs-webResult div.gs-visibleUrl-long{display:block}.gs-promotion div.gs-visibleUrl-short{display:none}.gs-promotion div.gs-visibleUrl-long{display:block}.gsc-cursor-box{border-color:#ECEFF1}.gsc-results .gsc-cursor-box .gsc-cursor-page{border-color:#CCCCCC;background-color:#ECEFF1;color:#039BE5}.gsc-results .gsc-cursor-box .gsc-cursor-current-page{border-color:#CCCCCC;background-color:#FFFFFF;color:#039BE5}.gsc-webResult.gsc-result.gsc-promotion{border-color:#F6F6F6;background-color:#F6F6F6}.gsc-completion-title{color:#039BE5}.gsc-completion-snippet{color:#333333}.gs-promotion a.gs-title:link,.gs-promotion a.gs-title:link *,.gs-promotion .gs-snippet a:link{color:#1155CC}.gs-promotion a.gs-title:visited,.gs-promotion a.gs-title:visited *,.gs-promotion .gs-snippet a:visited{color:#1155CC}.gs-promotion a.gs-title:hover,.gs-promotion a.gs-title:hover *,.gs-promotion .gs-snippet a:hover{color:#1155CC}.gs-promotion a.gs-title:active,.gs-promotion a.gs-title:active *,.gs-promotion .gs-snippet a:active{color:#1155CC}.gs-promotion .gs-snippet,.gs-promotion .gs-title .gs-promotion-title-right,.gs-promotion .gs-title .gs-promotion-title-right *{color:#666666}.gs-promotion .gs-visibleUrl,.gs-promotion .gs-visibleUrl-short{color:#039BE5}</style>
    <style type="text/css">.gscb_a{display:inline-block;font:27px/13px arial,sans-serif}.gsst_a .gscb_a{color:#a1b9ed;cursor:pointer}.gsst_a:hover .gscb_a,.gsst_a:focus .gscb_a{color:#36c}.gsst_a{display:inline-block}.gsst_a{cursor:pointer;padding:0 4px}.gsst_a:hover{text-decoration:none!important}.gsst_b{font-size:16px;padding:0 2px;position:relative;user-select:none;-webkit-user-select:none;white-space:nowrap}.gsst_e{opacity:0.55;}.gsst_a:hover .gsst_e,.gsst_a:focus .gsst_e{opacity:0.72;}.gsst_a:active .gsst_e{opacity:1;}.gsst_f{background:white;text-align:left}.gsst_g{background-color:white;border:1px solid #ccc;border-top-color:#d9d9d9;box-shadow:0 2px 4px rgba(0,0,0,0.2);-webkit-box-shadow:0 2px 4px rgba(0,0,0,0.2);margin:-1px -3px;padding:0 6px}.gsst_h{background-color:white;height:1px;margin-bottom:-1px;position:relative;top:-1px}.gsib_a{width:100%;padding:4px 6px 0}.gsib_a,.gsib_b{vertical-align:top}.gssb_c{border:0;position:absolute;z-index:989}.gssb_e{border:1px solid #ccc;border-top-color:#d9d9d9;box-shadow:0 2px 4px rgba(0,0,0,0.2);-webkit-box-shadow:0 2px 4px rgba(0,0,0,0.2);cursor:default}.gssb_f{visibility:hidden;white-space:nowrap}.gssb_k{border:0;display:block;position:absolute;top:0;z-index:988}.gsdd_a{border:none!important}.gsq_a{padding:0}.gsq_a{padding:0}.gscsep_a{display:none}.gssb_a{padding:0 7px}.gssb_a,.gssb_a td{white-space:nowrap;overflow:hidden;line-height:22px}#gssb_b{font-size:11px;color:#36c;text-decoration:none}#gssb_b:hover{font-size:11px;color:#36c;text-decoration:underline}.gssb_g{text-align:center;padding:8px 0 7px;position:relative}.gssb_h{font-size:15px;height:28px;margin:0.2em;-webkit-appearance:button}.gssb_i{background:#eee}.gss_ifl{visibility:hidden;padding-left:5px}.gssb_i .gss_ifl{visibility:visible}a.gssb_j{font-size:13px;color:#36c;text-decoration:none;line-height:100%}a.gssb_j:hover{text-decoration:underline}.gssb_l{height:1px;background-color:#e5e5e5}.gssb_m{color:#000;background:#fff}.gsfe_a{border:1px solid #b9b9b9;border-top-color:#a0a0a0;box-shadow:inset 0px 1px 2px rgba(0,0,0,0.1);-moz-box-shadow:inset 0px 1px 2px rgba(0,0,0,0.1);-webkit-box-shadow:inset 0px 1px 2px rgba(0,0,0,0.1);}.gsfe_b{border:1px solid #4d90fe;outline:none;box-shadow:inset 0px 1px 2px rgba(0,0,0,0.3);-moz-box-shadow:inset 0px 1px 2px rgba(0,0,0,0.3);-webkit-box-shadow:inset 0px 1px 2px rgba(0,0,0,0.3);}.gssb_a{padding:0 9px}.gsib_a{padding-right:8px;padding-left:8px}.gsst_a{padding-top:5.5px}.gssb_e{border:0}.gssb_l{margin:5px 0}input.gsc-input::-webkit-input-placeholder{font-size:14px}input.gsc-input:-moz-placeholder{font-size:14px}input.gsc-input::-moz-placeholder{font-size:14px}input.gsc-input:-ms-input-placeholder{font-size:14px}input.gsc-input:focus::-webkit-input-placeholder{color:transparent}input.gsc-input:focus:-moz-placeholder{color:transparent}input.gsc-input:focus::-moz-placeholder{color:transparent}input.gsc-input:focus:-ms-input-placeholder{color:transparent}.gssb_c .gsc-completion-container{position:static}.gssb_c{z-index:5000}.gsc-completion-container table{background:transparent;font-size:inherit;font-family:inherit}.gssb_c > tbody > tr,.gssb_c > tbody > tr > td,.gssb_d,.gssb_d > tbody > tr,.gssb_d > tbody > tr > td,.gssb_e,.gssb_e > tbody > tr,.gssb_e > tbody > tr > td{padding:0;margin:0;border:0}.gssb_a table,.gssb_a table tr,.gssb_a table tr td{padding:0;margin:0;border:0}</style>
  </head>
  <body class="gc-documentation develop libraries dac-nav-open" data-gr-c-s-loaded="true">
    <sub><a id="firstLine" name="firstLine"></a>Переклад українською - <a href="mailto:ac2epsilon@gmail.com">Арсеній
        Чеботарьов</a> - Ніжин 2018<br>
    </sub>
    <h1 itemprop="name">Міркування щодо архитектури застосування</h1>
    <div class="jd-descr " itemprop="articleBody">
      <style>
    .sidebox a.bug {
        padding-right: 25px;
        background: transparent url(images/bug.png) no-repeat center right;
    }
    .sidebox a.g-plus {
        padding-right: 25px;
        background: transparent url(images/g+.ico) no-repeat center right;
    }
</style> <nav class="inline-toc">
        <ol class="toc">
          <li><a href="https://developer.android.com/topic/libraries/architecture/guide.html#common_problems_faced_by_app_developers">Загальні
              проблеми, з якими зтикаються розробники застосувань</a></li>
          <li><a href="https://developer.android.com/topic/libraries/architecture/guide.html#common_architectural_principles">Загальні
              архитектурні принципи</a></li>
          <li><a href="https://developer.android.com/topic/libraries/architecture/guide.html#recommended_app_architecture">Рекомендована
              архитектура застосування</a>
            <ol class="toc">
              <li><a href="https://developer.android.com/topic/libraries/architecture/guide.html#building_the_user_interface">Побудова
                  користувацького інтерфейсу</a></li>
              <li><a href="https://developer.android.com/topic/libraries/architecture/guide.html#fetching_data">Підтягування
                  даних</a></li>
              <li><a href="https://developer.android.com/topic/libraries/architecture/guide.html#connecting_viewmodel_and_the_repository">Поєднання
                  ViewModel та репозитарію<br>
                </a></li>
              <li><a href="https://developer.android.com/topic/libraries/architecture/guide.html#caching_data">Кешування
                  даних</a></li>
              <li><a href="https://developer.android.com/topic/libraries/architecture/guide.html#persisting_data">Зберігання
                  даних</a></li>
              <li><a href="https://developer.android.com/topic/libraries/architecture/guide.html#testing">Тестування</a></li>
              <li><a href="https://developer.android.com/topic/libraries/architecture/guide.html#the_final_architecture">Фінальна
                  архитектура</a></li>
            </ol>
          </li>
          <li><a href="https://developer.android.com/topic/libraries/architecture/guide.html#guiding_principles">Керівні
              принципи</a></li>
          <li><a href="https://developer.android.com/topic/libraries/architecture/guide.html#addendum">Додаток:
              використання мережевого статусу</a></li>
        </ol>
      </nav>
      <p>Ця настанова для розробників, що вже знайомі з основами побудови
        застосувань, та тепер бажають знати кращі практики та рекомендовану
        архитектуру для побудови надійних застосувань промислової якості.</p>
      <aside class="note"><strong>Зауваження:</strong><span> Цей документ
          вважає, що читач вже знайомий з Android Framework. Якщо ви є новачком
          в розробці, клацніть на серії туторіалів <a href="https://developer.android.com/training/index.html">Getting
            Started</a>, що покриває попередні теми.</span></aside>
      <h2 id="common_problems_faced_by_app_developers" style="padding-bottom: 0px;">Загальні
        проблеми, з якими стикаються розробники застосувань</h2>
      <hr>
      <p>На відміну від своїх десктопних співродичів, які, в більшості випадків,
        мають одну точку входу в вигляді іконки запуску, та роблять як єдиний
        монолітний процес, застосування Android мають значно більш складну
        структуру. Типове застосування Android побудоване з декількох <a href="https://developer.android.com/guide/components/fundamentals.html#Components">app
          компонент</a>, включаючи активності, фрагменти, серсіви, провайдери
        вмісту та широкополосні отримувачі. </p>
      <p>Більшість з ціх застосувань декларовані в <a href="https://developer.android.com/guide/topics/manifest/manifest-intro.html">app
маніфесті,
          </a>що використовується Android OS для вирішення, як інтегрувати ваше
        застосування в загальний користувацький досвід роботи з пристроєм. В той
        час, як зазначено вище, десктопне застосування традиційно робить як
        монолітний процес, правильно написане застосування Android має бути
        значно гнучкішим, по мірі того, як користувач прокладає власний шлях
        поміж застосувань на пристрої, постійно переключаючи потоки та завдання.</p>
      <p>Наприклад, розглянемо, що трапиться, коли ви поділяєте фото в вашій
        улюбленій соціальній мережі. Застосування перемикає намір-інтент камери,
        з якого Android OS запускає застосування камери для обробки запиту. В
        цій точці, користувач залишає застосування соціальної мережі, але його
        досвід не має цього усвідомлювати. Застосування камери, в свою чергу,
        може запустити інші інтенти, як запустити обирач файлів, що може
        запустити інше застосування. З часом користувач повернеться до
        застосування соціальної мережі, та світлина буде передана. Також,
        користувач може бути перерваний телефонним викликом в любій точці цього
        процессу, щоб поширити фото після завершення телефонного виклику. </p>
      <p>В Android ця поведінка переривання застосувань, так що ваше
        застосування мусить обрболяти ці потоки коректно. Майте на увазі, що
        мобільні пристрої обмежені в ресурсах, так що в любий час операційна
        система може потребувати вбити деякі застосування, щоб вивільнити
        простір для нових.</p>
      <p>Смисл всього цього в тому, що компоненти вашого застосування можуть
        бути запущені індивідуально в довільному порядку, та можуть бути знищені
        в кожну мить, користувачем або системою. Оскільки компоненти
        застосування є ефемірними, та їх життєвий цикл (коли воні створюються та
        руйнуються) не контролюється вами, <strong>ви не повинні зберігати
          жодні дані застосування або стан в компонентах вашого застосування</strong>,
        та компоненти вашого застосування не повинні залежати один від одного.</p>
      <h2 id="common_architectural_principles" style="padding-bottom: 0px;">Загальні
        архитектурні принципи</h2>
      <hr>
      <p>Якщо ви не можете використовувати компоненти застосування для
        збегірання даних та стану застосування, як ми маємо структурувати
        застосування?</p>
      <p>Найбільш важлива річ, на якій ви маєте зфокусуватись, є <strong><a href="https://en.wikipedia.org/wiki/Separation_of_concerns">розділення
            концепцій</a></strong> вашого застосування. Є загальною помилкою
        писати весь ваш код в <code><a href="https://developer.android.com/reference/android/app/Activity.html">Activity</a></code>
        або <code><a href="https://developer.android.com/reference/android/app/Fragment.html">Fragment</a></code>.
        Любий код, що не обробляє UI, або не взаємодіє з операційною системою,
        не повинно бути в ціх класах. Утримання їх такими утисненими, як це
        можливе, дозволить вам уникнути багато проблем, пов'язаних з життєвим
        циклом. Не забувайте, що ви не <em>володієте</em> ціма класами, вони
        лише класи-клей, що лише втілюють контракт між OS, та вашим
        застосуванням. Android OS може зруйнувати їх в любий час, базуючись на
        взаємодії користувача, або інших факторах, як надостатня пам'ять. Краше
        мінімізувати вашу залежність від них, щоб провадити солідний
        користувацький досвід.</p>
      <p>Другий важливий принцип в тому, що вам треба <strong>будувати ваш UI
          від моделі</strong>, бажано стійкої моделі. Стійкість є ідеальною з
        двох причин: ваші користувачі не втратяться дані, якщо ваша OS зруйнує
        ваше застосування, щоб вивільнити ресурси, та ваше застосування буде
        продовжувати роботу, навіть коли ваше мережеве з'єднання слабке або
        відсутнє. Моделі є компонентами, що відповідні за обробку даних для
        застосування. Вони незалежні від Views та компонент застосування, і,
        таким чином, вони ізольовані від проблем життєвого циклу ціх компонент.
        Утримуючи код UI простим, та вільним від логіки застосування, робить
        керування простішим. Базуючи ваше застосування на класах моделі з гарно
        визначеною відповідальністю по обробці даних, робить їх придатними для
        тестування, та ваше застосування узгодженим.</p>
      <h2 id="recommended_app_architecture" style="padding-bottom: 0px;">Рекомендована
        архитектура застосування</h2>
      <hr>
      <p>В цьому розділі ми подемонструємо, як структурувати застосування,
        використовуючи <a href="https://developer.android.com/topic/libraries/architecture/index.html">Архитектурні
          компоненти</a>, через проходження випадку-прикладу.</p>
      <aside class="note"><strong>Зауваження:</strong><span> Неможливо мати один
          спосіб написання застосувань, що буде кращим для кожного сценарію.
          Кажучи це, рекомендована архитектура повинна бути гарною відправною
          точкою для більшості випаддків. Якщо ви вже маєте гарний спосіб
          написання Android застосувань, вам не треба його змінювати.</span></aside>
      <p>Уявіть, що ми будуємо UI, що показує профіль користувача. Цей
        користувацький профіль буде підтягуватись з нашого власного бекенду
        через REST API.</p>
      <h3 id="building_the_user_interface">Побудова користувацького інтерфейсу</h3>
      <p>UI буде складатись з фрагменту <code>UserProfileFragment.java</code>,
        та його відповідного файлу розташування <code>user_profile_layout.xml</code>.</p>
      <p>Щоб розробити UI, наша модель даних має зберігати два елементи даних.</p>
      <ul>
        <li><strong>ID користувача</strong>: Ідентифікатор для користувача.
          Краще передавати цю інформацію у фрагмент з використанням аргументів
          фрагменту. Якщо Android OS зруйнує ваш процес, ця інформація буде
          збережена, так що цей id буде доступним наступного разу, коли ваше
          застосування буде рестартоване.</li>
        <li><strong>Об'єкт User</strong>: POJO, що зберігає дані користувача.</li>
      </ul>
      <p>Ми будемо створювати <code>UserProfileViewModel</code> на базі класу <strong>ViewModel</strong>,
        що буде зберігати цю інформацію.</p>
      <blockquote>
        <p><strong><a href="https://developer.android.com/topic/libraries/architecture/viewmodel.html">ViewModel</a></strong>
          провадить дані для окремого компоненту UI, такого, як фрагмент або
          активність, та обробляє комунікацію з бізнес-частиною обробки даних,
          тобто викликами інших компонент для завантаження даних або передачі
          модифікацій користувача.&nbsp; ViewModel не знає щодо View, та не має
          впливу від змін конфігурації, таких, як перебудова активності через
          повертання пристрою.</p>
      </blockquote>
      <p>Тепер ми маємо три файли.</p>
      <ul>
        <li><code>user_profile.xml</code>: Визначення UI для екрана.</li>
        <li><code>UserProfileViewModel.java</code>: Клас, що готує дані для UI.</li>
        <li><code>UserProfileFragment.java</code>: UI контролер, що відображує
          дані в ViewModel, та реагує на взаємодію з користувачем.</li>
      </ul>
      <p>Нижче наша початкова реалізація (файл розташування для простоти
        опущений):</p>
      <pre class="prettyprint"><code><span class="kwd">public</span><span class="pln"> </span><span
class="kwd">class</span><span class="pln"> </span><span class="typ">UserProfileViewModel</span><span
class="pln"> </span><span class="kwd">extends</span><span class="pln"> </span><span
class="typ">ViewModel</span><span class="pln"> </span><span class="pun">{</span><span
class="pln"><br>&nbsp; &nbsp; </span><span class="kwd">private</span><span class="pln"> </span><span
class="typ">String</span><span class="pln"> userId</span><span class="pun">;</span><span
class="pln"><br>&nbsp; &nbsp; </span><span class="kwd">private</span><span class="pln"> </span><span
class="typ">User</span><span class="pln"> user</span><span class="pun">;</span><span
class="pln"><br><br>&nbsp; &nbsp; </span><span class="kwd">public</span><span class="pln"> </span><span
class="kwd">void</span><span class="pln"> init</span><span class="pun">(</span><span
class="typ">String</span><span class="pln"> userId</span><span class="pun">)</span><span
class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="kwd">this</span><span class="pun">.</span><span class="pln">userId </span><span
class="pun">=</span><span class="pln"> userId</span><span class="pun">;</span><span
class="pln"><br>&nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br>&nbsp; &nbsp; </span><span
class="kwd">public</span><span class="pln"> </span><span class="typ">User</span><span
class="pln"> getUser</span><span class="pun">()</span><span class="pln"> </span><span
class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="kwd">return</span><span class="pln"> user</span><span class="pun">;</span><span
class="pln"><br>&nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br></span><span
class="pun">}</span><span class="pln"><br></span></code></pre>
      <pre class="prettyprint"><code><span class="kwd">public</span><span class="pln"> </span><span
class="kwd">class</span><span class="pln"> </span><span class="typ">UserProfileFragment</span><span
class="pln"> </span><span class="kwd">extends</span><span class="pln"> </span><span
class="typ">Fragment</span><span class="pln"> </span><span class="pun">{</span><span
class="pln"><br>&nbsp; &nbsp; </span><span class="kwd">private</span><span class="pln"> </span><span
class="kwd">static</span><span class="pln"> </span><span class="kwd">final</span><span
class="pln"> </span><span class="typ">String</span><span class="pln"> UID_KEY </span><span
class="pun">=</span><span class="pln"> </span><span class="str">"uid"</span><span
class="pun">;</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="kwd">private</span><span
class="pln"> </span><span class="typ">UserProfileViewModel</span><span class="pln"> viewModel</span><span
class="pun">;</span><span class="pln"><br><br>&nbsp; &nbsp; </span><span class="lit">@Override</span><span
class="pln"><br>&nbsp; &nbsp; </span><span class="kwd">public</span><span class="pln"> </span><span
class="kwd">void</span><span class="pln"> onActivityCreated</span><span class="pun">(</span><span
class="lit">@Nullable</span><span class="pln"> </span><span class="typ">Bundle</span><span
class="pln"> savedInstanceState</span><span class="pun">)</span><span class="pln"> </span><span
class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="kwd">super</span><span class="pun">.</span><span class="pln">onActivityCreated</span><span
class="pun">(</span><span class="pln">savedInstanceState</span><span class="pun">);</span><span
class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="typ">String</span><span
class="pln"> userId </span><span class="pun">=</span><span class="pln"> getArguments</span><span
class="pun">().</span><span class="pln">getString</span><span class="pun">(</span><span
class="pln">UID_KEY</span><span class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; viewModel </span><span
class="pun">=</span><span class="pln"> </span><span class="typ">ViewModelProviders</span><span
class="pun">.</span><span class="pln">of</span><span class="pun">(</span><span class="kwd">this</span><span
class="pun">).</span><span class="kwd">get</span><span class="pun">(</span><span
class="typ">UserProfileViewModel</span><span class="pun">.</span><span class="kwd">class</span><span
class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; viewModel</span><span
class="pun">.</span><span class="pln">init</span><span class="pun">(</span><span
class="pln">userId</span><span class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; </span><span
class="pun">}</span><span class="pln"><br><br>&nbsp; &nbsp; </span><span class="lit">@Override</span><span
class="pln"><br>&nbsp; &nbsp; </span><span class="kwd">public</span><span class="pln"> </span><span
class="typ">View</span><span class="pln"> onCreateView</span><span class="pun">(</span><span
class="typ">LayoutInflater</span><span class="pln"> inflater</span><span class="pun">,</span><span
class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="lit">@Nullable</span><span class="pln"> </span><span class="typ">ViewGroup</span><span
class="pln"> container</span><span class="pun">,</span><span class="pln"> </span><span
class="lit">@Nullable</span><span class="pln"> </span><span class="typ">Bundle</span><span
class="pln"> savedInstanceState</span><span class="pun">)</span><span class="pln"> </span><span
class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="kwd">return</span><span class="pln"> inflater</span><span class="pun">.</span><span
class="pln">inflate</span><span class="pun">(</span><span class="pln">R</span><span
class="pun">.</span><span class="pln">layout</span><span class="pun">.</span><span
class="pln">user_profile</span><span class="pun">,</span><span class="pln"> container</span><span
class="pun">,</span><span class="pln"> </span><span class="kwd">false</span><span
class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="pun">}</span><span
class="pln"><br></span><span class="pun">}</span><span class="pln"><br></span></code></pre>
      <p>Тепер, коли ми маємо ці три модулі коду, як пов'язати їх разом? В кінці
        кінців, коли встановлюється поле користувача в ViewModel, нам треба
        спосіб поінформувати UI. Це те, де з'являється клас <em>LiveData</em>.</p>
      <blockquote>
        <p><strong><a href="https://developer.android.com/topic/libraries/architecture/livedata.html">LiveData</a></strong>
          є прозорий контейнер даних. Він дозволяє компонентам вашого
          застосування досліджувати об'єкти <a href="https://developer.android.com/reference/android/arch/lifecycle/LiveData.html"><code>LiveData</code></a>
          щодо змін без створення явних та жорстких шляхів залежностей між ними.
          LiveData також поважає стан життєвого циклу&nbsp; компонент вашого
          застосування (активностей, фрагментів, сервісів), та робить правильні
          речі для запобігання утічкам об'єкта, так що ваше застосування не
          споживає більше пам'яті.</p>
      </blockquote>
      <aside class="note"><strong>Зауваження:</strong><span> Якщо ви вже
          використовуєте бібліотеку, як <a href="https://github.com/ReactiveX/RxJava">RxJava</a>
          або <a href="https://github.com/google/agera">Agera</a>, ви можете
          продовжувати використовувати їх замість LiveData. Але коли ви
          використовуєте їх або інші підходи, переконайтесь, що ви відповідно
          обробляєте життєвий цикл, так що ваші потоки даних призупиняються,
          коли відповідний LifecycleOwner зупиняється, та потоки руйнуються,
          коли theLifecycleOwner руйнується. Ви можете також додати артифакт <code>android.arch.lifecycle:reactivestreams</code>
          для використання LiveData з іншими бібліотеками реактивних потоків
          (наприклад, з RxJava2).</span></aside>
      <p>Тепер ми заміщуємо поле <code>User</code> в <code>UserProfileViewModel</code>
        на <code>LiveData&lt;User&gt;</code>, так що фрагмент може бути
        поінформований, коли дані будуть оновлені. Велика річ щодо <a href="https://developer.android.com/reference/android/arch/lifecycle/LiveData.html"><code>LiveData</code></a>
        в тому, що він поінформований про життєвий цикл, та буде автоматично
        очищувати посилання, коли вони більше не потрібні.</p>
      <pre class="prettyprint"><span class="kwd">public</span><span class="pln"> </span><span
class="kwd">class</span><span class="pln"> </span><span class="typ">UserProfileViewModel</span><span
class="pln"> </span><span class="kwd">extends</span><span class="pln"> </span><span
class="typ">ViewModel</span><span class="pln"> </span><span class="pun">{</span><span
class="pln"><br>&nbsp; &nbsp; </span><span class="pun">...</span><span class="pln"><br>&nbsp; &nbsp; </span><strike><span
class="kwd">private</span><span class="pln"> </span><span class="typ">User</span><span
class="pln"> user</span><span class="pun">;</span></strike><span class="pln"><br>&nbsp; &nbsp; </span><mark><span
class="kwd">private</span><span class="pln"> </span><span class="typ">LiveData</span><span
class="pun">&lt;</span><span class="typ">User</span><span class="pun">&gt;</span><span
class="pln"> user</span><span class="pun">;</span></mark><span class="pln"><br>&nbsp; &nbsp; </span><span
class="kwd">public</span><span class="pln"> </span><span class="typ">LiveData</span><span
class="pun">&lt;</span><span class="typ">User</span><span class="pun">&gt;</span><span
class="pln"> getUser</span><span class="pun">()</span><span class="pln"> </span><span
class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="kwd">return</span><span class="pln"> user</span><span class="pun">;</span><span
class="pln"><br>&nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br></span><span
class="pun">}</span></pre>
      <p>Тепер ми модифікуємо <code>UserProfileFragment</code> для нагляду за
        даними, та оновлення UI.</p>
      <pre class="prettyprint"><code><span class="lit">@Override</span><span class="pln"><br></span><span
class="kwd">public</span><span class="pln"> </span><span class="kwd">void</span><span
class="pln"> onActivityCreated</span><span class="pun">(</span><span class="lit">@Nullable</span><span
class="pln"> </span><span class="typ">Bundle</span><span class="pln"> savedInstanceState</span><span
class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; </span><span
class="kwd">super</span><span class="pun">.</span><span class="pln">onActivityCreated</span><span
class="pun">(</span><span class="pln">savedInstanceState</span><span class="pun">);</span><span
class="pln"><br>&nbsp; &nbsp; viewModel</span><span class="pun">.</span><span class="pln">getUser</span><span
class="pun">().</span><span class="pln">observe</span><span class="pun">(</span><span
class="kwd">this</span><span class="pun">,</span><span class="pln"> user </span><span
class="pun">-&gt;</span><span class="pln"> </span><span class="pun">{</span><span
class="pln"><br>&nbsp; &nbsp; &nbsp; </span><span class="com">// оновлення UI</span><span
class="pln"><br>&nbsp; &nbsp; </span><span class="pun">});</span><span class="pln"><br></span><span
class="pun">}</span><span class="pln"><br></span></code></pre>
      <p>Кожного разу, коли дані користувача оновлюються, буде викликаний
        зворотній виклик <a href="https://developer.android.com/reference/android/arch/lifecycle/Observer.html#onChanged%28T%29">onChanged</a>,
        та UI буде оновлений.</p>
      <p>Якщо ви знайомі з іншими бібліотеками, де використовуютсья бібліотеки
        для нагляду, ви можете помітити, що ми не перекрили метод фрагмента <code><a
            href="https://developer.android.com/reference/android/app/Fragment.html#onStop%28%29">onStop()</a></code>
        для припинення нагляду за даними. Це не потрібно для LiveData, оскільки
        він в курсі життєвого циклу, що означає, що він не викликатиме зворотній
        виклик, якщо фрагмент не знаходиться в активному стані (отрав <code><a
            href="https://developer.android.com/reference/android/app/Fragment.html#onStart%28%29">onStart()</a></code>,
        але не отримував <code><a href="https://developer.android.com/reference/android/app/Fragment.html#onStop%28%29">onStop()</a></code>).
        LiveData також буде автоматично видаляти наглядач-обсервер, коли
        фрагмент отримує <code><a href="https://developer.android.com/reference/android/app/Fragment.html#onDestroy%28%29">onDestroy()</a></code>.</p>
      <p>Ми також не робимо нічого особливого для обробки змін конфігурації
        (наприклад, коли користувач обертає екран). ViewModel автоматично
        відновлюється при зміні конфігурації, так що коли новий фрагмент
        приходить до життя, він буде отримувати той самий примірник ViewModel,
        та зворотній виклик буде викликаний безпосередньо з поточними даними. Це
        та причина, чому ViewModels не має прямо посилатись на View; вони можуть
        пережити життєвий цикл View. Дивіться <a href="https://developer.android.com/topic/libraries/architecture/viewmodel.html#the_lifecycle_of_a_viewmodel">життєвий
          цикл ViewModel</a>.</p>
      <h3 id="fetching_data">Підтягування даних</h3>
      <p>Тепер ми поєднали ViewModel з фрагментом, але як ViewModel підтягує
        дані користувача? В цьому прикладі ми вважаємо, що наш бекенд провадить
        REST API. Ми будемо викоистовувати бібліотеку <a href="http://square.github.io/retrofit/">Retrofit</a>
        для доступу до нашого бекенду, хоча ви вільні використовувати іншу
        бібліотеку, що прислуговуєтсья тій самій цілі.</p>
      <p>Ось наш retrofit <code>Webservice</code>, що комунікує з нашим
        бекендомt:</p>
      <pre class="prettyprint"><code><span class="kwd">public</span><span class="pln"> </span><span
class="kwd">interface</span><span class="pln"> </span><span class="typ">Webservice</span><span
class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; </span><span
class="com">/**<br>&nbsp; &nbsp; &nbsp;* @GET декларує запит HTTP GET<br>&nbsp; &nbsp; &nbsp;* @Path("user") анотація на параметрі userId її як заміну для<br>&nbsp; &nbsp; &nbsp;* замінника {user} в шляху @GET<br>&nbsp; &nbsp; &nbsp;*/</span><span
class="pln"><br>&nbsp; &nbsp; </span><span class="lit">@GET</span><span class="pun">(</span><span
class="str">"/users/{user}"</span><span class="pun">)</span><span class="pln"><br>&nbsp; &nbsp; </span><span
class="typ">Call</span><span class="pun">&lt;</span><span class="typ">User</span><span
class="pun">&gt;</span><span class="pln"> getUser</span><span class="pun">(</span><span
class="lit">@Path</span><span class="pun">(</span><span class="str">"user"</span><span
class="pun">)</span><span class="pln"> </span><span class="typ">String</span><span
class="pln"> userId</span><span class="pun">);</span><span class="pln"><br></span><span
class="pun">}</span><span class="pln"><br></span></code></pre>
      <p>Природна реалізація <code>ViewModel</code> could directly call the <code>Webservice</code>,
        щоб підтягнути дані, та присвоїти їх назад об'єкту користувача. Навіть
        хоча це працює, вашому застосуванню буде складно керувати цім по мірі
        зростання. Це надає багато відповідальності класу ViewModel, що іде
        всупереч принципу <em>розділення концепцій, </em>який ми згадували
        раніше. Додатково, сфера впливу ViewModel прив'язаний до життєвого циклу
        <code><a href="https://developer.android.com/reference/android/app/Activity.html">Activity</a></code>
        або <code><a href="https://developer.android.com/reference/android/app/Fragment.html">Fragment</a></code>,
        так що втрата даних, коли життєвй цикл завершиться, стане поганою
        новиною для користувача. Замість цього, наш ViewModel буде делегавувати
        цю роботу довому модулю, <strong>Repository</strong>.</p>
      <blockquote>
        <p><strong>Repository</strong> модулі відповідають за обробку операцій з
          даними. Вони провадять чистий API до загалу застосування. Вони знають,
          коли отримувати дані від яких викликів API, щоб оновлювати дані. Ви
          можете розглядати їх як медіатори між різними джерелами даних (модель
          стійкості, веб сервіс, кеш, тощо).</p>
      </blockquote>
      <p>Клас <code>UserRepository</code> нижче використовує <code>WebService</code>
        to fetch the user data item.</p>
      <pre class="prettyprint"><code><span class="kwd">public</span><span class="pln"> </span><span
class="kwd">class</span><span class="pln"> </span><span class="typ">UserRepository</span><span
class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; </span><span
class="kwd">private</span><span class="pln"> </span><span class="typ">Webservice</span><span
class="pln"> webservice</span><span class="pun">;</span><span class="pln"><br>&nbsp; &nbsp; </span><span
class="com">// ...</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="kwd">public</span><span
class="pln"> </span><span class="typ">LiveData</span><span class="pun">&lt;</span><span
class="typ">User</span><span class="pun">&gt;</span><span class="pln"> getUser</span><span
class="pun">(</span><span class="kwd">int</span><span class="pln"> userId</span><span
class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="com">// This is not an optimal implementation, we'll fix it below</span><span
class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">final</span><span
class="pln"> </span><span class="typ">MutableLiveData</span><span class="pun">&lt;</span><span
class="typ">User</span><span class="pun">&gt;</span><span class="pln"> data </span><span
class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span
class="pln"> </span><span class="typ">MutableLiveData</span><span class="pun">&lt;&gt;();</span><span
class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; webservice</span><span class="pun">.</span><span
class="pln">getUser</span><span class="pun">(</span><span class="pln">userId</span><span
class="pun">).</span><span class="pln">enqueue</span><span class="pun">(</span><span
class="kwd">new</span><span class="pln"> </span><span class="typ">Callback</span><span
class="pun">&lt;</span><span class="typ">User</span><span class="pun">&gt;()</span><span
class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="lit">@Override</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="kwd">public</span><span class="pln"> </span><span class="kwd">void</span><span
class="pln"> onResponse</span><span class="pun">(</span><span class="typ">Call</span><span
class="pun">&lt;</span><span class="typ">User</span><span class="pun">&gt;</span><span
class="pln"> call</span><span class="pun">,</span><span class="pln"> </span><span
class="typ">Response</span><span class="pun">&lt;</span><span class="typ">User</span><span
class="pun">&gt;</span><span class="pln"> response</span><span class="pun">)</span><span
class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="com">// error case is left out for brevity</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; data</span><span
class="pun">.</span><span class="pln">setValue</span><span class="pun">(</span><span
class="pln">response</span><span class="pun">.</span><span class="pln">body</span><span
class="pun">());</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="pun">}</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="pun">});</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="kwd">return</span><span class="pln"> data</span><span class="pun">;</span><span
class="pln"><br>&nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br></span><span
class="pun">}</span><span class="pln"><br></span></code></pre>
      <p>Навіть якщо модуль репозиторію виглядає непотрібним, він
        прислуговується важливому призначенні; він абстрагує джерела даних з
        решти застосування. Тепер ourViewModel не знає, що дані отримуються від
        <code>Webservice</code>, що означає, що ми можемо змінити його на іншу
        реалізацію в разі потреби.</p>
      <aside class="note"><strong>Зауваження:</strong><span> Ми облишили випадок
          мережевої помилки в цілях спрощення. Щоб побачити альтернативну
          реалізацію, що виказує помилки та статус завантаження дивіться <a href="https://developer.android.com/topic/libraries/architecture/guide.html#addendum">Додаток:
            використання мережевого статусу</a>.</span></aside>
      <h4 id="managing_dependencies_between_components">Керування залежностями
        між компоннетами:</h4>
      <p>Клас <code>UserRepository</code> вище потребує примірник <code>Webservice</code>
        для своєї роботи. Ми можемо просто створити його, але для цього треба
        знати залежності класу <code>Webservice</code> для його конструювання.
        Це може значно ускладнити код та привести до його дублікації (тобто,
        кожний клас, що потребує примірник <code>Webservice</code>, буде
        потребувати знання, як сконструювати його, разом з залежностями).
        Додатково <code>UserRepository</code>, можливо, не є єдиним класом, що
        потребує <code>Webservice</code>. Якщо кожний клас створюватиме новий <code>WebService</code>,
        це може дуже навантажувати ресурси.</p>
      <p>Існують два шаблони, що ви можете використовувати для обходу цієї
        проблеми:</p>
      <ul>
        <li><a href="https://en.wikipedia.org/wiki/Dependency_injection">Dependency
            Injection</a>: Введення залежностей, або Dependency Injection,
          скорочено DI, дозволяє класам визначати свої свої залежності без їх
          побудови. Під час виконання інший клас відповідає за провадження ціх
          залежностей. Ми рекомендуємо бібліотеку Google <a href="https://google.github.io/dagger/">Dagger
            2</a> для реалізації введення залежності в застосування Android.
          Dagger 2 automatically constructs objects by walking the dependency
          tree and provides compile time guarantees on dependencies.</li>
        <li><a href="https://en.wikipedia.org/wiki/Service_locator_pattern">Service
            Locator</a>: Локатор сервісів, або Service Locator, скорочено SL,&nbsp;
          провадить реєстр, де класи можуть отримати свої залежності, замість
          того, щоб конструювати їх. Це відносно простіше до реалізації, ніж DI,
          так що коли ви не дружите з DI, використовуйте замість цього Service
          Locator.</li>
      </ul>
      <p>Ці шаблони дозволяють вам маштабувати ваш код, оскільки вони провадять
        прозорі шаблони для керування залежностями, без дублікації кода або
        доданої складності. Обоє з них також дозволяють заміну реалізацій для
        тестування; це одна з головних вигод з їх використання.</p>
      <p>В цьому прикладі ми збираємось використовувати <a href="https://google.github.io/dagger/">Dagger
          2</a> для керумання залежностями.</p>
      <h3 id="connecting_viewmodel_and_the_repository">Поєднання ViewModel та
        репозитарію</h3>
      <p>Тепер ми модифікуємо наш <code>UserProfileViewModel</code> для
        використання з репозитарієм.</p>
      <pre class="prettyprint"><code><span class="kwd">public</span><span class="pln"> </span><span
class="kwd">class</span><span class="pln"> </span><span class="typ">UserProfileViewModel</span><span
class="pln"> </span><span class="kwd">extends</span><span class="pln"> </span><span
class="typ">ViewModel</span><span class="pln"> </span><span class="pun">{</span><span
class="pln"><br>&nbsp; &nbsp; </span><span class="kwd">private</span><span class="pln"> </span><span
class="typ">LiveData</span><span class="pun">&lt;</span><span class="typ">User</span><span
class="pun">&gt;</span><span class="pln"> user</span><span class="pun">;</span><span
class="pln"><br>&nbsp; &nbsp; </span><span class="kwd">private</span><span class="pln"> </span><span
class="typ">UserRepository</span><span class="pln"> userRepo</span><span class="pun">;</span><span
class="pln"><br><br>&nbsp; &nbsp; </span><span class="lit">@Inject</span><span class="pln"> </span><span
class="com">// параметр UserRepository провадиться Dagger 2</span><span class="pln"><br>&nbsp; &nbsp; </span><span
class="kwd">public</span><span class="pln"> </span><span class="typ">UserProfileViewModel</span><span
class="pun">(</span><span class="typ">UserRepository</span><span class="pln"> userRepo</span><span
class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="kwd">this</span><span class="pun">.</span><span class="pln">userRepo </span><span
class="pun">=</span><span class="pln"> userRepo</span><span class="pun">;</span><span
class="pln"><br>&nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br><br>&nbsp; &nbsp; </span><span
class="kwd">public</span><span class="pln"> </span><span class="kwd">void</span><span
class="pln"> init</span><span class="pun">(</span><span class="typ">String</span><span
class="pln"> userId</span><span class="pun">)</span><span class="pln"> </span><span
class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">this</span><span
class="pun">.</span><span class="pln">user </span><span class="pun">!=</span><span
class="pln"> </span><span class="kwd">null</span><span class="pun">)</span><span
class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="com">// ViewModel стврюється для кожного Fragment</span><span class="pln">,<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="com">// так що ми знаємо, що userId не змінився</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="kwd">return</span><span class="pun">;</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="pun">}</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; user </span><span
class="pun">=</span><span class="pln"> userRepo</span><span class="pun">.</span><span
class="pln">getUser</span><span class="pun">(</span><span class="pln">userId</span><span
class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="pun">}</span><span
class="pln"><br><br>&nbsp; &nbsp; </span><span class="kwd">public</span><span class="pln"> </span><span
class="typ">LiveData</span><span class="pun">&lt;</span><span class="typ">User</span><span
class="pun">&gt;</span><span class="pln"> getUser</span><span class="pun">()</span><span
class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="kwd">return</span><span class="pln"> </span><span class="kwd">this</span><span
class="pun">.</span><span class="pln">user</span><span class="pun">;</span><span
class="pln"><br>&nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br></span><span
class="pun">}</span><span class="pln"><br></span></code></pre>
      <h3 id="caching_data">Кешування даних</h3>
      <p>Реалізація репозитарію вище гарна для абстрагування виклику до веб
        сервісу, але оскільки вона покладається тільки на одне джерело даних,
        вона не дуже функціональна.</p>
      <p>Проблема з реалізацією <code>UserRepository</code> вище в тому, що
        після отримання даних вона ніде їх не зберігає. Якщо користувач полишає
        <code>UserProfileFragment</code>, та потім повертається до нього, дані
        будуть отримані повторно. Це погано з двох причин: це призводить до
        втрати дорогоцінного мережевого трафіку, та примушує користувача
        очікувати завершення нового запиту. Щоб владнати це, ми додамо нове
        джерело даних до нашого <code>UserRepository</code>, що буде кешувати
        об'єкти <code>User</code> в пам'яті.</p>
      <pre class="prettyprint"><code><span class="lit">@Singleton</span><span class="pln"> &nbsp;</span><span
class="com">// інформує Dagger, що цей клас треба конструювати тільки один раз</span><span
class="pln"><br></span><span class="kwd">public</span><span class="pln"> </span><span
class="kwd">class</span><span class="pln"> </span><span class="typ">UserRepository</span><span
class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; </span><span
class="kwd">private</span><span class="pln"> </span><span class="typ">Webservice</span><span
class="pln"> webservice</span><span class="pun">;</span><span class="pln"><br>&nbsp; &nbsp; </span><span
class="com">// простий кеш в пам'яті, деталі випущені для скорочення</span><span
class="pln"><br>&nbsp; &nbsp; </span><span class="kwd">private</span><span class="pln"> </span><span
class="typ">UserCache</span><span class="pln"> userCache</span><span class="pun">;</span><span
class="pln"><br>&nbsp; &nbsp; </span><span class="kwd">public</span><span class="pln"> </span><span
class="typ">LiveData</span><span class="pun">&lt;</span><span class="typ">User</span><span
class="pun">&gt;</span><span class="pln"> getUser</span><span class="pun">(</span><span
class="typ">String</span><span class="pln"> userId</span><span class="pun">)</span><span
class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="typ">LiveData</span><span class="pun">&lt;</span><span class="typ">User</span><span
class="pun">&gt;</span><span class="pln"> cached </span><span class="pun">=</span><span
class="pln"> userCache</span><span class="pun">.</span><span class="kwd">get</span><span
class="pun">(</span><span class="pln">userId</span><span class="pun">);</span><span
class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">if</span><span
class="pln"> </span><span class="pun">(</span><span class="pln">cached </span><span
class="pun">!=</span><span class="pln"> </span><span class="kwd">null</span><span
class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="kwd">return</span><span class="pln"> cached</span><span class="pun">;</span><span
class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun">}</span><span
class="pln"><br><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">final</span><span
class="pln"> </span><span class="typ">MutableLiveData</span><span class="pun">&lt;</span><span
class="typ">User</span><span class="pun">&gt;</span><span class="pln"> data </span><span
class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span
class="pln"> </span><span class="typ">MutableLiveData</span><span class="pun">&lt;&gt;();</span><span
class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; userCache</span><span class="pun">.</span><span
class="pln">put</span><span class="pun">(</span><span class="pln">userId</span><span
class="pun">,</span><span class="pln"> data</span><span class="pun">);</span><span
class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com">// це все ще не оптімально, але краще ніж раніше.</span><span
class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com">// повна реалізація має також обробляти випадки помилок.</span><span
class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; webservice</span><span class="pun">.</span><span
class="pln">getUser</span><span class="pun">(</span><span class="pln">userId</span><span
class="pun">).</span><span class="pln">enqueue</span><span class="pun">(</span><span
class="kwd">new</span><span class="pln"> </span><span class="typ">Callback</span><span
class="pun">&lt;</span><span class="typ">User</span><span class="pun">&gt;()</span><span
class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="lit">@Override</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="kwd">public</span><span class="pln"> </span><span class="kwd">void</span><span
class="pln"> onResponse</span><span class="pun">(</span><span class="typ">Call</span><span
class="pun">&lt;</span><span class="typ">User</span><span class="pun">&gt;</span><span
class="pln"> call</span><span class="pun">,</span><span class="pln"> </span><span
class="typ">Response</span><span class="pun">&lt;</span><span class="typ">User</span><span
class="pun">&gt;</span><span class="pln"> response</span><span class="pun">)</span><span
class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; data</span><span
class="pun">.</span><span class="pln">setValue</span><span class="pun">(</span><span
class="pln">response</span><span class="pun">.</span><span class="pln">body</span><span
class="pun">());</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="pun">}</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="pun">});</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="kwd">return</span><span class="pln"> data</span><span class="pun">;</span><span
class="pln"><br>&nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br></span><span
class="pun">}</span><span class="pln"><br></span></code></pre>
      <h3 id="persisting_data">Зберігання даних</h3>
      <p>В нашій поточній реалізації, якщо користувач повертає екран, або
        виходить та повертається до застосування, існуючий UI буде видимий
        безпосередньо, оскільки репозитарій отримуж дані від кешу в пам'яті. Але
        ще відбуватиметься, якщо користувач вийде із застосування, та
        повернетьтся через годину, після того, як Android OS вже вб'є процес?</p>
      <p>В поточній реалізації нам буде треба знову підтягнути дані з мережі. Це
        не тільки поганий досвід для користувача, але також розтринькує мобільні
        ресурси для отримання тих самих даних. Ви можете просто полагодити це,
        через кешування веб запитів, але це створює нові проблеми. Що буде, коли
        ті самі дані користувача трапляються в іншому типі запитів (наприклад,
        при отриманні списка друзів)? Тоді, можливо, ваше застосування буде
        показувати неузгоджені дані, що, в кращому випадку, трохи спантеличить
        користувача. Наприклад, ті самі дані користувача можуть показуватись
        інакше, оскільки запит списку друзів, та запит окремого користувача
        відбувались в різний час. Ваше застосування має поєднати їх, щоб
        уникнути неузгодженості.</p>
      <p>Відповідний спосіб для обробки цього випадку полягає в використанні
        стійкої моделі. Ось де на допомогу приходить бібліотека стійкості <a href="https://developer.android.com/training/data-storage/room/index.html">Room</a>.</p>
      <blockquote>
        <p><a href="https://developer.android.com/training/data-storage/room/index.html">Room</a>
          є бібліотекою мепінгу, що провадить локальне зберігання даних з
          мінімумом загального коду. Під час компіляції вона перевіряє кожний
          запит відносно схеми, так що поламані запити SQL призведуть до помилок
          часу компіляції, замість збоїв часу виконання. Room абстрагується від
          деяких деталей реалізації роботи з сирими SQL таблицями та запитами.
          Він також дозволяє нагляд за змінами вданих бази даних (включаючи
          колекції та запити поєднання), показуючи такі зміни через об'єкти <em>LiveData</em>.
          На додаток, він явно визначає потокові обмеження, що націлені на
          загальні проблеми, такі, як доступ до сховища в головному потоці.</p>
      </blockquote>
      <aside class="note"><strong>Зауваження:</strong><span> Якщо ваше
          застосування вже використовує інше рішення для зберігання, як
          відзеркалення SQLite ORM, вам не треба заміняти ваше існуюче рішення
          на <a href="https://developer.android.com/training/data-storage/room/index.html">Room</a>.
          Однак, якщо ви пишете нове застосування, або робите рефакторинг
          існуючого, ми рекомендуємо використовувати Room для збереження даних.
          Таким чином ви можете отримати вигоди від абстрагування бібліотеки, та
          додати можливості валідації.</span></aside>
      <p>Щоб використати Room, нам треба we need to define our local schema.
        First, annotate the <code>User</code> class with <a href="https://developer.android.com/reference/android/arch/persistence/room/Entity.html"><code>@Entity</code></a>
        to mark it as a table in your database.</p>
      <pre class="prettyprint"><code><span class="lit">@Entity</span><span class="pln"><br></span><span
class="kwd">class</span><span class="pln"> </span><span class="typ">User</span><span
class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; </span><span
class="lit">@PrimaryKey</span><span class="pln"><br>&nbsp; </span><span class="kwd">private</span><span
class="pln"> </span><span class="kwd">int</span><span class="pln"> id</span><span
class="pun">;</span><span class="pln"><br>&nbsp; </span><span class="kwd">private</span><span
class="pln"> </span><span class="typ">String</span><span class="pln"> name</span><span
class="pun">;</span><span class="pln"><br>&nbsp; </span><span class="kwd">private</span><span
class="pln"> </span><span class="typ">String</span><span class="pln"> lastName</span><span
class="pun">;</span><span class="pln"><br>&nbsp; </span><span class="com">// getters and setters for fields</span><span
class="pln"><br></span><span class="pun">}</span><span class="pln"><br></span></code></pre>
      <p>Then, create a database class by extending <a href="https://developer.android.com/reference/android/arch/persistence/room/RoomDatabase.html"><code>RoomDatabase</code></a>
        for your app:</p>
      <pre class="prettyprint"><code><span class="lit">@Database</span><span class="pun">(</span><span
class="pln">entities </span><span class="pun">=</span><span class="pln"> </span><span
class="pun">{</span><span class="typ">User</span><span class="pun">.</span><span
class="kwd">class</span><span class="pun">},</span><span class="pln"> version </span><span
class="pun">=</span><span class="pln"> </span><span class="lit">1</span><span class="pun">)</span><span
class="pln"><br></span><span class="kwd">public</span><span class="pln"> </span><span
class="kwd">abstract</span><span class="pln"> </span><span class="kwd">class</span><span
class="pln"> </span><span class="typ">MyDatabase</span><span class="pln"> </span><span
class="kwd">extends</span><span class="pln"> </span><span class="typ">RoomDatabase</span><span
class="pln"> </span><span class="pun">{</span><span class="pln"><br></span><span
class="pun">}</span><span class="pln"><br></span></code></pre>
      <p>Notice that <code>MyDatabase</code> is abstract. Room automatically
        provides an implementation of it. See the <a href="https://developer.android.com/topic/libraries/architecture/room.html">Room</a>
        documentation for details.</p>
      <p>Now we need a way to insert the user data into the database. For this,
        we'llcreate a <a href="https://en.wikipedia.org/wiki/Data_access_object">data
          access object (DAO)</a>.</p>
      <pre class="prettyprint"><code><span class="lit">@Dao</span><span class="pln"><br></span><span
class="kwd">public</span><span class="pln"> </span><span class="kwd">interface</span><span
class="pln"> </span><span class="typ">UserDao</span><span class="pln"> </span><span
class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="lit">@Insert</span><span
class="pun">(</span><span class="pln">onConflict </span><span class="pun">=</span><span
class="pln"> REPLACE</span><span class="pun">)</span><span class="pln"><br>&nbsp; &nbsp; </span><span
class="kwd">void</span><span class="pln"> save</span><span class="pun">(</span><span
class="typ">User</span><span class="pln"> user</span><span class="pun">);</span><span
class="pln"><br>&nbsp; &nbsp; </span><span class="lit">@Query</span><span class="pun">(</span><span
class="str">"SELECT * FROM user WHERE id = :userId"</span><span class="pun">)</span><span
class="pln"><br>&nbsp; &nbsp; </span><span class="typ">LiveData</span><span class="pun">&lt;</span><span
class="typ">User</span><span class="pun">&gt;</span><span class="pln"> load</span><span
class="pun">(</span><span class="typ">String</span><span class="pln"> userId</span><span
class="pun">);</span><span class="pln"><br></span><span class="pun">}</span><span
class="pln"><br></span></code></pre>
      <p>Then, reference the DAO from our database class.</p>
      <pre class="prettyprint"><code><span class="lit">@Database</span><span class="pun">(</span><span
class="pln">entities </span><span class="pun">=</span><span class="pln"> </span><span
class="pun">{</span><span class="typ">User</span><span class="pun">.</span><span
class="kwd">class</span><span class="pun">},</span><span class="pln"> version </span><span
class="pun">=</span><span class="pln"> </span><span class="lit">1</span><span class="pun">)</span><span
class="pln"><br></span><span class="kwd">public</span><span class="pln"> </span><span
class="kwd">abstract</span><span class="pln"> </span><span class="kwd">class</span><span
class="pln"> </span><span class="typ">MyDatabase</span><span class="pln"> </span><span
class="kwd">extends</span><span class="pln"> </span><span class="typ">RoomDatabase</span><span
class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; </span><span
class="kwd">public</span><span class="pln"> </span><span class="kwd">abstract</span><span
class="pln"> </span><span class="typ">UserDao</span><span class="pln"> userDao</span><span
class="pun">();</span><span class="pln"><br></span><span class="pun">}</span><span
class="pln"><br></span></code></pre>
      <p>Notice that the <code>load</code> method returns a <code>LiveData&lt;User&gt;</code>.
        Room knows when the database is modified and it will automatically
        notify all active observerswhen the data changes. Because it is using <em>LiveData</em>,
        this will be efficient because it will update the data only if there is
        at least one active observer.</p>
      <aside class="note"><strong>Note:</strong><span> Room checks invalidations
          based on table modifications which means it may dispatch false
          positive notifications.</span></aside>
      <p>Now we can modify our <code>UserRepository</code> to incorporate the
        Room data source.</p>
      <pre class="prettyprint"><code><span class="lit">@Singleton</span><span class="pln"><br></span><span
class="kwd">public</span><span class="pln"> </span><span class="kwd">class</span><span
class="pln"> </span><span class="typ">UserRepository</span><span class="pln"> </span><span
class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="kwd">private</span><span
class="pln"> </span><span class="kwd">final</span><span class="pln"> </span><span
class="typ">Webservice</span><span class="pln"> webservice</span><span class="pun">;</span><span
class="pln"><br>&nbsp; &nbsp; </span><span class="kwd">private</span><span class="pln"> </span><span
class="kwd">final</span><span class="pln"> </span><span class="typ">UserDao</span><span
class="pln"> userDao</span><span class="pun">;</span><span class="pln"><br>&nbsp; &nbsp; </span><span
class="kwd">private</span><span class="pln"> </span><span class="kwd">final</span><span
class="pln"> </span><span class="typ">Executor</span><span class="pln"> executor</span><span
class="pun">;</span><span class="pln"><br><br>&nbsp; &nbsp; </span><span class="lit">@Inject</span><span
class="pln"><br>&nbsp; &nbsp; </span><span class="kwd">public</span><span class="pln"> </span><span
class="typ">UserRepository</span><span class="pun">(</span><span class="typ">Webservice</span><span
class="pln"> webservice</span><span class="pun">,</span><span class="pln"> </span><span
class="typ">UserDao</span><span class="pln"> userDao</span><span class="pun">,</span><span
class="pln"> </span><span class="typ">Executor</span><span class="pln"> executor</span><span
class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="kwd">this</span><span class="pun">.</span><span class="pln">webservice </span><span
class="pun">=</span><span class="pln"> webservice</span><span class="pun">;</span><span
class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">this</span><span
class="pun">.</span><span class="pln">userDao </span><span class="pun">=</span><span
class="pln"> userDao</span><span class="pun">;</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="kwd">this</span><span class="pun">.</span><span class="pln">executor </span><span
class="pun">=</span><span class="pln"> executor</span><span class="pun">;</span><span
class="pln"><br>&nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br><br>&nbsp; &nbsp; </span><span
class="kwd">public</span><span class="pln"> </span><span class="typ">LiveData</span><span
class="pun">&lt;</span><span class="typ">User</span><span class="pun">&gt;</span><span
class="pln"> getUser</span><span class="pun">(</span><span class="typ">String</span><span
class="pln"> userId</span><span class="pun">)</span><span class="pln"> </span><span
class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; refreshUser</span><span
class="pun">(</span><span class="pln">userId</span><span class="pun">);</span><span
class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="com">// return a LiveData directly from the database.</span><span
class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">return</span><span
class="pln"> userDao</span><span class="pun">.</span><span class="pln">load</span><span
class="pun">(</span><span class="pln">userId</span><span class="pun">);</span><span
class="pln"><br>&nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br><br>&nbsp; &nbsp; </span><span
class="kwd">private</span><span class="pln"> </span><span class="kwd">void</span><span
class="pln"> refreshUser</span><span class="pun">(</span><span class="kwd">final</span><span
class="pln"> </span><span class="typ">String</span><span class="pln"> userId</span><span
class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; executor</span><span
class="pun">.</span><span class="pln">execute</span><span class="pun">(()</span><span
class="pln"> </span><span class="pun">-&gt;</span><span class="pln"> </span><span
class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="com">// running in a background thread</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="com">// check if user was fetched recently</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="kwd">boolean</span><span class="pln"> userExists </span><span class="pun">=</span><span
class="pln"> userDao</span><span class="pun">.</span><span class="pln">hasUser</span><span
class="pun">(</span><span class="pln">FRESH_TIMEOUT</span><span class="pun">);</span><span
class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">if</span><span
class="pln"> </span><span class="pun">(!</span><span class="pln">userExists</span><span
class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="com">// refresh the data</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="typ">Response</span><span class="pln"> response </span><span class="pun">=</span><span
class="pln"> webservice</span><span class="pun">.</span><span class="pln">getUser</span><span
class="pun">(</span><span class="pln">userId</span><span class="pun">).</span><span
class="pln">execute</span><span class="pun">();</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="com">// TODO check for error etc.</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="com">// Update the database.The LiveData will automatically refresh so</span><span
class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="com">// we don't need to do anything else here besides updating the database</span><span
class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; userDao</span><span
class="pun">.</span><span class="pln">save</span><span class="pun">(</span><span
class="pln">response</span><span class="pun">.</span><span class="pln">body</span><span
class="pun">());</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="pun">}</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="pun">});</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="pun">}</span><span
class="pln"><br></span><span class="pun">}</span><span class="pln"><br></span></code></pre>
      <p>Notice that even though we changed where the data comes from in <code>UserRepository</code>,
        we didn't need to change our <code>UserProfileViewModel</code> or <code>UserProfileFragment</code>.
        This is the flexibility provided by the abstraction. This is also great
        for testing because you can provide a fake <code>UserRepository</code>
        while testing your <code>UserProfileViewModel</code>.</p>
      <p>Now our code is complete. If the user comes back to the same UI days
        later,they will instantly see the user information because we've
        persisted it. Meanwhile, our repository will update the data in the
        background if the datais stale. Of course, depending on your use case,
        you may prefer not to show the persisted data if it is too old.</p>
      <p>In some use cases, such as pull-to-refresh, it is important for the UI
        to showthe user if there is currently a network operation in progress.
        It is good practice to separate the UI action from the actual data since
        it might beupdated for various reasons (for example, if we fetch a list
        of friends, the same user might be fetched again triggering a <code>LiveData&lt;User&gt;</code>
        update). From the UI's perspective, the fact that there is a request in
        flight is justanother data point, similar to any other piece data (like
        the <code>User</code> object).</p>
      <p>There are 2 common solutions for this use case:</p>
      <ul>
        <li>Change <code>getUser</code> to return a LiveData that includes the
          status of the network operation. An example implementation is provided
          in the <a href="https://developer.android.com/topic/libraries/architecture/guide.html#addendum">Addendum:
            exposing network status</a> section.</li>
        <li>Provide another public function in the repository class that can
          return the refresh status of the User. This option is better if you
          want to show the network status in your UI only in response to
          explicit user action (like pull-to-refresh).</li>
      </ul>
      <h4 id="truth">Single source of truth</h4>
      <p>It is common for different REST API endpoints to return the same data.
        Forinstance, if our backend had another endpoint that returns a list of
        friends, the same user object could come from two different API
        endpoints, maybe indifferent granularity. If the <code>UserRepository</code>
        were to return the response from the <code>Webservice</code> request
        as-is, our UIs could potentially show inconsistent data since the data
        might change on the server side between theserequests. This is why in
        the <code>UserRepository</code> implementation, the web service
        callback just saves the data into the database. Then, changes to the
        databasewill trigger callbacks on active <em>LiveData</em> objects.</p>
      <p>In this model, the database serves as the single source of truth, and
        otherparts of the app access it via the repository. Regardless of
        whether you use a disk cache, we recommend that your repository
        designate a data source as thesingle source of truth to the rest of your
        app.</p>
      <h3 id="testing">Testing</h3>
      <p>We've mentioned that one of the benefits of separation is testability.
        Letssee how we can test each code module.</p>
      <ul>
        <li>
          <p><strong>User Interface &amp; Interactions</strong>: This will be
            the only time you need an <a href="https://developer.android.com/training/testing/unit-testing/instrumented-unit-tests.html">Android
              UI Instrumentation test</a>. The best way to test UI code is to
            create an <a href="https://developer.android.com/training/testing/ui-testing/espresso-testing.html">Espresso</a>
            test. You can create the fragment and provide it a mock ViewModel.
            Since the fragment only talks to the ViewModel, mocking it will be
            sufficient to fully test this UI.</p>
        </li>
        <li>
          <p><strong>ViewModel</strong>: The ViewModel can be tested using a <a
              href="https://developer.android.com/training/testing/unit-testing/local-unit-tests.html">JUnit
              test</a>. You need to mock only the <code>UserRepository</code>
            to test it.</p>
        </li>
        <li>
          <p><strong>UserRepository</strong>: You can test the <code>UserRepository</code>
            with a JUnit test as well. You need to mock the <code>Webservice</code>
            and the DAO. You can test that it makes the right web service calls,
            saves the result into the database and does not make any unnecessary
            requests if the data is cached and up to date. Since both <code>Webservice</code>
            and <code>UserDao</code> are interfaces, you can mock them or
            create fake implementations for more complex test cases..</p>
        </li>
        <li>
          <p><strong>UserDao</strong>: The recommended approach for testing DAO
            classes is using instrumentation tests. Since these instrumentation
            tests do not require any UI, they will still run fast. For each
            test, you can create an in-memory database to ensure that the test
            does not have any side effects (like changing the database files on
            the disk).</p>
          <p>Room also allows specifying the database implementation so you can
            test itby providing it the JUnit implementation of the <a href="https://developer.android.com/reference/android/arch/persistence/db/SupportSQLiteOpenHelper.html"><code>SupportSQLiteOpenHelper</code></a>.
            This approach is usually not recommended because the SQLite
            versionrunning on the device may differ from the SQLite version on
            your host machine.</p>
        </li>
        <li>
          <p><strong>Webservice</strong>: It is important to make tests
            independent from the outside world so even your <code>Webservice</code>
            tests should avoid making network calls to your backend. There are
            plenty of libraries that help with this. For instance, <a href="https://github.com/square/okhttp/tree/master/mockwebserver">MockWebServer</a>
            is a great library that can help you create a fake local server for
            your tests.</p>
        </li>
        <li>
          <p><strong>Testing Artifacts</strong> Architecture Components provides
            a maven artifact to control its background threads. Inside the <code>android.arch.core:core-testing</code>
            artifact, there are 2 JUnit rules:</p>
          <ul>
            <li><code>InstantTaskExecutorRule</code>: This rule can be used to
              force Architecture Components to instantly execute any background
              operation on the calling thread.</li>
            <li><code>CountingTaskExecutorRule</code>: This rule can be used in
              instrumentation tests to wait for background operations of the
              Architecture Components or connect it to Espresso as an idling
              resource.</li>
          </ul>
        </li>
      </ul>
      <h3 id="the_final_architecture">The final architecture</h3>
      <p>The following diagram shows all the modules in our recommended
        architectureand how they interact with one another:</p>
      <p style="text-align:center;"><img src="./Guide%20to%20App%20Architecture%20_%20Android%20Developers_files/final-architecture.png"></p>
      <h2 id="guiding_principles" style="padding-bottom: 0px;">Guiding
        principles</h2>
      <hr>
      <p>Programming is a creative field, and building Android apps is not
        anexception. There are many ways to solve a problem, be it communicating
        data between multiple activities or fragments, retrieving remote data
        andpersisting it locally for offline mode, or any number of other common
        scenarios that non-trivial apps encounter.</p>
      <p>While the following recommendations are not mandatory, it has been
        ourexperience that following them will make your code base more robust,
        testable and maintainable in the long run.</p>
      <ul>
        <li>The entry points you define in your manifest - activities, services,
          broadcast receivers, etc. - are not the source of data. Instead, they
          should only be coordinating the subset of data that is relevant to
          that entry point. Because each app component is rather short lived,
          depending on the user's interaction with their device and the overall
          current health of the runtime, you do not want any of these entry
          points to be the source of data.</li>
        <li>Be merciless in creating well defined boundaries of responsibility
          between various modules of your app. For example, don't spread the
          code that loads data from the network across multiple classes or
          packages in your code base. Similarly, don't stuff unrelated
          responsibilities - such as data caching and data binding - into the
          same class.</li>
        <li>Expose as little as possible from each module. Do not be tempted to
          create "just that one" shortcut that exposes internal implementation
          detail from one module. You may gain a bit of time in the short term,
          but you will be paying technical debt many times over as your codebase
          evolves.</li>
        <li>As you define the interaction between the modules, think about how
          to make each one testable in isolation. For example, having a
          well-defined API for fetching data from the network will make it
          easier to test the module that persists that data in a local database.
          If, instead, you mix the logic from these two modules in one place, or
          sprinkle your networking code across your entire code base, it will be
          much harder - if not impossible - to test.</li>
        <li>The core of your app is what makes it stand out from the rest. Don't
          spend your time reinventing the wheel or writing the same boilerplate
          code again and again. Instead, focus your mental energy on what makes
          your app unique, and let the Android Architecture Components and other
          recommended libraries handle the repetitive boilerplate.</li>
        <li>Persist as much relevant and fresh data as possible so that your app
          is usable when the device is in offline mode. While you may enjoy
          constant and high speed connectivity, your users might not.</li>
        <li>Your repository should designate one data source as the single
          source of truth. Whenever your app needs to access this piece of data,
          it should always originate from the single source of truth. For more
          information, see <a href="https://developer.android.com/topic/libraries/architecture/guide.html#truth">Single
            source of truth</a>.</li>
      </ul>
      <h2 id="addendum" style="padding-bottom: 0px;">Addendum: exposing network
        status</h2>
      <hr>
      <p>In the <a href="https://developer.android.com/topic/libraries/architecture/guide.html#recommended_app_architecture">recommended
          app architecture</a> section above, we intentionally omitted network
        error and loading states to keep thesamples simple. In this section, we
        demonstrate a way to expose network status using a <code>Resource</code>
        class to encapsulate both the data and its state.</p>
      <p>Below is a sample implementation:</p>
      <pre class="prettyprint"><code><span class="com">//a generic class that describes a data with a status</span><span
class="pln"><br></span><span class="kwd">public</span><span class="pln"> </span><span
class="kwd">class</span><span class="pln"> </span><span class="typ">Resource</span><span
class="pun">&lt;</span><span class="pln">T</span><span class="pun">&gt;</span><span
class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; </span><span
class="lit">@NonNull</span><span class="pln"> </span><span class="kwd">public</span><span
class="pln"> </span><span class="kwd">final</span><span class="pln"> </span><span
class="typ">Status</span><span class="pln"> status</span><span class="pun">;</span><span
class="pln"><br>&nbsp; &nbsp; </span><span class="lit">@Nullable</span><span class="pln"> </span><span
class="kwd">public</span><span class="pln"> </span><span class="kwd">final</span><span
class="pln"> T data</span><span class="pun">;</span><span class="pln"><br>&nbsp; &nbsp; </span><span
class="lit">@Nullable</span><span class="pln"> </span><span class="kwd">public</span><span
class="pln"> </span><span class="kwd">final</span><span class="pln"> </span><span
class="typ">String</span><span class="pln"> message</span><span class="pun">;</span><span
class="pln"><br>&nbsp; &nbsp; </span><span class="kwd">private</span><span class="pln"> </span><span
class="typ">Resource</span><span class="pun">(</span><span class="lit">@NonNull</span><span
class="pln"> </span><span class="typ">Status</span><span class="pln"> status</span><span
class="pun">,</span><span class="pln"> </span><span class="lit">@Nullable</span><span
class="pln"> T data</span><span class="pun">,</span><span class="pln"> </span><span
class="lit">@Nullable</span><span class="pln"> </span><span class="typ">String</span><span
class="pln"> message</span><span class="pun">)</span><span class="pln"> </span><span
class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="kwd">this</span><span class="pun">.</span><span class="pln">status </span><span
class="pun">=</span><span class="pln"> status</span><span class="pun">;</span><span
class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">this</span><span
class="pun">.</span><span class="pln">data </span><span class="pun">=</span><span
class="pln"> data</span><span class="pun">;</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="kwd">this</span><span class="pun">.</span><span class="pln">message </span><span
class="pun">=</span><span class="pln"> message</span><span class="pun">;</span><span
class="pln"><br>&nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br><br>&nbsp; &nbsp; </span><span
class="kwd">public</span><span class="pln"> </span><span class="kwd">static</span><span
class="pln"> </span><span class="pun">&lt;</span><span class="pln">T</span><span
class="pun">&gt;</span><span class="pln"> </span><span class="typ">Resource</span><span
class="pun">&lt;</span><span class="pln">T</span><span class="pun">&gt;</span><span
class="pln"> success</span><span class="pun">(</span><span class="lit">@NonNull</span><span
class="pln"> T data</span><span class="pun">)</span><span class="pln"> </span><span
class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="kwd">return</span><span class="pln"> </span><span class="kwd">new</span><span
class="pln"> </span><span class="typ">Resource</span><span class="pun">&lt;&gt;(</span><span
class="pln">SUCCESS</span><span class="pun">,</span><span class="pln"> data</span><span
class="pun">,</span><span class="pln"> </span><span class="kwd">null</span><span
class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="pun">}</span><span
class="pln"><br><br>&nbsp; &nbsp; </span><span class="kwd">public</span><span class="pln"> </span><span
class="kwd">static</span><span class="pln"> </span><span class="pun">&lt;</span><span
class="pln">T</span><span class="pun">&gt;</span><span class="pln"> </span><span
class="typ">Resource</span><span class="pun">&lt;</span><span class="pln">T</span><span
class="pun">&gt;</span><span class="pln"> error</span><span class="pun">(</span><span
class="typ">String</span><span class="pln"> msg</span><span class="pun">,</span><span
class="pln"> </span><span class="lit">@Nullable</span><span class="pln"> T data</span><span
class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="kwd">return</span><span class="pln"> </span><span class="kwd">new</span><span
class="pln"> </span><span class="typ">Resource</span><span class="pun">&lt;&gt;(</span><span
class="pln">ERROR</span><span class="pun">,</span><span class="pln"> data</span><span
class="pun">,</span><span class="pln"> msg</span><span class="pun">);</span><span
class="pln"><br>&nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br><br>&nbsp; &nbsp; </span><span
class="kwd">public</span><span class="pln"> </span><span class="kwd">static</span><span
class="pln"> </span><span class="pun">&lt;</span><span class="pln">T</span><span
class="pun">&gt;</span><span class="pln"> </span><span class="typ">Resource</span><span
class="pun">&lt;</span><span class="pln">T</span><span class="pun">&gt;</span><span
class="pln"> loading</span><span class="pun">(</span><span class="lit">@Nullable</span><span
class="pln"> T data</span><span class="pun">)</span><span class="pln"> </span><span
class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="kwd">return</span><span class="pln"> </span><span class="kwd">new</span><span
class="pln"> </span><span class="typ">Resource</span><span class="pun">&lt;&gt;(</span><span
class="pln">LOADING</span><span class="pun">,</span><span class="pln"> data</span><span
class="pun">,</span><span class="pln"> </span><span class="kwd">null</span><span
class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="pun">}</span><span
class="pln"><br></span><span class="pun">}</span><span class="pln"><br></span></code></pre>
      <p>Because loading data from network while showing it from the disk is a
        common use case, we are going to create a helper class <code>NetworkBoundResource</code>
        that can be reused in multiple places. Below is the decision tree for<code>NetworkBoundResource</code>:</p>
      <p style="text-align:center;"><img src="./Guide%20to%20App%20Architecture%20_%20Android%20Developers_files/network-bound-resource.png"></p>
      <p>It starts by observing database for the resource. When the entry is
        loaded from the database for the first time, <code>NetworkBoundResource</code>
        checks whether the result is good enough to be dispatched and/or it
        should be fetched fromnetwork. Note that both of these can happen at the
        same time since you probably want to show the cached data while updating
        it from the network.</p>
      <p>If the network call completes successfully, it saves the response into
        thedatabase and re-initializes the stream. If network request fails, we
        dispatch a failure directly.</p>
      <aside class="note"><strong>Note:</strong><span> After saving new data to
          disk, we re-initialize the stream from the database, though, usually
          we don’t need to do that, since the database willdispatch the change.
          On the other hand, relying on the database to dispatch the change
          would be relying on the side effects which is not good because itmight
          break if the database can avoid dispatching changes if data did not
          change. We also don’t want to dispatch the result that arrived from
          thenetwork because that will go against the single source of truth
          (maybe there are triggers in the database that will change the value
          on save). We alsodidn’t want to dispatch <code>SUCCESS</code> without
          the new data since it would be sending wrong information to the
          client.</span></aside>
      <p>Below is the public API provided by <code>NetworkBoundResource</code>
        class for its children:</p>
      <pre class="prettyprint"><code><span class="com">// ResultType: Type for the Resource data</span><span
class="pln"><br></span><span class="com">// RequestType: Type for the API response</span><span
class="pln"><br></span><span class="kwd">public</span><span class="pln"> </span><span
class="kwd">abstract</span><span class="pln"> </span><span class="kwd">class</span><span
class="pln"> </span><span class="typ">NetworkBoundResource</span><span class="pun">&lt;</span><span
class="typ">ResultType</span><span class="pun">,</span><span class="pln"> </span><span
class="typ">RequestType</span><span class="pun">&gt;</span><span class="pln"> </span><span
class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="com">// Called to save the result of the API response into the database</span><span
class="pln"><br>&nbsp; &nbsp; </span><span class="lit">@WorkerThread</span><span
class="pln"><br>&nbsp; &nbsp; </span><span class="kwd">protected</span><span class="pln"> </span><span
class="kwd">abstract</span><span class="pln"> </span><span class="kwd">void</span><span
class="pln"> saveCallResult</span><span class="pun">(</span><span class="lit">@NonNull</span><span
class="pln"> </span><span class="typ">RequestType</span><span class="pln"> item</span><span
class="pun">);</span><span class="pln"><br><br>&nbsp; &nbsp; </span><span class="com">// Called with the data in the database to decide whether it should be</span><span
class="pln"><br>&nbsp; &nbsp; </span><span class="com">// fetched from the network.</span><span
class="pln"><br>&nbsp; &nbsp; </span><span class="lit">@MainThread</span><span class="pln"><br>&nbsp; &nbsp; </span><span
class="kwd">protected</span><span class="pln"> </span><span class="kwd">abstract</span><span
class="pln"> </span><span class="kwd">boolean</span><span class="pln"> shouldFetch</span><span
class="pun">(</span><span class="lit">@Nullable</span><span class="pln"> </span><span
class="typ">ResultType</span><span class="pln"> data</span><span class="pun">);</span><span
class="pln"><br><br>&nbsp; &nbsp; </span><span class="com">// Called to get the cached data from the database</span><span
class="pln"><br>&nbsp; &nbsp; </span><span class="lit">@NonNull</span><span class="pln"> </span><span
class="lit">@MainThread</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="kwd">protected</span><span
class="pln"> </span><span class="kwd">abstract</span><span class="pln"> </span><span
class="typ">LiveData</span><span class="pun">&lt;</span><span class="typ">ResultType</span><span
class="pun">&gt;</span><span class="pln"> loadFromDb</span><span class="pun">();</span><span
class="pln"><br><br>&nbsp; &nbsp; </span><span class="com">// Called to create the API call.</span><span
class="pln"><br>&nbsp; &nbsp; </span><span class="lit">@NonNull</span><span class="pln"> </span><span
class="lit">@MainThread</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="kwd">protected</span><span
class="pln"> </span><span class="kwd">abstract</span><span class="pln"> </span><span
class="typ">LiveData</span><span class="pun">&lt;</span><span class="typ">ApiResponse</span><span
class="pun">&lt;</span><span class="typ">RequestType</span><span class="pun">&gt;&gt;</span><span
class="pln"> createCall</span><span class="pun">();</span><span class="pln"><br><br>&nbsp; &nbsp; </span><span
class="com">// Called when the fetch fails. The child class may want to reset components</span><span
class="pln"><br>&nbsp; &nbsp; </span><span class="com">// like rate limiter.</span><span
class="pln"><br>&nbsp; &nbsp; </span><span class="lit">@MainThread</span><span class="pln"><br>&nbsp; &nbsp; </span><span
class="kwd">protected</span><span class="pln"> </span><span class="kwd">void</span><span
class="pln"> onFetchFailed</span><span class="pun">()</span><span class="pln"> </span><span
class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="pun">}</span><span
class="pln"><br><br>&nbsp; &nbsp; </span><span class="com">// returns a LiveData that represents the resource, implemented</span><span
class="pln"><br>&nbsp; &nbsp; </span><span class="com">// in the base class.</span><span
class="pln"><br>&nbsp; &nbsp; </span><span class="kwd">public</span><span class="pln"> </span><span
class="kwd">final</span><span class="pln"> </span><span class="typ">LiveData</span><span
class="pun">&lt;</span><span class="typ">Resource</span><span class="pun">&lt;</span><span
class="typ">ResultType</span><span class="pun">&gt;&gt;</span><span class="pln"> getAsLiveData</span><span
class="pun">();</span><span class="pln"><br></span><span class="pun">}</span><span
class="pln"><br></span></code></pre>
      <p>Notice that the class above defines two type parameters (<code>ResultType</code>,
        <code>RequestType</code>) since the data type returned from the API may
        not match the data type used locally.</p>
      <p>Also notice that the code above uses <code>ApiResponse</code> for
        network request. <code>ApiResponse</code> is a simple wrapper around <code>Retrofit2.Call</code>
        class to convert its response into a LiveData.</p>
      <p>Below is the rest of the implementation for the <code>NetworkBoundResource</code>
        class:</p>
      <pre class="prettyprint"><code><span class="kwd">public</span><span class="pln"> </span><span
class="kwd">abstract</span><span class="pln"> </span><span class="kwd">class</span><span
class="pln"> </span><span class="typ">NetworkBoundResource</span><span class="pun">&lt;</span><span
class="typ">ResultType</span><span class="pun">,</span><span class="pln"> </span><span
class="typ">RequestType</span><span class="pun">&gt;</span><span class="pln"> </span><span
class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="kwd">private</span><span
class="pln"> </span><span class="kwd">final</span><span class="pln"> </span><span
class="typ">MediatorLiveData</span><span class="pun">&lt;</span><span class="typ">Resource</span><span
class="pun">&lt;</span><span class="typ">ResultType</span><span class="pun">&gt;&gt;</span><span
class="pln"> result </span><span class="pun">=</span><span class="pln"> </span><span
class="kwd">new</span><span class="pln"> </span><span class="typ">MediatorLiveData</span><span
class="pun">&lt;&gt;();</span><span class="pln"><br><br>&nbsp; &nbsp; </span><span
class="lit">@MainThread</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="typ">NetworkBoundResource</span><span
class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; result</span><span
class="pun">.</span><span class="pln">setValue</span><span class="pun">(</span><span
class="typ">Resource</span><span class="pun">.</span><span class="pln">loading</span><span
class="pun">(</span><span class="kwd">null</span><span class="pun">));</span><span
class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="typ">LiveData</span><span
class="pun">&lt;</span><span class="typ">ResultType</span><span class="pun">&gt;</span><span
class="pln"> dbSource </span><span class="pun">=</span><span class="pln"> loadFromDb</span><span
class="pun">();</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; result</span><span
class="pun">.</span><span class="pln">addSource</span><span class="pun">(</span><span
class="pln">dbSource</span><span class="pun">,</span><span class="pln"> data </span><span
class="pun">-&gt;</span><span class="pln"> </span><span class="pun">{</span><span
class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result</span><span class="pun">.</span><span
class="pln">removeSource</span><span class="pun">(</span><span class="pln">dbSource</span><span
class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">shouldFetch</span><span
class="pun">(</span><span class="pln">data</span><span class="pun">))</span><span
class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fetchFromNetwork</span><span
class="pun">(</span><span class="pln">dbSource</span><span class="pun">);</span><span
class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun">}</span><span
class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span
class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result</span><span
class="pun">.</span><span class="pln">addSource</span><span class="pun">(</span><span
class="pln">dbSource</span><span class="pun">,</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; newData </span><span
class="pun">-&gt;</span><span class="pln"> result</span><span class="pun">.</span><span
class="pln">setValue</span><span class="pun">(</span><span class="typ">Resource</span><span
class="pun">.</span><span class="pln">success</span><span class="pun">(</span><span
class="pln">newData</span><span class="pun">)));</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="pun">}</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="pun">});</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="pun">}</span><span
class="pln"><br><br>&nbsp; &nbsp; </span><span class="kwd">private</span><span class="pln"> </span><span
class="kwd">void</span><span class="pln"> fetchFromNetwork</span><span class="pun">(</span><span
class="kwd">final</span><span class="pln"> </span><span class="typ">LiveData</span><span
class="pun">&lt;</span><span class="typ">ResultType</span><span class="pun">&gt;</span><span
class="pln"> dbSource</span><span class="pun">)</span><span class="pln"> </span><span
class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="typ">LiveData</span><span class="pun">&lt;</span><span class="typ">ApiResponse</span><span
class="pun">&lt;</span><span class="typ">RequestType</span><span class="pun">&gt;&gt;</span><span
class="pln"> apiResponse </span><span class="pun">=</span><span class="pln"> createCall</span><span
class="pun">();</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="com">// we re-attach dbSource as a new source,</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="com">// it will dispatch its latest value quickly</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; result</span><span
class="pun">.</span><span class="pln">addSource</span><span class="pun">(</span><span
class="pln">dbSource</span><span class="pun">,</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; newData </span><span
class="pun">-&gt;</span><span class="pln"> result</span><span class="pun">.</span><span
class="pln">setValue</span><span class="pun">(</span><span class="typ">Resource</span><span
class="pun">.</span><span class="pln">loading</span><span class="pun">(</span><span
class="pln">newData</span><span class="pun">)));</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; result</span><span
class="pun">.</span><span class="pln">addSource</span><span class="pun">(</span><span
class="pln">apiResponse</span><span class="pun">,</span><span class="pln"> response </span><span
class="pun">-&gt;</span><span class="pln"> </span><span class="pun">{</span><span
class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result</span><span class="pun">.</span><span
class="pln">removeSource</span><span class="pun">(</span><span class="pln">apiResponse</span><span
class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result</span><span
class="pun">.</span><span class="pln">removeSource</span><span class="pun">(</span><span
class="pln">dbSource</span><span class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="com">//noinspection ConstantConditions</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">response</span><span
class="pun">.</span><span class="pln">isSuccessful</span><span class="pun">())</span><span
class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; saveResultAndReInit</span><span
class="pun">(</span><span class="pln">response</span><span class="pun">);</span><span
class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="pun">}</span><span
class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span
class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; onFetchFailed</span><span
class="pun">();</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result</span><span
class="pun">.</span><span class="pln">addSource</span><span class="pun">(</span><span
class="pln">dbSource</span><span class="pun">,</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; newData </span><span
class="pun">-&gt;</span><span class="pln"> result</span><span class="pun">.</span><span
class="pln">setValue</span><span class="pun">(</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="typ">Resource</span><span class="pun">.</span><span class="pln">error</span><span
class="pun">(</span><span class="pln">response</span><span class="pun">.</span><span
class="pln">errorMessage</span><span class="pun">,</span><span class="pln"> newData</span><span
class="pun">)));</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="pun">}</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="pun">});</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="pun">}</span><span
class="pln"><br><br>&nbsp; &nbsp; </span><span class="lit">@MainThread</span><span
class="pln"><br>&nbsp; &nbsp; </span><span class="kwd">private</span><span class="pln"> </span><span
class="kwd">void</span><span class="pln"> saveResultAndReInit</span><span class="pun">(</span><span
class="typ">ApiResponse</span><span class="pun">&lt;</span><span class="typ">RequestType</span><span
class="pun">&gt;</span><span class="pln"> response</span><span class="pun">)</span><span
class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="kwd">new</span><span class="pln"> </span><span class="typ">AsyncTask</span><span
class="pun">&lt;</span><span class="typ">Void</span><span class="pun">,</span><span
class="pln"> </span><span class="typ">Void</span><span class="pun">,</span><span
class="pln"> </span><span class="typ">Void</span><span class="pun">&gt;()</span><span
class="pln"> </span><span class="pun">{</span><span class="pln"><br><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="lit">@Override</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="kwd">protected</span><span class="pln"> </span><span class="typ">Void</span><span
class="pln"> doInBackground</span><span class="pun">(</span><span class="typ">Void</span><span
class="pun">...</span><span class="pln"> voids</span><span class="pun">)</span><span
class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; saveCallResult</span><span
class="pun">(</span><span class="pln">response</span><span class="pun">.</span><span
class="pln">body</span><span class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="kwd">return</span><span class="pln"> </span><span class="kwd">null</span><span
class="pun">;</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="pun">}</span><span class="pln"><br><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="lit">@Override</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="kwd">protected</span><span class="pln"> </span><span class="kwd">void</span><span
class="pln"> onPostExecute</span><span class="pun">(</span><span class="typ">Void</span><span
class="pln"> aVoid</span><span class="pun">)</span><span class="pln"> </span><span
class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="com">// we specially request a new live data,</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="com">// otherwise we will get immediately last cached value,</span><span
class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="com">// which may not be updated with latest results received from network.</span><span
class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; result</span><span
class="pun">.</span><span class="pln">addSource</span><span class="pun">(</span><span
class="pln">loadFromDb</span><span class="pun">(),</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; newData </span><span
class="pun">-&gt;</span><span class="pln"> result</span><span class="pun">.</span><span
class="pln">setValue</span><span class="pun">(</span><span class="typ">Resource</span><span
class="pun">.</span><span class="pln">success</span><span class="pun">(</span><span
class="pln">newData</span><span class="pun">)));</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="pun">}</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="pun">}.</span><span class="pln">execute</span><span class="pun">();</span><span
class="pln"><br>&nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br><br>&nbsp; &nbsp; </span><span
class="kwd">public</span><span class="pln"> </span><span class="kwd">final</span><span
class="pln"> </span><span class="typ">LiveData</span><span class="pun">&lt;</span><span
class="typ">Resource</span><span class="pun">&lt;</span><span class="typ">ResultType</span><span
class="pun">&gt;&gt;</span><span class="pln"> getAsLiveData</span><span class="pun">()</span><span
class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="kwd">return</span><span class="pln"> result</span><span class="pun">;</span><span
class="pln"><br>&nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br></span><span
class="pun">}</span><span class="pln"><br></span></code></pre>
      <p>Now, we can use use <code>NetworkBoundResource</code> to write our
        disk and network bound <code>User</code> implementation in the
        repository.</p>
      <pre class="prettyprint"><code><span class="kwd">class</span><span class="pln"> </span><span
class="typ">UserRepository</span><span class="pln"> </span><span class="pun">{</span><span
class="pln"><br>&nbsp; &nbsp; </span><span class="typ">Webservice</span><span class="pln"> webservice</span><span
class="pun">;</span><span class="pln"><br>&nbsp; &nbsp; </span><span class="typ">UserDao</span><span
class="pln"> userDao</span><span class="pun">;</span><span class="pln"><br><br>&nbsp; &nbsp; </span><span
class="kwd">public</span><span class="pln"> </span><span class="typ">LiveData</span><span
class="pun">&lt;</span><span class="typ">Resource</span><span class="pun">&lt;</span><span
class="typ">User</span><span class="pun">&gt;&gt;</span><span class="pln"> loadUser</span><span
class="pun">(</span><span class="kwd">final</span><span class="pln"> </span><span
class="typ">String</span><span class="pln"> userId</span><span class="pun">)</span><span
class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="kwd">return</span><span class="pln"> </span><span class="kwd">new</span><span
class="pln"> </span><span class="typ">NetworkBoundResource</span><span class="pun">&lt;</span><span
class="typ">User</span><span class="pun">,</span><span class="typ">User</span><span
class="pun">&gt;()</span><span class="pln"> </span><span class="pun">{</span><span
class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="lit">@Override</span><span
class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">protected</span><span
class="pln"> </span><span class="kwd">void</span><span class="pln"> saveCallResult</span><span
class="pun">(</span><span class="lit">@NonNull</span><span class="pln"> </span><span
class="typ">User</span><span class="pln"> item</span><span class="pun">)</span><span
class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; userDao</span><span
class="pun">.</span><span class="pln">insert</span><span class="pun">(</span><span
class="pln">item</span><span class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="pun">}</span><span class="pln"><br><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="lit">@Override</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="kwd">protected</span><span class="pln"> </span><span class="kwd">boolean</span><span
class="pln"> shouldFetch</span><span class="pun">(</span><span class="lit">@Nullable</span><span
class="pln"> </span><span class="typ">User</span><span class="pln"> data</span><span
class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="kwd">return</span><span class="pln"> rateLimiter</span><span class="pun">.</span><span
class="pln">canFetch</span><span class="pun">(</span><span class="pln">userId</span><span
class="pun">)</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span
class="pln"> </span><span class="pun">(</span><span class="pln">data </span><span
class="pun">==</span><span class="pln"> </span><span class="kwd">null</span><span
class="pln"> </span><span class="pun">||</span><span class="pln"> </span><span class="pun">!</span><span
class="pln">isFresh</span><span class="pun">(</span><span class="pln">data</span><span
class="pun">));</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="pun">}</span><span class="pln"><br><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="lit">@NonNull</span><span class="pln"> </span><span class="lit">@Override</span><span
class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">protected</span><span
class="pln"> </span><span class="typ">LiveData</span><span class="pun">&lt;</span><span
class="typ">User</span><span class="pun">&gt;</span><span class="pln"> loadFromDb</span><span
class="pun">()</span><span class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="kwd">return</span><span class="pln"> userDao</span><span class="pun">.</span><span
class="pln">load</span><span class="pun">(</span><span class="pln">userId</span><span
class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="pun">}</span><span class="pln"><br><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="lit">@NonNull</span><span class="pln"> </span><span class="lit">@Override</span><span
class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="kwd">protected</span><span
class="pln"> </span><span class="typ">LiveData</span><span class="pun">&lt;</span><span
class="typ">ApiResponse</span><span class="pun">&lt;</span><span class="typ">User</span><span
class="pun">&gt;&gt;</span><span class="pln"> createCall</span><span class="pun">()</span><span
class="pln"> </span><span class="pun">{</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="kwd">return</span><span class="pln"> webservice</span><span class="pun">.</span><span
class="pln">getUser</span><span class="pun">(</span><span class="pln">userId</span><span
class="pun">);</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="pun">}</span><span class="pln"><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span
class="pun">}.</span><span class="pln">getAsLiveData</span><span class="pun">();</span><span
class="pln"><br>&nbsp; &nbsp; </span><span class="pun">}</span><span class="pln"><br></span><span
class="pun">}</span><span class="pln"><br></span></code></pre>
    </div>
    <footer class="devsite-footer-promos nocontent">
      <nav class="devsite-full-site-width">
        <ul class="devsite-footer-promos-list">
          <li class="devsite-footer-promo"> <a href="https://twitter.com/AndroidDev"
              class="devsite-footer-promo-title gc-analytics-event" data-category="Site-Wide Custom Events"
              data-label="Footer Twitter Promo"> </a><br>
          </li>
        </ul>
      </nav>
    </footer>
  </body>
</html>
