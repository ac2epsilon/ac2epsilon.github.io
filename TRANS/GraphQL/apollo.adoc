:ascii-ids:
:doctype: book
:source-highlighter: pygments
:icons: font

= Apollo 101 ~by ac2~

=== Как работать с JSON в mysql

Если вам повезло, и у вас стоит MySQL, а не какая то дрянь, вроде MariaDB, то у вас доступны тип поля JSON и несколько функций работы с ним. Вот как можно собрать различные переводы в ML файле:

[source,sql]
----
CREATE VIEW `ac_category` AS
    SELECT 
        `aircraft_category_id` AS `id`,
        JSON_OBJECTAGG(`lang_id`, `name`) AS `name_ml`
    FROM
        `aircraft_category_ml`
    GROUP BY `aircraft_category_id`
----

Результат говорит за себя:

[source,sql]
----
mysql> describe ac_category;
+---------+---------+------+-----+---------+-------+
| Field   | Type    | Null | Key | Default | Extra |
+---------+---------+------+-----+---------+-------+
| id      | int(11) | NO   |     | NULL    |       |
| name_ml | json    | YES  |     | NULL    |       |
+---------+---------+------+-----+---------+-------+
2 rows in set (0.01 sec)
----

Правда не все понимают этот тип, но приличные ORM всегда поддерживают настройку маршаллинга для любых типов. Например, Knex делает ето в конфиге: 

[source,js]
----
const knexConfig = {
  client: 'mysql',
...
    typeCast: function(field, next) {
      if (field.type === 'JSON') {
        return (JSON.parse(field.string()))
      }
      return next();
    },
  },
};
----

После этого я просто даю объектный тип на поле:

[source]
----
  type ML {
    en: String
    de: String
    ru: String
    uk: String
  }
  type AirCraft {
    id: ID
    name: String
    type: String
    brand: String
    category_ml: ML
  }
----

И главное не забыть (а ето и не получится) что надо дать декомпозицию:

[source]
----
{
  aircrafts {
    id
    name
    type
    brand
    category_ml {
      en
      ru
    }
  }
}
----

Получим красивый результат:

[source,json]
----
{
  "data": {
    "aircrafts": [
      {
        "id": "796",
        "name": "Avro Shackleton",
        "type": "Not Specified",
        "brand": "Not Specified",
        "category_ml": {
          "en": "Other",
          "ru": "Другие"
        }
      },
----

=== Краткое прохождение 

[source,bash]
----
mkdir graphql-server-example
cd graphql-server-example
npm init --yes
npm install apollo-server graphql dotenv mysql datasource-sql
touch index.js
----

[source,js]
----
const { ApolloServer, gql } = require('apollo-server');
const typeDefs = gql`
  type Book {
    title: String
    author: String
  }
  type Query {
    books: [Book]
  }
`;
const resolvers = {
  Query: {
    books: () => books,
  },
};
const server = new ApolloServer({ typeDefs, resolvers });
server.listen().then(({ url }) => {
  console.log(`🚀  Server ready at ${url}`);
});
----

[source,bash]
----
node index.js
----