:ascii-ids:
:doctype: book
:source-highlighter: pygments
:icons: font

= Apollo 101 ~by ac2~

=== ĞšĞ°Ğº Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ Ñ JSON Ğ² mysql

Ğ•ÑĞ»Ğ¸ Ğ²Ğ°Ğ¼ Ğ¿Ğ¾Ğ²ĞµĞ·Ğ»Ğ¾, Ğ¸ Ñƒ Ğ²Ğ°Ñ ÑÑ‚Ğ¾Ğ¸Ñ‚ MySQL, Ğ° Ğ½Ğµ ĞºĞ°ĞºĞ°Ñ Ñ‚Ğ¾ Ğ´Ñ€ÑĞ½ÑŒ, Ğ²Ñ€Ğ¾Ğ´Ğµ MariaDB, Ñ‚Ğ¾ Ñƒ Ğ²Ğ°Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹ Ñ‚Ğ¸Ğ¿ Ğ¿Ğ¾Ğ»Ñ JSON Ğ¸ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¹ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ Ğ½Ğ¸Ğ¼. Ğ’Ğ¾Ñ‚ ĞºĞ°Ğº Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ ÑĞ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ Ñ€Ğ°Ğ·Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğµ Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ğ´Ñ‹ Ğ² ML Ñ„Ğ°Ğ¹Ğ»Ğµ:

[source,sql]
----
CREATE VIEW `ac_category` AS
    SELECT 
        `aircraft_category_id` AS `id`,
        JSON_OBJECTAGG(`lang_id`, `name`) AS `name_ml`
    FROM
        `aircraft_category_ml`
    GROUP BY `aircraft_category_id`
----

Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¸Ñ‚ Ğ·Ğ° ÑĞµĞ±Ñ:

[source,sql]
----
mysql> describe ac_category;
+---------+---------+------+-----+---------+-------+
| Field   | Type    | Null | Key | Default | Extra |
+---------+---------+------+-----+---------+-------+
| id      | int(11) | NO   |     | NULL    |       |
| name_ml | json    | YES  |     | NULL    |       |
+---------+---------+------+-----+---------+-------+
2 rows in set (0.01 sec)
----

ĞŸÑ€Ğ°Ğ²Ğ´Ğ° Ğ½Ğµ Ğ²ÑĞµ Ğ¿Ğ¾Ğ½Ğ¸Ğ¼Ğ°ÑÑ‚ ÑÑ‚Ğ¾Ñ‚ Ñ‚Ğ¸Ğ¿, Ğ½Ğ¾ Ğ¿Ñ€Ğ¸Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğµ ORM Ğ²ÑĞµĞ³Ğ´Ğ° Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ÑÑ‚ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºÑƒ Ğ¼Ğ°Ñ€ÑˆĞ°Ğ»Ğ»Ğ¸Ğ½Ğ³Ğ° Ğ´Ğ»Ñ Ğ»ÑĞ±Ñ‹Ñ… Ñ‚Ğ¸Ğ¿Ğ¾Ğ². ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, Knex Ğ´ĞµĞ»Ğ°ĞµÑ‚ ĞµÑ‚Ğ¾ Ğ² ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğµ: 

[source,js]
----
const knexConfig = {
  client: 'mysql',
...
    typeCast: function(field, next) {
      if (field.type === 'JSON') {
        return (JSON.parse(field.string()))
      }
      return next();
    },
  },
};
----

ĞŸĞ¾ÑĞ»Ğµ ÑÑ‚Ğ¾Ğ³Ğ¾ Ñ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ´Ğ°Ñ Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ½Ñ‹Ğ¹ Ñ‚Ğ¸Ğ¿ Ğ½Ğ° Ğ¿Ğ¾Ğ»Ğµ:

[source]
----
  type ML {
    en: String
    de: String
    ru: String
    uk: String
  }
  type AirCraft {
    id: ID
    name: String
    type: String
    brand: String
    category_ml: ML
  }
----

Ğ˜ Ğ³Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ½Ğµ Ğ·Ğ°Ğ±Ñ‹Ñ‚ÑŒ (Ğ° ĞµÑ‚Ğ¾ Ğ¸ Ğ½Ğµ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑÑ) Ñ‡Ñ‚Ğ¾ Ğ½Ğ°Ğ´Ğ¾ Ğ´Ğ°Ñ‚ÑŒ Ğ´ĞµĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ:

[source]
----
{
  aircrafts {
    id
    name
    type
    brand
    category_ml {
      en
      ru
    }
  }
}
----

ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ğ¼ ĞºÑ€Ğ°ÑĞ¸Ğ²Ñ‹Ğ¹ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚:

[source,json]
----
{
  "data": {
    "aircrafts": [
      {
        "id": "796",
        "name": "Avro Shackleton",
        "type": "Not Specified",
        "brand": "Not Specified",
        "category_ml": {
          "en": "Other",
          "ru": "Ğ”Ñ€ÑƒĞ³Ğ¸Ğµ"
        }
      },
----

=== ĞšÑ€Ğ°Ñ‚ĞºĞ¾Ğµ Ğ¿Ñ€Ğ¾Ñ…Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ 

[source,bash]
----
mkdir graphql-server-example
cd graphql-server-example
npm init --yes
npm install apollo-server graphql dotenv mysql datasource-sql
touch index.js
----

[source,js]
----
const { ApolloServer, gql } = require('apollo-server');
const typeDefs = gql`
  type Book {
    title: String
    author: String
  }
  type Query {
    books: [Book]
  }
`;
const resolvers = {
  Query: {
    books: () => books,
  },
};
const server = new ApolloServer({ typeDefs, resolvers });
server.listen().then(({ url }) => {
  console.log(`ğŸš€  Server ready at ${url}`);
});
----

[source,bash]
----
node index.js
----