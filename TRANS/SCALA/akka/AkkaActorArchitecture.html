<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.6.10" />
<title></title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

.monospaced, code, pre {
  font-family: "Courier New", Courier, monospace;
  font-size: inherit;
  color: navy;
  padding: 0;
  margin: 0;
}
pre {
  white-space: pre-wrap;
}

#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #888;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; vertical-align: text-bottom; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel0, div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }

div.unbreakable { page-break-inside: avoid; }


/*
 * xhtml11 specific
 *
 * */

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}
.highlight .hll { background-color: #ffffcc }
.highlight  { background: #f8f8f8; }
.highlight .c { color: #408080; font-style: italic } /* Comment */
.highlight .err { border: 1px solid #FF0000 } /* Error */
.highlight .k { color: #008000; font-weight: bold } /* Keyword */
.highlight .o { color: #666666 } /* Operator */
.highlight .cm { color: #408080; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #BC7A00 } /* Comment.Preproc */
.highlight .c1 { color: #408080; font-style: italic } /* Comment.Single */
.highlight .cs { color: #408080; font-style: italic } /* Comment.Special */
.highlight .gd { color: #A00000 } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #FF0000 } /* Generic.Error */
.highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight .gi { color: #00A000 } /* Generic.Inserted */
.highlight .go { color: #808080 } /* Generic.Output */
.highlight .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight .gt { color: #0040D0 } /* Generic.Traceback */
.highlight .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #008000 } /* Keyword.Pseudo */
.highlight .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #B00040 } /* Keyword.Type */
.highlight .m { color: #666666 } /* Literal.Number */
.highlight .s { color: #BA2121 } /* Literal.String */
.highlight .na { color: #7D9029 } /* Name.Attribute */
.highlight .nb { color: #008000 } /* Name.Builtin */
.highlight .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.highlight .no { color: #880000 } /* Name.Constant */
.highlight .nd { color: #AA22FF } /* Name.Decorator */
.highlight .ni { color: #999999; font-weight: bold } /* Name.Entity */
.highlight .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #0000FF } /* Name.Function */
.highlight .nl { color: #A0A000 } /* Name.Label */
.highlight .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.highlight .nt { color: #008000; font-weight: bold } /* Name.Tag */
.highlight .nv { color: #19177C } /* Name.Variable */
.highlight .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mf { color: #666666 } /* Literal.Number.Float */
.highlight .mh { color: #666666 } /* Literal.Number.Hex */
.highlight .mi { color: #666666 } /* Literal.Number.Integer */
.highlight .mo { color: #666666 } /* Literal.Number.Oct */
.highlight .sb { color: #BA2121 } /* Literal.String.Backtick */
.highlight .sc { color: #BA2121 } /* Literal.String.Char */
.highlight .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.highlight .s2 { color: #BA2121 } /* Literal.String.Double */
.highlight .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.highlight .sh { color: #BA2121 } /* Literal.String.Heredoc */
.highlight .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.highlight .sx { color: #008000 } /* Literal.String.Other */
.highlight .sr { color: #BB6688 } /* Literal.String.Regex */
.highlight .s1 { color: #BA2121 } /* Literal.String.Single */
.highlight .ss { color: #19177C } /* Literal.String.Symbol */
.highlight .bp { color: #008000 } /* Name.Builtin.Pseudo */
.highlight .vc { color: #19177C } /* Name.Variable.Class */
.highlight .vg { color: #19177C } /* Name.Variable.Global */
.highlight .vi { color: #19177C } /* Name.Variable.Instance */
.highlight .il { color: #666666 } /* Literal.Number.Integer.Long */


</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install();
/*]]>*/
</script>
</head>
<body class="book">
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="___">Вступ до прикладу</h2>
<div class="sectionbody">
<div class="paragraph"><p>Під час написання прози найважчою частиною є складання перших кількох речень. Під час створення системи Akka виникає подібне «чисте полотно». Ви можете задатися питанням: який повинен бути перший актор? Де він повинен жити? Що він повинен робити? На щастя - на відміну від прози - усталені кращі практики можуть провести нас через ці початкові кроки. У решті цього посібника ми вивчаємо основну логіку простого додатка Akka, що познайомлять вас з акторами та показати, як формулювати рішення з ними. Приклад демонструє загальні зразки, які допоможуть вам почати свої проекти Akka.</p></div>
<div class="sect2">
<h3 id="_">Передумови</h3>
<div class="paragraph"><p>Ви повинні наразі ознайомитися зі вказівками у посібнику <a href="https://developer.lightbend.com/guides/akka-quickstart-scala/?_ga=2.78769181.862459059.1579167332-1972390590.1574487700">Akka Quickstart with Scala</a>, щоб завантажити та запустити приклад Hello World. Ви використовуватимете це як початковий проект та додасте функціонал, описаний у цьому підручнику.</p></div>
<div class="paragraph"><div class="title">Зауваження</div><p>NOTE
DSL і Java, і Scala модулів Akka вбудовані в один JAR. Для поступового досвіду розробки, використовуючи IDE, наприклад Eclipse або IntelliJ, ви можете відключити в автоімпортері пропонувати імпорт <code>javadsl</code> під час роботи в Scala або навпаки. Дивіться <a href="https://doc.akka.io/docs/akka/current/additional/ide.html">Поради щодо IDE</a>.</p></div>
</div>
<div class="sect2">
<h3 id="___iot">Приклад використання IoT</h3>
<div class="paragraph"><p>У цьому підручнику ми будемо використовувати Akka для створення частини системи Internet of Things (IoT), яка повідомляє дані з сенсорних пристроїв, встановлених у будинках клієнтів. Приклад зосереджується на показниках температури. Цільовий випадок використання дозволяє клієнтам увійти та переглянути останню повідомлену температуру з різних частин своїх будинків. Ви можете уявити, що такі датчики також можуть збирати відносну вологість чи інші цікаві дані, і програма, ймовірно, підтримує зчитування та зміну конфігурації пристрою, можливо, навіть попереджає власників будинків, коли стан датчика виходить за межі певного діапазону.</p></div>
<div class="paragraph"><p>У реальній системі застосування дістається клієнтів через мобільний додаток або браузер. Цей посібник зосереджений лише на основній логіці зберігання температур, які б викликалися через мережевий протокол, наприклад, HTTP. Це також включає написання тестів, щоб допомогти вам почуватись комфортно та досвідчено в тестуванні акторів.</p></div>
<div class="paragraph"><p>Навчальний додаток складається з двох основних компонентів:</p></div>
<div class="ulist"><ul>
<li>
<p>
Збір даних про пристрій: - підтримує локальне представлення віддалених пристроїв. Кілька сенсорних пристроїв для будинку організовано в одну групу пристроїв.
</p>
</li>
<li>
<p>
Інформаційна панель користувача: - періодично збирає дані з пристроїв для зареєстрованої оселі користувача та представляє результати у вигляді звіту.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Наступна схема ілюструє архітектуру застосування. Оскільки нас цікавить стан кожного сенсорного пристрою, ми будемо моделювати пристрої як актори. Запущена програма створить стільки примірників акторів пристроїв та груп пристроїв, скільки потрібно.</p></div>
<div class="imageblock">
<div class="content">
<img src="arch_boxes_diagram.png" alt="arch_boxes_diagram.png" />
</div>
</div>
</div>
<div class="sect2">
<h3 id="_______">Про що ви дізнаєтесь у цьому підручнику</h3>
<div class="paragraph"><p>Цей підручник представляє та ілюструє:</p></div>
<div class="ulist"><ul>
<li>
<p>
Ієрархія актора та те, як вона впливає на поведінку актора
</p>
</li>
<li>
<p>
Як обрати правильну деталізацію для акторів
</p>
</li>
<li>
<p>
Як визначити протоколи як повідомлення
</p>
</li>
<li>
<p>
Типові розмовні стилі
</p>
</li>
</ul></div>
<div class="paragraph"><p>Почнемо з того, що дізнаємось більше про акторів.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="__1__">Частина 1: Архітектура акторів</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="__2">Залежність</h3>
<div class="paragraph"><p>Додайте таку залежність у свій проект:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="n">libraryDependencies</span> <span class="o">+=</span> <span class="s">&quot;com.typesafe.akka&quot;</span> <span class="o">%%</span> <span class="s">&quot;akka-actor-typed&quot;</span> <span class="o">%</span> <span class="s">&quot;2.6.1&quot;</span>
</pre></div></div></div>
</div>
<div class="sect2">
<h3 id="__3">Вступ</h3>
<div class="paragraph"><p>Використання Akka позбавляє вас від створення інфраструктури для системи акторів та від написання коду низького рівня, необхідного для контролю базової поведінки. Щоб оцінити це, давайте подивимося на відносини між акторами, яких ви створюєте у своєму коді, та тими, які Akka створює та керує для вас внутрішньо, життєвим циклом актора та вирішенням несправностей.</p></div>
</div>
<div class="sect2">
<h3 id="___akka">Ієрархія актора Akka</h3>
<div class="paragraph"><p>Актор в Akka завжди належить до батька. Ви створите актора, виклиаючи <code>ActorContext.spawn()</code>. Актор-творець стає батьком новоствореного дитячого актора. Ви можете запитати, хто є батьком першого актора, якого ви створюєте?</p></div>
<div class="paragraph"><p>Як показано нижче, всі актори мають спільного батька, користувацького опікуна, який визначається та створюється під час запуску <code>ActorSystem</code>. Як ми розповідали в Посібнику зі швидкого початку роботи, створення актора повертає посилання, що є валідною URL-адресою. Так, наприклад, якщо ми створимо актора з ім'ям <code>someActor</code> від опікуна користувача за допомогою <code>context.spawn(someBehavior, "someActor")</code>, його посилання буде включати шлях /<code>user/someActor</code>.</p></div>
<div class="imageblock">
<div class="content">
<img src="actor_top_tree.png" alt="actor_top_tree.png" />
</div>
</div>
<div class="paragraph"><p>Насправді, до того, як розпочати ваш перший актор, Акка вже створив двох акторів у системі. Імена цих вбудованих акторів містять позначку "опікун". До акторів-опікунів належать:</p></div>
<div class="ulist"><ul>
<li>
<p>
<code>/</code> так званий кореневий опікун. Це батько всіх акторів в системі, і останній зупиняється, коли сама система припиняється.
</p>
</li>
<li>
<p>
<code>/system</code> системний опікун. Akka або інші бібліотеки, побудовані поверх Akka, можуть створювати акторів у просторі імен <code>system</code>.
</p>
</li>
<li>
<p>
<code>/ user</code> опікун користувача. Це актор вищого рівня, який ви надаєте для запуску всіх інших акторів у вашому застосуванні.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Найпростіший спосіб побачити ієрархію акторів у дії - це надрукувати екземпляри <code>ActorRef</code>. У цьому невеликому експерименті ми створюємо актора, друкуємо його посилання, створюємо дитину цього актора та друкуємо посилання на дитину. Ми починаємо з проекту <code>Hello World</code>, якщо ви ще не завантажили його, завантажте проект Quickstart з <a href="https://developer.lightbend.com/start/?group=akka&amp;project=akka-quickstart-scala&amp;_ga=2.178160684.862459059.1579167332-1972390590.1574487700">Lightbend Tech Hub</a>.</p></div>
<div class="paragraph"><p>In your Hello World project, navigate to the com.lightbend.akka.sample package and create a new Scala file called ActorHierarchyExperiments.scala here. Copy and paste the code from the snippet below to this new source file. Save your file and run sbt "runMain com.lightbend.akka.sample.ActorHierarchyExperiments" to observe the output.
У своєму проекті <code>Hello World</code> перейдіть до пакунку <code>com.lightbend.akka.sample</code> та створіть тут новий файл Scala під назвою <code>ActorHierarchyExperiment.scala</code>. Скопіюйте та вставте код із фрагмента нижче в цей новий вихідний файл. Збережіть файл і запустіть <code>sbt "runMain com.lightbend.akka.sample.ActorHierarchyExperiment"</code>, щоб спостерігати за результатами.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">akka.actor.typed.ActorSystem</span>
<span class="k">import</span> <span class="nn">akka.actor.typed.Behavior</span>
<span class="k">import</span> <span class="nn">akka.actor.typed.scaladsl.AbstractBehavior</span>
<span class="k">import</span> <span class="nn">akka.actor.typed.scaladsl.ActorContext</span>
<span class="k">import</span> <span class="nn">akka.actor.typed.scaladsl.Behaviors</span>

<span class="k">object</span> <span class="nc">PrintMyActorRefActor</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">apply</span><span class="o">()</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">Behaviors</span><span class="o">.</span><span class="n">setup</span><span class="o">(</span><span class="n">context</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">PrintMyActorRefActor</span><span class="o">(</span><span class="n">context</span><span class="o">))</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">PrintMyActorRefActor</span><span class="o">(</span><span class="n">context</span><span class="k">:</span> <span class="kt">ActorContext</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">AbstractBehavior</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="n">context</span><span class="o">)</span> <span class="o">{</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">onMessage</span><span class="o">(</span><span class="n">msg</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span>
    <span class="n">msg</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="s">&quot;printit&quot;</span> <span class="k">=&gt;</span>
        <span class="k">val</span> <span class="n">secondRef</span> <span class="k">=</span> <span class="n">context</span><span class="o">.</span><span class="n">spawn</span><span class="o">(</span><span class="nc">Behaviors</span><span class="o">.</span><span class="n">empty</span><span class="o">[</span><span class="kt">String</span><span class="o">],</span> <span class="s">&quot;second-actor&quot;</span><span class="o">)</span>
        <span class="n">println</span><span class="o">(</span><span class="s">s&quot;Second: </span><span class="si">$secondRef</span><span class="s">&quot;</span><span class="o">)</span>
        <span class="k">this</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">Main</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">apply</span><span class="o">()</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">Behaviors</span><span class="o">.</span><span class="n">setup</span><span class="o">(</span><span class="n">context</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">Main</span><span class="o">(</span><span class="n">context</span><span class="o">))</span>

<span class="o">}</span>

<span class="k">class</span> <span class="nc">Main</span><span class="o">(</span><span class="n">context</span><span class="k">:</span> <span class="kt">ActorContext</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">AbstractBehavior</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="n">context</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">override</span> <span class="k">def</span> <span class="n">onMessage</span><span class="o">(</span><span class="n">msg</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span>
    <span class="n">msg</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="s">&quot;start&quot;</span> <span class="k">=&gt;</span>
        <span class="k">val</span> <span class="n">firstRef</span> <span class="k">=</span> <span class="n">context</span><span class="o">.</span><span class="n">spawn</span><span class="o">(</span><span class="nc">PrintMyActorRefActor</span><span class="o">(),</span> <span class="s">&quot;first-actor&quot;</span><span class="o">)</span>
        <span class="n">println</span><span class="o">(</span><span class="s">s&quot;First: </span><span class="si">$firstRef</span><span class="s">&quot;</span><span class="o">)</span>
        <span class="n">firstRef</span> <span class="o">!</span> <span class="s">&quot;printit&quot;</span>
        <span class="k">this</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">ActorHierarchyExperiments</span> <span class="k">extends</span> <span class="nc">App</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">testSystem</span> <span class="k">=</span> <span class="nc">ActorSystem</span><span class="o">(</span><span class="nc">Main</span><span class="o">(),</span> <span class="s">&quot;testSystem&quot;</span><span class="o">)</span>
  <span class="n">testSystem</span> <span class="o">!</span> <span class="s">&quot;start&quot;</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Зверніть увагу на те, як повідомлення просило першого актора зробити свою роботу. Ми надіслали повідомлення, використовуючи батьківське посилання: <code>firstRef ! "printit"</code>. Коли код виконується, вивід включає посилання на першого актора та дитини, яку він створив як частину завдання друку. Ваш результат повинен виглядати приблизно так:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>First: Actor[akka://testSystem/user/first-actor#1053618476]
Second: Actor[akka://testSystem/user/first-actor/second-actor#-1544706041]</code></pre>
</div></div>
<div class="paragraph"><p>Зверніть увагу на структуру посилань:</p></div>
<div class="ulist"><ul>
<li>
<p>
Обидва шляхи починаються з <code>akka://testSystem/</code>. Оскільки всі посилання актора є дійсними URL-адресами, <code>akka://</code>- це значення поля протоколу.
</p>
</li>
<li>
<p>
Далі, як і у всесвітній павутині, URL ідентифікує систему. У цьому прикладі система називається <code>testSystem</code>, але це може бути будь-яка інша назва. Якщо ввімкнено віддалений зв’язок між декількома системами, ця частина URL-адреси включає ім'я хоста, щоб інші системи могли знайти його в мережі.
</p>
</li>
<li>
<p>
Оскільки посилання другого актора включає шлях <code>/first-actor/</code>, він ідентифікує його як дитину першого.
</p>
</li>
<li>
<p>
Остання частина посилання на актора, <code>#1053618476</code> або <code>#-1544706041</code>, є унікальним ідентифікатором, який ви можете ігнорувати в більшості випадків.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Тепер, коли ви зрозуміли, як виглядає ієрархія акторів, вам може бути цікаво: <em>навіщо нам потрібна ця ієрархія</em>? Для чого вона використовується?</p></div>
<div class="paragraph"><p>Важлива роль ієрархії - безпечне управління життєвими циклами акторів. Давайте розглянемо це далі і подивимось, як ці знання можуть допомогти нам написати кращий код.</p></div>
</div>
<div class="sect2">
<h3 id="____2">Життєвий цикл актора</h3>
<div class="paragraph"><p>Актори набувать життя, коли їх створюють, а потім, за бажанням користувачів, їх зупиняють. Кожного разу, коли актора зупиняють, всі його діти теж припиняються. Така поведінка значно спрощує очищення ресурсів та допомагає уникнути витоків ресурсів, таких як відкриті сокети та файли. Фактично, загально недооціненні труднощі при роботі з низькорівневим багатопотоковим кодом - це управління життєвим циклом різних супутніх ресурсів.</p></div>
<div class="paragraph"><p>Щоб зупинити актора, рекомендований шаблон поведінки - повернути <code>Behaviors.stopped()</code> всередині актора, щоб зупинитись самостійно, як правило у відповідь на певне повідомлення про зупинку, визначене користувачем, або коли актор скінчає свою роботу. Зупинити дочірнього актора технічно можливо, викликавши <code>context.stop(childRef)</code> від батька, але зупинити довільні (не-дочірні) актори таким чином неможливо.</p></div>
<div class="paragraph"><p>API актора Akka пропонує деякі сигнали життєвого циклу, наприклад, <code>PostStop</code> надсилається безпосередньо перед тим, як актор зупиняється. Після цього часу повідомлення не обробляються.</p></div>
<div class="paragraph"><p>Давайте використаємо сигнал життєвого циклу <code>PostStop</code> у простому експерименті, щоб спостерігати за поведінкою, коли ми зупиняємо актора. Спочатку додайте до свого проекту два класи акторів:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">object</span> <span class="nc">StartStopActor1</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">apply</span><span class="o">()</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">Behaviors</span><span class="o">.</span><span class="n">setup</span><span class="o">(</span><span class="n">context</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">StartStopActor1</span><span class="o">(</span><span class="n">context</span><span class="o">))</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">StartStopActor1</span><span class="o">(</span><span class="n">context</span><span class="k">:</span> <span class="kt">ActorContext</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">AbstractBehavior</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="n">context</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">println</span><span class="o">(</span><span class="s">&quot;first started&quot;</span><span class="o">)</span>
  <span class="n">context</span><span class="o">.</span><span class="n">spawn</span><span class="o">(</span><span class="nc">StartStopActor2</span><span class="o">(),</span> <span class="s">&quot;second&quot;</span><span class="o">)</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">onMessage</span><span class="o">(</span><span class="n">msg</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span>
    <span class="n">msg</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="s">&quot;stop&quot;</span> <span class="k">=&gt;</span> <span class="nc">Behaviors</span><span class="o">.</span><span class="n">stopped</span>
    <span class="o">}</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">onSignal</span><span class="k">:</span> <span class="kt">PartialFunction</span><span class="o">[</span><span class="kt">Signal</span>, <span class="kt">Behavior</span><span class="o">[</span><span class="kt">String</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">PostStop</span> <span class="k">=&gt;</span>
      <span class="n">println</span><span class="o">(</span><span class="s">&quot;first stopped&quot;</span><span class="o">)</span>
      <span class="k">this</span>
  <span class="o">}</span>

<span class="o">}</span>

<span class="k">object</span> <span class="nc">StartStopActor2</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">apply</span><span class="o">()</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">Behaviors</span><span class="o">.</span><span class="n">setup</span><span class="o">(</span><span class="k">new</span> <span class="nc">StartStopActor2</span><span class="o">(</span><span class="k">_</span><span class="o">))</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">StartStopActor2</span><span class="o">(</span><span class="n">context</span><span class="k">:</span> <span class="kt">ActorContext</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">AbstractBehavior</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="n">context</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">println</span><span class="o">(</span><span class="s">&quot;second started&quot;</span><span class="o">)</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">onMessage</span><span class="o">(</span><span class="n">msg</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="c1">// цей актор не обробляє повідомлень</span>
    <span class="nc">Behaviors</span><span class="o">.</span><span class="n">unhandled</span>
  <span class="o">}</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">onSignal</span><span class="k">:</span> <span class="kt">PartialFunction</span><span class="o">[</span><span class="kt">Signal</span>, <span class="kt">Behavior</span><span class="o">[</span><span class="kt">String</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">PostStop</span> <span class="k">=&gt;</span>
      <span class="n">println</span><span class="o">(</span><span class="s">&quot;second stopped&quot;</span><span class="o">)</span>
      <span class="k">this</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>І створіть як <code>'main'</code> клас, як вище, щоб запустити акторів, а потім надішліть їм повідомлення <code>"stop"</code>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">first</span> <span class="k">=</span> <span class="n">context</span><span class="o">.</span><span class="n">spawn</span><span class="o">(</span><span class="nc">StartStopActor1</span><span class="o">(),</span> <span class="s">&quot;first&quot;</span><span class="o">)</span>
<span class="n">first</span> <span class="o">!</span> <span class="s">&quot;stop&quot;</span>
</pre></div></div></div>
<div class="paragraph"><p>Ви знову можете використовувати sbt для запуску цієї програми. Вихід повинен виглядати так:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>first started
second started
second stopped
first stopped</code></pre>
</div></div>
<div class="paragraph"><p>Коли ми зупинили актора <code>first</code>, він зупинив свого дитячого актора, <code>second</code>, перш ніж зупинити себе. Цей порядок жорсткий, усі сигнали <code>PostStop</code> дітей обробляються до обробки <code>PostStop</code> батьківського сигналу.</p></div>
</div>
<div class="sect2">
<h3 id="__">Обробка збоїв</h3>
<div class="paragraph"><p>Батьки та діти пов'язані протягом усього життєвого циклу. Кожного разу, коли актор не спрацьовує (закидає виключення або необроблені бульбашки виключень спливають з <code>onMessage</code>), інформація про відмову просувається до стратегії нагляду, яка потім вирішує, як поводитися з виключенням, спричиненим актором. Стратегія нагляду, як правило, визначається батьківським актором, коли той породжує дитячого актора. Таким чином батьки виступають в ролі наглядачів за своїми дітьми. Стратегія нагляду за замовчуванням - зупинити дитину. Якщо ви не визначите стратегію, всі збої призводять до зупинки.</p></div>
<div class="paragraph"><p>Давайте дослідимо стратегії перезавантаження у простому експерименті. Додайте наступні класи до свого проекту, як ви робили з попередніми:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">object</span> <span class="nc">SupervisingActor</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">apply</span><span class="o">()</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">Behaviors</span><span class="o">.</span><span class="n">setup</span><span class="o">(</span><span class="n">context</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">SupervisingActor</span><span class="o">(</span><span class="n">context</span><span class="o">))</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">SupervisingActor</span><span class="o">(</span><span class="n">context</span><span class="k">:</span> <span class="kt">ActorContext</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">AbstractBehavior</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="n">context</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">private</span> <span class="k">val</span> <span class="n">child</span> <span class="k">=</span> <span class="n">context</span><span class="o">.</span><span class="n">spawn</span><span class="o">(</span>
    <span class="nc">Behaviors</span><span class="o">.</span><span class="n">supervise</span><span class="o">(</span><span class="nc">SupervisedActor</span><span class="o">()).</span><span class="n">onFailure</span><span class="o">(</span><span class="nc">SupervisorStrategy</span><span class="o">.</span><span class="n">restart</span><span class="o">),</span>
    <span class="n">name</span> <span class="k">=</span> <span class="s">&quot;supervised-actor&quot;</span><span class="o">)</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">onMessage</span><span class="o">(</span><span class="n">msg</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span>
    <span class="n">msg</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="s">&quot;failChild&quot;</span> <span class="k">=&gt;</span>
        <span class="n">child</span> <span class="o">!</span> <span class="s">&quot;fail&quot;</span>
        <span class="k">this</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">SupervisedActor</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">apply</span><span class="o">()</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">Behaviors</span><span class="o">.</span><span class="n">setup</span><span class="o">(</span><span class="n">context</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">SupervisedActor</span><span class="o">(</span><span class="n">context</span><span class="o">))</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">SupervisedActor</span><span class="o">(</span><span class="n">context</span><span class="k">:</span> <span class="kt">ActorContext</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">AbstractBehavior</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="n">context</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">println</span><span class="o">(</span><span class="s">&quot;supervised actor started&quot;</span><span class="o">)</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">onMessage</span><span class="o">(</span><span class="n">msg</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span>
    <span class="n">msg</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="s">&quot;fail&quot;</span> <span class="k">=&gt;</span>
        <span class="n">println</span><span class="o">(</span><span class="s">&quot;supervised actor fails now&quot;</span><span class="o">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nc">Exception</span><span class="o">(</span><span class="s">&quot;I failed!&quot;</span><span class="o">)</span>
    <span class="o">}</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">onSignal</span><span class="k">:</span> <span class="kt">PartialFunction</span><span class="o">[</span><span class="kt">Signal</span>, <span class="kt">Behavior</span><span class="o">[</span><span class="kt">String</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">PreRestart</span> <span class="k">=&gt;</span>
      <span class="n">println</span><span class="o">(</span><span class="s">&quot;supervised actor will be restarted&quot;</span><span class="o">)</span>
      <span class="k">this</span>
    <span class="k">case</span> <span class="nc">PostStop</span> <span class="k">=&gt;</span>
      <span class="n">println</span><span class="o">(</span><span class="s">&quot;supervised actor stopped&quot;</span><span class="o">)</span>
      <span class="k">this</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>І виконайте:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">supervisingActor</span> <span class="k">=</span> <span class="n">context</span><span class="o">.</span><span class="n">spawn</span><span class="o">(</span><span class="nc">SupervisingActor</span><span class="o">(),</span> <span class="s">&quot;supervising-actor&quot;</span><span class="o">)</span>
<span class="n">supervisingActor</span> <span class="o">!</span> <span class="s">&quot;failChild&quot;</span>
</pre></div></div></div>
<div class="paragraph"><p>Ви повинні побачити вихід подібний до наступного:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>supervised actor started
supervised actor fails now
supervised actor will be restarted
supervised actor started
[ERROR] [11/12/2018 12:03:27.171] [ActorHierarchyExperiments-akka.actor.default-dispatcher-2] [akka://ActorHierarchyExperiments/user/supervising-actor/supervised-actor] Supervisor akka.actor.typed.internal.RestartSupervisor@1c452254 saw failure: I failed!
java.lang.Exception: I failed!
        at typed.tutorial_1.SupervisedActor.onMessage(ActorHierarchyExperiments.scala:113)
        at typed.tutorial_1.SupervisedActor.onMessage(ActorHierarchyExperiments.scala:106)
        at akka.actor.typed.scaladsl.AbstractBehavior.receive(AbstractBehavior.scala:59)
        at akka.actor.typed.Behavior$.interpret(Behavior.scala:395)
        at akka.actor.typed.Behavior$.interpretMessage(Behavior.scala:369)
        at akka.actor.typed.internal.InterceptorImpl$$anon$2.apply(InterceptorImpl.scala:49)
        at akka.actor.typed.internal.SimpleSupervisor.aroundReceive(Supervision.scala:85)
        at akka.actor.typed.internal.InterceptorImpl.receive(InterceptorImpl.scala:70)
        at akka.actor.typed.Behavior$.interpret(Behavior.scala:395)
        at akka.actor.typed.Behavior$.interpretMessage(Behavior.scala:369)</code></pre>
</div></div>
<div class="paragraph"><p>Ми бачимо, що після відмови керований актор зупиняється та негайно перезапускається. Ми також бачимо запис журналу, який повідомляє про виключення, який обробляли, у цьому випадку - наше тестове виключення. У цьому прикладі ми також використовували сигнал <code>PreRestart</code>, який обробляється перед перезапуском.</p></div>
<div class="paragraph"><p>For the impatient, we also recommend looking into the fault tolerance reference page for more in-depth details.
Для нетерплячих ми також радимо заглянути на довідкову сторінку щодо стійкості до відмов для отримання більш поглиблених деталей.</p></div>
</div>
<div class="sect2">
<h3 id="__4">Підсумок</h3>
<div class="paragraph"><p>Ми дізналися про те, як Akka керує акторами в ієрархіях, де батьки контролюють своїх дітей та обробляють виключення. Ми побачили, як створити дуже простого актора та дитину. Далі ми застосуємо ці знання до прикладу використання, моделюючи комунікацію, необхідну для отримання інформації від акторів пристрою. Пізніше ми розберемося з тим, як керувати акторами в групах.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="__2___">Частина 2: Створення першого актора</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="__5">Вступ</h3>
<div class="paragraph"><p>З розумінням ієрархії та поведінки акторів, питання, що залишається, полягає в тому, як поєднати високорівневі компоненти нашої системи IoT з акторами. Опікуном користувача може бути актор, який представляє всю програму. Іншими словами, у нас в системі IoT буде єдиний актор вищого рівня. Компоненти, які створюють пристрої та панелі керування, будуть дітьми цього актора. Це дозволяє нам переробити приклад використання діаграми архітектури випадку на дерево акторів:</p></div>
<div class="imageblock">
<div class="content">
<img src="arch_tree_diagram.png" alt="arch_tree_diagram.png" />
</div>
</div>
<div class="paragraph"><p>Ми можемо визначити першого актора, IotSupervisor, за допомогою кількох рядків коду. Щоб почати свою програму:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Створіть новий вихідний файл <code>IotSupervisor</code> в пакеті <code>com.lightbend.akka.sample</code>.
</p>
</li>
<li>
<p>
Вставте наступний код у новий файл, щоб визначити <code>IotSupervisor</code>.
</p>
</li>
</ol></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">akka.actor.typed.Behavior</span>
<span class="k">import</span> <span class="nn">akka.actor.typed.PostStop</span>
<span class="k">import</span> <span class="nn">akka.actor.typed.Signal</span>
<span class="k">import</span> <span class="nn">akka.actor.typed.scaladsl.AbstractBehavior</span>
<span class="k">import</span> <span class="nn">akka.actor.typed.scaladsl.ActorContext</span>
<span class="k">import</span> <span class="nn">akka.actor.typed.scaladsl.Behaviors</span>

<span class="k">object</span> <span class="nc">IotSupervisor</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">apply</span><span class="o">()</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">Nothing</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">Behaviors</span><span class="o">.</span><span class="n">setup</span><span class="o">[</span><span class="kt">Nothing</span><span class="o">](</span><span class="n">context</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">IotSupervisor</span><span class="o">(</span><span class="n">context</span><span class="o">))</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">IotSupervisor</span><span class="o">(</span><span class="n">context</span><span class="k">:</span> <span class="kt">ActorContext</span><span class="o">[</span><span class="kt">Nothing</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">AbstractBehavior</span><span class="o">[</span><span class="kt">Nothing</span><span class="o">](</span><span class="n">context</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">context</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">&quot;IoT Application started&quot;</span><span class="o">)</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">onMessage</span><span class="o">(</span><span class="n">msg</span><span class="k">:</span> <span class="kt">Nothing</span><span class="o">)</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">Nothing</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="c1">// No need to handle any messages</span>
    <span class="nc">Behaviors</span><span class="o">.</span><span class="n">unhandled</span>
  <span class="o">}</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">onSignal</span><span class="k">:</span> <span class="kt">PartialFunction</span><span class="o">[</span><span class="kt">Signal</span>, <span class="kt">Behavior</span><span class="o">[</span><span class="kt">Nothing</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">PostStop</span> <span class="k">=&gt;</span>
      <span class="n">context</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">&quot;IoT Application stopped&quot;</span><span class="o">)</span>
      <span class="k">this</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Код подібний до прикладів акторів, які ми використовували в попередніх експериментах, але зауважте, що замість <code>printl()</code> ми використовуємо вбудований у програму журнал Akka через <code>context.log</code>.</p></div>
<div class="paragraph"><p>Щоб забезпечити головну точку входу, яка створює систему акторів, додайте наступний код до нового об'єкта <code>IotApp</code>.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">akka.actor.typed.ActorSystem</span>

<span class="k">object</span> <span class="nc">IotApp</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">main</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">Array</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="c1">// Створення ActorSystem та високорівневого наглядача</span>
    <span class="nc">ActorSystem</span><span class="o">[</span><span class="kt">Nothing</span><span class="o">](</span><span class="nc">IotSupervisor</span><span class="o">(),</span> <span class="s">&quot;iot-system&quot;</span><span class="o">)</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Додаток робить мало, крім запису до журналу, коли він запускається. Але у нас перший актор на місці, і ми готові додати інших акторів.</p></div>
</div>
<div class="sect2">
<h3 id="___2">Що далі?</h3>
<div class="paragraph"><p>У наступних розділах ми будемо нарощувати додаток поступово:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Створимо представлення для пристрою.
</p>
</li>
<li>
<p>
Створимо компонент керування пристроєм.
</p>
</li>
<li>
<p>
Додамо можливості запитів до груп пристроїв.
</p>
</li>
</ol></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="__3____">Частина 3: Робота з акторами пристроїв</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="__6">Вступ</h3>
<div class="paragraph"><p>У попередніх темах ми пояснювали, як розглядати акторські системи загалом, тобто як компоненти повинні бути представлені, як актори повинні бути розташовані в ієрархії. У цій частині ми розглянемо акторів у малому, реалізуючи актор прострою.</p></div>
<div class="paragraph"><p>Якби ми працювали з об'єктами, ми зазвичай розробляли API як інтерфейси - набір абстрактних методів, які заповнюються фактичною реалізацією. У світі акторів протоколи займають місце інтерфейсів. Хоча формалізувати загальні протоколи мовою програмування неможливо, ми можемо скласти їхній основний елемент - повідомлення. Отже, ми почнемо з ідентифікації повідомлень, які ми хочемо надіслати акторам пристроїв.</p></div>
<div class="paragraph"><p>Зазвичай повідомлення підпадають під категорії або шаблони. Визначивши ці закономірності, ви побачите, що стає простіше обирати між ними та реалізовувати їх. Перший приклад демонструє схему повідомлення на відповідь на запит.</p></div>
</div>
<div class="sect2">
<h3 id="____">Ідентифікація повідомлень для пристроїв</h3>
<div class="paragraph"><p>Завдання актора пристрою будуть простими:</p></div>
<div class="ulist"><ul>
<li>
<p>
Зберати вимірювання температури
</p>
</li>
<li>
<p>
На запит повідомити про останню вимірювану температуру
</p>
</li>
</ul></div>
<div class="paragraph"><p>Однак пристрій може запуститися без попереднього вимірювання температури. Отже, нам потрібно враховувати випадок, коли немає температури. Це також дозволяє перевірити частину запиту актора без присутності частини запису, оскільки актор пристрою може повідомити про порожній результат.</p></div>
<div class="paragraph"><p>Протокол отримання поточної температури від актора пристрою простий. Актор:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Чекає запиту на поточну температуру.
</p>
</li>
<li>
<p>
Відповідає на запит у відповідь, що:
</p>
<div class="ulist"><ul>
<li>
<p>
містить поточну температуру або,
</p>
</li>
<li>
<p>
вказує, що температура ще недоступна.
</p>
</li>
</ul></div>
</li>
</ol></div>
<div class="paragraph"><p>Нам потрібно два повідомлення, одне для запиту та одне для відповіді. Наша перша спроба може виглядати наступним чином:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">akka.actor.typed.ActorRef</span>

<span class="k">object</span> <span class="nc">Device</span> <span class="o">{</span>
  <span class="k">sealed</span> <span class="k">trait</span> <span class="nc">Command</span>
  <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">ReadTemperature</span><span class="o">(</span><span class="n">replyTo</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">RespondTemperature</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">Command</span>
  <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">RespondTemperature</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">Double</span><span class="o">])</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Зауважте, що повідомлення <code>ReadTemperature</code> містить <code>ActorRef[RespondTemperature]</code>, який використовує актор пристрою, відповідаючи на запит.</p></div>
<div class="paragraph"><p>Ці два повідомлення, схоже, покривають необхідну функціональність. Однак обраний нами підхід повинен враховувати розподілений характер програми. Хоча основний механізм спілкування з актором на локальному JVM є таким самим, як і з віддаленим актором, ми маємо пам’ятати про наступне:</p></div>
<div class="ulist"><ul>
<li>
<p>
Будуть помітні відмінності у затримці доставки між локальними та віддаленими повідомленнями, оскільки такі чинники, як пропускна здатність мережевого зв’язку та розмір повідомлення, також беруть участь.
</p>
</li>
<li>
<p>
Надійність викликає занепокоєння, оскільки віддалене надсилання повідомлень передбачає більше кроків, а це означає, що більше може піти не так.
</p>
</li>
<li>
<p>
Локальне надсилання передасть посилання на повідомлення всередині того ж JVM без будь-яких обмежень на базовий об'єкт, який надсилається, тоді як віддалений транспорт поставить обмеження на розмір повідомлення.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Крім того, хоч надсилання всередині одного і того ж JVM є значно надійнішим, якщо актор не працює через помилку програміста під час обробки повідомлення, ефект такий же, як і якщо не вдається  запит на віддалену мережу через збій віддаленого хоста під час обробки повідомлення. Навіть незважаючи на те, що в обох випадках послуга відновлюється через деякий час (актор перезапускається наглядачем, хост перезапускається оператором або системою моніторингу) під час аварії втрачаються окремі запити. <strong>Тому писати свої актори таким чином, щоб кожне повідомлення могло бути втрачено - це безпечна, песимістична ставка.</strong></p></div>
<div class="paragraph"><p>Але щоб зрозуміти вимоги гнучкості в протоколі треба розглянути питання впорядкування та гарантії доставки повідомлень Akka. Akka забезпечує таку поведінку для надсилання повідомлень:</p></div>
<div class="ulist"><ul>
<li>
<p>
Принаймні одноразова доставка, тобто доставка негарантована.
</p>
</li>
<li>
<p>
Упорядкування повідомлень підтримується для пари відправник-одержувач.
</p>
</li>
</ul></div>
<div class="paragraph"><p>У наступних розділах обговорюється ця поведінка більш докладно:</p></div>
<div class="sect3">
<h4 id="___3">Доставка повідомлень</h4>
<div class="paragraph"><p>Семантика доставки, що надається підсистемами обміну повідомленнями, зазвичай підпадає під такі категорії:</p></div>
<div class="ulist"><ul>
<li>
<p>
Принаймні одноразова доставка - кожне повідомлення доставляється нуль або один раз; в більш зрозумілих виразах це означає, що повідомлення можуть бути втрачені, але ніколи не дублюються.
</p>
</li>
<li>
<p>
Принаймні одноразова доставка - потенційно можна зробити кілька спроб доставити кожне повідомлення, поки щонайменше одна не буде успішною; на більш людяній мові це означає, що повідомлення можуть дублюватися, але ніколи не втрачаються.
</p>
</li>
<li>
<p>
Рівно одноразова доставка - кожне повідомлення доставляється рівно один раз одержувачу; повідомлення не можна ні втрачати, ні дублювати.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Перша поведінка, яку застосовує Акка, є найдешевшою і дає найвищі показники продуктивності. Вона має найменші затрати на реалізацію, оскільки це можна зробити в режимі вистрілити-та-забуття, не утримуючи стан на боці відправлення або в транспортному механізмі. Другий варіант, принаймні-один-раз, вимагає повторних спроб для протидії транспортним втратам. Це додає накладні витрати на утримання стану на боці відправлення та наявність механізму підтвердження на боці прийому. Рівно одноразова доставка є найдорожчою і призводить до найгірших показників: крім накладних витрат, що додаються принаймні-один-раз доставкою, вона вимагає, щоб стан зберігавсяв точці прийому, щоб відфільтрувати повторювані доставки.</p></div>
<div class="paragraph"><p>У системі акторів нам потрібно визначити точний сенс гарантії - в який момент система вважає доставку виконаною:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Коли повідомлення надсилається в мережу?
</p>
</li>
<li>
<p>
Коли повідомлення прийняте на вузлі приймаючого актора?
</p>
</li>
<li>
<p>
Коли повідомлення поміщається в поштову скриньку цільового актора?
</p>
</li>
<li>
<p>
Коли актор-ціль повідомлення починає обробляти повідомлення?
</p>
</li>
<li>
<p>
Коли цільовий актор успішно обробив повідомлення?
</p>
</li>
</ol></div>
<div class="paragraph"><p>Більшість фреймворків та протоколів, які вимагають гарантованої доставки, насправді забезпечують щось подібне до пунктів 4 та 5. Хоча це звучить розумно, <strong>чи це насправді корисно</strong>? Щоб зрозуміти наслідки, розглянемо простий, практичний приклад: користувач намагається зробити замовлення, і ми хочемо лише стверджувати, що воно успішно обробляється після того, як тільки воно насправді знаходиться на диску в базі даних замовлень.</p></div>
<div class="paragraph"><p>Якщо ми розраховуємо на успішну обробку повідомлення, актор повідомить про успіх як тільки замовлення буде надіслане до внутрішнього API, який несе відповідальність за його підтвердження, обробку та занесення до бази даних. На жаль, одразу після виклику API може статися будь-яке з наступного:</p></div>
<div class="ulist"><ul>
<li>
<p>
Хост може вийти з ладу.
</p>
</li>
<li>
<p>
Десеріалізація може схибити.
</p>
</li>
<li>
<p>
Перевірка може не вдатися.
</p>
</li>
<li>
<p>
База даних може бути недоступною.
</p>
</li>
<li>
<p>
Може виникнути програмна помилка.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Це ілюструє, що <strong>гарантія доставки</strong> не перетворюється на <strong>гарантії рівня домену</strong>. Ми хочемо повідомити про успіх лише після того, як замовлення було фактично повністю оброблене та збережено. <strong>Єдиною сутністю, яка може повідомити про успіх, є сама програма, оскільки лише вона має будь-яке розуміння необхідних гарантій домену. Жодна узагальнена структура не може з'ясувати специфіку конкретного домену та те, що вважається успіхом у цій галузі.</strong></p></div>
<div class="paragraph"><p>У цьому конкретному прикладі ми хочемо повідомити про успіх лише після успішного запису в базу даних, де база даних визнала, що замовлення тепер безпечно зберігається. <strong>З цих причин Akka підносить відповідальність із гарантіями на саму програму. Тобто вам доведеться їх реалізовувати самостійно за допомогою інструментів, які надає Akka. Це дає вам повний контроль над гарантіями, які ви хочете надати.</strong> Тепер давайте розглянемо впорядкування повідомлень, який надає Akka, щоб легко розуміти логіку програми.</p></div>
</div>
<div class="sect3">
<h4 id="___4">Впорядкування повідомлень</h4>
<div class="paragraph"><p>In Akka, for a given pair of actors, messages sent directly from the first to the second will not be received out-of-order. The word directly emphasizes that this guarantee only applies when sending with the tell operator directly to the final destination, but not when employing mediators.
У Akka для певної пари акторів повідомлення, що надсилаються безпосередньо від першого до другого, не надходитимуть не-по-порядку. Слово <em>безпосередньо</em> підкреслює, що ця гарантія застосовується лише при надсиланні з оператором розвідки безпосередньо до кінцевого пункту призначення, але не під час використання посередників.</p></div>
<div class="paragraph"><p>Якщо:</p></div>
<div class="ulist"><ul>
<li>
<p>
Актор A1 надсилає повідомлення M1, M2, M3 до A2.
</p>
</li>
<li>
<p>
Актор A3 надсилає повідомлення M4, M5, M6 до A2.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Це означає, що для повідомлень Akka:</p></div>
<div class="ulist"><ul>
<li>
<p>
Якщо M1 доставлене, воно повинно бути доставлене до M2 та M3.
</p>
</li>
<li>
<p>
Якщо M2 доставлене, воно повинно бути доставлене до M3.
</p>
</li>
<li>
<p>
Якщо M4 доставлене, воно повинно бути доставлене до M5 та M6.
</p>
</li>
<li>
<p>
Якщо M5 доставлене, воно повинно бути доставлене до M6.
</p>
</li>
<li>
<p>
A2 може бачити повідомлення від A1 переміжені з повідомленнями від A3.
</p>
</li>
<li>
<p>
Оскільки немає гарантованої доставки, будь-яке повідомлення може бути відхилене, тобто не надходити на A2.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Ці гарантії забезпечують хороший баланс: коли повідомлення від одного актора приходить впорядковано,є зручним для побудови систем, про які можна легко розмірковувати. З іншого боку, здатність повідомленням різних акторів надходити по черзі, забезпечує достатню свободу для ефективної реалізації системи акторів.</p></div>
<div class="paragraph"><p>Детальну інформацію про гарантії доставки дивиться на <a href="https://doc.akka.io/docs/akka/current/general/message-delivery-reliability.html">довідковій сторінці</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_____">Додавання гнучкості до повідомлень пристрою</h3>
<div class="paragraph"><p>Наш перший протокол запитів був коректним, але він не враховував розподілене виконання програми. Якщо ми хочемо реалізувати повтори в акторі, який запитує актор пристрою (через таймаути запитів), або якщо ми хочемо опитувати декілька акторів, нам потрібно мати можливість співвіднести запити та відповіді. Отже, ми додаємо ще одне поле до своїх повідомлень, щоб можна було впровадити <code>ID</code> для запитів (ми додамо цей код до нашої програми на наступному кроці):</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">sealed</span> <span class="k">trait</span> <span class="nc">Command</span>
<span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">ReadTemperature</span><span class="o">(</span><span class="n">requestId</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span> <span class="n">replyTo</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">RespondTemperature</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">Command</span>
<span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">RespondTemperature</span><span class="o">(</span><span class="n">requestId</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span> <span class="n">value</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">Double</span><span class="o">])</span>
</pre></div></div></div>
</div>
<div class="sect2">
<h3 id="________2">Реалізація актора пристрою та його протокол зчитування</h3>
<div class="paragraph"><p>Як ми дізналися на прикладі Hello World, кожен актор визначає тип повідомлень, які він буде приймати. Наш актор пристрою несе відповідальність за те, що він використовує той самий параметр ідентифікатора для відповіді на даний запит, що могло би виглядати так.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">akka.actor.typed.Behavior</span>
<span class="k">import</span> <span class="nn">akka.actor.typed.scaladsl.AbstractBehavior</span>
<span class="k">import</span> <span class="nn">akka.actor.typed.scaladsl.ActorContext</span>
<span class="k">import</span> <span class="nn">akka.actor.typed.scaladsl.Behaviors</span>

<span class="k">object</span> <span class="nc">Device</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">groupId</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">deviceId</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">Command</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">Behaviors</span><span class="o">.</span><span class="n">setup</span><span class="o">(</span><span class="n">context</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">Device</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">groupId</span><span class="o">,</span> <span class="n">deviceId</span><span class="o">))</span>

  <span class="k">sealed</span> <span class="k">trait</span> <span class="nc">Command</span>
  <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">ReadTemperature</span><span class="o">(</span><span class="n">requestId</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span> <span class="n">replyTo</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">RespondTemperature</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">Command</span>
  <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">RespondTemperature</span><span class="o">(</span><span class="n">requestId</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span> <span class="n">value</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">Double</span><span class="o">])</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">Device</span><span class="o">(</span><span class="n">context</span><span class="k">:</span> <span class="kt">ActorContext</span><span class="o">[</span><span class="kt">Device.Command</span><span class="o">],</span> <span class="n">groupId</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">deviceId</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
    <span class="k">extends</span> <span class="nc">AbstractBehavior</span><span class="o">[</span><span class="kt">Device.Command</span><span class="o">](</span><span class="n">context</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">import</span> <span class="nn">Device._</span>

  <span class="k">var</span> <span class="n">lastTemperatureReading</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">Double</span><span class="o">]</span> <span class="k">=</span> <span class="nc">None</span>

  <span class="n">context</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info2</span><span class="o">(</span><span class="s">&quot;Device actor {}-{} started&quot;</span><span class="o">,</span> <span class="n">groupId</span><span class="o">,</span> <span class="n">deviceId</span><span class="o">)</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">onMessage</span><span class="o">(</span><span class="n">msg</span><span class="k">:</span> <span class="kt">Command</span><span class="o">)</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">Command</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="n">msg</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">ReadTemperature</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">replyTo</span><span class="o">)</span> <span class="k">=&gt;</span>
        <span class="n">replyTo</span> <span class="o">!</span> <span class="nc">RespondTemperature</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">lastTemperatureReading</span><span class="o">)</span>
        <span class="k">this</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">onSignal</span><span class="k">:</span> <span class="kt">PartialFunction</span><span class="o">[</span><span class="kt">Signal</span>, <span class="kt">Behavior</span><span class="o">[</span><span class="kt">Command</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">PostStop</span> <span class="k">=&gt;</span>
      <span class="n">context</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info2</span><span class="o">(</span><span class="s">&quot;Device actor {}-{} stopped&quot;</span><span class="o">,</span> <span class="n">groupId</span><span class="o">,</span> <span class="n">deviceId</span><span class="o">)</span>
      <span class="k">this</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>В коді зауважте, що:</p></div>
<div class="ulist"><ul>
<li>
<p>
Метод <code>apply</code> в супутньому об'єкті визначає, як побудувати <code>Behavior</code> для актора <code>Device</code>. Параметри включають ідентифікатор пристрою та групу, до якої він належить, яку ми будемо використовувати згодом.
</p>
</li>
<li>
<p>
Повідомлення, про які ми казали раніше, визначені в супутнім об’єкті.
</p>
</li>
<li>
<p>
У класі <code>Device</code> значення <code>lastTemperatureReading</code> спочатку встановлюється в значення <code>None</code>, і актор повідомляє про це за запитом.
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="___5">Тестування актора</h3>
<div class="paragraph"><p>Виходячи з актора вище, ми могли б написати тест. У пакеті <code>com.lightbend.akka.sample</code> у тестовому дереві проекту додайте наступний код у файл <code>DeviceSpec.scala</code>. (Ми використовуємо ScalaTest, але будь-який інший тестовий фреймворк може бути використаний разом із тестовою програмою Akka Testkit).</p></div>
<div class="paragraph"><p>Ви можете запустити цей тест, запустивши тест у рядку <code>sbt</code>.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">akka.actor.testkit.typed.scaladsl.ScalaTestWithActorTestKit</span>
<span class="k">import</span> <span class="nn">org.scalatest.WordSpecLike</span>

<span class="k">class</span> <span class="nc">DeviceSpec</span> <span class="k">extends</span> <span class="nc">ScalaTestWithActorTestKit</span> <span class="k">with</span> <span class="nc">WordSpecLike</span> <span class="o">{</span>
  <span class="k">import</span> <span class="nn">Device._</span>

  <span class="s">&quot;Device actor&quot;</span> <span class="n">must</span> <span class="o">{</span>

    <span class="s">&quot;reply with empty reading if no temperature is known&quot;</span> <span class="n">in</span> <span class="o">{</span>
      <span class="k">val</span> <span class="n">probe</span> <span class="k">=</span> <span class="n">createTestProbe</span><span class="o">[</span><span class="kt">RespondTemperature</span><span class="o">]()</span>
      <span class="k">val</span> <span class="n">deviceActor</span> <span class="k">=</span> <span class="n">spawn</span><span class="o">(</span><span class="nc">Device</span><span class="o">(</span><span class="s">&quot;group&quot;</span><span class="o">,</span> <span class="s">&quot;device&quot;</span><span class="o">))</span>

      <span class="n">deviceActor</span> <span class="o">!</span> <span class="nc">Device</span><span class="o">.</span><span class="nc">ReadTemperature</span><span class="o">(</span><span class="n">requestId</span> <span class="k">=</span> <span class="mi">42</span><span class="o">,</span> <span class="n">probe</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span>
      <span class="k">val</span> <span class="n">response</span> <span class="k">=</span> <span class="n">probe</span><span class="o">.</span><span class="n">receiveMessage</span><span class="o">()</span>
      <span class="n">response</span><span class="o">.</span><span class="n">requestId</span> <span class="n">should</span> <span class="o">===(</span><span class="mi">42</span><span class="o">)</span>
      <span class="n">response</span><span class="o">.</span><span class="n">value</span> <span class="n">should</span> <span class="o">===(</span><span class="nc">None</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Тепер актору потрібен спосіб зміни стану температури, коли він отримує повідомлення від датчика.</p></div>
</div>
<div class="sect2">
<h3 id="____3">Додавання протоколу запису</h3>
<div class="paragraph"><p>Мета протоколу запису - оновити поточне поле температури, коли актор отримує повідомлення, що містить температуру. Знову ж, заманливо визначити протокол запису як дуже просте повідомлення, приблизно так:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">sealed</span> <span class="k">trait</span> <span class="nc">Command</span>
<span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">RecordTemperature</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">Double</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Command</span>
</pre></div></div></div>
<div class="paragraph"><p>Однак такий підхід не враховує, що відправник повідомлення про температуру запису ніколи не може бути впевнений, оброблено повідомлення чи ні. Ми бачили, що Akka не гарантує доставку цих повідомлень і залишає це додатку для надання сповіщень про успіх. У нашому випадку ми хотіли б надіслати підтвердження до відправника після того, як ми оновимо останній запис температури. Наприклад, відповісти повідомленням <code>TemperatureRecorded</code>. Як і у випадку температурних запитів та відповідей, також є хорошою ідеєю включити поле для ідентифікації, щоб забезпечити максимальну гнучкість.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">RecordTemperature</span><span class="o">(</span><span class="n">requestId</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span> <span class="n">value</span><span class="k">:</span> <span class="kt">Double</span><span class="o">,</span> <span class="n">replyTo</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">TemperatureRecorded</span><span class="o">])</span>
    <span class="k">extends</span> <span class="nc">Command</span>
<span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">TemperatureRecorded</span><span class="o">(</span><span class="n">requestId</span><span class="k">:</span> <span class="kt">Long</span><span class="o">)</span>
</pre></div></div></div>
</div>
<div class="sect2">
<h3 id="______">Актор з читанням і записом повідомлень</h3>
<div class="paragraph"><p>Збираючи протокол читання і запису разом, актор пристрою виглядає як такий приклад:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">akka.actor.typed.ActorRef</span>
<span class="k">import</span> <span class="nn">akka.actor.typed.Behavior</span>
<span class="k">import</span> <span class="nn">akka.actor.typed.PostStop</span>
<span class="k">import</span> <span class="nn">akka.actor.typed.Signal</span>
<span class="k">import</span> <span class="nn">akka.actor.typed.scaladsl.AbstractBehavior</span>
<span class="k">import</span> <span class="nn">akka.actor.typed.scaladsl.ActorContext</span>
<span class="k">import</span> <span class="nn">akka.actor.typed.scaladsl.Behaviors</span>
<span class="k">import</span> <span class="nn">akka.actor.typed.scaladsl.LoggerOps</span>

<span class="k">object</span> <span class="nc">Device</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">groupId</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">deviceId</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">Command</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">Behaviors</span><span class="o">.</span><span class="n">setup</span><span class="o">(</span><span class="n">context</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">Device</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">groupId</span><span class="o">,</span> <span class="n">deviceId</span><span class="o">))</span>

  <span class="k">sealed</span> <span class="k">trait</span> <span class="nc">Command</span>

  <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">ReadTemperature</span><span class="o">(</span><span class="n">requestId</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span> <span class="n">replyTo</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">RespondTemperature</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">Command</span>
  <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">RespondTemperature</span><span class="o">(</span><span class="n">requestId</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span> <span class="n">value</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">Double</span><span class="o">])</span>

  <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">RecordTemperature</span><span class="o">(</span><span class="n">requestId</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span> <span class="n">value</span><span class="k">:</span> <span class="kt">Double</span><span class="o">,</span> <span class="n">replyTo</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">TemperatureRecorded</span><span class="o">])</span>
      <span class="k">extends</span> <span class="nc">Command</span>
  <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">TemperatureRecorded</span><span class="o">(</span><span class="n">requestId</span><span class="k">:</span> <span class="kt">Long</span><span class="o">)</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">Device</span><span class="o">(</span><span class="n">context</span><span class="k">:</span> <span class="kt">ActorContext</span><span class="o">[</span><span class="kt">Device.Command</span><span class="o">],</span> <span class="n">groupId</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">deviceId</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
    <span class="k">extends</span> <span class="nc">AbstractBehavior</span><span class="o">[</span><span class="kt">Device.Command</span><span class="o">](</span><span class="n">context</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">import</span> <span class="nn">Device._</span>

  <span class="k">var</span> <span class="n">lastTemperatureReading</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">Double</span><span class="o">]</span> <span class="k">=</span> <span class="nc">None</span>

  <span class="n">context</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info2</span><span class="o">(</span><span class="s">&quot;Device actor {}-{} started&quot;</span><span class="o">,</span> <span class="n">groupId</span><span class="o">,</span> <span class="n">deviceId</span><span class="o">)</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">onMessage</span><span class="o">(</span><span class="n">msg</span><span class="k">:</span> <span class="kt">Command</span><span class="o">)</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">Command</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="n">msg</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">RecordTemperature</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="n">replyTo</span><span class="o">)</span> <span class="k">=&gt;</span>
        <span class="n">context</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info2</span><span class="o">(</span><span class="s">&quot;Recorded temperature reading {} with {}&quot;</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="n">id</span><span class="o">)</span>
        <span class="n">lastTemperatureReading</span> <span class="k">=</span> <span class="nc">Some</span><span class="o">(</span><span class="n">value</span><span class="o">)</span>
        <span class="n">replyTo</span> <span class="o">!</span> <span class="nc">TemperatureRecorded</span><span class="o">(</span><span class="n">id</span><span class="o">)</span>
        <span class="k">this</span>

      <span class="k">case</span> <span class="nc">ReadTemperature</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">replyTo</span><span class="o">)</span> <span class="k">=&gt;</span>
        <span class="n">replyTo</span> <span class="o">!</span> <span class="nc">RespondTemperature</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">lastTemperatureReading</span><span class="o">)</span>
        <span class="k">this</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">onSignal</span><span class="k">:</span> <span class="kt">PartialFunction</span><span class="o">[</span><span class="kt">Signal</span>, <span class="kt">Behavior</span><span class="o">[</span><span class="kt">Command</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">PostStop</span> <span class="k">=&gt;</span>
      <span class="n">context</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info2</span><span class="o">(</span><span class="s">&quot;Device actor {}-{} stopped&quot;</span><span class="o">,</span> <span class="n">groupId</span><span class="o">,</span> <span class="n">deviceId</span><span class="o">)</span>
      <span class="k">this</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>We should also write a new test case now, exercising both the read/query and write/record functionality together:
Ми також повинні написати новий тестовий випадок, здійснюючи разом функцію читання/запиту та запису:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="s">&quot;reply with latest temperature reading&quot;</span> <span class="n">in</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">recordProbe</span> <span class="k">=</span> <span class="n">createTestProbe</span><span class="o">[</span><span class="kt">TemperatureRecorded</span><span class="o">]()</span>
  <span class="k">val</span> <span class="n">readProbe</span> <span class="k">=</span> <span class="n">createTestProbe</span><span class="o">[</span><span class="kt">RespondTemperature</span><span class="o">]()</span>
  <span class="k">val</span> <span class="n">deviceActor</span> <span class="k">=</span> <span class="n">spawn</span><span class="o">(</span><span class="nc">Device</span><span class="o">(</span><span class="s">&quot;group&quot;</span><span class="o">,</span> <span class="s">&quot;device&quot;</span><span class="o">))</span>

  <span class="n">deviceActor</span> <span class="o">!</span> <span class="nc">Device</span><span class="o">.</span><span class="nc">RecordTemperature</span><span class="o">(</span><span class="n">requestId</span> <span class="k">=</span> <span class="mi">1</span><span class="o">,</span> <span class="mf">24.0</span><span class="o">,</span> <span class="n">recordProbe</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span>
  <span class="n">recordProbe</span><span class="o">.</span><span class="n">expectMessage</span><span class="o">(</span><span class="nc">Device</span><span class="o">.</span><span class="nc">TemperatureRecorded</span><span class="o">(</span><span class="n">requestId</span> <span class="k">=</span> <span class="mi">1</span><span class="o">))</span>

  <span class="n">deviceActor</span> <span class="o">!</span> <span class="nc">Device</span><span class="o">.</span><span class="nc">ReadTemperature</span><span class="o">(</span><span class="n">requestId</span> <span class="k">=</span> <span class="mi">2</span><span class="o">,</span> <span class="n">readProbe</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">response1</span> <span class="k">=</span> <span class="n">readProbe</span><span class="o">.</span><span class="n">receiveMessage</span><span class="o">()</span>
  <span class="n">response1</span><span class="o">.</span><span class="n">requestId</span> <span class="n">should</span> <span class="o">===(</span><span class="mi">2</span><span class="o">)</span>
  <span class="n">response1</span><span class="o">.</span><span class="n">value</span> <span class="n">should</span> <span class="o">===(</span><span class="nc">Some</span><span class="o">(</span><span class="mf">24.0</span><span class="o">))</span>

  <span class="n">deviceActor</span> <span class="o">!</span> <span class="nc">Device</span><span class="o">.</span><span class="nc">RecordTemperature</span><span class="o">(</span><span class="n">requestId</span> <span class="k">=</span> <span class="mi">3</span><span class="o">,</span> <span class="mf">55.0</span><span class="o">,</span> <span class="n">recordProbe</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span>
  <span class="n">recordProbe</span><span class="o">.</span><span class="n">expectMessage</span><span class="o">(</span><span class="nc">Device</span><span class="o">.</span><span class="nc">TemperatureRecorded</span><span class="o">(</span><span class="n">requestId</span> <span class="k">=</span> <span class="mi">3</span><span class="o">))</span>

  <span class="n">deviceActor</span> <span class="o">!</span> <span class="nc">Device</span><span class="o">.</span><span class="nc">ReadTemperature</span><span class="o">(</span><span class="n">requestId</span> <span class="k">=</span> <span class="mi">4</span><span class="o">,</span> <span class="n">readProbe</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">response2</span> <span class="k">=</span> <span class="n">readProbe</span><span class="o">.</span><span class="n">receiveMessage</span><span class="o">()</span>
  <span class="n">response2</span><span class="o">.</span><span class="n">requestId</span> <span class="n">should</span> <span class="o">===(</span><span class="mi">4</span><span class="o">)</span>
  <span class="n">response2</span><span class="o">.</span><span class="n">value</span> <span class="n">should</span> <span class="o">===(</span><span class="nc">Some</span><span class="o">(</span><span class="mf">55.0</span><span class="o">))</span>
<span class="o">}</span>
</pre></div></div></div>
</div>
<div class="sect2">
<h3 id="___6">Що далі?</h3>
<div class="paragraph"><p>Поки ми почали проектувати нашу загальну архітектуру, і ми написали першого актора, який безпосередньо відповідає домену. Тепер ми повинні створити компонент, який відповідає за підтримку груп пристроїв та самих акторів пристроїв.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="__4____">Частина 4: Робота з групами пристроїв</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="__7">Вступ</h3>
<div class="paragraph"><p>Розглянемо детальніше основну функціональність, необхідну для нашого випадку використання. У повній системі IoT для моніторингу домашньої температури кроки для підключення датчика пристрою до нашої системи можуть виглядати так:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Сенсорний пристрій вдома підключається через деякий протокол.
</p>
</li>
<li>
<p>
Компонент, що управляє мережевими з'єднаннями, приймає з'єднання.
</p>
</li>
<li>
<p>
Датчик надає свою групу та ідентифікатор пристрою для реєстрації в компоненті диспетчера пристроїв нашої системи.
</p>
</li>
<li>
<p>
Компонент диспетчера пристроїв обробляє реєстрацію шляхом пошуку або створення актора, відповідального за збереження стану датчика.
</p>
</li>
<li>
<p>
Актор відповідає підтвердженням, виставляючи свого <code>ActorRef</code>.
</p>
</li>
<li>
<p>
Мережевий компонент тепер використовує <code>ActorRef</code> для зв'язку між датчиком і актором пристрою, не проходячи через диспетчер пристроїв.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Кроки 1 і 2 проходять поза межами нашої підручникової системи. У цьому розділі ми розпочнемо розгляд кроків 3-6 та створимо спосіб сенсорам зареєструватися в нашій системі та спілкуватися з акторами. Але спочатку у нас є ще одне архітектурне рішення - скільки рівнів акторів ми повинні використовувати для представлення груп пристроїв та датчиків пристроїв?</p></div>
<div class="paragraph"><p>Одним з головних викликів розробки для програмістів Akka є вибір найкращої деталізації для акторів. На практиці, залежно від особливостей взаємодій між суб'єктами, зазвичай існує кілька гідних способів організації системи. У нашому випадку, наприклад, можна було б мати одного актора, який підтримує всі групи та пристрої - можливо, використовуючи хеш-мапи. Також було б розумно мати актора для кожної групи, який відстежує стан усіх пристроїв в одному будинку.</p></div>
<div class="paragraph"><p>Наступні вказівки допомагають нам вибрати найбільш відповідну ієрархію акторів:</p></div>
<div class="ulist"><ul>
<li>
<p>
Взагалі віддайте перевагу більшій зернистості. Введення більш спеціалізованих акторів, ніж потрібно, викликає більше проблем, ніж вирішує.
</p>
</li>
<li>
<p>
Додайте більш дрібну деталізацію, коли система вимагає:
</p>
<div class="ulist"><ul>
<li>
<p>
Вищої конкурентності.
</p>
</li>
<li>
<p>
Складних перемовин розмови між акторами, які мають багато станів. Ми побачимо дуже хороший приклад для цього в наступному розділі.
</p>
</li>
<li>
<p>
Достатній стан, який має сенс розділити на менших акторів.
</p>
</li>
<li>
<p>
Кілька незв'язаних відповідальностей. Використання окремих акторів дозволяє окремим зазнавати невдачі і відновлюватися з невеликим впливом на інших.
</p>
</li>
</ul></div>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="____4">Ієрархія диспетчера пристроїв</h3>
<div class="paragraph"><p>Розглядаючи принципи, викладені в попередньому розділі, ми будемо моделювати компонент диспетчера пристроїв як дерево акторів з трьома рівнями:</p></div>
<div class="ulist"><ul>
<li>
<p>
Актор наглядача верхнього рівня представляє системний компонент для пристроїв. Це також точка входу для пошуку та створення групи пристроїв та акторів пристроїв.
</p>
</li>
<li>
<p>
На наступному рівні кожен актор групи контролює акторів пристрою для одного ідентифікатора групи (наприклад, одного будинку). Вони також надають послуги, такі як запит показань температури з усіх доступних пристроїв у їх групі.
</p>
</li>
<li>
<p>
Актори пристрою керують усіма взаємодіями з фактичними датчиками пристрою, такими як читання показань температури.
</p>
</li>
</ul></div>
<div class="imageblock">
<div class="content">
<img src="device_manager_tree.png" alt="device_manager_tree.png" />
</div>
</div>
<div class="paragraph"><p>Ми вибрали цю тришарову архітектуру з таких причин:</p></div>
<div class="ulist"><ul>
<li>
<p>
Маючи групи окремих акторів:
</p>
<div class="ulist"><ul>
<li>
<p>
Ізолює збої, які трапляються в групі. Якщо б один актор керував усіма групами пристроїв, помилка в одній групі, яка викликає перезавантаження, знищить стан груп, які в іншому випадку могли б працювати.
</p>
</li>
<li>
<p>
Спрощує проблему опиту всіх пристроїв, що належать до групи. Кожен актор групи містить лише стан, пов'язаний зі своєю групою.
</p>
</li>
<li>
<p>
Збільшує паралелізм у системі. Оскільки в кожній групі є виділений актор, вони працюють одночасно, і ми можемо одночасно запитувати кілька груп.
</p>
</li>
</ul></div>
</li>
<li>
<p>
Датчики змодельовані як окремі актори пристрою:
</p>
<div class="ulist"><ul>
<li>
<p>
Виділяє відмови одного актора пристрою від решти пристроїв у групі.
</p>
</li>
<li>
<p>
Підвищує паралельність збору температурних показань. Мережеві з'єднання різних датчиків безпосередньо спілкуються зі своїми окремими акторами пристроїв, зменшуючи суперечки.
</p>
</li>
</ul></div>
</li>
</ul></div>
<div class="paragraph"><p>Визначивши архітектуру, ми можемо розпочати роботу над протоколом реєстрації датчиків.</p></div>
</div>
<div class="sect2">
<h3 id="___7">Протокол реєстрації</h3>
<div class="paragraph"><p>В якості першого кроку нам потрібно розробити протокол як для реєстрації пристрою, так і для створення групи та акторів пристроїв, які будуть відповідати за нього. Цей протокол надаватиметься самим компонентом <code>DeviceManager</code>, оскільки це єдиний відомий та наперед доступний актор: групи пристроїв та учасники пристроїв створюються на вимогу.</p></div>
<div class="paragraph"><p>Розглядаючи реєстрацію більш детально, ми можемо окреслити необхідну функціональність:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Коли <code>DeviceManager</code> отримує запит із групою та ідентифікатором пристрою:
</p>
<div class="ulist"><ul>
<li>
<p>
Якщо у менеджера вже є актор для групи пристроїв, він пересилає йому запит.
</p>
</li>
<li>
<p>
В іншому випадку він створює новий актор групи пристроїв, а потім пересилає запит.
</p>
</li>
</ul></div>
</li>
<li>
<p>
Актор <code>DeviceGroup</code> отримує запит на реєстрацію актора для даного пристрою:
</p>
<div class="ulist"><ul>
<li>
<p>
Якщо в групі вже є актор для пристрою, він відповідає <code>ActorRef</code> існуючого актора пристрою.
</p>
</li>
<li>
<p>
В іншому випадку актор DeviceGroup спочатку створює актор пристрою і відповідає з ActorRef новоствореного актора пристрою.
</p>
</li>
</ul></div>
</li>
<li>
<p>
Датчик тепер матиме <code>ActorRef</code> актора пристрою для передачі повідомлень безпосередньо йому.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Повідомлення, які ми використовуватимемо для передачі запитів на реєстрацію та їх підтвердження, мають таке визначення:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">RequestTrackDevice</span><span class="o">(</span><span class="n">groupId</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">deviceId</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">replyTo</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">DeviceRegistered</span><span class="o">])</span>
    <span class="k">extends</span> <span class="nc">DeviceManager</span><span class="o">.</span><span class="nc">Command</span>
    <span class="k">with</span> <span class="nc">DeviceGroup</span><span class="o">.</span><span class="nc">Command</span>

<span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">DeviceRegistered</span><span class="o">(</span><span class="n">device</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">Device.Command</span><span class="o">])</span>
</pre></div></div></div>
<div class="paragraph"><p>У цьому випадку ми не включили поле <code>ID</code> запиту до повідомлень. Оскільки реєстрація відбувається один раз, коли компонент підключає систему до якогось мережевого протоколу, ідентифікатор не важливий. Однак, як правило, найкраща практика включати ідентифікатор запиту.</p></div>
<div class="paragraph"><p>Тепер ми почнемо реалізовувати протокол знизу вгору. На практиці може працювати як підхід зверху вниз, так і знизу вгору. Але в нашому випадку ми виграємо від підходу знизу вгору, оскільки він дозволяє нам негайно писати тести на нові функції, не мудруючи над частинами, які нам знадобляться будувати пізніше.</p></div>
</div>
<div class="sect2">
<h3 id="________3">Додавання підтримки реєстрації для учасників групи пристроїв</h3>
<div class="paragraph"><p>Актор групи має певну роботу, коли йдеться про реєстрацію, зокрема:</p></div>
<div class="ulist"><ul>
<li>
<p>
Обробка запиту на реєстрацію для існуючого актора пристрою або створення нового актора.
</p>
</li>
<li>
<p>
Відстеження, які учасники пристроїв існують у групі, та видалення їх із групи, коли вони зупиняються.
</p>
</li>
</ul></div>
<div class="sect3">
<h4 id="_____2">Обробка запиту на реєстрацію</h4>
<div class="paragraph"><p>Актор групи пристроїв повинен або відповісти на запит <code>ActorRef</code> існуючої дитини, або він повинен створити його. Щоб шукати дітей-акторів за їх ідентифікаторами пристроїв, ми використаємо їх ID пристрою.</p></div>
<div class="paragraph"><p>Додайте до вихідного файлу:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">object</span> <span class="nc">DeviceGroup</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">groupId</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">Command</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">Behaviors</span><span class="o">.</span><span class="n">setup</span><span class="o">(</span><span class="n">context</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">DeviceGroup</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">groupId</span><span class="o">))</span>

  <span class="k">trait</span> <span class="nc">Command</span>

  <span class="k">private</span> <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">DeviceTerminated</span><span class="o">(</span><span class="n">device</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">Device.Command</span><span class="o">],</span> <span class="n">groupId</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">deviceId</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
      <span class="k">extends</span> <span class="nc">Command</span>

<span class="o">}</span>

<span class="k">class</span> <span class="nc">DeviceGroup</span><span class="o">(</span><span class="n">context</span><span class="k">:</span> <span class="kt">ActorContext</span><span class="o">[</span><span class="kt">DeviceGroup.Command</span><span class="o">],</span> <span class="n">groupId</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
    <span class="k">extends</span> <span class="nc">AbstractBehavior</span><span class="o">[</span><span class="kt">DeviceGroup.Command</span><span class="o">](</span><span class="n">context</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">import</span> <span class="nn">DeviceGroup._</span>
  <span class="k">import</span> <span class="nn">DeviceManager.</span><span class="o">{</span> <span class="nc">DeviceRegistered</span><span class="o">,</span> <span class="nc">ReplyDeviceList</span><span class="o">,</span> <span class="nc">RequestDeviceList</span><span class="o">,</span> <span class="nc">RequestTrackDevice</span> <span class="o">}</span>

  <span class="k">private</span> <span class="k">var</span> <span class="n">deviceIdToActor</span> <span class="k">=</span> <span class="nc">Map</span><span class="o">.</span><span class="n">empty</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">Device.Command</span><span class="o">]]</span>

  <span class="n">context</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">&quot;DeviceGroup {} started&quot;</span><span class="o">,</span> <span class="n">groupId</span><span class="o">)</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">onMessage</span><span class="o">(</span><span class="n">msg</span><span class="k">:</span> <span class="kt">Command</span><span class="o">)</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">Command</span><span class="o">]</span> <span class="k">=</span>
    <span class="n">msg</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="n">trackMsg</span> <span class="k">@</span> <span class="nc">RequestTrackDevice</span><span class="o">(</span><span class="n">`groupId`</span><span class="o">,</span> <span class="n">deviceId</span><span class="o">,</span> <span class="n">replyTo</span><span class="o">)</span> <span class="k">=&gt;</span>
        <span class="n">deviceIdToActor</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">deviceId</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
          <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">deviceActor</span><span class="o">)</span> <span class="k">=&gt;</span>
            <span class="n">replyTo</span> <span class="o">!</span> <span class="nc">DeviceRegistered</span><span class="o">(</span><span class="n">deviceActor</span><span class="o">)</span>
          <span class="k">case</span> <span class="nc">None</span> <span class="k">=&gt;</span>
            <span class="n">context</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">&quot;Creating device actor for {}&quot;</span><span class="o">,</span> <span class="n">trackMsg</span><span class="o">.</span><span class="n">deviceId</span><span class="o">)</span>
            <span class="k">val</span> <span class="n">deviceActor</span> <span class="k">=</span> <span class="n">context</span><span class="o">.</span><span class="n">spawn</span><span class="o">(</span><span class="nc">Device</span><span class="o">(</span><span class="n">groupId</span><span class="o">,</span> <span class="n">deviceId</span><span class="o">),</span> <span class="s">s&quot;device-</span><span class="si">$deviceId</span><span class="s">&quot;</span><span class="o">)</span>
            <span class="n">deviceIdToActor</span> <span class="o">+=</span> <span class="n">deviceId</span> <span class="o">-&gt;</span> <span class="n">deviceActor</span>
            <span class="n">replyTo</span> <span class="o">!</span> <span class="nc">DeviceRegistered</span><span class="o">(</span><span class="n">deviceActor</span><span class="o">)</span>
        <span class="o">}</span>
        <span class="k">this</span>

      <span class="k">case</span> <span class="nc">RequestTrackDevice</span><span class="o">(</span><span class="n">gId</span><span class="o">,</span> <span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span>
        <span class="n">context</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warn2</span><span class="o">(</span><span class="s">&quot;Ignoring TrackDevice request for {}. This actor is responsible for {}.&quot;</span><span class="o">,</span> <span class="n">gId</span><span class="o">,</span> <span class="n">groupId</span><span class="o">)</span>
        <span class="k">this</span>
    <span class="o">}</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">onSignal</span><span class="k">:</span> <span class="kt">PartialFunction</span><span class="o">[</span><span class="kt">Signal</span>, <span class="kt">Behavior</span><span class="o">[</span><span class="kt">Command</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">PostStop</span> <span class="k">=&gt;</span>
      <span class="n">context</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">&quot;DeviceGroup {} stopped&quot;</span><span class="o">,</span> <span class="n">groupId</span><span class="o">)</span>
      <span class="k">this</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Як і коли ми робили із пристроєм, ми перевіряємо цю нову функціональність. Ми також перевіряємо, що актори, які повернулися за двома різними ідентифікаторами, насправді різні, і ми також намагаємось записати показник температури для кожного з пристроїв, щоб побачити, чи реагують актори.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="s">&quot;be able to register a device actor&quot;</span> <span class="n">in</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">probe</span> <span class="k">=</span> <span class="n">createTestProbe</span><span class="o">[</span><span class="kt">DeviceRegistered</span><span class="o">]()</span>
  <span class="k">val</span> <span class="n">groupActor</span> <span class="k">=</span> <span class="n">spawn</span><span class="o">(</span><span class="nc">DeviceGroup</span><span class="o">(</span><span class="s">&quot;group&quot;</span><span class="o">))</span>

  <span class="n">groupActor</span> <span class="o">!</span> <span class="nc">RequestTrackDevice</span><span class="o">(</span><span class="s">&quot;group&quot;</span><span class="o">,</span> <span class="s">&quot;device1&quot;</span><span class="o">,</span> <span class="n">probe</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">registered1</span> <span class="k">=</span> <span class="n">probe</span><span class="o">.</span><span class="n">receiveMessage</span><span class="o">()</span>
  <span class="k">val</span> <span class="n">deviceActor1</span> <span class="k">=</span> <span class="n">registered1</span><span class="o">.</span><span class="n">device</span>

  <span class="c1">// іниший deviceId</span>
  <span class="n">groupActor</span> <span class="o">!</span> <span class="nc">RequestTrackDevice</span><span class="o">(</span><span class="s">&quot;group&quot;</span><span class="o">,</span> <span class="s">&quot;device2&quot;</span><span class="o">,</span> <span class="n">probe</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">registered2</span> <span class="k">=</span> <span class="n">probe</span><span class="o">.</span><span class="n">receiveMessage</span><span class="o">()</span>
  <span class="k">val</span> <span class="n">deviceActor2</span> <span class="k">=</span> <span class="n">registered2</span><span class="o">.</span><span class="n">device</span>
  <span class="n">deviceActor1</span> <span class="n">should</span> <span class="o">!==(</span><span class="n">deviceActor2</span><span class="o">)</span>

  <span class="c1">// перевіряємо, чи актори пристроїв роблять</span>
  <span class="k">val</span> <span class="n">recordProbe</span> <span class="k">=</span> <span class="n">createTestProbe</span><span class="o">[</span><span class="kt">TemperatureRecorded</span><span class="o">]()</span>
  <span class="n">deviceActor1</span> <span class="o">!</span> <span class="nc">RecordTemperature</span><span class="o">(</span><span class="n">requestId</span> <span class="k">=</span> <span class="mi">0</span><span class="o">,</span> <span class="mf">1.0</span><span class="o">,</span> <span class="n">recordProbe</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span>
  <span class="n">recordProbe</span><span class="o">.</span><span class="n">expectMessage</span><span class="o">(</span><span class="nc">TemperatureRecorded</span><span class="o">(</span><span class="n">requestId</span> <span class="k">=</span> <span class="mi">0</span><span class="o">))</span>
  <span class="n">deviceActor2</span> <span class="o">!</span> <span class="nc">Device</span><span class="o">.</span><span class="nc">RecordTemperature</span><span class="o">(</span><span class="n">requestId</span> <span class="k">=</span> <span class="mi">1</span><span class="o">,</span> <span class="mf">2.0</span><span class="o">,</span> <span class="n">recordProbe</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span>
  <span class="n">recordProbe</span><span class="o">.</span><span class="n">expectMessage</span><span class="o">(</span><span class="nc">Device</span><span class="o">.</span><span class="nc">TemperatureRecorded</span><span class="o">(</span><span class="n">requestId</span> <span class="k">=</span> <span class="mi">1</span><span class="o">))</span>
<span class="o">}</span>

<span class="s">&quot;ignore requests for wrong groupId&quot;</span> <span class="n">in</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">probe</span> <span class="k">=</span> <span class="n">createTestProbe</span><span class="o">[</span><span class="kt">DeviceRegistered</span><span class="o">]()</span>
  <span class="k">val</span> <span class="n">groupActor</span> <span class="k">=</span> <span class="n">spawn</span><span class="o">(</span><span class="nc">DeviceGroup</span><span class="o">(</span><span class="s">&quot;group&quot;</span><span class="o">))</span>

  <span class="n">groupActor</span> <span class="o">!</span> <span class="nc">RequestTrackDevice</span><span class="o">(</span><span class="s">&quot;wrongGroup&quot;</span><span class="o">,</span> <span class="s">&quot;device1&quot;</span><span class="o">,</span> <span class="n">probe</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span>
  <span class="n">probe</span><span class="o">.</span><span class="n">expectNoMessage</span><span class="o">(</span><span class="mf">500.</span><span class="n">milliseconds</span><span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Якщо для запиту на реєстрацію вже існує актор пристрою, ми хотіли б використовувати існуючий актор замість нового. Ми ще цього не тестували, тому нам потрібно це виправити:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="s">&quot;return same actor for same deviceId&quot;</span> <span class="n">in</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">probe</span> <span class="k">=</span> <span class="n">createTestProbe</span><span class="o">[</span><span class="kt">DeviceRegistered</span><span class="o">]()</span>
  <span class="k">val</span> <span class="n">groupActor</span> <span class="k">=</span> <span class="n">spawn</span><span class="o">(</span><span class="nc">DeviceGroup</span><span class="o">(</span><span class="s">&quot;group&quot;</span><span class="o">))</span>

  <span class="n">groupActor</span> <span class="o">!</span> <span class="nc">RequestTrackDevice</span><span class="o">(</span><span class="s">&quot;group&quot;</span><span class="o">,</span> <span class="s">&quot;device1&quot;</span><span class="o">,</span> <span class="n">probe</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">registered1</span> <span class="k">=</span> <span class="n">probe</span><span class="o">.</span><span class="n">receiveMessage</span><span class="o">()</span>

  <span class="c1">// повторна реєстрація має бути марною</span>
  <span class="n">groupActor</span> <span class="o">!</span> <span class="nc">RequestTrackDevice</span><span class="o">(</span><span class="s">&quot;group&quot;</span><span class="o">,</span> <span class="s">&quot;device1&quot;</span><span class="o">,</span> <span class="n">probe</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">registered2</span> <span class="k">=</span> <span class="n">probe</span><span class="o">.</span><span class="n">receiveMessage</span><span class="o">()</span>

  <span class="n">registered1</span><span class="o">.</span><span class="n">device</span> <span class="n">should</span> <span class="o">===(</span><span class="n">registered2</span><span class="o">.</span><span class="n">device</span><span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="______2">Відстеження акторів пристрою в групі</h4>
<div class="paragraph"><p>Поки ми застосували логіку реєстрації акторів пристроїв у групі. Однак пристрої приходять і виходять, тому нам знадобиться спосіб видалення акторів пристрою з <code>Map[String, ActorRef [DeviceMessage]]</code>. Будемо вважати, що при видаленні пристрою його відповідний актор пристрою зупиняється. Нагляд, як ми обговорювали раніше, обробляє лише сценарії помилок - не добровільні зупинки. Тому нам потрібно повідомити батьків про зупинку одного з діючих пристроїв.</p></div>
<div class="paragraph"><p>Akka надає функцію "Death Watch", яка дозволяє актору спостерігати за іншим актором та отримувати сповіщення, якщо іншого актора зупинено. На відміну від нагляду, спостереження не обмежується стосунками батько-дитина. Будь-який актор може спостерігати за будь-яким іншим актором, доки він знає його <code>ActorRef</code>. Після того, як піддослідний актор зупиняється, спостерігач отримує сигнал Terminated(actorRef), який також містить посилання на піддослідного актора. Спостерігач може або обробляти це повідомлення явно, або схибити з <code>DeathPactException</code>. Це останнє є корисне, якщо актор вже не може виконувати свої власні обов'язки після того, як піддосліддний актор був зупинений. У нашому випадку група все-таки повинна функціонувати після зупинки одного пристрою, тому нам потрібно обробляти сигнал <code>Terminated(actorRef)</code>.</p></div>
<div class="paragraph"><p>Наш актор групи пристроїв повинен включати функціональні можливості, які:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Починає нагляд за новими акторами пристроїв, коли вони створені.
</p>
</li>
<li>
<p>
Видаляє актор пристрою з <code>Map[String, ActorRef [DeviceMessage]]</code> - який відображає пристрої для акторів пристроїв - коли повідомлення вказує, що воно припинилося.
</p>
</li>
</ol></div>
<div class="paragraph"><p>На жаль, сигнал <code>Terminated</code> містить лише <code>ActorRef</code> дитини-актора. Нам потрібен ідентифікатор актора, щоб видалити його з мапи наявниї пристроїв. Альтернатива сигналу <code>Terminated</code> полягає у визначенні користувацького повідомлення, яке надсилатиметься після зупинки піддослідного актора. Ми будемо використовувати це тут, оскільки це дає нам можливість перенести ідентифікатор пристрою в цьому повідомленні.</p></div>
<div class="paragraph"><p>Додавання функціональності для ідентифікації результатів актора в цьому:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DeviceGroup</span><span class="o">(</span><span class="n">context</span><span class="k">:</span> <span class="kt">ActorContext</span><span class="o">[</span><span class="kt">DeviceGroup.Command</span><span class="o">],</span> <span class="n">groupId</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
    <span class="k">extends</span> <span class="nc">AbstractBehavior</span><span class="o">[</span><span class="kt">DeviceGroup.Command</span><span class="o">](</span><span class="n">context</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">import</span> <span class="nn">DeviceGroup._</span>
  <span class="k">import</span> <span class="nn">DeviceManager.</span><span class="o">{</span> <span class="nc">DeviceRegistered</span><span class="o">,</span> <span class="nc">ReplyDeviceList</span><span class="o">,</span> <span class="nc">RequestDeviceList</span><span class="o">,</span> <span class="nc">RequestTrackDevice</span> <span class="o">}</span>

  <span class="k">private</span> <span class="k">var</span> <span class="n">deviceIdToActor</span> <span class="k">=</span> <span class="nc">Map</span><span class="o">.</span><span class="n">empty</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">Device.Command</span><span class="o">]]</span>

  <span class="n">context</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">&quot;DeviceGroup {} started&quot;</span><span class="o">,</span> <span class="n">groupId</span><span class="o">)</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">onMessage</span><span class="o">(</span><span class="n">msg</span><span class="k">:</span> <span class="kt">Command</span><span class="o">)</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">Command</span><span class="o">]</span> <span class="k">=</span>
    <span class="n">msg</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="n">trackMsg</span> <span class="k">@</span> <span class="nc">RequestTrackDevice</span><span class="o">(</span><span class="n">`groupId`</span><span class="o">,</span> <span class="n">deviceId</span><span class="o">,</span> <span class="n">replyTo</span><span class="o">)</span> <span class="k">=&gt;</span>
        <span class="n">deviceIdToActor</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">deviceId</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
          <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">deviceActor</span><span class="o">)</span> <span class="k">=&gt;</span>
            <span class="n">replyTo</span> <span class="o">!</span> <span class="nc">DeviceRegistered</span><span class="o">(</span><span class="n">deviceActor</span><span class="o">)</span>
          <span class="k">case</span> <span class="nc">None</span> <span class="k">=&gt;</span>
            <span class="n">context</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">&quot;Creating device actor for {}&quot;</span><span class="o">,</span> <span class="n">trackMsg</span><span class="o">.</span><span class="n">deviceId</span><span class="o">)</span>
            <span class="k">val</span> <span class="n">deviceActor</span> <span class="k">=</span> <span class="n">context</span><span class="o">.</span><span class="n">spawn</span><span class="o">(</span><span class="nc">Device</span><span class="o">(</span><span class="n">groupId</span><span class="o">,</span> <span class="n">deviceId</span><span class="o">),</span> <span class="s">s&quot;device-</span><span class="si">$deviceId</span><span class="s">&quot;</span><span class="o">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">watchWith</span><span class="o">(</span><span class="n">deviceActor</span><span class="o">,</span> <span class="nc">DeviceTerminated</span><span class="o">(</span><span class="n">deviceActor</span><span class="o">,</span> <span class="n">groupId</span><span class="o">,</span> <span class="n">deviceId</span><span class="o">))</span>
            <span class="n">deviceIdToActor</span> <span class="o">+=</span> <span class="n">deviceId</span> <span class="o">-&gt;</span> <span class="n">deviceActor</span>
            <span class="n">replyTo</span> <span class="o">!</span> <span class="nc">DeviceRegistered</span><span class="o">(</span><span class="n">deviceActor</span><span class="o">)</span>
        <span class="o">}</span>
        <span class="k">this</span>

      <span class="k">case</span> <span class="nc">RequestTrackDevice</span><span class="o">(</span><span class="n">gId</span><span class="o">,</span> <span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span>
        <span class="n">context</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warn2</span><span class="o">(</span><span class="s">&quot;Ignoring TrackDevice request for {}. This actor is responsible for {}.&quot;</span><span class="o">,</span> <span class="n">gId</span><span class="o">,</span> <span class="n">groupId</span><span class="o">)</span>
        <span class="k">this</span>

      <span class="k">case</span> <span class="nc">DeviceTerminated</span><span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">,</span> <span class="n">deviceId</span><span class="o">)</span> <span class="k">=&gt;</span>
        <span class="n">context</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">&quot;Device actor for {} has been terminated&quot;</span><span class="o">,</span> <span class="n">deviceId</span><span class="o">)</span>
        <span class="n">deviceIdToActor</span> <span class="o">-=</span> <span class="n">deviceId</span>
        <span class="k">this</span>

    <span class="o">}</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">onSignal</span><span class="k">:</span> <span class="kt">PartialFunction</span><span class="o">[</span><span class="kt">Signal</span>, <span class="kt">Behavior</span><span class="o">[</span><span class="kt">Command</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">PostStop</span> <span class="k">=&gt;</span>
      <span class="n">context</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">&quot;DeviceGroup {} stopped&quot;</span><span class="o">,</span> <span class="n">groupId</span><span class="o">)</span>
      <span class="k">this</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Поки ми не маємо можливості визначити, які пристрої відслідковує актор групового пристрою, і, отже, ми не можемо перевірити свою нову функціональність. Щоб зробити його тестуваним, ми додамо нову можливість запиту (повідомлення <code>RequestDeviceList</code>), у якому перераховані поточні активні <code>ID</code> пристрою:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">RequestDeviceList</span><span class="o">(</span><span class="n">requestId</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span> <span class="n">groupId</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">replyTo</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">ReplyDeviceList</span><span class="o">])</span>
    <span class="k">extends</span> <span class="nc">DeviceManager</span><span class="o">.</span><span class="nc">Command</span>
    <span class="k">with</span> <span class="nc">DeviceGroup</span><span class="o">.</span><span class="nc">Command</span>

<span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">ReplyDeviceList</span><span class="o">(</span><span class="n">requestId</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span> <span class="n">ids</span><span class="k">:</span> <span class="kt">Set</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span>
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">object</span> <span class="nc">DeviceGroup</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">groupId</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">Command</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">Behaviors</span><span class="o">.</span><span class="n">setup</span><span class="o">(</span><span class="n">context</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">DeviceGroup</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">groupId</span><span class="o">))</span>

  <span class="k">trait</span> <span class="nc">Command</span>

  <span class="k">private</span> <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">DeviceTerminated</span><span class="o">(</span><span class="n">device</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">Device.Command</span><span class="o">],</span> <span class="n">groupId</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">deviceId</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
      <span class="k">extends</span> <span class="nc">Command</span>

<span class="o">}</span>

<span class="k">class</span> <span class="nc">DeviceGroup</span><span class="o">(</span><span class="n">context</span><span class="k">:</span> <span class="kt">ActorContext</span><span class="o">[</span><span class="kt">DeviceGroup.Command</span><span class="o">],</span> <span class="n">groupId</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
    <span class="k">extends</span> <span class="nc">AbstractBehavior</span><span class="o">[</span><span class="kt">DeviceGroup.Command</span><span class="o">](</span><span class="n">context</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">import</span> <span class="nn">DeviceGroup._</span>
  <span class="k">import</span> <span class="nn">DeviceManager.</span><span class="o">{</span> <span class="nc">DeviceRegistered</span><span class="o">,</span> <span class="nc">ReplyDeviceList</span><span class="o">,</span> <span class="nc">RequestDeviceList</span><span class="o">,</span> <span class="nc">RequestTrackDevice</span> <span class="o">}</span>

  <span class="k">private</span> <span class="k">var</span> <span class="n">deviceIdToActor</span> <span class="k">=</span> <span class="nc">Map</span><span class="o">.</span><span class="n">empty</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">Device.Command</span><span class="o">]]</span>

  <span class="n">context</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">&quot;DeviceGroup {} started&quot;</span><span class="o">,</span> <span class="n">groupId</span><span class="o">)</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">onMessage</span><span class="o">(</span><span class="n">msg</span><span class="k">:</span> <span class="kt">Command</span><span class="o">)</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">Command</span><span class="o">]</span> <span class="k">=</span>
    <span class="n">msg</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="n">trackMsg</span> <span class="k">@</span> <span class="nc">RequestTrackDevice</span><span class="o">(</span><span class="n">`groupId`</span><span class="o">,</span> <span class="n">deviceId</span><span class="o">,</span> <span class="n">replyTo</span><span class="o">)</span> <span class="k">=&gt;</span>
        <span class="n">deviceIdToActor</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">deviceId</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
          <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">deviceActor</span><span class="o">)</span> <span class="k">=&gt;</span>
            <span class="n">replyTo</span> <span class="o">!</span> <span class="nc">DeviceRegistered</span><span class="o">(</span><span class="n">deviceActor</span><span class="o">)</span>
          <span class="k">case</span> <span class="nc">None</span> <span class="k">=&gt;</span>
            <span class="n">context</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">&quot;Creating device actor for {}&quot;</span><span class="o">,</span> <span class="n">trackMsg</span><span class="o">.</span><span class="n">deviceId</span><span class="o">)</span>
            <span class="k">val</span> <span class="n">deviceActor</span> <span class="k">=</span> <span class="n">context</span><span class="o">.</span><span class="n">spawn</span><span class="o">(</span><span class="nc">Device</span><span class="o">(</span><span class="n">groupId</span><span class="o">,</span> <span class="n">deviceId</span><span class="o">),</span> <span class="s">s&quot;device-</span><span class="si">$deviceId</span><span class="s">&quot;</span><span class="o">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">watchWith</span><span class="o">(</span><span class="n">deviceActor</span><span class="o">,</span> <span class="nc">DeviceTerminated</span><span class="o">(</span><span class="n">deviceActor</span><span class="o">,</span> <span class="n">groupId</span><span class="o">,</span> <span class="n">deviceId</span><span class="o">))</span>
            <span class="n">deviceIdToActor</span> <span class="o">+=</span> <span class="n">deviceId</span> <span class="o">-&gt;</span> <span class="n">deviceActor</span>
            <span class="n">replyTo</span> <span class="o">!</span> <span class="nc">DeviceRegistered</span><span class="o">(</span><span class="n">deviceActor</span><span class="o">)</span>
        <span class="o">}</span>
        <span class="k">this</span>

      <span class="k">case</span> <span class="nc">RequestTrackDevice</span><span class="o">(</span><span class="n">gId</span><span class="o">,</span> <span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span>
        <span class="n">context</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warn2</span><span class="o">(</span><span class="s">&quot;Ignoring TrackDevice request for {}. This actor is responsible for {}.&quot;</span><span class="o">,</span> <span class="n">gId</span><span class="o">,</span> <span class="n">groupId</span><span class="o">)</span>
        <span class="k">this</span>

      <span class="k">case</span> <span class="nc">RequestDeviceList</span><span class="o">(</span><span class="n">requestId</span><span class="o">,</span> <span class="n">gId</span><span class="o">,</span> <span class="n">replyTo</span><span class="o">)</span> <span class="k">=&gt;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">gId</span> <span class="o">==</span> <span class="n">groupId</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">replyTo</span> <span class="o">!</span> <span class="nc">ReplyDeviceList</span><span class="o">(</span><span class="n">requestId</span><span class="o">,</span> <span class="n">deviceIdToActor</span><span class="o">.</span><span class="n">keySet</span><span class="o">)</span>
          <span class="k">this</span>
        <span class="o">}</span> <span class="k">else</span>
          <span class="nc">Behaviors</span><span class="o">.</span><span class="n">unhandled</span>

      <span class="k">case</span> <span class="nc">DeviceTerminated</span><span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">,</span> <span class="n">deviceId</span><span class="o">)</span> <span class="k">=&gt;</span>
        <span class="n">context</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">&quot;Device actor for {} has been terminated&quot;</span><span class="o">,</span> <span class="n">deviceId</span><span class="o">)</span>
        <span class="n">deviceIdToActor</span> <span class="o">-=</span> <span class="n">deviceId</span>
        <span class="k">this</span>

    <span class="o">}</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">onSignal</span><span class="k">:</span> <span class="kt">PartialFunction</span><span class="o">[</span><span class="kt">Signal</span>, <span class="kt">Behavior</span><span class="o">[</span><span class="kt">Command</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">PostStop</span> <span class="k">=&gt;</span>
      <span class="n">context</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">&quot;DeviceGroup {} stopped&quot;</span><span class="o">,</span> <span class="n">groupId</span><span class="o">)</span>
      <span class="k">this</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Ми майже готові перевірити видалення пристроїв. Але нам ще потрібні такі можливості:</p></div>
<div class="ulist"><ul>
<li>
<p>
Щоб зупинити дію пристрою з нашого тестового випадку, ми повинні надіслати повідомлення на нього. Ми додаємо повідомлення <code>Passivate</code>, яке вказує актору зупинитися.
</p>
</li>
<li>
<p>
Повідомляти про те, коли зупинено дію пристрою. Ми також можемо використовувати для цього Death Watch.
</p>
</li>
</ul></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">case</span> <span class="k">object</span> <span class="nc">Passivate</span> <span class="k">extends</span> <span class="nc">Command</span>
</pre></div></div></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">akka.actor.typed.ActorRef</span>
<span class="k">import</span> <span class="nn">akka.actor.typed.Behavior</span>
<span class="k">import</span> <span class="nn">akka.actor.typed.PostStop</span>
<span class="k">import</span> <span class="nn">akka.actor.typed.Signal</span>
<span class="k">import</span> <span class="nn">akka.actor.typed.scaladsl.AbstractBehavior</span>
<span class="k">import</span> <span class="nn">akka.actor.typed.scaladsl.ActorContext</span>
<span class="k">import</span> <span class="nn">akka.actor.typed.scaladsl.Behaviors</span>
<span class="k">import</span> <span class="nn">akka.actor.typed.scaladsl.LoggerOps</span>

<span class="k">object</span> <span class="nc">Device</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">groupId</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">deviceId</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">Command</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">Behaviors</span><span class="o">.</span><span class="n">setup</span><span class="o">(</span><span class="n">context</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">Device</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">groupId</span><span class="o">,</span> <span class="n">deviceId</span><span class="o">))</span>

  <span class="k">sealed</span> <span class="k">trait</span> <span class="nc">Command</span>

  <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">ReadTemperature</span><span class="o">(</span><span class="n">requestId</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span> <span class="n">replyTo</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">RespondTemperature</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">Command</span>
  <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">RespondTemperature</span><span class="o">(</span><span class="n">requestId</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span> <span class="n">value</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">Double</span><span class="o">])</span>

  <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">RecordTemperature</span><span class="o">(</span><span class="n">requestId</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span> <span class="n">value</span><span class="k">:</span> <span class="kt">Double</span><span class="o">,</span> <span class="n">replyTo</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">TemperatureRecorded</span><span class="o">])</span>
      <span class="k">extends</span> <span class="nc">Command</span>
  <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">TemperatureRecorded</span><span class="o">(</span><span class="n">requestId</span><span class="k">:</span> <span class="kt">Long</span><span class="o">)</span>

  <span class="k">case</span> <span class="k">object</span> <span class="nc">Passivate</span> <span class="k">extends</span> <span class="nc">Command</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">Device</span><span class="o">(</span><span class="n">context</span><span class="k">:</span> <span class="kt">ActorContext</span><span class="o">[</span><span class="kt">Device.Command</span><span class="o">],</span> <span class="n">groupId</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">deviceId</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
    <span class="k">extends</span> <span class="nc">AbstractBehavior</span><span class="o">[</span><span class="kt">Device.Command</span><span class="o">](</span><span class="n">context</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">import</span> <span class="nn">Device._</span>

  <span class="k">var</span> <span class="n">lastTemperatureReading</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">Double</span><span class="o">]</span> <span class="k">=</span> <span class="nc">None</span>

  <span class="n">context</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info2</span><span class="o">(</span><span class="s">&quot;Device actor {}-{} started&quot;</span><span class="o">,</span> <span class="n">groupId</span><span class="o">,</span> <span class="n">deviceId</span><span class="o">)</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">onMessage</span><span class="o">(</span><span class="n">msg</span><span class="k">:</span> <span class="kt">Command</span><span class="o">)</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">Command</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="n">msg</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">RecordTemperature</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="n">replyTo</span><span class="o">)</span> <span class="k">=&gt;</span>
        <span class="n">context</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info2</span><span class="o">(</span><span class="s">&quot;Recorded temperature reading {} with {}&quot;</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="n">id</span><span class="o">)</span>
        <span class="n">lastTemperatureReading</span> <span class="k">=</span> <span class="nc">Some</span><span class="o">(</span><span class="n">value</span><span class="o">)</span>
        <span class="n">replyTo</span> <span class="o">!</span> <span class="nc">TemperatureRecorded</span><span class="o">(</span><span class="n">id</span><span class="o">)</span>
        <span class="k">this</span>

      <span class="k">case</span> <span class="nc">ReadTemperature</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">replyTo</span><span class="o">)</span> <span class="k">=&gt;</span>
        <span class="n">replyTo</span> <span class="o">!</span> <span class="nc">RespondTemperature</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">lastTemperatureReading</span><span class="o">)</span>
        <span class="k">this</span>

      <span class="k">case</span> <span class="nc">Passivate</span> <span class="k">=&gt;</span>
        <span class="nc">Behaviors</span><span class="o">.</span><span class="n">stopped</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">onSignal</span><span class="k">:</span> <span class="kt">PartialFunction</span><span class="o">[</span><span class="kt">Signal</span>, <span class="kt">Behavior</span><span class="o">[</span><span class="kt">Command</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">PostStop</span> <span class="k">=&gt;</span>
      <span class="n">context</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info2</span><span class="o">(</span><span class="s">&quot;Device actor {}-{} stopped&quot;</span><span class="o">,</span> <span class="n">groupId</span><span class="o">,</span> <span class="n">deviceId</span><span class="o">)</span>
      <span class="k">this</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Зараз ми додамо ще два тестові випадки. По-перше, ми перевіряємо, що ми повертаємо список належних ідентифікаторів, коли додамо кілька пристроїв. Другий тестовий випадок гарантує відповідне видалення ідентифікатора пристрою після зупинки актора пристрою. У <code>TestProbe</code> є метод <code>expectTerminated</code>, який ми можемо легко використати для того, щоб стверджувати, що актор пристрою припинено.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="s">&quot;be able to list active devices&quot;</span> <span class="n">in</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">registeredProbe</span> <span class="k">=</span> <span class="n">createTestProbe</span><span class="o">[</span><span class="kt">DeviceRegistered</span><span class="o">]()</span>
  <span class="k">val</span> <span class="n">groupActor</span> <span class="k">=</span> <span class="n">spawn</span><span class="o">(</span><span class="nc">DeviceGroup</span><span class="o">(</span><span class="s">&quot;group&quot;</span><span class="o">))</span>

  <span class="n">groupActor</span> <span class="o">!</span> <span class="nc">RequestTrackDevice</span><span class="o">(</span><span class="s">&quot;group&quot;</span><span class="o">,</span> <span class="s">&quot;device1&quot;</span><span class="o">,</span> <span class="n">registeredProbe</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span>
  <span class="n">registeredProbe</span><span class="o">.</span><span class="n">receiveMessage</span><span class="o">()</span>

  <span class="n">groupActor</span> <span class="o">!</span> <span class="nc">RequestTrackDevice</span><span class="o">(</span><span class="s">&quot;group&quot;</span><span class="o">,</span> <span class="s">&quot;device2&quot;</span><span class="o">,</span> <span class="n">registeredProbe</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span>
  <span class="n">registeredProbe</span><span class="o">.</span><span class="n">receiveMessage</span><span class="o">()</span>

  <span class="k">val</span> <span class="n">deviceListProbe</span> <span class="k">=</span> <span class="n">createTestProbe</span><span class="o">[</span><span class="kt">ReplyDeviceList</span><span class="o">]()</span>
  <span class="n">groupActor</span> <span class="o">!</span> <span class="nc">RequestDeviceList</span><span class="o">(</span><span class="n">requestId</span> <span class="k">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">groupId</span> <span class="k">=</span> <span class="s">&quot;group&quot;</span><span class="o">,</span> <span class="n">deviceListProbe</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span>
  <span class="n">deviceListProbe</span><span class="o">.</span><span class="n">expectMessage</span><span class="o">(</span><span class="nc">ReplyDeviceList</span><span class="o">(</span><span class="n">requestId</span> <span class="k">=</span> <span class="mi">0</span><span class="o">,</span> <span class="nc">Set</span><span class="o">(</span><span class="s">&quot;device1&quot;</span><span class="o">,</span> <span class="s">&quot;device2&quot;</span><span class="o">)))</span>
<span class="o">}</span>

<span class="s">&quot;be able to list active devices after one shuts down&quot;</span> <span class="n">in</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">registeredProbe</span> <span class="k">=</span> <span class="n">createTestProbe</span><span class="o">[</span><span class="kt">DeviceRegistered</span><span class="o">]()</span>
  <span class="k">val</span> <span class="n">groupActor</span> <span class="k">=</span> <span class="n">spawn</span><span class="o">(</span><span class="nc">DeviceGroup</span><span class="o">(</span><span class="s">&quot;group&quot;</span><span class="o">))</span>

  <span class="n">groupActor</span> <span class="o">!</span> <span class="nc">RequestTrackDevice</span><span class="o">(</span><span class="s">&quot;group&quot;</span><span class="o">,</span> <span class="s">&quot;device1&quot;</span><span class="o">,</span> <span class="n">registeredProbe</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">registered1</span> <span class="k">=</span> <span class="n">registeredProbe</span><span class="o">.</span><span class="n">receiveMessage</span><span class="o">()</span>
  <span class="k">val</span> <span class="n">toShutDown</span> <span class="k">=</span> <span class="n">registered1</span><span class="o">.</span><span class="n">device</span>

  <span class="n">groupActor</span> <span class="o">!</span> <span class="nc">RequestTrackDevice</span><span class="o">(</span><span class="s">&quot;group&quot;</span><span class="o">,</span> <span class="s">&quot;device2&quot;</span><span class="o">,</span> <span class="n">registeredProbe</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span>
  <span class="n">registeredProbe</span><span class="o">.</span><span class="n">receiveMessage</span><span class="o">()</span>

  <span class="k">val</span> <span class="n">deviceListProbe</span> <span class="k">=</span> <span class="n">createTestProbe</span><span class="o">[</span><span class="kt">ReplyDeviceList</span><span class="o">]()</span>
  <span class="n">groupActor</span> <span class="o">!</span> <span class="nc">RequestDeviceList</span><span class="o">(</span><span class="n">requestId</span> <span class="k">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">groupId</span> <span class="k">=</span> <span class="s">&quot;group&quot;</span><span class="o">,</span> <span class="n">deviceListProbe</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span>
  <span class="n">deviceListProbe</span><span class="o">.</span><span class="n">expectMessage</span><span class="o">(</span><span class="nc">ReplyDeviceList</span><span class="o">(</span><span class="n">requestId</span> <span class="k">=</span> <span class="mi">0</span><span class="o">,</span> <span class="nc">Set</span><span class="o">(</span><span class="s">&quot;device1&quot;</span><span class="o">,</span> <span class="s">&quot;device2&quot;</span><span class="o">)))</span>

  <span class="n">toShutDown</span> <span class="o">!</span> <span class="nc">Passivate</span>
  <span class="n">registeredProbe</span><span class="o">.</span><span class="n">expectTerminated</span><span class="o">(</span><span class="n">toShutDown</span><span class="o">,</span> <span class="n">registeredProbe</span><span class="o">.</span><span class="n">remainingOrDefault</span><span class="o">)</span>

  <span class="c1">// використання awaitAssert для отримання причини затримки groupActor</span>
  <span class="c1">// в отриманні Terminated, цей порядок не визначений</span>
  <span class="n">registeredProbe</span><span class="o">.</span><span class="n">awaitAssert</span> <span class="o">{</span>
    <span class="n">groupActor</span> <span class="o">!</span> <span class="nc">RequestDeviceList</span><span class="o">(</span><span class="n">requestId</span> <span class="k">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">groupId</span> <span class="k">=</span> <span class="s">&quot;group&quot;</span><span class="o">,</span> <span class="n">deviceListProbe</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span>
    <span class="n">deviceListProbe</span><span class="o">.</span><span class="n">expectMessage</span><span class="o">(</span><span class="nc">ReplyDeviceList</span><span class="o">(</span><span class="n">requestId</span> <span class="k">=</span> <span class="mi">1</span><span class="o">,</span> <span class="nc">Set</span><span class="o">(</span><span class="s">&quot;device2&quot;</span><span class="o">)))</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
</div>
</div>
<div class="sect2">
<h3 id="_____3">Створення акторів менеджера пристроїв</h3>
<div class="paragraph"><p>Піднімаючись до наступного рівня в нашій ієрархії, нам потрібно створити точку входу для нашого компонента диспетчера пристроїв у вихідному файлі <code>DeviceManager</code>. Цей актор дуже схожий на актор групи пристроїв, але створює акторів групи пристроїв замість акторів пристроїв:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">object</span> <span class="nc">DeviceManager</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">apply</span><span class="o">()</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">Command</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">Behaviors</span><span class="o">.</span><span class="n">setup</span><span class="o">(</span><span class="n">context</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">DeviceManager</span><span class="o">(</span><span class="n">context</span><span class="o">))</span>


  <span class="k">sealed</span> <span class="k">trait</span> <span class="nc">Command</span>

  <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">RequestTrackDevice</span><span class="o">(</span><span class="n">groupId</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">deviceId</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">replyTo</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">DeviceRegistered</span><span class="o">])</span>
      <span class="k">extends</span> <span class="nc">DeviceManager</span><span class="o">.</span><span class="nc">Command</span>
      <span class="k">with</span> <span class="nc">DeviceGroup</span><span class="o">.</span><span class="nc">Command</span>

  <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">DeviceRegistered</span><span class="o">(</span><span class="n">device</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">Device.Command</span><span class="o">])</span>

  <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">RequestDeviceList</span><span class="o">(</span><span class="n">requestId</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span> <span class="n">groupId</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">replyTo</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">ReplyDeviceList</span><span class="o">])</span>
      <span class="k">extends</span> <span class="nc">DeviceManager</span><span class="o">.</span><span class="nc">Command</span>
      <span class="k">with</span> <span class="nc">DeviceGroup</span><span class="o">.</span><span class="nc">Command</span>

  <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">ReplyDeviceList</span><span class="o">(</span><span class="n">requestId</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span> <span class="n">ids</span><span class="k">:</span> <span class="kt">Set</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span>

  <span class="k">private</span> <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">DeviceGroupTerminated</span><span class="o">(</span><span class="n">groupId</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">DeviceManager</span><span class="o">.</span><span class="nc">Command</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">DeviceManager</span><span class="o">(</span><span class="n">context</span><span class="k">:</span> <span class="kt">ActorContext</span><span class="o">[</span><span class="kt">DeviceManager.Command</span><span class="o">])</span>
    <span class="k">extends</span> <span class="nc">AbstractBehavior</span><span class="o">[</span><span class="kt">DeviceManager.Command</span><span class="o">](</span><span class="n">context</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">import</span> <span class="nn">DeviceManager._</span>

  <span class="k">var</span> <span class="n">groupIdToActor</span> <span class="k">=</span> <span class="nc">Map</span><span class="o">.</span><span class="n">empty</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">DeviceGroup.Command</span><span class="o">]]</span>

  <span class="n">context</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">&quot;DeviceManager started&quot;</span><span class="o">)</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">onMessage</span><span class="o">(</span><span class="n">msg</span><span class="k">:</span> <span class="kt">Command</span><span class="o">)</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">Command</span><span class="o">]</span> <span class="k">=</span>
    <span class="n">msg</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="n">trackMsg</span> <span class="k">@</span> <span class="nc">RequestTrackDevice</span><span class="o">(</span><span class="n">groupId</span><span class="o">,</span> <span class="k">_</span><span class="o">,</span> <span class="n">replyTo</span><span class="o">)</span> <span class="k">=&gt;</span>
        <span class="n">groupIdToActor</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">groupId</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
          <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">ref</span><span class="o">)</span> <span class="k">=&gt;</span>
            <span class="n">ref</span> <span class="o">!</span> <span class="n">trackMsg</span>
          <span class="k">case</span> <span class="nc">None</span> <span class="k">=&gt;</span>
            <span class="n">context</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">&quot;Creating device group actor for {}&quot;</span><span class="o">,</span> <span class="n">groupId</span><span class="o">)</span>
            <span class="k">val</span> <span class="n">groupActor</span> <span class="k">=</span> <span class="n">context</span><span class="o">.</span><span class="n">spawn</span><span class="o">(</span><span class="nc">DeviceGroup</span><span class="o">(</span><span class="n">groupId</span><span class="o">),</span> <span class="s">&quot;group-&quot;</span> <span class="o">+</span> <span class="n">groupId</span><span class="o">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">watchWith</span><span class="o">(</span><span class="n">groupActor</span><span class="o">,</span> <span class="nc">DeviceGroupTerminated</span><span class="o">(</span><span class="n">groupId</span><span class="o">))</span>
            <span class="n">groupActor</span> <span class="o">!</span> <span class="n">trackMsg</span>
            <span class="n">groupIdToActor</span> <span class="o">+=</span> <span class="n">groupId</span> <span class="o">-&gt;</span> <span class="n">groupActor</span>
        <span class="o">}</span>
        <span class="k">this</span>

      <span class="k">case</span> <span class="n">req</span> <span class="k">@</span> <span class="nc">RequestDeviceList</span><span class="o">(</span><span class="n">requestId</span><span class="o">,</span> <span class="n">groupId</span><span class="o">,</span> <span class="n">replyTo</span><span class="o">)</span> <span class="k">=&gt;</span>
        <span class="n">groupIdToActor</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">groupId</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
          <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">ref</span><span class="o">)</span> <span class="k">=&gt;</span>
            <span class="n">ref</span> <span class="o">!</span> <span class="n">req</span>
          <span class="k">case</span> <span class="nc">None</span> <span class="k">=&gt;</span>
            <span class="n">replyTo</span> <span class="o">!</span> <span class="nc">ReplyDeviceList</span><span class="o">(</span><span class="n">requestId</span><span class="o">,</span> <span class="nc">Set</span><span class="o">.</span><span class="n">empty</span><span class="o">)</span>
        <span class="o">}</span>
        <span class="k">this</span>

      <span class="k">case</span> <span class="nc">DeviceGroupTerminated</span><span class="o">(</span><span class="n">groupId</span><span class="o">)</span> <span class="k">=&gt;</span>
        <span class="n">context</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">&quot;Device group actor for {} has been terminated&quot;</span><span class="o">,</span> <span class="n">groupId</span><span class="o">)</span>
        <span class="n">groupIdToActor</span> <span class="o">-=</span> <span class="n">groupId</span>
        <span class="k">this</span>
    <span class="o">}</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">onSignal</span><span class="k">:</span> <span class="kt">PartialFunction</span><span class="o">[</span><span class="kt">Signal</span>, <span class="kt">Behavior</span><span class="o">[</span><span class="kt">Command</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">PostStop</span> <span class="k">=&gt;</span>
      <span class="n">context</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">&quot;DeviceManager stopped&quot;</span><span class="o">)</span>
      <span class="k">this</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Тести менеджера пристроїв ми залишаємо для вас як вправу, оскільки він дуже схожий на тести, які ми вже написали для актора групи.</p></div>
</div>
<div class="sect2">
<h3 id="___8">Що далі?</h3>
<div class="paragraph"><p>Зараз у нас є ієрархічний компонент для реєстрації та відстеження пристроїв та запису вимірювань. Ми бачили, як реалізувати різні типи моделей розмов, наприклад:</p></div>
<div class="ulist"><ul>
<li>
<p>
Запит-відповідь (для записів температури)
</p>
</li>
<li>
<p>
Створення на замовлення (для реєстрації пристроїв)
</p>
</li>
<li>
<p>
Створення-перегляд-завершення (для створення групи та актора пристрою як дітей)
</p>
</li>
</ul></div>
<div class="paragraph"><p>У наступному розділі ми введемо можливості групового запиту, який встановить новий шаблон розмови "розсипати-збирати". Зокрема, ми реалізуємо функціонал, який дозволяє користувачам запитувати стан усіх пристроїв, що належать до групи.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="__5____">Частина 5: Запити до груп пристроїв</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="__8">Вступ</h3>
<div class="paragraph"><p>Схеми перемовин, які ми бачили до цього часу, прості в тому сенсі, що вони вимагають від актора, щоб він мало тримався або не мав стану. Конкретно:</p></div>
<div class="ulist"><ul>
<li>
<p>
Актори пристрою повертають показання, які не потребують змін у стані
</p>
</li>
<li>
<p>
Записується температура, що оновлює одне поле
</p>
</li>
<li>
<p>
Актори групи пристроїв підтримують членство в групі, додаючи або видаляючи записи з мапи
</p>
</li>
</ul></div>
<div class="paragraph"><p>У цій частині ми використаємо більш складний приклад. Оскільки власники будинків будуть зацікавлені у температурі в усьому будинку, наша мета - мати можливість запитувати всіх учасників пристроїв у групі. Для початку почнемо з дослідження того, як повинен вести себе такий API запиту.</p></div>
</div>
<div class="sect2">
<h3 id="_____4">Робота з можливими сценаріями</h3>
<div class="paragraph"><p>Перше питання, з яким ми стикаємося, - це те, що членство в групі динамічне. Кожен сенсорний пристрій представлений актором, який може зупинитися в будь-який час. На початку запиту ми можемо запитати у всіх існуючих акторів пристрою про поточну температуру. Однак протягом життєвого циклу запиту:</p></div>
<div class="ulist"><ul>
<li>
<p>
Актор пристрою може зупинитися і не зможе відповісти на відповідь зчитуванням температури.
</p>
</li>
<li>
<p>
Новий актор пристрою може запуститись і не буде включений у запит, оскільки ми про нього не знали.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Ці питання можна вирішувати різними способами, але важливим моментом є врегулювання бажаної поведінки. У нашому випадку добре робитиме таке:</p></div>
<div class="ulist"><ul>
<li>
<p>
Коли надходить запит, актор групи робить знімок існуючих акторів пристрою і запитує лише цих акторів про температуру.
</p>
</li>
<li>
<p>
Актори, які запускаються після надходження запиту, ігноруються.
</p>
</li>
<li>
<p>
Якщо актор зі знімку зупиняється під час запиту, не відповідаючи, ми повідомляємо про те, що він зупинився відправника повідомлення запиту.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Окрім акторів пристроїв, які динамічно приходять та йдуть, на деякі відповіді може знадобитися багато часу, щоб відповісти. Наприклад, вони можуть застрягнути у випадковому нескінченному циклі або вийти з ладу через помилку та відмовитись від нашого запиту. Ми не хочемо, щоб запит тривав нескінченно, тому вважатимемо його завершеним у будь-якому з наступних випадків:</p></div>
<div class="ulist"><ul>
<li>
<p>
Усі учасники знімка або відповіли, або підтвердили, що їх зупинено.
</p>
</li>
<li>
<p>
Ми досягаємо заздалегідь визначеного ліміту часу.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Враховуючи ці рішення, одночасно із тим, що пристрій зі знімку, можливо, тільки запустився і ще не отримав температуру для запису, ми можемо визначити чотири стани для кожного актора пристрою стосовно температурного запиту:</p></div>
<div class="ulist"><ul>
<li>
<p>
У ньому доступна температура: <code>Temperature</code>.
</p>
</li>
<li>
<p>
Він відповів, але температура ще не доступна: <code>TemperatureNotAvailable</code>.
</p>
</li>
<li>
<p>
Він зупинився, перш ніж відповісти: <code>DeviceNotAvailable</code>.
</p>
</li>
<li>
<p>
Він не відповів до встановленого терміну: <code>DeviceTimedOut</code>.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Підсумовуючи ці типи повідомлень, ми можемо додати до протоколу повідомлень наступне:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">RequestAllTemperatures</span><span class="o">(</span><span class="n">requestId</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span> <span class="n">groupId</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">replyTo</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">RespondAllTemperatures</span><span class="o">])</span>
    <span class="k">extends</span> <span class="nc">DeviceGroupQuery</span><span class="o">.</span><span class="nc">Command</span>
    <span class="k">with</span> <span class="nc">DeviceGroup</span><span class="o">.</span><span class="nc">Command</span>
    <span class="k">with</span> <span class="nc">DeviceManager</span><span class="o">.</span><span class="nc">Command</span>

<span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">RespondAllTemperatures</span><span class="o">(</span><span class="n">requestId</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span> <span class="n">temperatures</span><span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">TemperatureReading</span><span class="o">])</span>

<span class="k">sealed</span> <span class="k">trait</span> <span class="nc">TemperatureReading</span>
<span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">Temperature</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">Double</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">TemperatureReading</span>
<span class="k">case</span> <span class="k">object</span> <span class="nc">TemperatureNotAvailable</span> <span class="k">extends</span> <span class="nc">TemperatureReading</span>
<span class="k">case</span> <span class="k">object</span> <span class="nc">DeviceNotAvailable</span> <span class="k">extends</span> <span class="nc">TemperatureReading</span>
<span class="k">case</span> <span class="k">object</span> <span class="nc">DeviceTimedOut</span> <span class="k">extends</span> <span class="nc">TemperatureReading</span>
</pre></div></div></div>
</div>
<div class="sect2">
<h3 id="___9">Реалізація запиту</h3>
<div class="paragraph"><p>Один із підходів до здійснення запиту включає додавання коду до актора групи пристроїв. Однак на практиці це може бути дуже громіздким і схильним до помилок. Пам’ятайте, що коли ми починаємо запит, нам потрібно зробити знімок присутніх пристроїв і запустити таймер, щоб ми могли застосувати термін. Тим часом може надійти ще один запит. Для другого запиту нам слід відслідковувати точно таку ж інформацію, але у відриві від попереднього запиту. Це вимагає від нас збереження окремих відображень між запитами та акторами пристроїв.</p></div>
<div class="paragraph"><p>Натомість ми застосуємо більш простий та кращий підхід. Ми створимо актора, який представляє єдиний запит, який виконує завдання, необхідні для заповнення запиту від імені актора групи. Поки ми створювали акторів, які належали до класичних об'єктів домену, але зараз ми створимо актора, який представляє процес чи завдання, а не сутність. Ми отримуємо вигоду, тримаючи простий актор групи пристроїв та покращуючи можливість перевірки можливостей запиту.</p></div>
</div>
<div class="sect2">
<h3 id="____5">Визначення актора запиту</h3>
<div class="paragraph"><p>По-перше, нам потрібно розробити життєвий цикл нашого актора запиту. Це складається з виявлення його початкового стану, першої дії, яку він вживе, та очищення - якщо необхідно. Актору запиту знадобиться така інформація:</p></div>
<div class="ulist"><ul>
<li>
<p>
Знімок та ідентифікатори активних акторів пристрою для запиту.
</p>
</li>
<li>
<p>
Ідентифікатор запиту, який розпочав запит (щоб ми могли включити його у відповідь).
</p>
</li>
<li>
<p>
Посилання актора, який надіслав запит. Відповідь ми надішлемо цьому актору напряму.
</p>
</li>
<li>
<p>
Кінцевий термін, який вказує, як довго запит повинен чекати відповідей. Створення його як параметра спростить тестування.
</p>
</li>
</ul></div>
<div class="sect3">
<h4 id="_____5">Планування часу очікування запиту</h4>
<div class="paragraph"><p>Оскільки нам потрібен спосіб вказати, як довго ми готові чекати відповідей, настав час ввести нову функцію Akka, яку ми ще не використовували, вбудований інструмент планування. Використання <code>Behaviors.withTimers</code> та <code>startSingleTimer</code> для планування повідомлення, яке буде надіслане після заданої затримки.</p></div>
<div class="paragraph"><p>Нам потрібно створити повідомлення, яке представляє час очікування запиту. Для цього ми створюємо просте повідомлення <code>CollectionTimeout</code> без будь-яких параметрів.</p></div>
<div class="paragraph"><p>На початку запиту нам потрібно спитати у кожного з акторів пристрою про поточну температуру. Щоб мати можливість швидко виявити пристрої, які зупинилися, перш ніж вони отримали повідомлення <code>ReadTemperature</code>, ми також будемо спостерігати за кожним з акторів. Таким чином, ми отримуємо <code>DeviceTerminated</code> повідомлення для тих, хто зупиняється протягом життя запиту, тому нам не потрібно чекати таймауту, щоб позначити їх як недоступні.</p></div>
<div class="paragraph"><p>Збираючи це разом, контур нашого актора <code>DeviceGroupQuery</code> виглядає так:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">object</span> <span class="nc">DeviceGroupQuery</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span>
      <span class="n">deviceIdToActor</span><span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">Device.Command</span><span class="o">]],</span>
      <span class="n">requestId</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span>
      <span class="n">requester</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">DeviceManager.RespondAllTemperatures</span><span class="o">],</span>
      <span class="n">timeout</span><span class="k">:</span> <span class="kt">FiniteDuration</span><span class="o">)</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">Command</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="nc">Behaviors</span><span class="o">.</span><span class="n">setup</span> <span class="o">{</span> <span class="n">context</span> <span class="k">=&gt;</span>
      <span class="nc">Behaviors</span><span class="o">.</span><span class="n">withTimers</span> <span class="o">{</span> <span class="n">timers</span> <span class="k">=&gt;</span>
        <span class="k">new</span> <span class="nc">DeviceGroupQuery</span><span class="o">(</span><span class="n">deviceIdToActor</span><span class="o">,</span> <span class="n">requestId</span><span class="o">,</span> <span class="n">requester</span><span class="o">,</span> <span class="n">timeout</span><span class="o">,</span> <span class="n">context</span><span class="o">,</span> <span class="n">timers</span><span class="o">)</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">trait</span> <span class="nc">Command</span>

  <span class="k">private</span> <span class="k">case</span> <span class="k">object</span> <span class="nc">CollectionTimeout</span> <span class="k">extends</span> <span class="nc">Command</span>

  <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">WrappedRespondTemperature</span><span class="o">(</span><span class="n">response</span><span class="k">:</span> <span class="kt">Device.RespondTemperature</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Command</span>

  <span class="k">private</span> <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">DeviceTerminated</span><span class="o">(</span><span class="n">deviceId</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Command</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">DeviceGroupQuery</span><span class="o">(</span>
    <span class="n">deviceIdToActor</span><span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">Device.Command</span><span class="o">]],</span>
    <span class="n">requestId</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span>
    <span class="n">requester</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">DeviceManager.RespondAllTemperatures</span><span class="o">],</span>
    <span class="n">timeout</span><span class="k">:</span> <span class="kt">FiniteDuration</span><span class="o">,</span>
    <span class="n">context</span><span class="k">:</span> <span class="kt">ActorContext</span><span class="o">[</span><span class="kt">DeviceGroupQuery.Command</span><span class="o">],</span>
    <span class="n">timers</span><span class="k">:</span> <span class="kt">TimerScheduler</span><span class="o">[</span><span class="kt">DeviceGroupQuery.Command</span><span class="o">])</span>
    <span class="k">extends</span> <span class="nc">AbstractBehavior</span><span class="o">[</span><span class="kt">DeviceGroupQuery.Command</span><span class="o">](</span><span class="n">context</span><span class="o">)</span> <span class="o">{</span>

  <span class="k">import</span> <span class="nn">DeviceGroupQuery._</span>
  <span class="k">import</span> <span class="nn">DeviceManager.DeviceNotAvailable</span>
  <span class="k">import</span> <span class="nn">DeviceManager.DeviceTimedOut</span>
  <span class="k">import</span> <span class="nn">DeviceManager.RespondAllTemperatures</span>
  <span class="k">import</span> <span class="nn">DeviceManager.Temperature</span>
  <span class="k">import</span> <span class="nn">DeviceManager.TemperatureNotAvailable</span>
  <span class="k">import</span> <span class="nn">DeviceManager.TemperatureReading</span>

  <span class="n">timers</span><span class="o">.</span><span class="n">startSingleTimer</span><span class="o">(</span><span class="nc">CollectionTimeout</span><span class="o">,</span> <span class="nc">CollectionTimeout</span><span class="o">,</span> <span class="n">timeout</span><span class="o">)</span>

  <span class="k">private</span> <span class="k">val</span> <span class="n">respondTemperatureAdapter</span> <span class="k">=</span> <span class="n">context</span><span class="o">.</span><span class="n">messageAdapter</span><span class="o">(</span><span class="nc">WrappedRespondTemperature</span><span class="o">.</span><span class="n">apply</span><span class="o">)</span>


  <span class="n">deviceIdToActor</span><span class="o">.</span><span class="n">foreach</span> <span class="o">{</span>
    <span class="k">case</span> <span class="o">(</span><span class="n">deviceId</span><span class="o">,</span> <span class="n">device</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="n">context</span><span class="o">.</span><span class="n">watchWith</span><span class="o">(</span><span class="n">device</span><span class="o">,</span> <span class="nc">DeviceTerminated</span><span class="o">(</span><span class="n">deviceId</span><span class="o">))</span>
      <span class="n">device</span> <span class="o">!</span> <span class="nc">Device</span><span class="o">.</span><span class="nc">ReadTemperature</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">respondTemperatureAdapter</span><span class="o">)</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Зауважте, що ми повинні перетворити відповіді <code>RespondTemperature</code> з актора пристрою в протокол повідомлення, який розуміє актор <code>DeviceGroupQuery</code>, тобто <code>DeviceGroupQueryMessage</code>. Для цього ми використовуємо <code>messageAdapter</code>, який загортає <code>RespondTemperature</code> в <code>WrappedRespondTemperature</code>, яка розширює <code>DeviceGroupQueryMessage</code>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="____6">Відстеження стану актора</h3>
<div class="paragraph"><p>Актор запиту, крім таймера, що очікує на розгляд, має ще один важливий аспект, відстежуючи набір акторів, які: відповіли, зупинились чи не відповіли. Ми відстежуємо цей стан у <code>var</code> полі незмінної <code>Map</code> в акторі.</p></div>
<div class="paragraph"><p>Для нашого випадку використання:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Ми стежимо за станом:
</p>
<div class="ulist"><ul>
<li>
<p>
<code>Map</code> вже отриманих відповідей
</p>
</li>
<li>
<p>
<code>Set</code> акторів, яких ми ще чекаємо
</p>
</li>
</ul></div>
</li>
<li>
<p>
У нас є три події для дій:
</p>
<div class="ulist"><ul>
<li>
<p>
Ми можемо отримати повідомлення <code>RespondTemperature</code> від одного з пристроїв.
</p>
</li>
<li>
<p>
Ми можемо отримати повідомлення <code>DeviceTerminated</code> для актора пристрою, яке тим часом зупинено.
</p>
</li>
<li>
<p>
Ми можемо досягти граничного терміну та отримати <code>CollectionTimeout</code>.
</p>
</li>
</ul></div>
</li>
</ol></div>
<div class="paragraph"><p>Для цього додайте у вихідний файл <code>DeviceGroupQuery</code> наступне:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">private</span> <span class="k">var</span> <span class="n">repliesSoFar</span> <span class="k">=</span> <span class="nc">Map</span><span class="o">.</span><span class="n">empty</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">TemperatureReading</span><span class="o">]</span>
<span class="k">private</span> <span class="k">var</span> <span class="n">stillWaiting</span> <span class="k">=</span> <span class="n">deviceIdToActor</span><span class="o">.</span><span class="n">keySet</span>

<span class="k">override</span> <span class="k">def</span> <span class="n">onMessage</span><span class="o">(</span><span class="n">msg</span><span class="k">:</span> <span class="kt">Command</span><span class="o">)</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">Command</span><span class="o">]</span> <span class="k">=</span>
  <span class="n">msg</span> <span class="k">match</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">WrappedRespondTemperature</span><span class="o">(</span><span class="n">response</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">onRespondTemperature</span><span class="o">(</span><span class="n">response</span><span class="o">)</span>
    <span class="k">case</span> <span class="nc">DeviceTerminated</span><span class="o">(</span><span class="n">deviceId</span><span class="o">)</span>          <span class="k">=&gt;</span> <span class="n">onDeviceTerminated</span><span class="o">(</span><span class="n">deviceId</span><span class="o">)</span>
    <span class="k">case</span> <span class="nc">CollectionTimeout</span>                   <span class="k">=&gt;</span> <span class="n">onCollectionTimout</span><span class="o">()</span>
  <span class="o">}</span>

<span class="k">private</span> <span class="k">def</span> <span class="n">onRespondTemperature</span><span class="o">(</span><span class="n">response</span><span class="k">:</span> <span class="kt">Device.RespondTemperature</span><span class="o">)</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">Command</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">reading</span> <span class="k">=</span> <span class="n">response</span><span class="o">.</span><span class="n">value</span> <span class="k">match</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">value</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Temperature</span><span class="o">(</span><span class="n">value</span><span class="o">)</span>
    <span class="k">case</span> <span class="nc">None</span>        <span class="k">=&gt;</span> <span class="nc">TemperatureNotAvailable</span>
  <span class="o">}</span>

  <span class="k">val</span> <span class="n">deviceId</span> <span class="k">=</span> <span class="n">response</span><span class="o">.</span><span class="n">deviceId</span>
  <span class="n">repliesSoFar</span> <span class="o">+=</span> <span class="o">(</span><span class="n">deviceId</span> <span class="o">-&gt;</span> <span class="n">reading</span><span class="o">)</span>
  <span class="n">stillWaiting</span> <span class="o">-=</span> <span class="n">deviceId</span>

  <span class="n">respondWhenAllCollected</span><span class="o">()</span>
<span class="o">}</span>

<span class="k">private</span> <span class="k">def</span> <span class="n">onDeviceTerminated</span><span class="o">(</span><span class="n">deviceId</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">Command</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">stillWaiting</span><span class="o">(</span><span class="n">deviceId</span><span class="o">))</span> <span class="o">{</span>
    <span class="n">repliesSoFar</span> <span class="o">+=</span> <span class="o">(</span><span class="n">deviceId</span> <span class="o">-&gt;</span> <span class="nc">DeviceNotAvailable</span><span class="o">)</span>
    <span class="n">stillWaiting</span> <span class="o">-=</span> <span class="n">deviceId</span>
  <span class="o">}</span>
  <span class="n">respondWhenAllCollected</span><span class="o">()</span>
<span class="o">}</span>

<span class="k">private</span> <span class="k">def</span> <span class="n">onCollectionTimout</span><span class="o">()</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">Command</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="n">repliesSoFar</span> <span class="o">++=</span> <span class="n">stillWaiting</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">deviceId</span> <span class="k">=&gt;</span> <span class="n">deviceId</span> <span class="o">-&gt;</span> <span class="nc">DeviceTimedOut</span><span class="o">)</span>
  <span class="n">stillWaiting</span> <span class="k">=</span> <span class="nc">Set</span><span class="o">.</span><span class="n">empty</span>
  <span class="n">respondWhenAllCollected</span><span class="o">()</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Для <code>RespondTemperature</code> та <code>DeviceTerminated</code> ми відстежуємо відповіді через оновлення <code>repliesSoFar</code>, та видаляємо актора з <code>stillWaiting</code>. Для цього ми можемо використовувати ідентифікатор актора, який вже присутній у повідомленні <code>DeviceTerminated</code>. Для нашого повідомлення <code>RespondTemperature</code> нам потрібно буде додати цю інформацію наступним чином:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">RespondTemperature</span><span class="o">(</span><span class="n">requestId</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span> <span class="n">deviceId</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">value</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">Double</span><span class="o">])</span>
</pre></div></div></div>
<div class="paragraph"><p>Та:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">case</span> <span class="nc">ReadTemperature</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">replyTo</span><span class="o">)</span> <span class="k">=&gt;</span>
  <span class="n">replyTo</span> <span class="o">!</span> <span class="nc">RespondTemperature</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">deviceId</span><span class="o">,</span> <span class="n">lastTemperatureReading</span><span class="o">)</span>
  <span class="k">this</span>
</pre></div></div></div>
<div class="paragraph"><p>Після обробки кожного повідомлення ми делегуємо методу <code>responseWhenAllCollected</code>, який ми обговоримо найближчим часом.</p></div>
<div class="paragraph"><p>У випадку тайм-ауту нам потрібно взяти всіх учасників, які ще не відповіли (члени <code>stillWaiting</code>) і поставити <code>DeviceTimedOut</code> як статус у остаточній відповіді.</p></div>
<div class="paragraph"><p>Тепер ми повинні розібратися, що робити у respondWhenAllCollected. По-перше, нам потрібно записати новий результат в мапу <code>repliesSoFar</code>,та видалити актора з <code>stillWaiting</code>. Наступний крок - перевірити, чи є ще актори, яких ми чекаємо. Якщо таких немає, ми надсилаємо результат запиту оригінальному запитувачу та зупиняємо актора запиту. В іншому випадку нам потрібно оновити структури <code>repliesSoFar</code> та  <code>stillWaiting</code>, та чекати додаткових повідомлень.</p></div>
<div class="paragraph"><p>Маючи всі ці знання, ми можемо створити метод <code>respoWhenAllCollected</code>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">private</span> <span class="k">def</span> <span class="n">respondWhenAllCollected</span><span class="o">()</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">Command</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">stillWaiting</span><span class="o">.</span><span class="n">isEmpty</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">requester</span> <span class="o">!</span> <span class="nc">RespondAllTemperatures</span><span class="o">(</span><span class="n">requestId</span><span class="o">,</span> <span class="n">repliesSoFar</span><span class="o">)</span>
    <span class="nc">Behaviors</span><span class="o">.</span><span class="n">stopped</span>
  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="k">this</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Зараз наш актор запитів виконаний:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">object</span> <span class="nc">DeviceGroupQuery</span> <span class="o">{</span>

  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span>
      <span class="n">deviceIdToActor</span><span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">Device.Command</span><span class="o">]],</span>
      <span class="n">requestId</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span>
      <span class="n">requester</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">DeviceManager.RespondAllTemperatures</span><span class="o">],</span>
      <span class="n">timeout</span><span class="k">:</span> <span class="kt">FiniteDuration</span><span class="o">)</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">Command</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="nc">Behaviors</span><span class="o">.</span><span class="n">setup</span> <span class="o">{</span> <span class="n">context</span> <span class="k">=&gt;</span>
      <span class="nc">Behaviors</span><span class="o">.</span><span class="n">withTimers</span> <span class="o">{</span> <span class="n">timers</span> <span class="k">=&gt;</span>
        <span class="k">new</span> <span class="nc">DeviceGroupQuery</span><span class="o">(</span><span class="n">deviceIdToActor</span><span class="o">,</span> <span class="n">requestId</span><span class="o">,</span> <span class="n">requester</span><span class="o">,</span> <span class="n">timeout</span><span class="o">,</span> <span class="n">context</span><span class="o">,</span> <span class="n">timers</span><span class="o">)</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">trait</span> <span class="nc">Command</span>

  <span class="k">private</span> <span class="k">case</span> <span class="k">object</span> <span class="nc">CollectionTimeout</span> <span class="k">extends</span> <span class="nc">Command</span>

  <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">WrappedRespondTemperature</span><span class="o">(</span><span class="n">response</span><span class="k">:</span> <span class="kt">Device.RespondTemperature</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Command</span>

  <span class="k">private</span> <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">DeviceTerminated</span><span class="o">(</span><span class="n">deviceId</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Command</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">DeviceGroupQuery</span><span class="o">(</span>
    <span class="n">deviceIdToActor</span><span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">Device.Command</span><span class="o">]],</span>
    <span class="n">requestId</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span>
    <span class="n">requester</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">DeviceManager.RespondAllTemperatures</span><span class="o">],</span>
    <span class="n">timeout</span><span class="k">:</span> <span class="kt">FiniteDuration</span><span class="o">,</span>
    <span class="n">context</span><span class="k">:</span> <span class="kt">ActorContext</span><span class="o">[</span><span class="kt">DeviceGroupQuery.Command</span><span class="o">],</span>
    <span class="n">timers</span><span class="k">:</span> <span class="kt">TimerScheduler</span><span class="o">[</span><span class="kt">DeviceGroupQuery.Command</span><span class="o">])</span>
    <span class="k">extends</span> <span class="nc">AbstractBehavior</span><span class="o">[</span><span class="kt">DeviceGroupQuery.Command</span><span class="o">](</span><span class="n">context</span><span class="o">)</span> <span class="o">{</span>

  <span class="k">import</span> <span class="nn">DeviceGroupQuery._</span>
  <span class="k">import</span> <span class="nn">DeviceManager.DeviceNotAvailable</span>
  <span class="k">import</span> <span class="nn">DeviceManager.DeviceTimedOut</span>
  <span class="k">import</span> <span class="nn">DeviceManager.RespondAllTemperatures</span>
  <span class="k">import</span> <span class="nn">DeviceManager.Temperature</span>
  <span class="k">import</span> <span class="nn">DeviceManager.TemperatureNotAvailable</span>
  <span class="k">import</span> <span class="nn">DeviceManager.TemperatureReading</span>

  <span class="n">timers</span><span class="o">.</span><span class="n">startSingleTimer</span><span class="o">(</span><span class="nc">CollectionTimeout</span><span class="o">,</span> <span class="nc">CollectionTimeout</span><span class="o">,</span> <span class="n">timeout</span><span class="o">)</span>

  <span class="k">private</span> <span class="k">val</span> <span class="n">respondTemperatureAdapter</span> <span class="k">=</span> <span class="n">context</span><span class="o">.</span><span class="n">messageAdapter</span><span class="o">(</span><span class="nc">WrappedRespondTemperature</span><span class="o">.</span><span class="n">apply</span><span class="o">)</span>

  <span class="k">private</span> <span class="k">var</span> <span class="n">repliesSoFar</span> <span class="k">=</span> <span class="nc">Map</span><span class="o">.</span><span class="n">empty</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">TemperatureReading</span><span class="o">]</span>
  <span class="k">private</span> <span class="k">var</span> <span class="n">stillWaiting</span> <span class="k">=</span> <span class="n">deviceIdToActor</span><span class="o">.</span><span class="n">keySet</span>


  <span class="n">deviceIdToActor</span><span class="o">.</span><span class="n">foreach</span> <span class="o">{</span>
    <span class="k">case</span> <span class="o">(</span><span class="n">deviceId</span><span class="o">,</span> <span class="n">device</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="n">context</span><span class="o">.</span><span class="n">watchWith</span><span class="o">(</span><span class="n">device</span><span class="o">,</span> <span class="nc">DeviceTerminated</span><span class="o">(</span><span class="n">deviceId</span><span class="o">))</span>
      <span class="n">device</span> <span class="o">!</span> <span class="nc">Device</span><span class="o">.</span><span class="nc">ReadTemperature</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">respondTemperatureAdapter</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">onMessage</span><span class="o">(</span><span class="n">msg</span><span class="k">:</span> <span class="kt">Command</span><span class="o">)</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">Command</span><span class="o">]</span> <span class="k">=</span>
    <span class="n">msg</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">WrappedRespondTemperature</span><span class="o">(</span><span class="n">response</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">onRespondTemperature</span><span class="o">(</span><span class="n">response</span><span class="o">)</span>
      <span class="k">case</span> <span class="nc">DeviceTerminated</span><span class="o">(</span><span class="n">deviceId</span><span class="o">)</span>          <span class="k">=&gt;</span> <span class="n">onDeviceTerminated</span><span class="o">(</span><span class="n">deviceId</span><span class="o">)</span>
      <span class="k">case</span> <span class="nc">CollectionTimeout</span>                   <span class="k">=&gt;</span> <span class="n">onCollectionTimout</span><span class="o">()</span>
    <span class="o">}</span>

  <span class="k">private</span> <span class="k">def</span> <span class="n">onRespondTemperature</span><span class="o">(</span><span class="n">response</span><span class="k">:</span> <span class="kt">Device.RespondTemperature</span><span class="o">)</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">Command</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">reading</span> <span class="k">=</span> <span class="n">response</span><span class="o">.</span><span class="n">value</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">value</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Temperature</span><span class="o">(</span><span class="n">value</span><span class="o">)</span>
      <span class="k">case</span> <span class="nc">None</span>        <span class="k">=&gt;</span> <span class="nc">TemperatureNotAvailable</span>
    <span class="o">}</span>

    <span class="k">val</span> <span class="n">deviceId</span> <span class="k">=</span> <span class="n">response</span><span class="o">.</span><span class="n">deviceId</span>
    <span class="n">repliesSoFar</span> <span class="o">+=</span> <span class="o">(</span><span class="n">deviceId</span> <span class="o">-&gt;</span> <span class="n">reading</span><span class="o">)</span>
    <span class="n">stillWaiting</span> <span class="o">-=</span> <span class="n">deviceId</span>

    <span class="n">respondWhenAllCollected</span><span class="o">()</span>
  <span class="o">}</span>

  <span class="k">private</span> <span class="k">def</span> <span class="n">onDeviceTerminated</span><span class="o">(</span><span class="n">deviceId</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">Command</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">stillWaiting</span><span class="o">(</span><span class="n">deviceId</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">repliesSoFar</span> <span class="o">+=</span> <span class="o">(</span><span class="n">deviceId</span> <span class="o">-&gt;</span> <span class="nc">DeviceNotAvailable</span><span class="o">)</span>
      <span class="n">stillWaiting</span> <span class="o">-=</span> <span class="n">deviceId</span>
    <span class="o">}</span>
    <span class="n">respondWhenAllCollected</span><span class="o">()</span>
  <span class="o">}</span>

  <span class="k">private</span> <span class="k">def</span> <span class="n">onCollectionTimout</span><span class="o">()</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">Command</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="n">repliesSoFar</span> <span class="o">++=</span> <span class="n">stillWaiting</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">deviceId</span> <span class="k">=&gt;</span> <span class="n">deviceId</span> <span class="o">-&gt;</span> <span class="nc">DeviceTimedOut</span><span class="o">)</span>
    <span class="n">stillWaiting</span> <span class="k">=</span> <span class="nc">Set</span><span class="o">.</span><span class="n">empty</span>
    <span class="n">respondWhenAllCollected</span><span class="o">()</span>
  <span class="o">}</span>

  <span class="k">private</span> <span class="k">def</span> <span class="n">respondWhenAllCollected</span><span class="o">()</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">Command</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">stillWaiting</span><span class="o">.</span><span class="n">isEmpty</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">requester</span> <span class="o">!</span> <span class="nc">RespondAllTemperatures</span><span class="o">(</span><span class="n">requestId</span><span class="o">,</span> <span class="n">repliesSoFar</span><span class="o">)</span>
      <span class="nc">Behaviors</span><span class="o">.</span><span class="n">stopped</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="k">this</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
</div>
<div class="sect2">
<h3 id="____7">Тестування актора запиту</h3>
<div class="paragraph"><p>Тепер давайте перевіримо правильність виконання акторів запитів. Існують різні сценарії, які нам потрібно перевірити індивідуально, щоб переконатися, що все працює так, як очікувалося. Для того, щоб зробити це, нам потрібно якось імітувати дійових осіб пристрою, щоб виконувати різні нормальні сценарії чи збої. На щастя, ми взяли список співпрацівників (фактично <code>Map</code>) як параметр для актора запитів, тому ми можемо передати посилання на <code>TestProbe</code>. У нашому першому тесті ми перевіряємо випадок, коли є два пристрої, і обидва повідомляють про температуру:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="s">&quot;return temperature value for working devices&quot;</span> <span class="n">in</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">requester</span> <span class="k">=</span> <span class="n">createTestProbe</span><span class="o">[</span><span class="kt">RespondAllTemperatures</span><span class="o">]()</span>

  <span class="k">val</span> <span class="n">device1</span> <span class="k">=</span> <span class="n">createTestProbe</span><span class="o">[</span><span class="kt">Command</span><span class="o">]()</span>
  <span class="k">val</span> <span class="n">device2</span> <span class="k">=</span> <span class="n">createTestProbe</span><span class="o">[</span><span class="kt">Command</span><span class="o">]()</span>

  <span class="k">val</span> <span class="n">deviceIdToActor</span> <span class="k">=</span> <span class="nc">Map</span><span class="o">(</span><span class="s">&quot;device1&quot;</span> <span class="o">-&gt;</span> <span class="n">device1</span><span class="o">.</span><span class="n">ref</span><span class="o">,</span> <span class="s">&quot;device2&quot;</span> <span class="o">-&gt;</span> <span class="n">device2</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span>

  <span class="k">val</span> <span class="n">queryActor</span> <span class="k">=</span>
    <span class="n">spawn</span><span class="o">(</span><span class="nc">DeviceGroupQuery</span><span class="o">(</span><span class="n">deviceIdToActor</span><span class="o">,</span> <span class="n">requestId</span> <span class="k">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">requester</span> <span class="k">=</span> <span class="n">requester</span><span class="o">.</span><span class="n">ref</span><span class="o">,</span> <span class="n">timeout</span> <span class="k">=</span> <span class="mf">3.</span><span class="n">seconds</span><span class="o">))</span>

  <span class="n">device1</span><span class="o">.</span><span class="n">expectMessageType</span><span class="o">[</span><span class="kt">Device.ReadTemperature</span><span class="o">]</span>
  <span class="n">device2</span><span class="o">.</span><span class="n">expectMessageType</span><span class="o">[</span><span class="kt">Device.ReadTemperature</span><span class="o">]</span>

  <span class="n">queryActor</span> <span class="o">!</span> <span class="nc">WrappedRespondTemperature</span><span class="o">(</span><span class="nc">Device</span><span class="o">.</span><span class="nc">RespondTemperature</span><span class="o">(</span><span class="n">requestId</span> <span class="k">=</span> <span class="mi">0</span><span class="o">,</span> <span class="s">&quot;device1&quot;</span><span class="o">,</span> <span class="nc">Some</span><span class="o">(</span><span class="mf">1.0</span><span class="o">)))</span>
  <span class="n">queryActor</span> <span class="o">!</span> <span class="nc">WrappedRespondTemperature</span><span class="o">(</span><span class="nc">Device</span><span class="o">.</span><span class="nc">RespondTemperature</span><span class="o">(</span><span class="n">requestId</span> <span class="k">=</span> <span class="mi">0</span><span class="o">,</span> <span class="s">&quot;device2&quot;</span><span class="o">,</span> <span class="nc">Some</span><span class="o">(</span><span class="mf">2.0</span><span class="o">)))</span>

  <span class="n">requester</span><span class="o">.</span><span class="n">expectMessage</span><span class="o">(</span>
    <span class="nc">RespondAllTemperatures</span><span class="o">(</span>
      <span class="n">requestId</span> <span class="k">=</span> <span class="mi">1</span><span class="o">,</span>
      <span class="n">temperatures</span> <span class="k">=</span> <span class="nc">Map</span><span class="o">(</span><span class="s">&quot;device1&quot;</span> <span class="o">-&gt;</span> <span class="nc">Temperature</span><span class="o">(</span><span class="mf">1.0</span><span class="o">),</span> <span class="s">&quot;device2&quot;</span> <span class="o">-&gt;</span> <span class="nc">Temperature</span><span class="o">(</span><span class="mf">2.0</span><span class="o">))))</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Це було щасливим випадком, але ми знаємо, що іноді пристрої не можуть забезпечити вимірювання температури. Цей сценарій трохи відрізняється від попереднього:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="s">&quot;return TemperatureNotAvailable for devices with no readings&quot;</span> <span class="n">in</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">requester</span> <span class="k">=</span> <span class="n">createTestProbe</span><span class="o">[</span><span class="kt">RespondAllTemperatures</span><span class="o">]()</span>

  <span class="k">val</span> <span class="n">device1</span> <span class="k">=</span> <span class="n">createTestProbe</span><span class="o">[</span><span class="kt">Command</span><span class="o">]()</span>
  <span class="k">val</span> <span class="n">device2</span> <span class="k">=</span> <span class="n">createTestProbe</span><span class="o">[</span><span class="kt">Command</span><span class="o">]()</span>

  <span class="k">val</span> <span class="n">deviceIdToActor</span> <span class="k">=</span> <span class="nc">Map</span><span class="o">(</span><span class="s">&quot;device1&quot;</span> <span class="o">-&gt;</span> <span class="n">device1</span><span class="o">.</span><span class="n">ref</span><span class="o">,</span> <span class="s">&quot;device2&quot;</span> <span class="o">-&gt;</span> <span class="n">device2</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span>

  <span class="k">val</span> <span class="n">queryActor</span> <span class="k">=</span>
    <span class="n">spawn</span><span class="o">(</span><span class="nc">DeviceGroupQuery</span><span class="o">(</span><span class="n">deviceIdToActor</span><span class="o">,</span> <span class="n">requestId</span> <span class="k">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">requester</span> <span class="k">=</span> <span class="n">requester</span><span class="o">.</span><span class="n">ref</span><span class="o">,</span> <span class="n">timeout</span> <span class="k">=</span> <span class="mf">3.</span><span class="n">seconds</span><span class="o">))</span>

  <span class="n">device1</span><span class="o">.</span><span class="n">expectMessageType</span><span class="o">[</span><span class="kt">Device.ReadTemperature</span><span class="o">]</span>
  <span class="n">device2</span><span class="o">.</span><span class="n">expectMessageType</span><span class="o">[</span><span class="kt">Device.ReadTemperature</span><span class="o">]</span>

  <span class="n">queryActor</span> <span class="o">!</span> <span class="nc">WrappedRespondTemperature</span><span class="o">(</span><span class="nc">Device</span><span class="o">.</span><span class="nc">RespondTemperature</span><span class="o">(</span><span class="n">requestId</span> <span class="k">=</span> <span class="mi">0</span><span class="o">,</span> <span class="s">&quot;device1&quot;</span><span class="o">,</span> <span class="nc">None</span><span class="o">))</span>
  <span class="n">queryActor</span> <span class="o">!</span> <span class="nc">WrappedRespondTemperature</span><span class="o">(</span><span class="nc">Device</span><span class="o">.</span><span class="nc">RespondTemperature</span><span class="o">(</span><span class="n">requestId</span> <span class="k">=</span> <span class="mi">0</span><span class="o">,</span> <span class="s">&quot;device2&quot;</span><span class="o">,</span> <span class="nc">Some</span><span class="o">(</span><span class="mf">2.0</span><span class="o">)))</span>

  <span class="n">requester</span><span class="o">.</span><span class="n">expectMessage</span><span class="o">(</span>
    <span class="nc">RespondAllTemperatures</span><span class="o">(</span>
      <span class="n">requestId</span> <span class="k">=</span> <span class="mi">1</span><span class="o">,</span>
      <span class="n">temperatures</span> <span class="k">=</span> <span class="nc">Map</span><span class="o">(</span><span class="s">&quot;device1&quot;</span> <span class="o">-&gt;</span> <span class="nc">TemperatureNotAvailable</span><span class="o">,</span> <span class="s">&quot;device2&quot;</span> <span class="o">-&gt;</span> <span class="nc">Temperature</span><span class="o">(</span><span class="mf">2.0</span><span class="o">))))</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Ми також знаємо, що іноді актори пристрою зупиняються, перш ніж відповісти:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="s">&quot;return DeviceNotAvailable if device stops before answering&quot;</span> <span class="n">in</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">requester</span> <span class="k">=</span> <span class="n">createTestProbe</span><span class="o">[</span><span class="kt">RespondAllTemperatures</span><span class="o">]()</span>

  <span class="k">val</span> <span class="n">device1</span> <span class="k">=</span> <span class="n">createTestProbe</span><span class="o">[</span><span class="kt">Command</span><span class="o">]()</span>
  <span class="k">val</span> <span class="n">device2</span> <span class="k">=</span> <span class="n">createTestProbe</span><span class="o">[</span><span class="kt">Command</span><span class="o">]()</span>

  <span class="k">val</span> <span class="n">deviceIdToActor</span> <span class="k">=</span> <span class="nc">Map</span><span class="o">(</span><span class="s">&quot;device1&quot;</span> <span class="o">-&gt;</span> <span class="n">device1</span><span class="o">.</span><span class="n">ref</span><span class="o">,</span> <span class="s">&quot;device2&quot;</span> <span class="o">-&gt;</span> <span class="n">device2</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span>

  <span class="k">val</span> <span class="n">queryActor</span> <span class="k">=</span>
    <span class="n">spawn</span><span class="o">(</span><span class="nc">DeviceGroupQuery</span><span class="o">(</span><span class="n">deviceIdToActor</span><span class="o">,</span> <span class="n">requestId</span> <span class="k">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">requester</span> <span class="k">=</span> <span class="n">requester</span><span class="o">.</span><span class="n">ref</span><span class="o">,</span> <span class="n">timeout</span> <span class="k">=</span> <span class="mf">3.</span><span class="n">seconds</span><span class="o">))</span>

  <span class="n">device1</span><span class="o">.</span><span class="n">expectMessageType</span><span class="o">[</span><span class="kt">Device.ReadTemperature</span><span class="o">]</span>
  <span class="n">device2</span><span class="o">.</span><span class="n">expectMessageType</span><span class="o">[</span><span class="kt">Device.ReadTemperature</span><span class="o">]</span>

  <span class="n">queryActor</span> <span class="o">!</span> <span class="nc">WrappedRespondTemperature</span><span class="o">(</span><span class="nc">Device</span><span class="o">.</span><span class="nc">RespondTemperature</span><span class="o">(</span><span class="n">requestId</span> <span class="k">=</span> <span class="mi">0</span><span class="o">,</span> <span class="s">&quot;device1&quot;</span><span class="o">,</span> <span class="nc">Some</span><span class="o">(</span><span class="mf">2.0</span><span class="o">)))</span>

  <span class="n">device2</span><span class="o">.</span><span class="n">stop</span><span class="o">()</span>

  <span class="n">requester</span><span class="o">.</span><span class="n">expectMessage</span><span class="o">(</span>
    <span class="nc">RespondAllTemperatures</span><span class="o">(</span>
      <span class="n">requestId</span> <span class="k">=</span> <span class="mi">1</span><span class="o">,</span>
      <span class="n">temperatures</span> <span class="k">=</span> <span class="nc">Map</span><span class="o">(</span><span class="s">&quot;device1&quot;</span> <span class="o">-&gt;</span> <span class="nc">Temperature</span><span class="o">(</span><span class="mf">2.0</span><span class="o">),</span> <span class="s">&quot;device2&quot;</span> <span class="o">-&gt;</span> <span class="nc">DeviceNotAvailable</span><span class="o">)))</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Якщо ви пам’ятаєте, є ще один випадок, пов’язаний із зупинкою акторів пристроїв. Цілком можливо, що ми отримаємо звичайну відповідь від актора пристрою, але потім отримаємо припинене для того ж актора пізніше. У цьому випадку ми хочемо зберегти першу відповідь і не позначати пристрій як <code>DeviceNotAvailable</code>. Ми також повинні перевірити це:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="s">&quot;return temperature reading even if device stops after answering&quot;</span> <span class="n">in</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">requester</span> <span class="k">=</span> <span class="n">createTestProbe</span><span class="o">[</span><span class="kt">RespondAllTemperatures</span><span class="o">]()</span>

  <span class="k">val</span> <span class="n">device1</span> <span class="k">=</span> <span class="n">createTestProbe</span><span class="o">[</span><span class="kt">Command</span><span class="o">]()</span>
  <span class="k">val</span> <span class="n">device2</span> <span class="k">=</span> <span class="n">createTestProbe</span><span class="o">[</span><span class="kt">Command</span><span class="o">]()</span>

  <span class="k">val</span> <span class="n">deviceIdToActor</span> <span class="k">=</span> <span class="nc">Map</span><span class="o">(</span><span class="s">&quot;device1&quot;</span> <span class="o">-&gt;</span> <span class="n">device1</span><span class="o">.</span><span class="n">ref</span><span class="o">,</span> <span class="s">&quot;device2&quot;</span> <span class="o">-&gt;</span> <span class="n">device2</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span>

  <span class="k">val</span> <span class="n">queryActor</span> <span class="k">=</span>
    <span class="n">spawn</span><span class="o">(</span><span class="nc">DeviceGroupQuery</span><span class="o">(</span><span class="n">deviceIdToActor</span><span class="o">,</span> <span class="n">requestId</span> <span class="k">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">requester</span> <span class="k">=</span> <span class="n">requester</span><span class="o">.</span><span class="n">ref</span><span class="o">,</span> <span class="n">timeout</span> <span class="k">=</span> <span class="mf">3.</span><span class="n">seconds</span><span class="o">))</span>

  <span class="n">device1</span><span class="o">.</span><span class="n">expectMessageType</span><span class="o">[</span><span class="kt">Device.ReadTemperature</span><span class="o">]</span>
  <span class="n">device2</span><span class="o">.</span><span class="n">expectMessageType</span><span class="o">[</span><span class="kt">Device.ReadTemperature</span><span class="o">]</span>

  <span class="n">queryActor</span> <span class="o">!</span> <span class="nc">WrappedRespondTemperature</span><span class="o">(</span><span class="nc">Device</span><span class="o">.</span><span class="nc">RespondTemperature</span><span class="o">(</span><span class="n">requestId</span> <span class="k">=</span> <span class="mi">0</span><span class="o">,</span> <span class="s">&quot;device1&quot;</span><span class="o">,</span> <span class="nc">Some</span><span class="o">(</span><span class="mf">1.0</span><span class="o">)))</span>
  <span class="n">queryActor</span> <span class="o">!</span> <span class="nc">WrappedRespondTemperature</span><span class="o">(</span><span class="nc">Device</span><span class="o">.</span><span class="nc">RespondTemperature</span><span class="o">(</span><span class="n">requestId</span> <span class="k">=</span> <span class="mi">0</span><span class="o">,</span> <span class="s">&quot;device2&quot;</span><span class="o">,</span> <span class="nc">Some</span><span class="o">(</span><span class="mf">2.0</span><span class="o">)))</span>

  <span class="n">device2</span><span class="o">.</span><span class="n">stop</span><span class="o">()</span>

  <span class="n">requester</span><span class="o">.</span><span class="n">expectMessage</span><span class="o">(</span>
    <span class="nc">RespondAllTemperatures</span><span class="o">(</span>
      <span class="n">requestId</span> <span class="k">=</span> <span class="mi">1</span><span class="o">,</span>
      <span class="n">temperatures</span> <span class="k">=</span> <span class="nc">Map</span><span class="o">(</span><span class="s">&quot;device1&quot;</span> <span class="o">-&gt;</span> <span class="nc">Temperature</span><span class="o">(</span><span class="mf">1.0</span><span class="o">),</span> <span class="s">&quot;device2&quot;</span> <span class="o">-&gt;</span> <span class="nc">Temperature</span><span class="o">(</span><span class="mf">2.0</span><span class="o">))))</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Останній випадок, коли не всі пристрої реагують вчасно. Щоб отримати тест порівняно швидко, ми створимо актор <code>DeviceGroupQuery</code> з меншим тайм-аутом:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="s">&quot;return DeviceTimedOut if device does not answer in time&quot;</span> <span class="n">in</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">requester</span> <span class="k">=</span> <span class="n">createTestProbe</span><span class="o">[</span><span class="kt">RespondAllTemperatures</span><span class="o">]()</span>

  <span class="k">val</span> <span class="n">device1</span> <span class="k">=</span> <span class="n">createTestProbe</span><span class="o">[</span><span class="kt">Command</span><span class="o">]()</span>
  <span class="k">val</span> <span class="n">device2</span> <span class="k">=</span> <span class="n">createTestProbe</span><span class="o">[</span><span class="kt">Command</span><span class="o">]()</span>

  <span class="k">val</span> <span class="n">deviceIdToActor</span> <span class="k">=</span> <span class="nc">Map</span><span class="o">(</span><span class="s">&quot;device1&quot;</span> <span class="o">-&gt;</span> <span class="n">device1</span><span class="o">.</span><span class="n">ref</span><span class="o">,</span> <span class="s">&quot;device2&quot;</span> <span class="o">-&gt;</span> <span class="n">device2</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span>

  <span class="k">val</span> <span class="n">queryActor</span> <span class="k">=</span>
    <span class="n">spawn</span><span class="o">(</span><span class="nc">DeviceGroupQuery</span><span class="o">(</span><span class="n">deviceIdToActor</span><span class="o">,</span> <span class="n">requestId</span> <span class="k">=</span> <span class="mi">1</span><span class="o">,</span> <span class="n">requester</span> <span class="k">=</span> <span class="n">requester</span><span class="o">.</span><span class="n">ref</span><span class="o">,</span> <span class="n">timeout</span> <span class="k">=</span> <span class="mf">200.</span><span class="n">millis</span><span class="o">))</span>

  <span class="n">device1</span><span class="o">.</span><span class="n">expectMessageType</span><span class="o">[</span><span class="kt">Device.ReadTemperature</span><span class="o">]</span>
  <span class="n">device2</span><span class="o">.</span><span class="n">expectMessageType</span><span class="o">[</span><span class="kt">Device.ReadTemperature</span><span class="o">]</span>

  <span class="n">queryActor</span> <span class="o">!</span> <span class="nc">WrappedRespondTemperature</span><span class="o">(</span><span class="nc">Device</span><span class="o">.</span><span class="nc">RespondTemperature</span><span class="o">(</span><span class="n">requestId</span> <span class="k">=</span> <span class="mi">0</span><span class="o">,</span> <span class="s">&quot;device1&quot;</span><span class="o">,</span> <span class="nc">Some</span><span class="o">(</span><span class="mf">1.0</span><span class="o">)))</span>

  <span class="c1">// немає відповіді від device2</span>

  <span class="n">requester</span><span class="o">.</span><span class="n">expectMessage</span><span class="o">(</span>
    <span class="nc">RespondAllTemperatures</span><span class="o">(</span>
      <span class="n">requestId</span> <span class="k">=</span> <span class="mi">1</span><span class="o">,</span>
      <span class="n">temperatures</span> <span class="k">=</span> <span class="nc">Map</span><span class="o">(</span><span class="s">&quot;device1&quot;</span> <span class="o">-&gt;</span> <span class="nc">Temperature</span><span class="o">(</span><span class="mf">1.0</span><span class="o">),</span> <span class="s">&quot;device2&quot;</span> <span class="o">-&gt;</span> <span class="nc">DeviceTimedOut</span><span class="o">)))</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Тепер наш запит працює так, як очікувалося, і саме час включити цю нову функціональність в актор <code>DeviceGroup</code>.</p></div>
</div>
<div class="sect2">
<h3 id="______3">Додавання можливості запиту до групи</h3>
<div class="paragraph"><p>Включити функцію запиту до актора групи зараз досить просто. Ми зробили все складне в самому акторі запиту, актору групи потрібно лише створити його з правильними початковими параметрами і більше нічого.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">DeviceGroup</span><span class="o">(</span><span class="n">context</span><span class="k">:</span> <span class="kt">ActorContext</span><span class="o">[</span><span class="kt">DeviceGroup.Command</span><span class="o">],</span> <span class="n">groupId</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
    <span class="k">extends</span> <span class="nc">AbstractBehavior</span><span class="o">[</span><span class="kt">DeviceGroup.Command</span><span class="o">](</span><span class="n">context</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">import</span> <span class="nn">DeviceGroup._</span>
  <span class="k">import</span> <span class="nn">DeviceManager.</span><span class="o">{</span>
    <span class="nc">DeviceRegistered</span><span class="o">,</span>
    <span class="nc">ReplyDeviceList</span><span class="o">,</span>
    <span class="nc">RequestAllTemperatures</span><span class="o">,</span>
    <span class="nc">RequestDeviceList</span><span class="o">,</span>
    <span class="nc">RequestTrackDevice</span>
  <span class="o">}</span>

  <span class="k">private</span> <span class="k">var</span> <span class="n">deviceIdToActor</span> <span class="k">=</span> <span class="nc">Map</span><span class="o">.</span><span class="n">empty</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">Device.Command</span><span class="o">]]</span>

  <span class="n">context</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">&quot;DeviceGroup {} started&quot;</span><span class="o">,</span> <span class="n">groupId</span><span class="o">)</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">onMessage</span><span class="o">(</span><span class="n">msg</span><span class="k">:</span> <span class="kt">Command</span><span class="o">)</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">Command</span><span class="o">]</span> <span class="k">=</span>
    <span class="n">msg</span> <span class="k">match</span> <span class="o">{</span>
      <span class="c1">// ... інші випадки опущені</span>

      <span class="k">case</span> <span class="nc">RequestAllTemperatures</span><span class="o">(</span><span class="n">requestId</span><span class="o">,</span> <span class="n">gId</span><span class="o">,</span> <span class="n">replyTo</span><span class="o">)</span> <span class="k">=&gt;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">gId</span> <span class="o">==</span> <span class="n">groupId</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">context</span><span class="o">.</span><span class="n">spawnAnonymous</span><span class="o">(</span>
            <span class="nc">DeviceGroupQuery</span><span class="o">(</span><span class="n">deviceIdToActor</span><span class="o">,</span> <span class="n">requestId</span> <span class="k">=</span> <span class="n">requestId</span><span class="o">,</span> <span class="n">requester</span> <span class="k">=</span> <span class="n">replyTo</span><span class="o">,</span> <span class="mf">3.</span><span class="n">seconds</span><span class="o">))</span>
          <span class="k">this</span>
        <span class="o">}</span> <span class="k">else</span>
          <span class="nc">Behaviors</span><span class="o">.</span><span class="n">unhandled</span>
    <span class="o">}</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">onSignal</span><span class="k">:</span> <span class="kt">PartialFunction</span><span class="o">[</span><span class="kt">Signal</span>, <span class="kt">Behavior</span><span class="o">[</span><span class="kt">Command</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">PostStop</span> <span class="k">=&gt;</span>
      <span class="n">context</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">&quot;DeviceGroup {} stopped&quot;</span><span class="o">,</span> <span class="n">groupId</span><span class="o">)</span>
      <span class="k">this</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Напевно, варто повторити те, про що ми говорили на початку розділу. Зберігаючи тимчасовий стан, що стосується лише запиту, в окремому акторі, ми тримаємо реалізацію актора групи дуже простою. Він делегує все дітям-акторам, а тому не повинен тримати стан, що не має відношення до його основної діяльності. Також декілька запитів тепер можуть працювати паралельно один одному - насправді стільки, скільки потрібно. У нашому випадку запит на окремий актор пристрою - це швидка операція, але якби це було не так, наприклад, якщо до віддалених датчиків потрібно діставатись через мережу, ця конструкція значно покращила б пропускну здатність.</p></div>
<div class="paragraph"><p>Ми закриваємо цю главу, перевіряючи, що все працює разом. Цей тест є варіантом попереднього, тепер використовується функція групового запиту:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="s">&quot;be able to collect temperatures from all active devices&quot;</span> <span class="n">in</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">registeredProbe</span> <span class="k">=</span> <span class="n">createTestProbe</span><span class="o">[</span><span class="kt">DeviceRegistered</span><span class="o">]()</span>
  <span class="k">val</span> <span class="n">groupActor</span> <span class="k">=</span> <span class="n">spawn</span><span class="o">(</span><span class="nc">DeviceGroup</span><span class="o">(</span><span class="s">&quot;group&quot;</span><span class="o">))</span>

  <span class="n">groupActor</span> <span class="o">!</span> <span class="nc">RequestTrackDevice</span><span class="o">(</span><span class="s">&quot;group&quot;</span><span class="o">,</span> <span class="s">&quot;device1&quot;</span><span class="o">,</span> <span class="n">registeredProbe</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">deviceActor1</span> <span class="k">=</span> <span class="n">registeredProbe</span><span class="o">.</span><span class="n">receiveMessage</span><span class="o">().</span><span class="n">device</span>

  <span class="n">groupActor</span> <span class="o">!</span> <span class="nc">RequestTrackDevice</span><span class="o">(</span><span class="s">&quot;group&quot;</span><span class="o">,</span> <span class="s">&quot;device2&quot;</span><span class="o">,</span> <span class="n">registeredProbe</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">deviceActor2</span> <span class="k">=</span> <span class="n">registeredProbe</span><span class="o">.</span><span class="n">receiveMessage</span><span class="o">().</span><span class="n">device</span>

  <span class="n">groupActor</span> <span class="o">!</span> <span class="nc">RequestTrackDevice</span><span class="o">(</span><span class="s">&quot;group&quot;</span><span class="o">,</span> <span class="s">&quot;device3&quot;</span><span class="o">,</span> <span class="n">registeredProbe</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span>
  <span class="n">registeredProbe</span><span class="o">.</span><span class="n">receiveMessage</span><span class="o">()</span>

<span class="c1">// Перевірте, чи працюють актори пристрою</span>
  <span class="k">val</span> <span class="n">recordProbe</span> <span class="k">=</span> <span class="n">createTestProbe</span><span class="o">[</span><span class="kt">TemperatureRecorded</span><span class="o">]()</span>
  <span class="n">deviceActor1</span> <span class="o">!</span> <span class="nc">RecordTemperature</span><span class="o">(</span><span class="n">requestId</span> <span class="k">=</span> <span class="mi">0</span><span class="o">,</span> <span class="mf">1.0</span><span class="o">,</span> <span class="n">recordProbe</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span>
  <span class="n">recordProbe</span><span class="o">.</span><span class="n">expectMessage</span><span class="o">(</span><span class="nc">TemperatureRecorded</span><span class="o">(</span><span class="n">requestId</span> <span class="k">=</span> <span class="mi">0</span><span class="o">))</span>
  <span class="n">deviceActor2</span> <span class="o">!</span> <span class="nc">RecordTemperature</span><span class="o">(</span><span class="n">requestId</span> <span class="k">=</span> <span class="mi">1</span><span class="o">,</span> <span class="mf">2.0</span><span class="o">,</span> <span class="n">recordProbe</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span>
  <span class="n">recordProbe</span><span class="o">.</span><span class="n">expectMessage</span><span class="o">(</span><span class="nc">TemperatureRecorded</span><span class="o">(</span><span class="n">requestId</span> <span class="k">=</span> <span class="mi">1</span><span class="o">))</span>
<span class="c1">// Відсутня температура для device3</span>

  <span class="k">val</span> <span class="n">allTempProbe</span> <span class="k">=</span> <span class="n">createTestProbe</span><span class="o">[</span><span class="kt">RespondAllTemperatures</span><span class="o">]()</span>
  <span class="n">groupActor</span> <span class="o">!</span> <span class="nc">RequestAllTemperatures</span><span class="o">(</span><span class="n">requestId</span> <span class="k">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">groupId</span> <span class="k">=</span> <span class="s">&quot;group&quot;</span><span class="o">,</span> <span class="n">allTempProbe</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span>
  <span class="n">allTempProbe</span><span class="o">.</span><span class="n">expectMessage</span><span class="o">(</span>
    <span class="nc">RespondAllTemperatures</span><span class="o">(</span>
      <span class="n">requestId</span> <span class="k">=</span> <span class="mi">0</span><span class="o">,</span>
      <span class="n">temperatures</span> <span class="k">=</span>
        <span class="nc">Map</span><span class="o">(</span><span class="s">&quot;device1&quot;</span> <span class="o">-&gt;</span> <span class="nc">Temperature</span><span class="o">(</span><span class="mf">1.0</span><span class="o">),</span> <span class="s">&quot;device2&quot;</span> <span class="o">-&gt;</span> <span class="nc">Temperature</span><span class="o">(</span><span class="mf">2.0</span><span class="o">),</span> <span class="s">&quot;device3&quot;</span> <span class="o">-&gt;</span> <span class="nc">TemperatureNotAvailable</span><span class="o">)))</span>
<span class="o">}</span>
</pre></div></div></div>
</div>
<div class="sect2">
<h3 id="__9">Підсумок</h3>
<div class="paragraph"><p>У контексті системи IoT в цьому посібнику було введено серед інших такі поняття. Ви можете перейти за посиланнями, щоб за потреби переглянути їх:</p></div>
<div class="ulist"><ul>
<li>
<p>
Ієрархія акторів та їх життєвий цикл
</p>
</li>
<li>
<p>
Важливість розробки повідомлень для гнучкості
</p>
</li>
<li>
<p>
Як доглядати і зупиняти акторів, якщо це необхідно
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="___10">Що далі?</h3>
<div class="paragraph"><p>Щоб продовжити подорож з Akka, рекомендуємо:</p></div>
<div class="ulist"><ul>
<li>
<p>
Почніть створювати власні програми з Akka, переконайтеся, що ви залучитесь до нашої дивовижної спільноти для допомоги, якщо ви застрягли.
</p>
</li>
<li>
<p>
Якщо вам потрібна додаткова інформація та деталі, прочитайте решту довідкової документації та ознайомтеся з деякими <a href="https://doc.akka.io/docs/akka/current/typed/actors.html">книгами та відео</a> на Akka.
</p>
</li>
<li>
<p>
Якщо вас цікавить функціональне програмування, прочитайте, як можна визначити акторів у <a href="https://doc.akka.io/docs/akka/current/typed/actors.html#functional-style">функціональному стилі</a>. У цьому посібнику використовувався об'єктно-орієнтований стиль, але ви можете змішувати обидва, як вам подобається.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Щоб дістатись від цього посібника до повної програми, вам, ймовірно, потрібно надати або інтерфейс користувача, або API. Для цього рекомендуємо переглянути наступні технології та побачити, що вам підходить:</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="https://doc.akka.io/docs/akka-http/current/introduction.html">Akka HTTP</a> - це HTTP-сервер та клієнтська бібліотека, що дозволяє публікувати та споживати кінцеві точки HTTP
</p>
</li>
<li>
<p>
<a href="https://www.playframework.com/?_ga=2.218657882.279615735.1579622857-1972390590.1574487700">Play Framework</a> - це повноціннмй веб-фреймворк, побудований на версії Akka HTTP. Він добре інтегрується з Akka і може бути використаний для створення повного сучасного веб-інтерфейсу
</p>
</li>
<li>
<p>
<a href="https://www.lagomframework.com/?_ga=2.218657882.279615735.1579622857-1972390590.1574487700">Lagom</a> - це надійний фреймворк мікросервісів, побудований на Akka, який кодує багато найкращих практик навколо Akka і Play
</p>
</li>
</ul></div>
</div>
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Last updated
 2020-01-22 02:51:35 EET
</div>
</div>
</body>
</html>
