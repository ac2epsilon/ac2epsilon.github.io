<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.6.10" />
<title></title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

.monospaced, code, pre {
  font-family: "Courier New", Courier, monospace;
  font-size: inherit;
  color: navy;
  padding: 0;
  margin: 0;
}
pre {
  white-space: pre-wrap;
}

#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #888;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; vertical-align: text-bottom; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel0, div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }

div.unbreakable { page-break-inside: avoid; }


/*
 * xhtml11 specific
 *
 * */

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}
.highlight .hll { background-color: #ffffcc }
.highlight  { background: #f8f8f8; }
.highlight .c { color: #408080; font-style: italic } /* Comment */
.highlight .err { border: 1px solid #FF0000 } /* Error */
.highlight .k { color: #008000; font-weight: bold } /* Keyword */
.highlight .o { color: #666666 } /* Operator */
.highlight .cm { color: #408080; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #BC7A00 } /* Comment.Preproc */
.highlight .c1 { color: #408080; font-style: italic } /* Comment.Single */
.highlight .cs { color: #408080; font-style: italic } /* Comment.Special */
.highlight .gd { color: #A00000 } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #FF0000 } /* Generic.Error */
.highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight .gi { color: #00A000 } /* Generic.Inserted */
.highlight .go { color: #808080 } /* Generic.Output */
.highlight .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight .gt { color: #0040D0 } /* Generic.Traceback */
.highlight .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #008000 } /* Keyword.Pseudo */
.highlight .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #B00040 } /* Keyword.Type */
.highlight .m { color: #666666 } /* Literal.Number */
.highlight .s { color: #BA2121 } /* Literal.String */
.highlight .na { color: #7D9029 } /* Name.Attribute */
.highlight .nb { color: #008000 } /* Name.Builtin */
.highlight .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.highlight .no { color: #880000 } /* Name.Constant */
.highlight .nd { color: #AA22FF } /* Name.Decorator */
.highlight .ni { color: #999999; font-weight: bold } /* Name.Entity */
.highlight .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #0000FF } /* Name.Function */
.highlight .nl { color: #A0A000 } /* Name.Label */
.highlight .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.highlight .nt { color: #008000; font-weight: bold } /* Name.Tag */
.highlight .nv { color: #19177C } /* Name.Variable */
.highlight .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mf { color: #666666 } /* Literal.Number.Float */
.highlight .mh { color: #666666 } /* Literal.Number.Hex */
.highlight .mi { color: #666666 } /* Literal.Number.Integer */
.highlight .mo { color: #666666 } /* Literal.Number.Oct */
.highlight .sb { color: #BA2121 } /* Literal.String.Backtick */
.highlight .sc { color: #BA2121 } /* Literal.String.Char */
.highlight .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.highlight .s2 { color: #BA2121 } /* Literal.String.Double */
.highlight .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.highlight .sh { color: #BA2121 } /* Literal.String.Heredoc */
.highlight .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.highlight .sx { color: #008000 } /* Literal.String.Other */
.highlight .sr { color: #BB6688 } /* Literal.String.Regex */
.highlight .s1 { color: #BA2121 } /* Literal.String.Single */
.highlight .ss { color: #19177C } /* Literal.String.Symbol */
.highlight .bp { color: #008000 } /* Name.Builtin.Pseudo */
.highlight .vc { color: #19177C } /* Name.Variable.Class */
.highlight .vg { color: #19177C } /* Name.Variable.Global */
.highlight .vi { color: #19177C } /* Name.Variable.Instance */
.highlight .il { color: #666666 } /* Literal.Number.Integer.Long */


</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install();
/*]]>*/
</script>
</head>
<body class="book">
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="__">Шаблони взаємодії</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="___">Інформація про модуль</h3>
<div class="paragraph"><p>Щоб використовувати Akka Actors, додайте таку залежність у свій проект:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="n">libraryDependencies</span> <span class="o">+=</span> <span class="s">&quot;com.typesafe.akka&quot;</span> <span class="o">%%</span> <span class="s">&quot;akka-actor-typed&quot;</span> <span class="o">%</span> <span class="s">&quot;2.6.5&quot;</span>
</pre></div></div></div>
</div>
<div class="sect2">
<h3 id="_">Вступ</h3>
<div class="paragraph"><p>Взаємодія з актором в Akka здійснюється через <code>ActorRef[T]</code>, де <code>T</code> - тип повідомлень, які актор приймає, також відомий як "протокол". Це гарантує, що акторові можна надсилати лише правильний вид повідомлень, а також, що ніхто інший, крім самого Актора, не може отримати доступ до внутрішніх справ екземпляра Актора.</p></div>
<div class="paragraph"><p>Обмін повідомленнями з акторами дотримується кількох загальних зразків, давайте переглянемо кожен із них.</p></div>
</div>
<div class="sect2">
<h3 id="____2">Стріль і забудь</h3>
<div class="paragraph"><p>Принциповий спосіб взаємодії з актором - це <code>tell</code>, що є настільки поширеним, що має спеціальну символічну назву методу: <code>actRef ! message</code>. Надіслати повідомлення з <code>tell</code> можна безпечно з будь-якого потоку. <code>tell</code> є асинхронним, що означає, що метод повертається відразу. Після виконання заяви немає гарантії, що одержувач ще не обробив повідомлення. Це також означає, що немає ніякого способу дізнатися, чи було повідомлення отримано, обробка вдалася чи не вдалася.</p></div>
<div class="paragraph"><p>Приклад:</p></div>
<div class="imageblock">
<div class="content">
<img src="fire-forget.png" alt="fire-forget.png" />
</div>
</div>
<div class="paragraph"><p>За допомогою даного протоколу та поведінки актора:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">object</span> <span class="nc">Printer</span> <span class="o">{</span>

  <span class="k">case</span> <span class="k">class</span> <span class="nc">PrintMe</span><span class="o">(</span><span class="n">message</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>

  <span class="k">def</span> <span class="n">apply</span><span class="o">()</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">PrintMe</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">Behaviors</span><span class="o">.</span><span class="n">receive</span> <span class="o">{</span>
      <span class="k">case</span> <span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="nc">PrintMe</span><span class="o">(</span><span class="n">message</span><span class="o">))</span> <span class="k">=&gt;</span>
        <span class="n">context</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="n">message</span><span class="o">)</span>
        <span class="nc">Behaviors</span><span class="o">.</span><span class="n">same</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Стріль і забудь виглядає так:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">system</span> <span class="k">=</span> <span class="nc">ActorSystem</span><span class="o">(</span><span class="nc">Printer</span><span class="o">(),</span> <span class="s">&quot;fire-and-forget-sample&quot;</span><span class="o">)</span>

<span class="c1">// зауважте, як система також є актором верхнього рівня ref</span>
<span class="k">val</span> <span class="n">printer</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">Printer.PrintMe</span><span class="o">]</span> <span class="k">=</span> <span class="n">system</span>

<span class="c1">// це все стріль і забудь</span>
<span class="n">printer</span> <span class="o">!</span> <span class="nc">Printer</span><span class="o">.</span><span class="nc">PrintMe</span><span class="o">(</span><span class="s">&quot;message 1&quot;</span><span class="o">)</span>
<span class="n">printer</span> <span class="o">!</span> <span class="nc">Printer</span><span class="o">.</span><span class="nc">PrintMe</span><span class="o">(</span><span class="s">&quot;not message 2&quot;</span><span class="o">)</span>
</pre></div></div></div>
<div class="sect4">
<h5 id="___2">Корисно, коли:</h5>
<div class="ulist"><ul>
<li>
<p>
Не критично бути впевненим, що повідомлення було оброблено
</p>
</li>
<li>
<p>
Немає можливості відповісти на невдалу доставку чи обробку
</p>
</li>
<li>
<p>
Ми хочемо мінімізувати кількість створених повідомлень для отримання більшої пропускної здатності (надсилання відповіді потребує створення вдвічі більшої кількості повідомлень)
</p>
</li>
</ul></div>
</div>
<div class="sect4">
<h5 id="__2">Проблеми:</h5>
<div class="ulist"><ul>
<li>
<p>
Якщо приплив повідомлень в папку "Вхідні" більший, ніж актор може обробити, вона заповниться і, в гіршому випадку, може призвести до аварії JVM з <code>OutOfMemoryError</code>
</p>
</li>
<li>
<p>
Якщо повідомлення загубиться, відправник не дізнається про це
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="___3">Запит-відповідь</h3>
<div class="paragraph"><p>Багато взаємодій між акторами вимагають відправлення одного або більше повідомлень відповіді від отримуючого актора. Повідомлення відповіді може бути результатом запиту, певної форми підтвердження того, що повідомлення було отримано та оброблено, або подій, на які підписувався запит.</p></div>
<div class="paragraph"><p>У Akka одержувач відповідей повинен бути закодований як поле у ​​самому повідомленні, яке одержувач може потім використати, щоб надіслати (<code>tell</code>) відповідь назад.</p></div>
<div class="paragraph"><p>Приклад:</p></div>
<div class="imageblock">
<div class="content">
<img src="request-response.png" alt="request-response.png" />
</div>
</div>
<div class="paragraph"><p>З наступним протоколом:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">case</span> <span class="k">class</span> <span class="nc">Request</span><span class="o">(</span><span class="n">query</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">replyTo</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">Response</span><span class="o">])</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">Response</span><span class="o">(</span><span class="n">result</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Відправник буде використовувати свій власний <code>ActorRef[Response]</code>, до якого він може отримати доступ через <code>ActorContext.self</code>, для <code>replyTo</code>.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="n">cookieFabric</span> <span class="o">!</span> <span class="nc">CookieFabric</span><span class="o">.</span><span class="nc">Request</span><span class="o">(</span><span class="s">&quot;give me cookies&quot;</span><span class="o">,</span> <span class="n">context</span><span class="o">.</span><span class="n">self</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>На приймальній стороні <code>ActorRef[Response]</code> потім може бути використаний для надсилання однієї або декількох відповідей назад:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="n">apply</span><span class="o">()</span><span class="k">:</span> <span class="kt">Behaviors.Receive</span><span class="o">[</span><span class="kt">Request</span><span class="o">]</span> <span class="k">=</span>
  <span class="nc">Behaviors</span><span class="o">.</span><span class="n">receiveMessage</span><span class="o">[</span><span class="kt">Request</span><span class="o">]</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Request</span><span class="o">(</span><span class="n">query</span><span class="o">,</span> <span class="n">replyTo</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="c1">// ... обробити запит ...</span>
      <span class="n">replyTo</span> <span class="o">!</span> <span class="nc">Response</span><span class="o">(</span><span class="s">s&quot;Here are the cookies for [</span><span class="si">$query</span><span class="s">]!&quot;</span><span class="o">)</span>
      <span class="nc">Behaviors</span><span class="o">.</span><span class="n">same</span>
  <span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Корисно, коли:</p></div>
<div class="ulist"><ul>
<li>
<p>
Треба підписатись на актора, який відправить назад багато відповідей
</p>
</li>
</ul></div>
<div class="paragraph"><p>Проблеми:</p></div>
<div class="ulist"><ul>
<li>
<p>
Актори рідко отримують відповідь від іншого актора у складі свого протоколу (див. Адаптовану відповідь)
</p>
</li>
<li>
<p>
Важко виявити, що запит на повідомлення не був доставлений чи оброблений (див.<code>ask</code>)
</p>
</li>
<li>
<p>
Якщо протокол вже не містить способу надання контексту, наприклад ідентифікатора запиту, який також надсилається у відповіді, неможливо прив’язати взаємодію до певного конкретного контексту без введення нового, окремого актора (див.<code>ask</code>)
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="___4">Адаптований відповідь</h3>
<div class="paragraph"><p>Найчастіше надсилаючий актор, не підтримує та не має підтримувати отримання повідомлення відповіді від іншого актора. У таких випадках нам потрібно надати <code>ActorRef</code> потрібного типу та адаптувати відповідь на тип, який може обробляти надсилаючий актор.</p></div>
<div class="paragraph"><p>Приклад:</p></div>
<div class="imageblock">
<div class="content">
<img src="adapted-response.png" alt="adapted-response.png" />
</div>
</div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">object</span> <span class="nc">Backend</span> <span class="o">{</span>
  <span class="k">sealed</span> <span class="k">trait</span> <span class="nc">Request</span>
  <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">StartTranslationJob</span><span class="o">(</span><span class="n">taskId</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">site</span><span class="k">:</span> <span class="kt">URI</span><span class="o">,</span> <span class="n">replyTo</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">Response</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">Request</span>

  <span class="k">sealed</span> <span class="k">trait</span> <span class="nc">Response</span>
  <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">JobStarted</span><span class="o">(</span><span class="n">taskId</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Response</span>
  <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">JobProgress</span><span class="o">(</span><span class="n">taskId</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">progress</span><span class="k">:</span> <span class="kt">Double</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Response</span>
  <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">JobCompleted</span><span class="o">(</span><span class="n">taskId</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">result</span><span class="k">:</span> <span class="kt">URI</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Response</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">Frontend</span> <span class="o">{</span>

  <span class="k">sealed</span> <span class="k">trait</span> <span class="nc">Command</span>
  <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">Translate</span><span class="o">(</span><span class="n">site</span><span class="k">:</span> <span class="kt">URI</span><span class="o">,</span> <span class="n">replyTo</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">URI</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">Command</span>
  <span class="k">private</span> <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">WrappedBackendResponse</span><span class="o">(</span><span class="n">response</span><span class="k">:</span> <span class="kt">Backend.Response</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Command</span>

  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">backend</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">Backend.Request</span><span class="o">])</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">Command</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">Behaviors</span><span class="o">.</span><span class="n">setup</span><span class="o">[</span><span class="kt">Command</span><span class="o">]</span> <span class="o">{</span> <span class="n">context</span> <span class="k">=&gt;</span>
      <span class="k">val</span> <span class="n">backendResponseMapper</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">Backend.Response</span><span class="o">]</span> <span class="k">=</span>
        <span class="n">context</span><span class="o">.</span><span class="n">messageAdapter</span><span class="o">(</span><span class="n">rsp</span> <span class="k">=&gt;</span> <span class="nc">WrappedBackendResponse</span><span class="o">(</span><span class="n">rsp</span><span class="o">))</span>

      <span class="k">def</span> <span class="n">active</span><span class="o">(</span><span class="n">inProgress</span><span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">Int</span><span class="p">,</span> <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">URI</span><span class="o">]],</span> <span class="n">count</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">Command</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
        <span class="nc">Behaviors</span><span class="o">.</span><span class="n">receiveMessage</span><span class="o">[</span><span class="kt">Command</span><span class="o">]</span> <span class="o">{</span>
          <span class="k">case</span> <span class="nc">Translate</span><span class="o">(</span><span class="n">site</span><span class="o">,</span> <span class="n">replyTo</span><span class="o">)</span> <span class="k">=&gt;</span>
            <span class="k">val</span> <span class="n">taskId</span> <span class="k">=</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">backend</span> <span class="o">!</span> <span class="nc">Backend</span><span class="o">.</span><span class="nc">StartTranslationJob</span><span class="o">(</span><span class="n">taskId</span><span class="o">,</span> <span class="n">site</span><span class="o">,</span> <span class="n">backendResponseMapper</span><span class="o">)</span>
            <span class="n">active</span><span class="o">(</span><span class="n">inProgress</span><span class="o">.</span><span class="n">updated</span><span class="o">(</span><span class="n">taskId</span><span class="o">,</span> <span class="n">replyTo</span><span class="o">),</span> <span class="n">taskId</span><span class="o">)</span>

          <span class="k">case</span> <span class="n">wrapped</span><span class="k">:</span> <span class="kt">WrappedBackendResponse</span> <span class="o">=&gt;</span>
            <span class="n">wrapped</span><span class="o">.</span><span class="n">response</span> <span class="k">match</span> <span class="o">{</span>
              <span class="k">case</span> <span class="nc">Backend</span><span class="o">.</span><span class="nc">JobStarted</span><span class="o">(</span><span class="n">taskId</span><span class="o">)</span> <span class="k">=&gt;</span>
                <span class="n">context</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">&quot;Started {}&quot;</span><span class="o">,</span> <span class="n">taskId</span><span class="o">)</span>
                <span class="nc">Behaviors</span><span class="o">.</span><span class="n">same</span>
              <span class="k">case</span> <span class="nc">Backend</span><span class="o">.</span><span class="nc">JobProgress</span><span class="o">(</span><span class="n">taskId</span><span class="o">,</span> <span class="n">progress</span><span class="o">)</span> <span class="k">=&gt;</span>
                <span class="n">context</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info2</span><span class="o">(</span><span class="s">&quot;Progress {}: {}&quot;</span><span class="o">,</span> <span class="n">taskId</span><span class="o">,</span> <span class="n">progress</span><span class="o">)</span>
                <span class="nc">Behaviors</span><span class="o">.</span><span class="n">same</span>
              <span class="k">case</span> <span class="nc">Backend</span><span class="o">.</span><span class="nc">JobCompleted</span><span class="o">(</span><span class="n">taskId</span><span class="o">,</span> <span class="n">result</span><span class="o">)</span> <span class="k">=&gt;</span>
                <span class="n">context</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info2</span><span class="o">(</span><span class="s">&quot;Completed {}: {}&quot;</span><span class="o">,</span> <span class="n">taskId</span><span class="o">,</span> <span class="n">result</span><span class="o">)</span>
                <span class="n">inProgress</span><span class="o">(</span><span class="n">taskId</span><span class="o">)</span> <span class="o">!</span> <span class="n">result</span>
                <span class="n">active</span><span class="o">(</span><span class="n">inProgress</span> <span class="o">-</span> <span class="n">taskId</span><span class="o">,</span> <span class="n">count</span><span class="o">)</span>
            <span class="o">}</span>
        <span class="o">}</span>
      <span class="o">}</span>

      <span class="n">active</span><span class="o">(</span><span class="n">inProgress</span> <span class="k">=</span> <span class="nc">Map</span><span class="o">.</span><span class="n">empty</span><span class="o">,</span> <span class="n">count</span> <span class="k">=</span> <span class="mi">0</span><span class="o">)</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Ви можете зареєструвати кілька адаптерів повідомлень для різних класів повідомлень. Для кожного класу повідомлень можливий лише один адаптер повідомлень, щоб переконатися, що кількість адаптерів не зростає без обмежень при повторній реєстрації. Це також означає, що зареєстрований адаптер замінить існуючий адаптер для того ж класу повідомлень.</p></div>
<div class="paragraph"><p>Адаптер повідомлень буде використовуватися, якщо клас повідомлень відповідає даному класу або є його підкласом. Зареєстровані адаптери випробовуються у зворотному порядку їх порядку реєстрації, тобто останній зареєстрований першим.</p></div>
<div class="paragraph"><p>Адаптер повідомлень (і повернутий <code>ActorRef</code>) має той же життєвий цикл, що і актор, що приймає. Рекомендується зареєструвати адаптери у вищому рівні <code>Behaviors.setup</code> або в конструкторі абстрактної поведінки, але можна зареєструвати їх пізніше, якщо потрібно.</p></div>
<div class="paragraph"><p>Функція адаптера працює у приймаючому акторі і може безпечно отримувати доступ до свого стану, але якщо він кидає виняток, актор зупиняється.</p></div>
<div class="paragraph"><p>Корисно, коли:</p></div>
<div class="ulist"><ul>
<li>
<p>
Є переклад між різними протоколами повідомлення актора
</p>
</li>
<li>
<p>
Треба підписатись на актора, який відправить назад багато відповідей
</p>
</li>
</ul></div>
<div class="paragraph"><p>Проблеми:</p></div>
<div class="ulist"><ul>
<li>
<p>
Важко виявити, що запит на повідомлення не був доставлений чи оброблений (див. <code>ask</code>)
</p>
</li>
<li>
<p>
Лише одну адаптацію може бути здійснено для кожного типу відповідей, якщо зареєстровано нова, стара заміщується. Наприклад, різні цільові актори не можуть мати різну адаптацію, якщо вони використовують одні і ті ж типи відповідей, якщо деяке впівідношення не закодоване в самомоу повідомленні
</p>
</li>
<li>
<p>
Якщо протокол вже не містить способу надання контексту, наприклад, ідентифікатора запиту, який також надсилається у відповіді, неможливо прив’язати взаємодію до певного конкретного контексту без введення нового, окремого актора
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="___ask___">Запит-відповідь ask між двома акторами</h3>
<div class="paragraph"><p>У взаємодії, де є відображення 1: 1 між запитом та відповіддю, ми можемо використовувати <code>ask</code> у <code>ActorContext</code> для взаємодії з іншим актором.</p></div>
<div class="paragraph"><p>Взаємодія має два етапи: спочатку нам потрібно побудувати вихідне повідомлення; для цього нам потрібен <code>ActorRef[Response]</code>, який потрібно розмістити як одержувача у вихідному повідомленні. Другий крок - перетворення успішного <code>Response</code> або відмови в повідомлення, яке є частиною протоколу актора, що відправляє.</p></div>
<div class="paragraph"><p>Приклад:</p></div>
<div class="imageblock">
<div class="content">
<img src="ask-from-actor.png" alt="ask-from-actor.png" />
</div>
</div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">object</span> <span class="nc">Hal</span> <span class="o">{</span>
  <span class="k">sealed</span> <span class="k">trait</span> <span class="nc">Command</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">OpenThePodBayDoorsPlease</span><span class="o">(</span><span class="n">replyTo</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">Response</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">Command</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">Response</span><span class="o">(</span><span class="n">message</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>

  <span class="k">def</span> <span class="n">apply</span><span class="o">()</span><span class="k">:</span> <span class="kt">Behaviors.Receive</span><span class="o">[</span><span class="kt">Hal.Command</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">Behaviors</span><span class="o">.</span><span class="n">receiveMessage</span><span class="o">[</span><span class="kt">Command</span><span class="o">]</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">OpenThePodBayDoorsPlease</span><span class="o">(</span><span class="n">replyTo</span><span class="o">)</span> <span class="k">=&gt;</span>
        <span class="n">replyTo</span> <span class="o">!</span> <span class="nc">Response</span><span class="o">(</span><span class="s">&quot;I&#39;m sorry, Dave. I&#39;m afraid I can&#39;t do that.&quot;</span><span class="o">)</span>
        <span class="nc">Behaviors</span><span class="o">.</span><span class="n">same</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">Dave</span> <span class="o">{</span>

  <span class="k">sealed</span> <span class="k">trait</span> <span class="nc">Command</span>
  <span class="c1">// це частина протоколу, яка є внутрішньою для самого актора</span>
  <span class="k">private</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">AdaptedResponse</span><span class="o">(</span><span class="n">message</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Command</span>

  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">hal</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">Hal.Command</span><span class="o">])</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">Dave.Command</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">Behaviors</span><span class="o">.</span><span class="n">setup</span><span class="o">[</span><span class="kt">Command</span><span class="o">]</span> <span class="o">{</span> <span class="n">context</span> <span class="k">=&gt;</span>
      <span class="c1">// запитання у когось вимагає тайм-ауту, якщо тайм-аут потрапляє без відповіді</span>
      <span class="c1">// запит ask не вдається з TimeoutException</span>
      <span class="k">implicit</span> <span class="k">val</span> <span class="n">timeout</span><span class="k">:</span> <span class="kt">Timeout</span> <span class="o">=</span> <span class="mf">3.</span><span class="n">seconds</span>

      <span class="c1">// Примітка. Другий список параметрів виконує функцію `ActorRef[T] =&gt; Message`,</span>
      <span class="c1">// як OpenThePodBayDoorsPlease - кейс клас, він має фекторі метод apply</span>
      <span class="c1">// це те, що ми передаємо як другий параметр, тут він також міг бути записаний</span>
      <span class="c1">// як `ref =&gt; OpenThePodBayDoorsPlease (ref)`</span>
      <span class="n">context</span><span class="o">.</span><span class="n">ask</span><span class="o">(</span><span class="n">hal</span><span class="o">,</span> <span class="nc">Hal</span><span class="o">.</span><span class="nc">OpenThePodBayDoorsPlease</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">case</span> <span class="nc">Success</span><span class="o">(</span><span class="nc">Hal</span><span class="o">.</span><span class="nc">Response</span><span class="o">(</span><span class="n">message</span><span class="o">))</span> <span class="k">=&gt;</span> <span class="nc">AdaptedResponse</span><span class="o">(</span><span class="n">message</span><span class="o">)</span>
        <span class="k">case</span> <span class="nc">Failure</span><span class="o">(</span><span class="k">_</span><span class="o">)</span>                     <span class="k">=&gt;</span> <span class="nc">AdaptedResponse</span><span class="o">(</span><span class="s">&quot;Request failed&quot;</span><span class="o">)</span>
      <span class="o">}</span>

      <span class="c1">// ми також можемо зв’язати в контексті запиту і взаємодію, це безпечно дивитись на</span>
      <span class="c1">// внутрішній стан актора з функції перетворення, але пам’ятайте, що він може мати бути</span>
      <span class="c1">// змінений під час надходження відповіді та трансформація вже зроблена. Найкраще - це</span>
      <span class="c1">// використовувати незмінний стан, який ми зачинили, як тут.</span>
      <span class="k">val</span> <span class="n">requestId</span> <span class="k">=</span> <span class="mi">1</span>
      <span class="n">context</span><span class="o">.</span><span class="n">ask</span><span class="o">(</span><span class="n">hal</span><span class="o">,</span> <span class="nc">Hal</span><span class="o">.</span><span class="nc">OpenThePodBayDoorsPlease</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">case</span> <span class="nc">Success</span><span class="o">(</span><span class="nc">Hal</span><span class="o">.</span><span class="nc">Response</span><span class="o">(</span><span class="n">message</span><span class="o">))</span> <span class="k">=&gt;</span> <span class="nc">AdaptedResponse</span><span class="o">(</span><span class="s">s&quot;</span><span class="si">$requestId</span><span class="s">: </span><span class="si">$message</span><span class="s">&quot;</span><span class="o">)</span>
        <span class="k">case</span> <span class="nc">Failure</span><span class="o">(</span><span class="k">_</span><span class="o">)</span>                     <span class="k">=&gt;</span> <span class="nc">AdaptedResponse</span><span class="o">(</span><span class="s">s&quot;</span><span class="si">$requestId</span><span class="s">: Request failed&quot;</span><span class="o">)</span>
      <span class="o">}</span>

      <span class="nc">Behaviors</span><span class="o">.</span><span class="n">receiveMessage</span> <span class="o">{</span>
        <span class="c1">// адаптоване повідомлення в кінцевому підсумку обробляється, як і будь-яке інше</span>
        <span class="c1">// повідомлення, надіслане акторові</span>
        <span class="k">case</span> <span class="nc">AdaptedResponse</span><span class="o">(</span><span class="n">message</span><span class="o">)</span> <span class="k">=&gt;</span>
          <span class="n">context</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">&quot;Got response from hal: {}&quot;</span><span class="o">,</span> <span class="n">message</span><span class="o">)</span>
          <span class="nc">Behaviors</span><span class="o">.</span><span class="n">same</span>
      <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Функція адаптації відповіді працює у приймаючому акторі і може безпечно отримувати доступ до свого стану, але якщо вона закидає виняток, актор зупиняється.</p></div>
<div class="paragraph"><p>Корисно, коли:</p></div>
<div class="ulist"><ul>
<li>
<p>
Поодинокі запити відповідей
</p>
</li>
<li>
<p>
Актору потрібно знати, що повідомлення було оброблено, перш ніж продовжувати
</p>
</li>
<li>
<p>
Дозволити акторові повторне надсилання, якщо не представлена своєчасна відповідь
</p>
</li>
<li>
<p>
Відстежувати невирішені запити та не переповнювати одержувача повідомленнями ("зворотний тиск")
</p>
</li>
<li>
<p>
Контекст повинен бути доданий до взаємодії, але протокол цього не підтримує (ідентифікатор запиту, на який запит була відповідь)
</p>
</li>
</ul></div>
<div class="paragraph"><p>Проблеми:</p></div>
<div class="ulist"><ul>
<li>
<p>
Існує лише одна відповідь на одне запитання
</p>
</li>
<li>
<p>
Коли <code>ask</code> виходить в тайм-аут, актор, що приймає, не знає і може все-таки обробити його до завершення або навіть почати обробляти його після факту
</p>
</li>
<li>
<p>
Пошук гарного значення для тайм-аута, особливо, коли тригери <code>ask</code> сціплюють <code>ask</code> у приймаючого актора. Ви хочете, щоб короткий час очікування був чуйним і відповідав запитувачу, але в той же час ви не хочете мати багато помилкових позитивів
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="____code_ask_code____">Запит-відповідь із <code>ask</code> з-за меж актора</h3>
<div class="paragraph"><p>Іноді вам потрібно взаємодіяти з акторами ззовні акторської системи, це може бути зроблено за допомогою стрільнути і забути, як описано вище, або за допомогою іншої версії <code>ask</code>, яка повертає <code>Future[Response]</code>, яке або завершено успішною відповіддю або не вдалося з <code>TimeoutException</code>, якщо не було відповіді протягом зазначеного часу.</p></div>
<div class="paragraph"><p>Для цього ми використовуємо <code>ask</code> (або символічний?), неявно додано до <code>ActorRef</code> <code>akka.actor.typed.scaladsl.AskPattern._</code>, щоб надіслати повідомлення актору і отримати назад <code>Future[Response]</code>. <code>ask</code> приймає неявні параметри <code>Timeout</code> та <code>ActorSystem</code>.</p></div>
<div class="paragraph"><p>Приклад:</p></div>
<div class="imageblock">
<div class="content">
<img src="ask-from-outside.png" alt="ask-from-outside.png" />
</div>
</div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">object</span> <span class="nc">CookieFabric</span> <span class="o">{</span>
  <span class="k">sealed</span> <span class="k">trait</span> <span class="nc">Command</span> <span class="o">{}</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">GiveMeCookies</span><span class="o">(</span><span class="n">count</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">replyTo</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">Reply</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">Command</span>

  <span class="k">sealed</span> <span class="k">trait</span> <span class="nc">Reply</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">Cookies</span><span class="o">(</span><span class="n">count</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Reply</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">InvalidRequest</span><span class="o">(</span><span class="n">reason</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Reply</span>

  <span class="k">def</span> <span class="n">apply</span><span class="o">()</span><span class="k">:</span> <span class="kt">Behaviors.Receive</span><span class="o">[</span><span class="kt">CookieFabric.GiveMeCookies</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">Behaviors</span><span class="o">.</span><span class="n">receiveMessage</span> <span class="o">{</span> <span class="n">message</span> <span class="k">=&gt;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">message</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="o">)</span>
        <span class="n">message</span><span class="o">.</span><span class="n">replyTo</span> <span class="o">!</span> <span class="nc">InvalidRequest</span><span class="o">(</span><span class="s">&quot;Too many cookies.&quot;</span><span class="o">)</span>
      <span class="k">else</span>
        <span class="n">message</span><span class="o">.</span><span class="n">replyTo</span> <span class="o">!</span> <span class="nc">Cookies</span><span class="o">(</span><span class="n">message</span><span class="o">.</span><span class="n">count</span><span class="o">)</span>
      <span class="nc">Behaviors</span><span class="o">.</span><span class="n">same</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="k">import</span> <span class="nn">akka.actor.typed.scaladsl.AskPattern._</span>
<span class="k">import</span> <span class="nn">akka.util.Timeout</span>

<span class="c1">// запитання когось вимагає тайм-аут, якщо тайм-аут досягнутий без відповіді</span>
<span class="c1">// ask не вдається за допомогою TimeoutException</span>
<span class="k">implicit</span> <span class="k">val</span> <span class="n">timeout</span><span class="k">:</span> <span class="kt">Timeout</span> <span class="o">=</span> <span class="mf">3.</span><span class="n">seconds</span>
<span class="c1">// неявна ActorSystem в області застосування</span>
<span class="k">implicit</span> <span class="k">val</span> <span class="n">system</span><span class="k">:</span> <span class="kt">ActorSystem</span><span class="o">[</span><span class="k">_</span><span class="o">]</span> <span class="k">=</span> <span class="n">theSystem</span>

<span class="k">val</span> <span class="n">result</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">CookieFabric.Reply</span><span class="o">]</span> <span class="k">=</span> <span class="n">cookieFabric</span><span class="o">.</span><span class="n">ask</span><span class="o">(</span><span class="n">ref</span> <span class="k">=&gt;</span> <span class="nc">CookieFabric</span><span class="o">.</span><span class="nc">GiveMeCookies</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="n">ref</span><span class="o">))</span>

<span class="c1">// зворотний виклик відповіді буде виконано в цьому контексті виконання</span>
<span class="k">implicit</span> <span class="k">val</span> <span class="n">ec</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">executionContext</span>

<span class="n">result</span><span class="o">.</span><span class="n">onComplete</span> <span class="o">{</span>
  <span class="k">case</span> <span class="nc">Success</span><span class="o">(</span><span class="nc">CookieFabric</span><span class="o">.</span><span class="nc">Cookies</span><span class="o">(</span><span class="n">count</span><span class="o">))</span>         <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="s">s&quot;Yay, </span><span class="si">$count</span><span class="s"> cookies!&quot;</span><span class="o">)</span>
  <span class="k">case</span> <span class="nc">Success</span><span class="o">(</span><span class="nc">CookieFabric</span><span class="o">.</span><span class="nc">InvalidRequest</span><span class="o">(</span><span class="n">reason</span><span class="o">))</span> <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="s">s&quot;No cookies for me. </span><span class="si">$reason</span><span class="s">&quot;</span><span class="o">)</span>
  <span class="k">case</span> <span class="nc">Failure</span><span class="o">(</span><span class="n">ex</span><span class="o">)</span>                                  <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="s">s&quot;Boo! didn&#39;t get cookies: </span><span class="si">${</span><span class="n">ex</span><span class="o">.</span><span class="n">getMessage</span><span class="si">}</span><span class="s">&quot;</span><span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Зауважте, що помилки перевірки також явні в протоколі повідомлень. Запит <code>GiveMeCookies</code> може відповісти за допомогою <code>Cookies</code> або <code>InvalidRequest</code>. Заявник повинен вирішити, як обробити відповідь <code>InvalidRequest</code>. Іноді це слід трактувати як невдале <code>FutureFuture</code>, і для цього відповідь може бути відображена на стороні запитувача.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">cookies</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">CookieFabric.Cookies</span><span class="o">]</span> <span class="k">=</span>
  <span class="n">cookieFabric</span><span class="o">.</span><span class="n">ask</span><span class="o">[</span><span class="kt">CookieFabric.Reply</span><span class="o">](</span><span class="n">ref</span> <span class="k">=&gt;</span> <span class="nc">CookieFabric</span><span class="o">.</span><span class="nc">GiveMeCookies</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="n">ref</span><span class="o">)).</span><span class="n">flatMap</span> <span class="o">{</span>
    <span class="k">case</span> <span class="n">c</span><span class="k">:</span> <span class="kt">CookieFabric.Cookies</span>             <span class="o">=&gt;</span> <span class="nc">Future</span><span class="o">.</span><span class="n">successful</span><span class="o">(</span><span class="n">c</span><span class="o">)</span>
    <span class="k">case</span> <span class="nc">CookieFabric</span><span class="o">.</span><span class="nc">InvalidRequest</span><span class="o">(</span><span class="n">reason</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Future</span><span class="o">.</span><span class="n">failed</span><span class="o">(</span><span class="k">new</span> <span class="nc">IllegalArgumentException</span><span class="o">(</span><span class="n">reason</span><span class="o">))</span>
  <span class="o">}</span>

<span class="n">cookies</span><span class="o">.</span><span class="n">onComplete</span> <span class="o">{</span>
  <span class="k">case</span> <span class="nc">Success</span><span class="o">(</span><span class="nc">CookieFabric</span><span class="o">.</span><span class="nc">Cookies</span><span class="o">(</span><span class="n">count</span><span class="o">))</span> <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="s">s&quot;Yay, </span><span class="si">$count</span><span class="s"> cookies!&quot;</span><span class="o">)</span>
  <span class="k">case</span> <span class="nc">Failure</span><span class="o">(</span><span class="n">ex</span><span class="o">)</span>                          <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="s">s&quot;Boo! didn&#39;t get cookies: </span><span class="si">${</span><span class="n">ex</span><span class="o">.</span><span class="n">getMessage</span><span class="si">}</span><span class="s">&quot;</span><span class="o">)</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Корисно, коли:</p></div>
<div class="paragraph"><p>Запит на актора поза системою актора</p></div>
<div class="paragraph"><p>Проблеми:</p></div>
<div class="ulist"><ul>
<li>
<p>
Легко випадково замкнутись і небезпечно змінити стан із зворотними викликами на поверненому Future, оскільки вони будуть виконані в іншому потоці
</p>
</li>
<li>
<p>
Існує лише одна відповідь на одне запитання
</p>
</li>
<li>
<p>
Коли <code>ask</code> отримує тайм-аут, отримуючий актор не знає, і може все-таки обробити його до завершення або навіть почати обробляти його після факту
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="___5">Ігнорування відповідей</h3>
<div class="paragraph"><p>У деяких ситуаціях актор отримує відповідь на певне повідомлення із запитом, але вас не цікавить відповідь. У цьому випадку ви можете передати <code>system.ignoreRef</code>, перетворивши запит-відповідь на стріль-та-забудь.</p></div>
<div class="paragraph"><p><code>system.ignoreRef</code>, як вказує ім'я, повертає <code>ActorRef</code>, який ігнорує будь-яке повідомлення, надіслане до нього.</p></div>
<div class="paragraph"><p>За тим самим протоколом, що і запит-відповідь вище, якщо відправник вважає за краще ігнорувати відповідь, він може передавати <code>system.ignoreRef</code> для <code>replyTo</code>, до якого він може отримати доступ через <code>ActorContext.system.ignoreRef</code>.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="n">cookieFabric</span> <span class="o">!</span> <span class="nc">CookieFabric</span><span class="o">.</span><span class="nc">Request</span><span class="o">(</span><span class="s">&quot;don&#39;t send cookies back&quot;</span><span class="o">,</span> <span class="n">context</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">ignoreRef</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Корисно, коли:</p></div>
<div class="ulist"><ul>
<li>
<p>
Треба надіслати повідомлення, на яке протокол визначає відповідь, але ви не зацікавлені в отриманні відповіді
</p>
</li>
</ul></div>
<div class="paragraph"><p>Проблеми:</p></div>
<div class="paragraph"><p>Повернений <code>ActorRef</code> ігнорує всі надіслані йому повідомлення, тому його слід використовувати обережно.</p></div>
<div class="ulist"><ul>
<li>
<p>
Якщо мимоволі передати його навколо, як би це був звичайний <code>ActorRef</code>, це може призвести до порушених взаємодій актор-актор.
</p>
</li>
<li>
<p>
Використання його під час виконання запиту поза Акторською системою призведе до того, що <code>Future</code> повернеться <code>ask</code> до тайм-ауту, оскільки він ніколи не завершиться.
</p>
</li>
<li>
<p>
Нарешті, законно спостерігати за ним, але оскільки це особливий різновид, він ніколи не припиняється, і тому ви ніколи не отримаєте від нього сигналу Terminated.
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="___future__">Надіслати результат Future самому собі</h3>
<div class="paragraph"><p>Під час використання API, який повертає <code>Future</code> від актора, звичайно, що ви хочете використовувати значення відповіді в акторі, коли майбутнє завершено. Для цього <code>ActorContext</code> забезпечує метод <code>pipeToSelf</code>.</p></div>
<div class="paragraph"><p>Приклад:</p></div>
<div class="imageblock">
<div class="content">
<img src="pipe-to-self.png" alt="pipe-to-self.png" />
</div>
</div>
<div class="paragraph"><p>Актор, <code>CustomerRepository</code>, викликає метод <code>CustomerDataAccess</code>, який повертає майбутнє.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">trait</span> <span class="nc">CustomerDataAccess</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">update</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">Customer</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Done</span><span class="o">]</span>
<span class="o">}</span>

<span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">Customer</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">version</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span> <span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">address</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>

<span class="k">object</span> <span class="nc">CustomerRepository</span> <span class="o">{</span>
  <span class="k">sealed</span> <span class="k">trait</span> <span class="nc">Command</span>

  <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">Update</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">Customer</span><span class="o">,</span> <span class="n">replyTo</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">UpdateResult</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">Command</span>
  <span class="k">sealed</span> <span class="k">trait</span> <span class="nc">UpdateResult</span>
  <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">UpdateSuccess</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">UpdateResult</span>
  <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">UpdateFailure</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">reason</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">UpdateResult</span>
  <span class="k">private</span> <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">WrappedUpdateResult</span><span class="o">(</span><span class="n">result</span><span class="k">:</span> <span class="kt">UpdateResult</span><span class="o">,</span> <span class="n">replyTo</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">UpdateResult</span><span class="o">])</span>
      <span class="k">extends</span> <span class="nc">Command</span>

  <span class="k">private</span> <span class="k">val</span> <span class="nc">MaxOperationsInProgress</span> <span class="k">=</span> <span class="mi">10</span>

  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">dataAccess</span><span class="k">:</span> <span class="kt">CustomerDataAccess</span><span class="o">)</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">Command</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="n">next</span><span class="o">(</span><span class="n">dataAccess</span><span class="o">,</span> <span class="n">operationsInProgress</span> <span class="k">=</span> <span class="mi">0</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">private</span> <span class="k">def</span> <span class="n">next</span><span class="o">(</span><span class="n">dataAccess</span><span class="k">:</span> <span class="kt">CustomerDataAccess</span><span class="o">,</span> <span class="n">operationsInProgress</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">Command</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="nc">Behaviors</span><span class="o">.</span><span class="n">receive</span> <span class="o">{</span> <span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">command</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="n">command</span> <span class="k">match</span> <span class="o">{</span>
        <span class="k">case</span> <span class="nc">Update</span><span class="o">(</span><span class="n">value</span><span class="o">,</span> <span class="n">replyTo</span><span class="o">)</span> <span class="k">=&gt;</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">operationsInProgress</span> <span class="o">==</span> <span class="nc">MaxOperationsInProgress</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">replyTo</span> <span class="o">!</span> <span class="nc">UpdateFailure</span><span class="o">(</span><span class="n">value</span><span class="o">.</span><span class="n">id</span><span class="o">,</span> <span class="s">s&quot;Max </span><span class="si">$MaxOperationsInProgress</span><span class="s"> concurrent operations supported&quot;</span><span class="o">)</span>
            <span class="nc">Behaviors</span><span class="o">.</span><span class="n">same</span>
          <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">val</span> <span class="n">futureResult</span> <span class="k">=</span> <span class="n">dataAccess</span><span class="o">.</span><span class="n">update</span><span class="o">(</span><span class="n">value</span><span class="o">)</span>
            <span class="n">context</span><span class="o">.</span><span class="n">pipeToSelf</span><span class="o">(</span><span class="n">futureResult</span><span class="o">)</span> <span class="o">{</span>
              <span class="c1">// відображує значення Future до повідомлення, обробленого цим актором</span>
              <span class="k">case</span> <span class="nc">Success</span><span class="o">(</span><span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">WrappedUpdateResult</span><span class="o">(</span><span class="nc">UpdateSuccess</span><span class="o">(</span><span class="n">value</span><span class="o">.</span><span class="n">id</span><span class="o">),</span> <span class="n">replyTo</span><span class="o">)</span>
              <span class="k">case</span> <span class="nc">Failure</span><span class="o">(</span><span class="n">e</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">WrappedUpdateResult</span><span class="o">(</span><span class="nc">UpdateFailure</span><span class="o">(</span><span class="n">value</span><span class="o">.</span><span class="n">id</span><span class="o">,</span> <span class="n">e</span><span class="o">.</span><span class="n">getMessage</span><span class="o">),</span> <span class="n">replyTo</span><span class="o">)</span>
            <span class="o">}</span>
            <span class="c1">// збільшує operationsInProgress</span>
            <span class="n">next</span><span class="o">(</span><span class="n">dataAccess</span><span class="o">,</span> <span class="n">operationsInProgress</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span>
          <span class="o">}</span>

        <span class="k">case</span> <span class="nc">WrappedUpdateResult</span><span class="o">(</span><span class="n">result</span><span class="o">,</span> <span class="n">replyTo</span><span class="o">)</span> <span class="k">=&gt;</span>
          <span class="c1">// send result to original requestor</span>
          <span class="n">replyTo</span> <span class="o">!</span> <span class="n">result</span>
          <span class="c1">// decrease operationsInProgress counter</span>
          <span class="n">next</span><span class="o">(</span><span class="n">dataAccess</span><span class="o">,</span> <span class="n">operationsInProgress</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Може бути заманливо просто використовувати onComplete on the Future, але це вводить ризик доступу до внутрішнього стану актора, який не є безпечним для потоків із зовнішньої нитки. Наприклад, лічильник числаOfPendingOperations у наведеному вище прикладі не може отримати доступ до такого зворотного дзвінка. Тому краще відобразити результат на повідомлення та виконати подальшу обробку при отриманні цього повідомлення.</p></div>
<div class="paragraph"><p>Корисно, коли:</p></div>
<div class="ulist"><ul>
<li>
<p>
Є доступ до API, які повертають <code>Future</code> від актора, наприклад, до бази даних чи зовнішньої служби
</p>
</li>
<li>
<p>
Актору потрібно продовжувати обробку, коли <code>Future</code> завершиться
</p>
</li>
<li>
<p>
Зберігається контекст від початкового запиту і використовується, коли <code>Future</code> завершиться, наприклад посилання актора <code>replyTo</code>
</p>
</li>
</ul></div>
<div class="paragraph"><p>Проблеми:</p></div>
<div class="ulist"><ul>
<li>
<p>
Додавання обгорткових повідомлень для результатів
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="____">Один актор на сеанс</h3>
<div class="paragraph"><p>У деяких випадках повну відповідь на запит можна створити і надіслати назад лише після збору декількох відповідей від інших суб'єктів. Для таких видів взаємодії може бути корисним делегувати роботу на дитячого актора, по одному на сеанс. Дитина також може містити довільну логіку для здійснення повторних спроб, невдача по тайм-ауту, рубання хвоста, перевірка прогресу тощо</p></div>
<div class="paragraph"><p>Зауважте, що це по суті те, як реалізується <code>ask</code>, якщо все, що вам потрібно, - це одна відповідь з таймаутом, краще використовувати <code>ask</code>.</p></div>
<div class="paragraph"><p>Дитина створена з контекстом, який їй потрібно виконати, включаючи <code>ActorRef</code>, на який вона може відповісти. Коли повний результат є, дитина реагує на результат і зупиняється на собі.</p></div>
<div class="paragraph"><p>Оскільки протокол актора сеансу не є загальнодоступним API, а, скоріше, деталізацією реалізації головного актора, не завжди має сенс мати чіткий протокол та адаптувати повідомлення учасників, з якими взаємодіє актор сеансу. Для цього випадку використання можна висловити, що актор може отримати будь-яке повідомлення (<code>Any</code>).</p></div>
<div class="paragraph"><p>Приклад:</p></div>
<div class="imageblock">
<div class="content">
<img src="per-session-child.png" alt="per-session-child.png" />
</div>
</div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="c1">// фіктивні типи даних саме для цього зразка</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">Keys</span><span class="o">()</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">Wallet</span><span class="o">()</span>

<span class="k">object</span> <span class="nc">Home</span> <span class="o">{</span>
  <span class="k">sealed</span> <span class="k">trait</span> <span class="nc">Command</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">LeaveHome</span><span class="o">(</span><span class="n">who</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">replyTo</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">ReadyToLeaveHome</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">Command</span>
  <span class="k">case</span> <span class="k">class</span> <span class="nc">ReadyToLeaveHome</span><span class="o">(</span><span class="n">who</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">keys</span><span class="k">:</span> <span class="kt">Keys</span><span class="o">,</span> <span class="n">wallet</span><span class="k">:</span> <span class="kt">Wallet</span><span class="o">)</span>

  <span class="k">def</span> <span class="n">apply</span><span class="o">()</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">Command</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="nc">Behaviors</span><span class="o">.</span><span class="n">setup</span><span class="o">[</span><span class="kt">Command</span><span class="o">]</span> <span class="o">{</span> <span class="n">context</span> <span class="k">=&gt;</span>
      <span class="k">val</span> <span class="n">keyCabinet</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">KeyCabinet.GetKeys</span><span class="o">]</span> <span class="k">=</span> <span class="n">context</span><span class="o">.</span><span class="n">spawn</span><span class="o">(</span><span class="nc">KeyCabinet</span><span class="o">(),</span> <span class="s">&quot;key-cabinet&quot;</span><span class="o">)</span>
      <span class="k">val</span> <span class="n">drawer</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">Drawer.GetWallet</span><span class="o">]</span> <span class="k">=</span> <span class="n">context</span><span class="o">.</span><span class="n">spawn</span><span class="o">(</span><span class="nc">Drawer</span><span class="o">(),</span> <span class="s">&quot;drawer&quot;</span><span class="o">)</span>

      <span class="nc">Behaviors</span><span class="o">.</span><span class="n">receiveMessage</span><span class="o">[</span><span class="kt">Command</span><span class="o">]</span> <span class="o">{</span>
        <span class="k">case</span> <span class="nc">LeaveHome</span><span class="o">(</span><span class="n">who</span><span class="o">,</span> <span class="n">replyTo</span><span class="o">)</span> <span class="k">=&gt;</span>
          <span class="n">context</span><span class="o">.</span><span class="n">spawn</span><span class="o">(</span><span class="n">prepareToLeaveHome</span><span class="o">(</span><span class="n">who</span><span class="o">,</span> <span class="n">replyTo</span><span class="o">,</span> <span class="n">keyCabinet</span><span class="o">,</span> <span class="n">drawer</span><span class="o">),</span> <span class="s">s&quot;leaving-</span><span class="si">$who</span><span class="s">&quot;</span><span class="o">)</span>
          <span class="nc">Behaviors</span><span class="o">.</span><span class="n">same</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="c1">// на кожний сеанс поведінки актора</span>
  <span class="k">def</span> <span class="n">prepareToLeaveHome</span><span class="o">(</span>
      <span class="n">whoIsLeaving</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
      <span class="n">replyTo</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">ReadyToLeaveHome</span><span class="o">],</span>
      <span class="n">keyCabinet</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">KeyCabinet.GetKeys</span><span class="o">],</span>
      <span class="n">drawer</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">Drawer.GetWallet</span><span class="o">])</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">NotUsed</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="c1">// Нас не хвилює протокол актора, оскільки нам ніхто не надсилатиме</span>
    <span class="c1">// повідомлення, крім відповідей на наші запити, тому ми просто приймаємо будь-яке повідомлення</span>
    <span class="c1">// але звузити їх до більш обмежених типів, коли ми взаємодіємо з Behaviors</span>
      <span class="o">.</span><span class="n">setup</span><span class="o">[</span><span class="kt">AnyRef</span><span class="o">]</span> <span class="o">{</span> <span class="n">context</span> <span class="k">=&gt;</span>
        <span class="k">var</span> <span class="n">wallet</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">Wallet</span><span class="o">]</span> <span class="k">=</span> <span class="nc">None</span>
        <span class="k">var</span> <span class="n">keys</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">Keys</span><span class="o">]</span> <span class="k">=</span> <span class="nc">None</span>

<span class="c1">// ми звужуємо тип ActorRef до будь-якого підтипу фактичного типу, який ми приймаємо</span>
        <span class="n">keyCabinet</span> <span class="o">!</span> <span class="nc">KeyCabinet</span><span class="o">.</span><span class="nc">GetKeys</span><span class="o">(</span><span class="n">whoIsLeaving</span><span class="o">,</span> <span class="n">context</span><span class="o">.</span><span class="n">self</span><span class="o">.</span><span class="n">narrow</span><span class="o">[</span><span class="kt">Keys</span><span class="o">])</span>
        <span class="n">drawer</span> <span class="o">!</span> <span class="nc">Drawer</span><span class="o">.</span><span class="nc">GetWallet</span><span class="o">(</span><span class="n">whoIsLeaving</span><span class="o">,</span> <span class="n">context</span><span class="o">.</span><span class="n">self</span><span class="o">.</span><span class="n">narrow</span><span class="o">[</span><span class="kt">Wallet</span><span class="o">])</span>

        <span class="k">def</span> <span class="n">nextBehavior</span><span class="o">()</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">AnyRef</span><span class="o">]</span> <span class="k">=</span>
          <span class="o">(</span><span class="n">keys</span><span class="o">,</span> <span class="n">wallet</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
            <span class="k">case</span> <span class="o">(</span><span class="nc">Some</span><span class="o">(</span><span class="n">w</span><span class="o">),</span> <span class="nc">Some</span><span class="o">(</span><span class="n">k</span><span class="o">))</span> <span class="k">=&gt;</span>
              <span class="c1">// у нас обоє, &quot;сесія&quot; завершена!</span>
              <span class="n">replyTo</span> <span class="o">!</span> <span class="nc">ReadyToLeaveHome</span><span class="o">(</span><span class="n">whoIsLeaving</span><span class="o">,</span> <span class="n">w</span><span class="o">,</span> <span class="n">k</span><span class="o">)</span>
              <span class="nc">Behaviors</span><span class="o">.</span><span class="n">stopped</span>

            <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span>
              <span class="nc">Behaviors</span><span class="o">.</span><span class="n">same</span>
          <span class="o">}</span>

        <span class="nc">Behaviors</span><span class="o">.</span><span class="n">receiveMessage</span> <span class="o">{</span>
          <span class="k">case</span> <span class="n">w</span><span class="k">:</span> <span class="kt">Wallet</span> <span class="o">=&gt;</span>
            <span class="n">wallet</span> <span class="k">=</span> <span class="nc">Some</span><span class="o">(</span><span class="n">w</span><span class="o">)</span>
            <span class="n">nextBehavior</span><span class="o">()</span>
          <span class="k">case</span> <span class="n">k</span><span class="k">:</span> <span class="kt">Keys</span> <span class="o">=&gt;</span>
            <span class="n">keys</span> <span class="k">=</span> <span class="nc">Some</span><span class="o">(</span><span class="n">k</span><span class="o">)</span>
            <span class="n">nextBehavior</span><span class="o">()</span>
          <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span>
            <span class="nc">Behaviors</span><span class="o">.</span><span class="n">unhandled</span>
        <span class="o">}</span>
      <span class="o">}</span>
      <span class="o">.</span><span class="n">narrow</span><span class="o">[</span><span class="kt">NotUsed</span><span class="o">]</span> <span class="c1">// ми не даємо іншим знати, що ми щось приймаємо</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>У дійсному сеансі дитина, ймовірно, захоче також включити певну форму таймауту (див. щодо планування повідомлень для себе).</p></div>
<div class="paragraph"><p>Корисно, коли:</p></div>
<div class="ulist"><ul>
<li>
<p>
Один вхідний запит повинен спричинити багаторазову взаємодію з іншими суб'єктами, перш ніж результат може бути побудований, наприклад, агрегування кількох результатів
</p>
</li>
<li>
<p>
Потрібно обробляти підтвердження та повторювати повідомлення хоча б раз на доставку
</p>
</li>
</ul></div>
<div class="paragraph"><p>Проблеми:</p></div>
<div class="ulist"><ul>
<li>
<p>
Діти мають життєві цикли, якими потрібно керувати, щоб не створити витік ресурсів, легко можна пропустити сценарій, коли актор сеансу не зупиняється
</p>
</li>
<li>
<p>
Це збільшує складність, оскільки кожна така дитина може виконувати одночасно з іншими дітьми та батьком
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_____2">Агрегатор відповідей загального призначення</h3>
<div class="paragraph"><p>Це схоже на вищезазначений малюнок Актор на сеанс. Іноді ви можете в кінцевому підсумку повторити той самий спосіб збирання відповідей і хочете витягнути це для актора, який може повторно використовуватись.</p></div>
<div class="paragraph"><p>Існує багато варіацій цього шаблону, і саме тому це подано як приклад документації, а не вбудованої поведінки в Akka. Він призначений для адаптації до ваших конкретних потреб.</p></div>
<div class="paragraph"><p>Приклад:</p></div>
<div class="imageblock">
<div class="content">
<img src="aggregator.png" alt="aggregator.png" />
</div>
</div>
<div class="paragraph"><p>Цей приклад є агрегатором очікуваної кількості відповідей. Запити щодо пропозицій надсилаються із заданою функцією <code>sendRequests</code> двом акторам готелю, які обидва говорять за різними протоколами. Коли обидві очікувані відповіді будуть зібрані, вони агрегуються із заданою функцією агрегату <code>Replies</code> та повертаються до <code>replyTo</code>. Якщо відповіді не надходять у термін очікування, відповіді що зібрані надсилаються до <code>replyTo</code>.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">object</span> <span class="nc">Hotel1</span> <span class="o">{</span>
  <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">RequestQuote</span><span class="o">(</span><span class="n">replyTo</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">Quote</span><span class="o">])</span>
  <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">Quote</span><span class="o">(</span><span class="n">hotel</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">price</span><span class="k">:</span> <span class="kt">BigDecimal</span><span class="o">)</span>
<span class="o">}</span>
<span class="k">object</span> <span class="nc">Hotel2</span> <span class="o">{</span>
  <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">RequestPrice</span><span class="o">(</span><span class="n">replyTo</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">Price</span><span class="o">])</span>
  <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">Price</span><span class="o">(</span><span class="n">hotel</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">price</span><span class="k">:</span> <span class="kt">BigDecimal</span><span class="o">)</span>
<span class="o">}</span>

<span class="c1">// Any, оскільки немає загального типу між Hotel1 та Hotel2</span>
<span class="k">type</span> <span class="kt">Reply</span> <span class="o">=</span> <span class="nc">Any</span>

<span class="k">object</span> <span class="nc">HotelCustomer</span> <span class="o">{</span>
  <span class="k">sealed</span> <span class="k">trait</span> <span class="nc">Command</span>
  <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">Quote</span><span class="o">(</span><span class="n">hotel</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">price</span><span class="k">:</span> <span class="kt">BigDecimal</span><span class="o">)</span>
  <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">AggregatedQuotes</span><span class="o">(</span><span class="n">quotes</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">Quote</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">Command</span>

  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">hotel1</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">Hotel1.RequestQuote</span><span class="o">],</span>
    <span class="n">hotel2</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">Hotel2.RequestPrice</span><span class="o">])</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">Command</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>

    <span class="nc">Behaviors</span><span class="o">.</span><span class="n">setup</span><span class="o">[</span><span class="kt">Command</span><span class="o">]</span> <span class="o">{</span> <span class="n">context</span> <span class="k">=&gt;</span>
      <span class="n">context</span><span class="o">.</span><span class="n">spawnAnonymous</span><span class="o">(</span>
        <span class="nc">Aggregator</span><span class="o">[</span><span class="kt">Reply</span><span class="p">,</span> <span class="kt">AggregatedQuotes</span><span class="o">](</span>
          <span class="n">sendRequests</span> <span class="k">=</span> <span class="o">{</span> <span class="n">replyTo</span> <span class="k">=&gt;</span>
            <span class="n">hotel1</span> <span class="o">!</span> <span class="nc">Hotel1</span><span class="o">.</span><span class="nc">RequestQuote</span><span class="o">(</span><span class="n">replyTo</span><span class="o">)</span>
            <span class="n">hotel2</span> <span class="o">!</span> <span class="nc">Hotel2</span><span class="o">.</span><span class="nc">RequestPrice</span><span class="o">(</span><span class="n">replyTo</span><span class="o">)</span>
          <span class="o">},</span>
          <span class="n">expectedReplies</span> <span class="k">=</span> <span class="mi">2</span><span class="o">,</span>
          <span class="n">context</span><span class="o">.</span><span class="n">self</span><span class="o">,</span>
          <span class="n">aggregateReplies</span> <span class="k">=</span> <span class="n">replies</span> <span class="k">=&gt;</span>
            <span class="c1">// Готелі мають різні протоколи з різними відповідями,</span>
            <span class="c1">// конвертуйте їх у `HotelCustomer.Quote`, що цей актор розуміє.</span>
            <span class="nc">AggregatedQuotes</span><span class="o">(</span>
              <span class="n">replies</span>
                <span class="o">.</span><span class="n">map</span> <span class="o">{</span>
                  <span class="k">case</span> <span class="nc">Hotel1</span><span class="o">.</span><span class="nc">Quote</span><span class="o">(</span><span class="n">hotel</span><span class="o">,</span> <span class="n">price</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Quote</span><span class="o">(</span><span class="n">hotel</span><span class="o">,</span> <span class="n">price</span><span class="o">)</span>
                  <span class="k">case</span> <span class="nc">Hotel2</span><span class="o">.</span><span class="nc">Price</span><span class="o">(</span><span class="n">hotel</span><span class="o">,</span> <span class="n">price</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Quote</span><span class="o">(</span><span class="n">hotel</span><span class="o">,</span> <span class="n">price</span><span class="o">)</span>
                <span class="o">}</span>
                <span class="o">.</span><span class="n">sortBy</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">price</span><span class="o">)</span>
                <span class="o">.</span><span class="n">toList</span><span class="o">),</span>
          <span class="n">timeout</span> <span class="k">=</span> <span class="mf">5.</span><span class="n">seconds</span><span class="o">))</span>

      <span class="nc">Behaviors</span><span class="o">.</span><span class="n">receiveMessage</span> <span class="o">{</span>
        <span class="k">case</span> <span class="nc">AggregatedQuotes</span><span class="o">(</span><span class="n">quotes</span><span class="o">)</span> <span class="k">=&gt;</span>
          <span class="n">context</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">&quot;Best {}&quot;</span><span class="o">,</span> <span class="n">quotes</span><span class="o">.</span><span class="n">headOption</span><span class="o">.</span><span class="n">getOrElse</span><span class="o">(</span><span class="s">&quot;Quote N/A&quot;</span><span class="o">))</span>
          <span class="nc">Behaviors</span><span class="o">.</span><span class="n">same</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Реалізація агрегатора:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">scala.collection.immutable</span>
<span class="k">import</span> <span class="nn">scala.concurrent.duration.FiniteDuration</span>
<span class="k">import</span> <span class="nn">scala.reflect.ClassTag</span>

<span class="k">import</span> <span class="nn">akka.actor.typed.ActorRef</span>
<span class="k">import</span> <span class="nn">akka.actor.typed.Behavior</span>
<span class="k">import</span> <span class="nn">akka.actor.typed.scaladsl.Behaviors</span>

<span class="k">object</span> <span class="nc">Aggregator</span> <span class="o">{</span>

  <span class="k">sealed</span> <span class="k">trait</span> <span class="nc">Command</span>
  <span class="k">private</span> <span class="k">case</span> <span class="k">object</span> <span class="nc">ReceiveTimeout</span> <span class="k">extends</span> <span class="nc">Command</span>
  <span class="k">private</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">WrappedReply</span><span class="o">[</span><span class="kt">R</span><span class="o">](</span><span class="n">reply</span><span class="k">:</span> <span class="kt">R</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Command</span>

  <span class="k">def</span> <span class="n">apply</span><span class="o">[</span><span class="kt">Reply:</span> <span class="kt">ClassTag</span><span class="p">,</span> <span class="kt">Aggregate</span><span class="o">](</span>
      <span class="n">sendRequests</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">Reply</span><span class="o">]</span> <span class="k">=&gt;</span> <span class="nc">Unit</span><span class="o">,</span>
      <span class="n">expectedReplies</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span>
      <span class="n">replyTo</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">[</span><span class="kt">Aggregate</span><span class="o">],</span>
      <span class="n">aggregateReplies</span><span class="k">:</span> <span class="kt">immutable.IndexedSeq</span><span class="o">[</span><span class="kt">Reply</span><span class="o">]</span> <span class="k">=&gt;</span> <span class="nc">Aggregate</span><span class="o">,</span>
      <span class="n">timeout</span><span class="k">:</span> <span class="kt">FiniteDuration</span><span class="o">)</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">Command</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="nc">Behaviors</span><span class="o">.</span><span class="n">setup</span> <span class="o">{</span> <span class="n">context</span> <span class="k">=&gt;</span>
      <span class="n">context</span><span class="o">.</span><span class="n">setReceiveTimeout</span><span class="o">(</span><span class="n">timeout</span><span class="o">,</span> <span class="nc">ReceiveTimeout</span><span class="o">)</span>
      <span class="k">val</span> <span class="n">replyAdapter</span> <span class="k">=</span> <span class="n">context</span><span class="o">.</span><span class="n">messageAdapter</span><span class="o">[</span><span class="kt">Reply</span><span class="o">](</span><span class="nc">WrappedReply</span><span class="o">(</span><span class="k">_</span><span class="o">))</span>
      <span class="n">sendRequests</span><span class="o">(</span><span class="n">replyAdapter</span><span class="o">)</span>

      <span class="k">def</span> <span class="n">collecting</span><span class="o">(</span><span class="n">replies</span><span class="k">:</span> <span class="kt">immutable.IndexedSeq</span><span class="o">[</span><span class="kt">Reply</span><span class="o">])</span><span class="k">:</span> <span class="kt">Behavior</span><span class="o">[</span><span class="kt">Command</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
        <span class="nc">Behaviors</span><span class="o">.</span><span class="n">receiveMessage</span> <span class="o">{</span>
          <span class="k">case</span> <span class="nc">WrappedReply</span><span class="o">(</span><span class="n">reply</span><span class="k">:</span> <span class="kt">Reply</span><span class="o">)</span> <span class="k">=&gt;</span>
            <span class="k">val</span> <span class="n">newReplies</span> <span class="k">=</span> <span class="n">replies</span> <span class="o">:+</span> <span class="n">reply</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">newReplies</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">expectedReplies</span><span class="o">)</span> <span class="o">{</span>
              <span class="k">val</span> <span class="n">result</span> <span class="k">=</span> <span class="n">aggregateReplies</span><span class="o">(</span><span class="n">newReplies</span><span class="o">)</span>
              <span class="n">replyTo</span> <span class="o">!</span> <span class="n">result</span>
              <span class="nc">Behaviors</span><span class="o">.</span><span class="n">stopped</span>
            <span class="o">}</span> <span class="k">else</span>
              <span class="n">collecting</span><span class="o">(</span><span class="n">newReplies</span><span class="o">)</span>

          <span class="k">case</span> <span class="nc">ReceiveTimeout</span> <span class="k">=&gt;</span>
            <span class="k">val</span> <span class="n">aggregate</span> <span class="k">=</span> <span class="n">aggregateReplies</span><span class="o">(</span><span class="n">replies</span><span class="o">)</span>
            <span class="n">replyTo</span> <span class="o">!</span> <span class="n">aggregate</span>
            <span class="nc">Behaviors</span><span class="o">.</span><span class="n">stopped</span>
        <span class="o">}</span>
      <span class="o">}</span>

      <span class="n">collecting</span><span class="o">(</span><span class="nc">Vector</span><span class="o">.</span><span class="n">empty</span><span class="o">)</span>
    <span class="o">}</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Корисно, коли:</p></div>
<div class="ulist"><ul>
<li>
<p>
Агрегуючі відповіді виконуються однаково в декількох місцях і повинні бути вилучені для актора більш загального призначення.
</p>
</li>
<li>
<p>
Один вхідний запит повинен спричинити багаторазову взаємодію з іншими суб'єктами, перш ніж результат може бути побудований, наприклад, агрегування кількох результатів
</p>
</li>
<li>
<p>
Потрібно обробляти підтвердження та повторювати повідомлення для доставки хоча б раз
</p>
</li>
</ul></div>
<div class="paragraph"><p>Проблеми:</p></div>
<div class="ulist"><ul>
<li>
<p>
Протоколи повідомлень із загальними типами є складними, оскільки загальні типи стираються під час виконання
</p>
</li>
<li>
<p>
Діти мають життєві цикли, якими потрібно керувати, щоб не створити витік ресурсів, може легко пропустити сценарій, коли актор сеансу не зупиняється
</p>
</li>
<li>
<p>
Це збільшує складність, оскільки кожна така дитина може виконувати одночасно з іншими дітьми та батьком
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="____3">Рубання хвоста затримки</h3>
<div class="paragraph"><p>Це варіація вищезазначеної схеми агрегатора відповідей загального призначення.</p></div>
<div class="paragraph"><p>The goal of this algorithm is to decrease tail latencies (“chop off the tail latency”) in situations where multiple destination actors can perform the same piece of work, and where an actor may occasionally respond more slowly than expected. In this case, sending the same work request (also known as a “backup request”) to another actor results in decreased response time - because it’s less probable that multiple actors are under heavy load simultaneously. This technique is explained in depth in Jeff Dean’s presentation on Achieving Rapid Response Times in Large Online Services.</p></div>
<div class="paragraph"><p>There are many variations of this pattern and that is the reason this is provided as a documentation example rather than a built in Behavior in Akka. It is intended to be adjusted to your specific needs.</p></div>
<div class="paragraph"><p>Example:</p></div>
<div class="paragraph"><p>tail-chopping.png</p></div>
<div class="paragraph"><p>Scala
import scala.concurrent.duration.FiniteDuration
import scala.reflect.ClassTag</p></div>
<div class="paragraph"><p>import akka.actor.typed.ActorRef
import akka.actor.typed.Behavior
import akka.actor.typed.scaladsl.Behaviors</p></div>
<div class="paragraph"><p>object TailChopping {</p></div>
<div class="literalblock">
<div class="content">
<pre><code>sealed trait Command
private case object RequestTimeout extends Command
private case object FinalTimeout extends Command
private case class WrappedReply[R](reply: R) extends Command</code></pre>
</div></div>
<div class="literalblock">
<div class="content">
<pre><code>def apply[Reply: ClassTag](
    sendRequest: (Int, ActorRef[Reply]) =&gt; Boolean,
    nextRequestAfter: FiniteDuration,
    replyTo: ActorRef[Reply],
    finalTimeout: FiniteDuration,
    timeoutReply: Reply): Behavior[Command] = {
  Behaviors.setup { context =&gt;
    Behaviors.withTimers { timers =&gt;
      val replyAdapter = context.messageAdapter[Reply](WrappedReply(_))</code></pre>
</div></div>
<div class="literalblock">
<div class="content">
<pre><code>def waiting(requestCount: Int): Behavior[Command] = {
  Behaviors.receiveMessage {
    case WrappedReply(reply: Reply) =&gt;
      replyTo ! reply
      Behaviors.stopped</code></pre>
</div></div>
<div class="literalblock">
<div class="content">
<pre><code>case RequestTimeout =&gt;
  sendNextRequest(requestCount + 1)</code></pre>
</div></div>
<div class="literalblock">
<div class="content">
<pre><code>    case FinalTimeout =&gt;
      replyTo ! timeoutReply
      Behaviors.stopped
  }
}</code></pre>
</div></div>
<div class="literalblock">
<div class="content">
<pre><code>def sendNextRequest(requestCount: Int): Behavior[Command] = {
  if (sendRequest(requestCount, replyAdapter)) {
    timers.startSingleTimer(RequestTimeout, nextRequestAfter)
  } else {
    timers.startSingleTimer(FinalTimeout, finalTimeout)
  }
  waiting(requestCount)
}</code></pre>
</div></div>
<div class="literalblock">
<div class="content">
<pre><code>      sendNextRequest(1)
    }
  }
}</code></pre>
</div></div>
<div class="paragraph"><p>}
Java
Useful when:</p></div>
<div class="paragraph"><p>Reducing higher latency percentiles and variations of latency are important
The “work” can be done more than once with the same result, e.g. a request to retrieve information
Problems:</p></div>
<div class="paragraph"><p>Increased load since more messages are sent and “work” is performed more than once
Can’t be used when the “work” is not idempotent and must only be performed once
Message protocols with generic types are difficult since the generic types are erased in runtime
Children have life cycles that must be managed to not create a resource leak, it can be easy to miss a scenario where the session actor is not stopped
Scheduling messages to self
The following example demonstrates how to use timers to schedule messages to an actor.</p></div>
<div class="paragraph"><p>Example:</p></div>
<div class="paragraph"><p>timer.png</p></div>
<div class="paragraph"><p>The Buncher actor buffers a burst of incoming messages and delivers them as a batch after a timeout or when the number of batched messages exceeds a maximum size.</p></div>
<div class="paragraph"><p>Scala
object Buncher {</p></div>
<div class="literalblock">
<div class="content">
<pre><code>sealed trait Command
final case class ExcitingMessage(message: String) extends Command
final case class Batch(messages: Vector[Command])
private case object Timeout extends Command
private case object TimerKey</code></pre>
</div></div>
<div class="literalblock">
<div class="content">
<pre><code>  def apply(target: ActorRef[Batch], after: FiniteDuration, maxSize: Int): Behavior[Command] = {
    Behaviors.withTimers(timers =&gt; new Buncher(timers, target, after, maxSize).idle())
  }
}</code></pre>
</div></div>
<div class="paragraph"><p>class Buncher(
    timers: TimerScheduler[Buncher.Command],
    target: ActorRef[Buncher.Batch],
    after: FiniteDuration,
    maxSize: Int) {
  import Buncher._</p></div>
<div class="literalblock">
<div class="content">
<pre><code>private def idle(): Behavior[Command] = {
  Behaviors.receiveMessage[Command] { message =&gt;
    timers.startSingleTimer(TimerKey, Timeout, after)
    active(Vector(message))
  }
}</code></pre>
</div></div>
<div class="literalblock">
<div class="content">
<pre><code>  def active(buffer: Vector[Command]): Behavior[Command] = {
    Behaviors.receiveMessage[Command] {
      case Timeout =&gt;
        target ! Batch(buffer)
        idle()
      case m =&gt;
        val newBuffer = buffer :+ m
        if (newBuffer.size == maxSize) {
          timers.cancel(TimerKey)
          target ! Batch(newBuffer)
          idle()
        } else
          active(newBuffer)
    }
  }
}
Java
There are a few things worth noting here:</code></pre>
</div></div>
<div class="paragraph"><p>To get access to the timers you start with Behaviors.withTimers that will pass a TimerScheduler instance to the function. This can be used with any type of Behavior, including receive, receiveMessage, but also setup or any other behavior.
Each timer has a key and if a new timer with the same key is started, the previous is cancelled. It is guaranteed that a message from the previous timer is not received, even if it was already enqueued in the mailbox when the new timer was started.
Both periodic and single message timers are supported.
The TimerScheduler is mutable in itself, because it performs and manages the side effects of registering the scheduled tasks.
The TimerScheduler is bound to the lifecycle of the actor that owns it and is cancelled automatically when the actor is stopped.
Behaviors.withTimers can also be used inside Behaviors.supervise and it will automatically cancel the started timers correctly when the actor is restarted, so that the new incarnation will not receive scheduled messages from a previous incarnation.
Schedule periodically
Scheduling of recurring messages can have two different characteristics:</p></div>
<div class="paragraph"><p>fixed-delay - The delay between sending subsequent messages will always be (at least) the given delay. Use startTimerWithFixedDelay.
fixed-rate - The frequency of execution over time will meet the given interval. Use startTimerAtFixedRate.
If you are uncertain of which one to use you should pick startTimerWithFixedDelay.</p></div>
<div class="paragraph"><p>When using fixed-delay it will not compensate the delay between messages if the scheduling is delayed longer than specified for some reason. The delay between sending subsequent messages will always be (at least) the given delay. In the long run, the frequency of messages will generally be slightly lower than the reciprocal of the specified delay.</p></div>
<div class="paragraph"><p>Fixed-delay execution is appropriate for recurring activities that require “smoothness.” In other words, it is appropriate for activities where it is more important to keep the frequency accurate in the short run than in the long run.</p></div>
<div class="paragraph"><p>When using fixed-rate it will compensate the delay for a subsequent task if the previous messages were delayed too long. In such cases, the actual sending interval will differ from the interval passed to the scheduleAtFixedRate method.</p></div>
<div class="paragraph"><p>If the tasks are delayed longer than the interval, the subsequent message will be sent immediately after the prior one. This also has the consequence that after long garbage collection pauses or other reasons when the JVM was suspended all “missed” tasks will execute when the process wakes up again. For example, scheduleAtFixedRate with an interval of 1 second and the process is suspended for 30 seconds will result in 30 messages being sent in rapid succession to catch up. In the long run, the frequency of execution will be exactly the reciprocal of the specified interval.</p></div>
<div class="paragraph"><p>Fixed-rate execution is appropriate for recurring activities that are sensitive to absolute time or where the total time to perform a fixed number of executions is important, such as a countdown timer that ticks once every second for ten seconds.</p></div>
<div class="paragraph"><p>Warning
scheduleAtFixedRate can result in bursts of scheduled messages after long garbage collection pauses, which may in worst case cause undesired load on the system. scheduleWithFixedDelay is often preferred.</p></div>
<div class="paragraph"><p>Responding to a sharded actor
When Akka Cluster is used to shard actors you need to take into account that an actor may move or get passivated.</p></div>
<div class="paragraph"><p>The normal pattern for expecting a reply is to include an ActorRef in the message, typically a message adapter. This can be used for a sharded actor but if ctx.self is sent and the sharded actor is moved or passivated then the reply will sent to dead letters.</p></div>
<div class="paragraph"><p>An alternative is to send the entityId in the message and have the reply sent via sharding.</p></div>
<div class="paragraph"><p>Example:</p></div>
<div class="paragraph"><p>sharded-response.png</p></div>
<div class="paragraph"><p>Scala

object CounterConsumer {
  sealed trait Command
  final case class NewCount(count: Long) extends Command
  val TypeKey: EntityTypeKey[Command] = EntityTypeKey[Command]("example-sharded-response")
}</p></div>
<div class="paragraph"><p>object Counter {
  trait Command
  case object Increment extends Command
  final case class GetValue(replyToEntityId: String) extends Command
  val TypeKey: EntityTypeKey[Command] = EntityTypeKey[Command]("example-sharded-counter")</p></div>
<div class="literalblock">
<div class="content">
<pre><code>private def apply(): Behavior[Command] =
  Behaviors.setup { context =&gt;
    counter(ClusterSharding(context.system), 0)
  }</code></pre>
</div></div>
<div class="literalblock">
<div class="content">
<pre><code>private def counter(sharding: ClusterSharding, value: Long): Behavior[Command] =
  Behaviors.receiveMessage {
    case Increment =&gt;
      counter(sharding, value + 1)
    case GetValue(replyToEntityId) =&gt;
      val replyToEntityRef = sharding.entityRefFor(CounterConsumer.TypeKey, replyToEntityId)
      replyToEntityRef ! CounterConsumer.NewCount(value)
      Behaviors.same
  }</code></pre>
</div></div>
<div class="paragraph"><p>}
Java
A disadvantage is that a message adapter can’t be used so the response has to be in the protocol of the actor being responded to. Additionally the EntityTypeKey could be included in the message if it is not known statically.</p></div>
</div>
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Last updated
 2020-06-13 12:51:36 EEST
</div>
</div>
</body>
</html>
