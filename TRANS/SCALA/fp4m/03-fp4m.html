<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.6.10" />
<title>3. Розробка застосування</title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

.monospaced, code, pre {
  font-family: "Courier New", Courier, monospace;
  font-size: inherit;
  color: navy;
  padding: 0;
  margin: 0;
}
pre {
  white-space: pre-wrap;
}

#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #888;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; vertical-align: text-bottom; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel0, div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }

div.unbreakable { page-break-inside: avoid; }


/*
 * xhtml11 specific
 *
 * */

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}
.highlight .hll { background-color: #ffffcc }
.highlight  { background: #f8f8f8; }
.highlight .c { color: #408080; font-style: italic } /* Comment */
.highlight .err { border: 1px solid #FF0000 } /* Error */
.highlight .k { color: #008000; font-weight: bold } /* Keyword */
.highlight .o { color: #666666 } /* Operator */
.highlight .cm { color: #408080; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #BC7A00 } /* Comment.Preproc */
.highlight .c1 { color: #408080; font-style: italic } /* Comment.Single */
.highlight .cs { color: #408080; font-style: italic } /* Comment.Special */
.highlight .gd { color: #A00000 } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #FF0000 } /* Generic.Error */
.highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight .gi { color: #00A000 } /* Generic.Inserted */
.highlight .go { color: #808080 } /* Generic.Output */
.highlight .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight .gt { color: #0040D0 } /* Generic.Traceback */
.highlight .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #008000 } /* Keyword.Pseudo */
.highlight .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #B00040 } /* Keyword.Type */
.highlight .m { color: #666666 } /* Literal.Number */
.highlight .s { color: #BA2121 } /* Literal.String */
.highlight .na { color: #7D9029 } /* Name.Attribute */
.highlight .nb { color: #008000 } /* Name.Builtin */
.highlight .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.highlight .no { color: #880000 } /* Name.Constant */
.highlight .nd { color: #AA22FF } /* Name.Decorator */
.highlight .ni { color: #999999; font-weight: bold } /* Name.Entity */
.highlight .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #0000FF } /* Name.Function */
.highlight .nl { color: #A0A000 } /* Name.Label */
.highlight .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.highlight .nt { color: #008000; font-weight: bold } /* Name.Tag */
.highlight .nv { color: #19177C } /* Name.Variable */
.highlight .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mf { color: #666666 } /* Literal.Number.Float */
.highlight .mh { color: #666666 } /* Literal.Number.Hex */
.highlight .mi { color: #666666 } /* Literal.Number.Integer */
.highlight .mo { color: #666666 } /* Literal.Number.Oct */
.highlight .sb { color: #BA2121 } /* Literal.String.Backtick */
.highlight .sc { color: #BA2121 } /* Literal.String.Char */
.highlight .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.highlight .s2 { color: #BA2121 } /* Literal.String.Double */
.highlight .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.highlight .sh { color: #BA2121 } /* Literal.String.Heredoc */
.highlight .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.highlight .sx { color: #008000 } /* Literal.String.Other */
.highlight .sr { color: #BB6688 } /* Literal.String.Regex */
.highlight .s1 { color: #BA2121 } /* Literal.String.Single */
.highlight .ss { color: #19177C } /* Literal.String.Symbol */
.highlight .bp { color: #008000 } /* Name.Builtin.Pseudo */
.highlight .vc { color: #19177C } /* Name.Variable.Class */
.highlight .vg { color: #19177C } /* Name.Variable.Global */
.highlight .vi { color: #19177C } /* Name.Variable.Instance */
.highlight .il { color: #666666 } /* Literal.Number.Integer.Long */


</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install();
/*]]>*/
</script>
</head>
<body class="book">
<div id="header">
<h1>3. Розробка застосування</h1>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph"><p>В цій главі ми випишемо бізнес логіку та тести для чисто функціонального застосування сервера. Джерельний код для цього застосування включений в каталозі <code>example</code> разом з джерелом цієї книги, однак рекомендовано не читати код до фінальної глави, оскільки будуть значні рефакторинги по мірі того, як ми вивчатимемо FP.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_3_1_">3.1 Специфікація</h2>
<div class="sectionbody">
<div class="paragraph"><p>Наше застосування буде керувати фермою побудови <em>just-in-time</em> на обмежений бюджет. Воно буде слухати сервер <em>Drone Continuous Integration</em>, та відгалужувати робочі агенти з використанням <em>Google Container Engine</em> (GKE), щоб задовільняти потреби робочої черги.</p></div>
<div class="imageblock">
<div class="content">
<img src="architecture.png" alt="Архитектура" />
</div>
</div>
<div class="paragraph"><p>Дрон отримує роботу, коли контриб'ютор надсилає в github пул ріквест на керованому проекті. Дрон призначає роботу до своїх агентів, кожний з яких обробляє одне завдання за раз.</p></div>
<div class="paragraph"><p>Ціллю нашого застосування є переконатись, що існує досить агентів для завершення роботи, з обмеженням на число агентів, таким чином мінімізуючи загальну вартість. Наше застосування має знати число елементів в беклозі, та число доступних агентів.</p></div>
<div class="paragraph"><p>Google може відгалужувати вузли, кожний матиме декілька агентів дронів. Коли агент запускається, він реєструє себе за допомогою дронів, та дрон турбується про його життєвий цикл (включаючи виклики keep-alive для детекції видалених агентів).</p></div>
<div class="paragraph"><p>GKE нараховує рахунки за кожну хвилину роботи, округлюючи до найбільшої години для кожного вузла. Ніхто просто не виділяє новий вузол для кожного завдання в робочій черзі, ми маємо повторно використовувати вузли та залишати їх до їх 58-мої хвилини, щоб отримати найбільшу користь за наші гроші.</p></div>
<div class="paragraph"><p>Наше застосування має бути в змозі запускати та зупиняти вузли, так само, як перевіряти їх статус (тобто час роботи та список неактивних вузлів), та знати, який час GKE вважає за вірний.</p></div>
<div class="paragraph"><p>На додаток, немає API для прямого звернення до агентів, так що ми не знаємо, чи окремий агент виконує деяку роботу для сервера дронів. Якщо ми зупинимо агента, доки він виконує роботу, це буде незручно, та потребуватиме від людини повторно запустити завдання.</p></div>
<div class="paragraph"><p>Контриб'ютори можуть вручну додавати агентів до ферми, так що підрахунок агентів та вузлів не є еквівалентним. Нам не треба додавати жодних вузлів, якщо є доступні агенти.</p></div>
<div class="paragraph"><p>Збійний вузол повинен завжди бути найменьш коштовною опцією.</p></div>
<div class="paragraph"><p>Обоє, Drone та GKE, мають JSON over REST API з аутентифікацією OAuth 2.0.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_3_2__">3.2 Інтерфейси / алгебри</h2>
<div class="sectionbody">
<div class="paragraph"><p>Тепер ми будемо кодифікувати архитектурну діаграму з попереднього розділу. Зпершу, нам треба визначити простий тип даних для зберігання відмітки часу в мілісекундах, оскільки така проста річ не існує в стандартних бібліотеках ані Java, ані Scala:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>  <span class="k">import</span> <span class="nn">scala.concurrent.duration._</span>

  <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">Epoch</span><span class="o">(</span><span class="n">millis</span><span class="k">:</span> <span class="kt">Long</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">AnyVal</span> <span class="o">{</span>
    <span class="k">def</span> <span class="o">+(</span><span class="n">d</span><span class="k">:</span> <span class="kt">FiniteDuration</span><span class="o">)</span><span class="k">:</span> <span class="kt">Epoch</span> <span class="o">=</span> <span class="nc">Epoch</span><span class="o">(</span><span class="n">millis</span> <span class="o">+</span> <span class="n">d</span><span class="o">.</span><span class="n">toMillis</span><span class="o">)</span>
    <span class="k">def</span> <span class="o">-(</span><span class="n">e</span><span class="k">:</span> <span class="kt">Epoch</span><span class="o">)</span><span class="k">:</span> <span class="kt">FiniteDuration</span> <span class="o">=</span> <span class="o">(</span><span class="n">millis</span> <span class="o">-</span> <span class="n">e</span><span class="o">.</span><span class="n">millis</span><span class="o">).</span><span class="n">millis</span>
  <span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>В FP займає місце інтерфейсів в Java, або набору валідних повідомлень в Akka. Це прошарок, де ми визначаємо всі побічні взаємодії нашої системи.</p></div>
<div class="paragraph"><p>Існує тісна взаємодія між написанням бізнес логіки та алгеброю: це гарний рівень абстракції для розробки системи.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>  <span class="k">trait</span> <span class="nc">Drone</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]]</span> <span class="o">{</span>
    <span class="k">def</span> <span class="n">getBacklog</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span>
    <span class="k">def</span> <span class="n">getAgents</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span>
  <span class="o">}</span>

  <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">MachineNode</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
  <span class="k">trait</span> <span class="nc">Machines</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]]</span> <span class="o">{</span>
    <span class="k">def</span> <span class="n">getTime</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">Epoch</span><span class="o">]</span>
    <span class="k">def</span> <span class="n">getManaged</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">NonEmptyList</span><span class="o">[</span><span class="kt">MachineNode</span><span class="o">]]</span>
    <span class="k">def</span> <span class="n">getAlive</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">Map</span><span class="o">[</span><span class="kt">MachineNode</span>, <span class="kt">Epoch</span><span class="o">]]</span>
    <span class="k">def</span> <span class="n">start</span><span class="o">(</span><span class="n">node</span><span class="k">:</span> <span class="kt">MachineNode</span><span class="o">)</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">MachineNode</span><span class="o">]</span>
    <span class="k">def</span> <span class="n">stop</span><span class="o">(</span><span class="n">node</span><span class="k">:</span> <span class="kt">MachineNode</span><span class="o">)</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">MachineNode</span><span class="o">]</span>
  <span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Ми використали <code>NonEmptyList</code>, просто створений через виклик <code>.toNel</code> на стандартному <code>List</code> (що повертає Option[NonEmptyList]), все інше має бути знайомим.</p></div>
<div class="paragraph"><p>Це є гарною практикою в FP, щоб закодувати обмеження в параметрах та типах повернення — це означає ніколи не мати потреби обробляти ситуації, які неможливі. Однак це часто конфліктує з правилом Postel “бути ліберальним в тому, що ви сприймаєте від інших”.</p></div>
<div class="paragraph"><p>Хоча ми згодні, що параметри мають бути такі загальні, як це можливо, ми не згодні, що функція має приймати <code>Seq</code>, тільки якщо вона не може обробляти порожню <code>Seq</code>, інакше єдиним способом дії буде виключення, що руйнує загальність та спричиняє побічний ефект.</p></div>
<div class="paragraph"><p>Ми обираємо <code>NonEmptyList</code> не тому, що це <code>List</code>, а тому що це непорожня властивість. Коли ми вивчимо щодо ієрархії класів типів Scalaz, ми побачимо кращий шлях для запиту на не-порожність.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_3_3__">3.3 Бізнес логіка</h2>
<div class="sectionbody">
<div class="paragraph"><p>Тепер ми напишемо бізнес логіку, що визначає поведінку застосування, розглядаючи тільки щасливий шлях.</p></div>
<div class="paragraph"><p>Нам треба клас <code>WorldView</code> щоб зберігати знімок нашого знання щодо світу. Якщо б ми писали це застосування на Akka, <code>WorldView</code> мав би бути, можливо, <code>var</code> в <code>Actor</code> зі станом.</p></div>
<div class="paragraph"><p><code>WorldView</code> агрегує значення повернення всіх методів алгебри, та додає поле <code>pending</code> для відстеження незадовільнених запитів.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>  <span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">WorldView</span><span class="o">(</span>
    <span class="n">backlog</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span>
    <span class="n">agents</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span>
    <span class="n">managed</span><span class="k">:</span> <span class="kt">NonEmptyList</span><span class="o">[</span><span class="kt">MachineNode</span><span class="o">],</span>
    <span class="n">alive</span><span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">MachineNode</span>, <span class="kt">Epoch</span><span class="o">],</span>
    <span class="n">pending</span><span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">MachineNode</span>, <span class="kt">Epoch</span><span class="o">],</span>
    <span class="n">time</span><span class="k">:</span> <span class="kt">Epoch</span>
  <span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Тепер ми готові написати нашу бізнес логіку, але нам треба вказати, що ми залежимо від <code>Drone</code> та <code>Machines</code>.</p></div>
<div class="paragraph"><p>Ми можемо записати інтерфейс для бізнес логіки:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>  <span class="k">trait</span> <span class="nc">DynAgents</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]]</span> <span class="o">{</span>
    <span class="k">def</span> <span class="n">initial</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">WorldView</span><span class="o">]</span>
    <span class="k">def</span> <span class="n">update</span><span class="o">(</span><span class="n">old</span><span class="k">:</span> <span class="kt">WorldView</span><span class="o">)</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">WorldView</span><span class="o">]</span>
    <span class="k">def</span> <span class="n">act</span><span class="o">(</span><span class="n">world</span><span class="k">:</span> <span class="kt">WorldView</span><span class="o">)</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">WorldView</span><span class="o">]</span>
  <span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>та реалізувати його як модуль. Модуль залежить тільки від інших модулів, та може бути абстрагований через <code>F</code>. Якщо реалізація алгебраїчного інтерфейсу прив'язана до специфічного типу, як <code>IO</code>, він називається інтерпретатором.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>  <span class="k">final</span> <span class="k">class</span> <span class="nc">DynAgentsModule</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Monad</span><span class="o">](</span><span class="n">D</span><span class="k">:</span> <span class="kt">Drone</span><span class="o">[</span><span class="kt">F</span><span class="o">],</span> <span class="n">M</span><span class="k">:</span> <span class="kt">Machines</span><span class="o">[</span><span class="kt">F</span><span class="o">])</span>
    <span class="k">extends</span> <span class="nc">DynAgents</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span> <span class="o">{</span>
</pre></div></div></div>
<div class="paragraph"><p>Прив'язка контексту <code>Monad</code> означає, що <code>F</code> монадичний, дозволяючи нам використовувати <code>map</code>, <code>pure</code>, та звичайно <code>flatMap</code> через розширений <code>for</code>.</p></div>
<div class="paragraph"><p>Ми маємо  доступ до алгебри <code>Drone</code> та <code>Machines</code> як <code>D</code> та <code>M</code>, відповідно. Використання поодиноких великих літер як імен є загальною домовленостю іменування монад та реалізацій алгебр.</p></div>
<div class="paragraph"><p>Наша бізнес логіка буде робити в безкінечному циклі (псевдокод)</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>  <span class="n">state</span> <span class="k">=</span> <span class="n">initial</span><span class="o">()</span>
  <span class="k">while</span> <span class="nc">True</span><span class="k">:</span>
    <span class="kt">state</span> <span class="o">=</span> <span class="n">update</span><span class="o">(</span><span class="n">state</span><span class="o">)</span>
    <span class="n">state</span> <span class="k">=</span> <span class="n">act</span><span class="o">(</span><span class="n">state</span><span class="o">)</span>
</pre></div></div></div>
<div class="sect2">
<h3 id="_3_3_1_initial">3.3.1 initial</h3>
<div class="paragraph"><p>В <code>initial</code> ми викликаємо всі зовнішні сервіси, та агрегуємо їх результати в <code>WorldView</code>. По замовчанню поле <code>pending</code> є порожня <code>Map</code>.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>  <span class="k">def</span> <span class="n">initial</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">WorldView</span><span class="o">]</span> <span class="k">=</span> <span class="k">for</span> <span class="o">{</span>
    <span class="n">db</span> <span class="k">&lt;-</span> <span class="n">D</span><span class="o">.</span><span class="n">getBacklog</span>
    <span class="n">da</span> <span class="k">&lt;-</span> <span class="n">D</span><span class="o">.</span><span class="n">getAgents</span>
    <span class="n">mm</span> <span class="k">&lt;-</span> <span class="n">M</span><span class="o">.</span><span class="n">getManaged</span>
    <span class="n">ma</span> <span class="k">&lt;-</span> <span class="n">M</span><span class="o">.</span><span class="n">getAlive</span>
    <span class="n">mt</span> <span class="k">&lt;-</span> <span class="n">M</span><span class="o">.</span><span class="n">getTime</span>
  <span class="o">}</span> <span class="k">yield</span> <span class="nc">WorldView</span><span class="o">(</span><span class="n">db</span><span class="o">,</span> <span class="n">da</span><span class="o">,</span> <span class="n">mm</span><span class="o">,</span> <span class="n">ma</span><span class="o">,</span> <span class="nc">Map</span><span class="o">.</span><span class="n">empty</span><span class="o">,</span> <span class="n">mt</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Згадайте з Глави 1, що <code>flatMap</code> (тобто коли ми використовуємо генератор <code>&lt;-</code>) дозволяє нам оперувати на значенні, що генерується під час виконання. Коли ми повертаємо <code>F[_]</code>, ми повертаємо іншу програму, що має інтерпретуватись під час виконання, так що потім ми можемо зробити <code>flatMap</code>. Це те, як ми безпечно зціплюємо разом послідовний код з побічною дією, і так є в змозі провадити чисту реалізацію тестів. FP може бути описане як Екстрім Мокінг.</p></div>
</div>
<div class="sect2">
<h3 id="_3_3_2_update">3.3.2 update</h3>
<div class="paragraph"><p><code>update</code> має викликати <code>initial</code> для оновлення свого бачення світу, зберігаючи відомі очікуючі дії.</p></div>
<div class="paragraph"><p>Якщо вузол змінив стан, ми видаляємо його з очікуючих, та якщо підвисла операція займає більше ніж 10 хвилин щоб зробити щось, ми вважаємо що вона схибила, та забуваємо, що ми просили зробити це.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>  <span class="k">def</span> <span class="n">update</span><span class="o">(</span><span class="n">old</span><span class="k">:</span> <span class="kt">WorldView</span><span class="o">)</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">WorldView</span><span class="o">]</span> <span class="k">=</span> <span class="k">for</span> <span class="o">{</span>
    <span class="n">snap</span> <span class="k">&lt;-</span> <span class="n">initial</span>
    <span class="n">changed</span> <span class="k">=</span> <span class="n">symdiff</span><span class="o">(</span><span class="n">old</span><span class="o">.</span><span class="n">alive</span><span class="o">.</span><span class="n">keySet</span><span class="o">,</span> <span class="n">snap</span><span class="o">.</span><span class="n">alive</span><span class="o">.</span><span class="n">keySet</span><span class="o">)</span>
    <span class="n">pending</span> <span class="k">=</span> <span class="o">(</span><span class="n">old</span><span class="o">.</span><span class="n">pending</span> <span class="o">--</span> <span class="n">changed</span><span class="o">).</span><span class="n">filterNot</span> <span class="o">{</span>
      <span class="k">case</span> <span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="n">started</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="n">snap</span><span class="o">.</span><span class="n">time</span> <span class="o">-</span> <span class="n">started</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="mf">10.</span><span class="n">minutes</span>
    <span class="o">}</span>
    <span class="n">update</span> <span class="k">=</span> <span class="n">snap</span><span class="o">.</span><span class="n">copy</span><span class="o">(</span><span class="n">pending</span> <span class="k">=</span> <span class="n">pending</span><span class="o">)</span>
  <span class="o">}</span> <span class="k">yield</span> <span class="n">update</span>

  <span class="k">private</span> <span class="k">def</span> <span class="n">symdiff</span><span class="o">[</span><span class="kt">T</span><span class="o">](</span><span class="n">a</span><span class="k">:</span> <span class="kt">Set</span><span class="o">[</span><span class="kt">T</span><span class="o">],</span> <span class="n">b</span><span class="k">:</span> <span class="kt">Set</span><span class="o">[</span><span class="kt">T</span><span class="o">])</span><span class="k">:</span> <span class="kt">Set</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="k">=</span>
    <span class="o">(</span><span class="n">a</span> <span class="n">union</span> <span class="n">b</span><span class="o">)</span> <span class="o">--</span> <span class="o">(</span><span class="n">a</span> <span class="n">intersect</span> <span class="n">b</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Суцільні функції, як <code>.symdiff</code>, не потребують тестових інтерпретаторів, вони мають явні входи та виходи, так що ми можемо перемістити чистий код в окремі методи на об'єкті без стану, що можна тестувати ізольовано. Ми задовільняємось тестуванням тільки публічних методів, зважаючи що наша бізнес логіка легка для читання.</p></div>
</div>
<div class="sect2">
<h3 id="_3_3_3_act">3.3.3 act</h3>
<div class="paragraph"><p>Метод <code>act</code> трохи складніший, так що ми для ясності розіб'ємо його на частини: визначення того, що дія має бути виконана, та саме виконання дії. Це спрощення означає, що ми можемо виконувати тільки одну дію за виклик, але це має сенс, бо ми можемо контролювати виклики, та можемо обирати пере-виконати дію, доки більше не залишиться дій.</p></div>
<div class="paragraph"><p>Ми пишемо сценарій детектора як екстрактори для <code>WorldView</code>, що нічого більше, ніж виразний спосіб писати умови <code>if / else</code>.</p></div>
<div class="paragraph"><p>Нам треба додати агентів до ферми, якщо є беклог роботи, ми не маємо агентів, ми не маємо живих вузлів, та немає очікуваних дій. Ми повертаємо вузол кандидат, який ми можливо стартуємо:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>  <span class="k">private</span> <span class="k">object</span> <span class="nc">NeedsAgent</span> <span class="o">{</span>
    <span class="k">def</span> <span class="n">unapply</span><span class="o">(</span><span class="n">world</span><span class="k">:</span> <span class="kt">WorldView</span><span class="o">)</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">MachineNode</span><span class="o">]</span> <span class="k">=</span> <span class="n">world</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">WorldView</span><span class="o">(</span><span class="n">backlog</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">managed</span><span class="o">,</span> <span class="n">alive</span><span class="o">,</span> <span class="n">pending</span><span class="o">,</span> <span class="k">_</span><span class="o">)</span>
           <span class="k">if</span> <span class="n">backlog</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">alive</span><span class="o">.</span><span class="n">isEmpty</span> <span class="o">&amp;&amp;</span> <span class="n">pending</span><span class="o">.</span><span class="n">isEmpty</span>
             <span class="k">=&gt;</span> <span class="nc">Option</span><span class="o">(</span><span class="n">managed</span><span class="o">.</span><span class="n">head</span><span class="o">)</span>
      <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="nc">None</span>
    <span class="o">}</span>
  <span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Якщо немає беклогу, нам треба зупинити всі вузли, що завмерли (вони не роблять жодної роботи). Однак, оскільки Google виставляє рахунки щогодини, ми зупиняємо тільки машини на їх 58й хвилині, щоб отримати максимум за наші гроші. Ми повертаємо непорожній список вузлів, що треба зупинити.</p></div>
<div class="paragraph"><p>Як фінансова страховка, всі вузли повинні мати максимальний строк життя в 5 годин.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>  <span class="k">private</span> <span class="k">object</span> <span class="nc">Stale</span> <span class="o">{</span>
    <span class="k">def</span> <span class="n">unapply</span><span class="o">(</span><span class="n">world</span><span class="k">:</span> <span class="kt">WorldView</span><span class="o">)</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">NonEmptyList</span><span class="o">[</span><span class="kt">MachineNode</span><span class="o">]]</span> <span class="k">=</span> <span class="n">world</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">WorldView</span><span class="o">(</span><span class="n">backlog</span><span class="o">,</span> <span class="k">_</span><span class="o">,</span> <span class="k">_</span><span class="o">,</span> <span class="n">alive</span><span class="o">,</span> <span class="n">pending</span><span class="o">,</span> <span class="n">time</span><span class="o">)</span> <span class="k">if</span> <span class="n">alive</span><span class="o">.</span><span class="n">nonEmpty</span> <span class="k">=&gt;</span>
        <span class="o">(</span><span class="n">alive</span> <span class="o">--</span> <span class="n">pending</span><span class="o">.</span><span class="n">keys</span><span class="o">).</span><span class="n">collect</span> <span class="o">{</span>
          <span class="k">case</span> <span class="o">(</span><span class="n">n</span><span class="o">,</span> <span class="n">started</span><span class="o">)</span> <span class="k">if</span> <span class="n">backlog</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">time</span> <span class="o">-</span> <span class="n">started</span><span class="o">).</span><span class="n">toMinutes</span> <span class="o">%</span> <span class="mi">60</span> <span class="o">&gt;=</span> <span class="mi">58</span> <span class="k">=&gt;</span> <span class="n">n</span>
          <span class="k">case</span> <span class="o">(</span><span class="n">n</span><span class="o">,</span> <span class="n">started</span><span class="o">)</span> <span class="k">if</span> <span class="o">(</span><span class="n">time</span> <span class="o">-</span> <span class="n">started</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="mf">5.</span><span class="n">hours</span> <span class="k">=&gt;</span> <span class="n">n</span>
        <span class="o">}.</span><span class="n">toList</span><span class="o">.</span><span class="n">toNel</span>

      <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="nc">None</span>
    <span class="o">}</span>
  <span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Тепер ми визначили сценарії, що можуть трапитись, і можемо писати метод <code>act</code>. Коли ми плануємо вузол на запуск або зупинку, ми додаємо її до <code>pending</code>, занотовуючи час, коли ми запланувати дію.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>  <span class="k">def</span> <span class="n">act</span><span class="o">(</span><span class="n">world</span><span class="k">:</span> <span class="kt">WorldView</span><span class="o">)</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">WorldView</span><span class="o">]</span> <span class="k">=</span> <span class="n">world</span> <span class="k">match</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">NeedsAgent</span><span class="o">(</span><span class="n">node</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="k">for</span> <span class="o">{</span>
        <span class="k">_</span> <span class="k">&lt;-</span> <span class="n">M</span><span class="o">.</span><span class="n">start</span><span class="o">(</span><span class="n">node</span><span class="o">)</span>
        <span class="n">update</span> <span class="k">=</span> <span class="n">world</span><span class="o">.</span><span class="n">copy</span><span class="o">(</span><span class="n">pending</span> <span class="k">=</span> <span class="nc">Map</span><span class="o">(</span><span class="n">node</span> <span class="o">-&gt;</span> <span class="n">world</span><span class="o">.</span><span class="n">time</span><span class="o">))</span>
      <span class="o">}</span> <span class="k">yield</span> <span class="n">update</span>

    <span class="k">case</span> <span class="nc">Stale</span><span class="o">(</span><span class="n">nodes</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="n">nodes</span><span class="o">.</span><span class="n">foldLeftM</span><span class="o">(</span><span class="n">world</span><span class="o">)</span> <span class="o">{</span> <span class="o">(</span><span class="n">world</span><span class="o">,</span> <span class="n">n</span><span class="o">)</span> <span class="k">=&gt;</span>
        <span class="k">for</span> <span class="o">{</span>
          <span class="k">_</span> <span class="k">&lt;-</span> <span class="n">M</span><span class="o">.</span><span class="n">stop</span><span class="o">(</span><span class="n">n</span><span class="o">)</span>
          <span class="n">update</span> <span class="k">=</span> <span class="n">world</span><span class="o">.</span><span class="n">copy</span><span class="o">(</span><span class="n">pending</span> <span class="k">=</span> <span class="n">world</span><span class="o">.</span><span class="n">pending</span> <span class="o">+</span> <span class="o">(</span><span class="n">n</span> <span class="o">-&gt;</span> <span class="n">world</span><span class="o">.</span><span class="n">time</span><span class="o">))</span>
        <span class="o">}</span> <span class="k">yield</span> <span class="n">update</span>
      <span class="o">}</span>

    <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="n">world</span><span class="o">.</span><span class="n">pure</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span>
  <span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Оскільки <code>NeedsAgent</code> та <code>Stale</code> не покривають всі можливі ситуації, нам треба загальний випадок <code>_</code>, що нічого не робить. Згадайте з Глави 2, що <code>.pure</code> створює <code>for</code> (монадичний) контекст зі значення.</p></div>
<div class="paragraph"><p><code>foldLeftM</code> подібний до <code>foldLeft</code>, але кожна ітерація згортання може повертати монадичне значення. В нашому випадку кожна ітерація згортання повертає <code>F[WorldView]</code>. <code>M</code> означає <code>Monadic</code>. Ми пізнаємо більше про ці піднесені методи, що поводяться як дехто може очікувати, беручи монадичні значення на місті значень.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_3_4__">3.4 Юніт тести</h2>
<div class="sectionbody">
<div class="paragraph"><p>Підхід FP до написання застосувань є мрією розробника: делегування написання реалізацій алгебр членам команди, та фокусування на розробці бізнес логіки відповідає потребам.</p></div>
<div class="paragraph"><p>Наше застосування сильно залежне від таймінгів та веб сервісів третіх сторін. Якби це було традиційне OOP застосування, ми б створили моки для всіх викликів методів, або тестували акторів на вихідних скриньках. FP мокінг еквівалентний до провадження альтернативної реалізації алгебр залежностей. Алгебри вже ізолюють частини системи, що мають бути моковані, тобто інтерпретовані інакше в юніт тестах.</p></div>
<div class="paragraph"><p>Ми почнемо з деяких тестових даних:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>  <span class="k">object</span> <span class="nc">Data</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">node1</span>   <span class="k">=</span> <span class="nc">MachineNode</span><span class="o">(</span><span class="s">&quot;1243d1af-828f-4ba3-9fc0-a19d86852b5a&quot;</span><span class="o">)</span>
    <span class="k">val</span> <span class="n">node2</span>   <span class="k">=</span> <span class="nc">MachineNode</span><span class="o">(</span><span class="s">&quot;550c4943-229e-47b0-b6be-3d686c5f013f&quot;</span><span class="o">)</span>
    <span class="k">val</span> <span class="n">managed</span> <span class="k">=</span> <span class="nc">NonEmptyList</span><span class="o">(</span><span class="n">node1</span><span class="o">,</span> <span class="n">node2</span><span class="o">)</span>

    <span class="k">val</span> <span class="n">time1</span><span class="k">:</span> <span class="kt">Epoch</span> <span class="o">=</span> <span class="n">epoch</span><span class="s">&quot;2017-03-03T18:07:00Z&quot;</span>
    <span class="k">val</span> <span class="n">time2</span><span class="k">:</span> <span class="kt">Epoch</span> <span class="o">=</span> <span class="n">epoch</span><span class="s">&quot;2017-03-03T18:59:00Z&quot;</span> <span class="c1">// +52 mins</span>
    <span class="k">val</span> <span class="n">time3</span><span class="k">:</span> <span class="kt">Epoch</span> <span class="o">=</span> <span class="n">epoch</span><span class="s">&quot;2017-03-03T19:06:00Z&quot;</span> <span class="c1">// +59 mins</span>
    <span class="k">val</span> <span class="n">time4</span><span class="k">:</span> <span class="kt">Epoch</span> <span class="o">=</span> <span class="n">epoch</span><span class="s">&quot;2017-03-03T23:07:00Z&quot;</span> <span class="c1">// +5 hours</span>

    <span class="k">val</span> <span class="n">needsAgents</span> <span class="k">=</span> <span class="nc">WorldView</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">managed</span><span class="o">,</span> <span class="nc">Map</span><span class="o">.</span><span class="n">empty</span><span class="o">,</span> <span class="nc">Map</span><span class="o">.</span><span class="n">empty</span><span class="o">,</span> <span class="n">time1</span><span class="o">)</span>
  <span class="o">}</span>
  <span class="k">import</span> <span class="nn">Data._</span>
</pre></div></div></div>
<div class="paragraph"><p>Інтерполятор рядка <code>epoch</code> написаний за допомогою контекстуальної бібліотеки від Jon Pretty, даючи повну безпеку коло конструкторів рядків цього типу:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>  <span class="k">import</span> <span class="nn">java.time.Instant</span>
  <span class="k">object</span> <span class="nc">EpochInterpolator</span> <span class="k">extends</span> <span class="nc">Verifier</span><span class="o">[</span><span class="kt">Epoch</span><span class="o">]</span> <span class="o">{</span>
    <span class="k">def</span> <span class="n">check</span><span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Either</span><span class="o">[(</span><span class="kt">Int</span>, <span class="kt">String</span><span class="o">)</span>, <span class="kt">Epoch</span><span class="o">]</span> <span class="k">=</span>
      <span class="k">try</span> <span class="nc">Right</span><span class="o">(</span><span class="nc">Epoch</span><span class="o">(</span><span class="nc">Instant</span><span class="o">.</span><span class="n">parse</span><span class="o">(</span><span class="n">s</span><span class="o">).</span><span class="n">toEpochMilli</span><span class="o">))</span>
      <span class="k">catch</span> <span class="o">{</span> <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="nc">Left</span><span class="o">((</span><span class="mi">0</span><span class="o">,</span> <span class="s">&quot;not in ISO-8601 format&quot;</span><span class="o">))</span> <span class="o">}</span>
  <span class="o">}</span>
  <span class="k">implicit</span> <span class="k">class</span> <span class="nc">EpochMillisStringContext</span><span class="o">(</span><span class="n">sc</span><span class="k">:</span> <span class="kt">StringContext</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">epoch</span> <span class="k">=</span> <span class="nc">Prefix</span><span class="o">(</span><span class="nc">EpochInterpolator</span><span class="o">,</span> <span class="n">sc</span><span class="o">)</span>
  <span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Ми реалізуємо алгебри через розширення <code>Drone</code> та <code>Machines</code> за допомогою специфічного монадичного контексту, <code>Id</code> є найпростіший з таких.</p></div>
<div class="paragraph"><p>Наші “мок” реалізації просто програють фіксований <code>WorldView</code>. Ми ізолювали стан системи, так що ми можемо використовувати <code>var</code> для зберігання стану:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>  <span class="k">class</span> <span class="nc">Mutable</span><span class="o">(</span><span class="n">state</span><span class="k">:</span> <span class="kt">WorldView</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">var</span> <span class="n">started</span><span class="o">,</span> <span class="n">stopped</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">private</span> <span class="k">val</span> <span class="n">D</span><span class="k">:</span> <span class="kt">Drone</span><span class="o">[</span><span class="kt">Id</span><span class="o">]</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Drone</span><span class="o">[</span><span class="kt">Id</span><span class="o">]</span> <span class="o">{</span>
      <span class="k">def</span> <span class="n">getBacklog</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">backlog</span>
      <span class="k">def</span> <span class="n">getAgents</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">agents</span>
    <span class="o">}</span>

    <span class="k">private</span> <span class="k">val</span> <span class="n">M</span><span class="k">:</span> <span class="kt">Machines</span><span class="o">[</span><span class="kt">Id</span><span class="o">]</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Machines</span><span class="o">[</span><span class="kt">Id</span><span class="o">]</span> <span class="o">{</span>
      <span class="k">def</span> <span class="n">getAlive</span><span class="k">:</span> <span class="kt">Map</span><span class="o">[</span><span class="kt">MachineNode</span>, <span class="kt">Epoch</span><span class="o">]</span> <span class="k">=</span> <span class="n">state</span><span class="o">.</span><span class="n">alive</span>
      <span class="k">def</span> <span class="n">getManaged</span><span class="k">:</span> <span class="kt">NonEmptyList</span><span class="o">[</span><span class="kt">MachineNode</span><span class="o">]</span> <span class="k">=</span> <span class="n">state</span><span class="o">.</span><span class="n">managed</span>
      <span class="k">def</span> <span class="n">getTime</span><span class="k">:</span> <span class="kt">Epoch</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">time</span>
      <span class="k">def</span> <span class="n">start</span><span class="o">(</span><span class="n">node</span><span class="k">:</span> <span class="kt">MachineNode</span><span class="o">)</span><span class="k">:</span> <span class="kt">MachineNode</span> <span class="o">=</span> <span class="o">{</span> <span class="n">started</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">;</span> <span class="n">node</span> <span class="o">}</span>
      <span class="k">def</span> <span class="n">stop</span><span class="o">(</span><span class="n">node</span><span class="k">:</span> <span class="kt">MachineNode</span><span class="o">)</span><span class="k">:</span> <span class="kt">MachineNode</span> <span class="o">=</span> <span class="o">{</span> <span class="n">stopped</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">;</span> <span class="n">node</span> <span class="o">}</span>
    <span class="o">}</span>

    <span class="k">val</span> <span class="n">program</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">DynAgentsModule</span><span class="o">[</span><span class="kt">Id</span><span class="o">](</span><span class="n">D</span><span class="o">,</span> <span class="n">M</span><span class="o">)</span>
  <span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Ми повернемось до цього коду пізніше, та змінимо <code>var</code> на щось безпечніше.</p></div>
<div class="paragraph"><p>Коли ми пишемо юніт тест (тут використовуючи <code>FlatSpec</code> зі <code>Scalatest</code>), ми створюємо примірник <code>Mutable</code>, та потім імпортуємо всі його члени.</p></div>
<div class="paragraph"><p>Наші неявні <code>drone</code> та <code>machines</code> обоє використовують контекст виконання <code>Id</code>, і, таким чином, інтерпретуємо цю програму з тим, що вони повертають як <code>Id[WorldView]</code>, на чому ми можемо робити припущення.</p></div>
<div class="paragraph"><p>В цьому тривіальному випадку ми тільки перевіряємо, що метод <code>initial</code> повертає те саме значення, що ми використовуємо для статичних реалізацій:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>  <span class="s">&quot;Business Logic&quot;</span> <span class="n">should</span> <span class="s">&quot;generate an initial world view&quot;</span> <span class="n">in</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">mutable</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Mutable</span><span class="o">(</span><span class="n">needsAgents</span><span class="o">)</span>
    <span class="k">import</span> <span class="nn">mutable._</span>

    <span class="n">program</span><span class="o">.</span><span class="n">initial</span> <span class="n">shouldBe</span> <span class="n">needsAgents</span>
  <span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Ми можемо створювати більш докладні тести методів <code>update</code> та <code>act</code>, допомогаючи нам виявити вади та краще окреслити потреби:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>  <span class="n">it</span> <span class="n">should</span> <span class="s">&quot;remove changed nodes from pending&quot;</span> <span class="n">in</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">world</span> <span class="k">=</span> <span class="nc">WorldView</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">managed</span><span class="o">,</span> <span class="nc">Map</span><span class="o">(</span><span class="n">node1</span> <span class="o">-&gt;</span> <span class="n">time3</span><span class="o">),</span> <span class="nc">Map</span><span class="o">.</span><span class="n">empty</span><span class="o">,</span> <span class="n">time3</span><span class="o">)</span>
    <span class="k">val</span> <span class="n">mutable</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Mutable</span><span class="o">(</span><span class="n">world</span><span class="o">)</span>
    <span class="k">import</span> <span class="nn">mutable._</span>

    <span class="k">val</span> <span class="n">old</span> <span class="k">=</span> <span class="n">world</span><span class="o">.</span><span class="n">copy</span><span class="o">(</span><span class="n">alive</span> <span class="k">=</span> <span class="nc">Map</span><span class="o">.</span><span class="n">empty</span><span class="o">,</span>
                         <span class="n">pending</span> <span class="k">=</span> <span class="nc">Map</span><span class="o">(</span><span class="n">node1</span> <span class="o">-&gt;</span> <span class="n">time2</span><span class="o">),</span>
                         <span class="n">time</span> <span class="k">=</span> <span class="n">time2</span><span class="o">)</span>
    <span class="n">program</span><span class="o">.</span><span class="n">update</span><span class="o">(</span><span class="n">old</span><span class="o">)</span> <span class="n">shouldBe</span> <span class="n">world</span>
  <span class="o">}</span>

  <span class="n">it</span> <span class="n">should</span> <span class="s">&quot;request agents when needed&quot;</span> <span class="n">in</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">mutable</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Mutable</span><span class="o">(</span><span class="n">needsAgents</span><span class="o">)</span>
    <span class="k">import</span> <span class="nn">mutable._</span>

    <span class="k">val</span> <span class="n">expected</span> <span class="k">=</span> <span class="n">needsAgents</span><span class="o">.</span><span class="n">copy</span><span class="o">(</span>
      <span class="n">pending</span> <span class="k">=</span> <span class="nc">Map</span><span class="o">(</span><span class="n">node1</span> <span class="o">-&gt;</span> <span class="n">time1</span><span class="o">)</span>
    <span class="o">)</span>

    <span class="n">program</span><span class="o">.</span><span class="n">act</span><span class="o">(</span><span class="n">needsAgents</span><span class="o">)</span> <span class="n">shouldBe</span> <span class="n">expected</span>

    <span class="n">mutable</span><span class="o">.</span><span class="n">stopped</span> <span class="n">shouldBe</span> <span class="mi">0</span>
    <span class="n">mutable</span><span class="o">.</span><span class="n">started</span> <span class="n">shouldBe</span> <span class="mi">1</span>
  <span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Може бути нудним проходити через цілу тестову сюїту. Наступні тести просто реалізувати з використанням того самого підходу:</p></div>
<div class="ulist"><ul>
<li>
<p>
не запитувати агентів, коли є очікування на завершення
</p>
</li>
<li>
<p>
не зупиняти агентів, якщо вузли дуже молоді
</p>
</li>
<li>
<p>
припиняти агентів, якщо немає беклога , і вузли будуть скоро нараховувати нові витрати
</p>
</li>
<li>
<p>
не зупиняти агентів, якщо є очікувані дії
</p>
</li>
<li>
<p>
припиняти агенти, коли немає беклога, якщо вони дуже старі
</p>
</li>
<li>
<p>
припиняти агенти, навіть якщо вони виконують роботу, якщо вони дуже старі
</p>
</li>
<li>
<p>
ігнорувати невідповідаючі очікувані дії під час оновлення
</p>
</li>
</ul></div>
<div class="paragraph"><p>Всі ці тести синхроггі та ізольовані відносно потоку виконавця тестів (що може виконувати тести паралельно). Якщо ми розробляли нашу тестову сюїту в Akka, наші тести могли б бути предметом для довільних таймаутів, та збої були б приховані в файлах журналів.</p></div>
<div class="paragraph"><p>Ривок продуктивності простих тестів для бізнес логіки не може бути переоцінений. Згляньтесь на те, що 90% часу розробника застосування є взаємодія з замовником в проясненні, оновленні та полагодженні ціх бізнес правил. Все інше деталі реалізації.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_3_5_">3.5 Паралельність</h2>
<div class="sectionbody">
<div class="paragraph"><p>Застосування, що ми розробили, виконує кожний з алгебраїчних методів послідовно. Але є очевидні місця, де робота може бути виконана паралельно.</p></div>
<div class="sect2">
<h3 id="_3_5_1_initial">3.5.1 initial</h3>
<div class="paragraph"><p>В нашому визначенні <code>initial</code> ми можемо запитати, щоб вся інформація треба нам одночасно, замість одного запиту за раз.</p></div>
<div class="paragraph"><p>На відміну від <code>flatMap</code> для послідовних операцій, <code>Scalaz</code> використовує синтаксис <code>Apply</code> для паралельних операцій:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>  <span class="o">^^^^(</span><span class="n">D</span><span class="o">.</span><span class="n">getBacklog</span><span class="o">,</span> <span class="n">D</span><span class="o">.</span><span class="n">getAgents</span><span class="o">,</span> <span class="n">M</span><span class="o">.</span><span class="n">getManaged</span><span class="o">,</span> <span class="n">M</span><span class="o">.</span><span class="n">getAlive</span><span class="o">,</span> <span class="n">M</span><span class="o">.</span><span class="n">getTime</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>що також має інфіксну нотацію:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>  <span class="o">(</span><span class="n">D</span><span class="o">.</span><span class="n">getBacklog</span> <span class="o">|@|</span> <span class="n">D</span><span class="o">.</span><span class="n">getAgents</span> <span class="o">|@|</span> <span class="n">M</span><span class="o">.</span><span class="n">getManaged</span> <span class="o">|@|</span> <span class="n">M</span><span class="o">.</span><span class="n">getAlive</span> <span class="o">|@|</span> <span class="n">M</span><span class="o">.</span><span class="n">getTime</span><span class="o">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Якщо якась з паралельних операцій повертає значення в тому ж монадичному контексті, ми можемо застосувати функцію до результатів, коли вони всі повернуться. Перепишемо <code>initial</code>, щоб мати з цього вигоду:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>  <span class="k">def</span> <span class="n">initial</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">WorldView</span><span class="o">]</span> <span class="k">=</span>
    <span class="o">^^^^(</span><span class="n">D</span><span class="o">.</span><span class="n">getBacklog</span><span class="o">,</span> <span class="n">D</span><span class="o">.</span><span class="n">getAgents</span><span class="o">,</span> <span class="n">M</span><span class="o">.</span><span class="n">getManaged</span><span class="o">,</span> <span class="n">M</span><span class="o">.</span><span class="n">getAlive</span><span class="o">,</span> <span class="n">M</span><span class="o">.</span><span class="n">getTime</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">case</span> <span class="o">(</span><span class="n">db</span><span class="o">,</span> <span class="n">da</span><span class="o">,</span> <span class="n">mm</span><span class="o">,</span> <span class="n">ma</span><span class="o">,</span> <span class="n">mt</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">WorldView</span><span class="o">(</span><span class="n">db</span><span class="o">,</span> <span class="n">da</span><span class="o">,</span> <span class="n">mm</span><span class="o">,</span> <span class="n">ma</span><span class="o">,</span> <span class="nc">Map</span><span class="o">.</span><span class="n">empty</span><span class="o">,</span> <span class="n">mt</span><span class="o">)</span>
    <span class="o">}</span>
</pre></div></div></div>
</div>
<div class="sect2">
<h3 id="_3_5_2_act">3.5.2 act</h3>
<div class="paragraph"><p>В поточній логіці для <code>act</code>, ми зупиняємо кожний вузол послідовно, очікуючи на результат, та потім продовжуємо. Але ми можемо зупинити всі вузли паралельно, та потім оновити наше бачення світу.</p></div>
<div class="paragraph"><p>Недолік цього способу в тому, що всі збої спричинять швидкий шлях перед оновленням поля <code>pending</code>. Але це логічний компроміс, оскільки наше <code>update</code> буде акуратно обробляти випадок, коли вузол раптово зупинився.</p></div>
<div class="paragraph"><p>Нам треба метод, що оперує на <code>NonEmptyList</code>, що дозволяє нам <code>map</code> кожний елемент на <code>F[MachineNode]</code>, повертаючи <code>F[NonEmptyList[MachineNode]]</code>. Метод має назву <code>traverse</code>, та потім ми <code>flatMap</code> по ньому і отримуємо <code>NonEmptyList[MachineNode]</code>, з яким ми просто маємо справу:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span></span>  <span class="k">for</span> <span class="o">{</span>
    <span class="n">stopped</span> <span class="k">&lt;-</span> <span class="n">nodes</span><span class="o">.</span><span class="n">traverse</span><span class="o">(</span><span class="n">M</span><span class="o">.</span><span class="n">stop</span><span class="o">)</span>
    <span class="n">updates</span> <span class="k">=</span> <span class="n">stopped</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span> <span class="o">-&gt;</span> <span class="n">world</span><span class="o">.</span><span class="n">time</span><span class="o">).</span><span class="n">toList</span><span class="o">.</span><span class="n">toMap</span>
    <span class="n">update</span> <span class="k">=</span> <span class="n">world</span><span class="o">.</span><span class="n">copy</span><span class="o">(</span><span class="n">pending</span> <span class="k">=</span> <span class="n">world</span><span class="o">.</span><span class="n">pending</span> <span class="o">++</span> <span class="n">updates</span><span class="o">)</span>
  <span class="o">}</span> <span class="k">yield</span> <span class="n">update</span>
</pre></div></div></div>
<div class="paragraph"><p>Можливо це простіше зрозуміти, ніж послідовну версію.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_3_6_">3.6 Підсумок</h2>
<div class="sectionbody">
<div class="paragraph"><p>Алгебри визначають інтерфейс між системами.</p></div>
<div class="paragraph"><p>Модулі є реалізаціями алгебри в термінах інших алгебр.</p></div>
<div class="paragraph"><p>Інтерпретатори є суцільними реалізаціями алгебри для фіксованого <code>F[_]</code>.</p></div>
<div class="paragraph"><p>Тестові інтерпретатори можуть заміняти частини з побічними ефектами системи, даючи значну частину тестового покриття.</p></div>
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Last updated
 2019-07-07 23:06:10 EEST
</div>
</div>
</body>
</html>
