<!DOCTYPE html>
<html>
  <head>
    <meta>
    <meta>
    <title>BEP44</title>
  </head>
  <body>
    <p>
      <meta http-equiv="content-type" content="text/html; charset=utf-8">
    </p>
    <div id="header" style="margin: 0px; width: 700px; border-bottom: 2px solid rgb(238, 238, 238); color: rgb(51, 51, 51); font-family: &quot;Trebuchet MS&quot;, sans-serif; font-size: 10px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-style: initial; text-decoration-color: initial;">
      <h1 style="margin: 1em 0px 0.1em; font-size: 2em; font-weight: normal; letter-spacing: -1px;"><a
          href="http://bittorrent.org/index.html" style="color: rgb(102, 102, 102); text-decoration: none; border: 0px;">BitTorrent<span
            style="font-weight: bold; color: rgb(0, 153, 255);">.org</span></a></h1>
    </div>
    <div id="nav" style="margin: 0px 0px 40px; padding: 0.5em 0px; text-align: right; color: rgb(51, 51, 51); font-family: &quot;Trebuchet MS&quot;, sans-serif; font-size: 10px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-style: initial; text-decoration-color: initial;">
      <ul style="list-style: none; padding: 0px; margin: 0px;">
        <li style="margin-left: 1em; padding: 0px; display: inline; font-size: 1.5em; font-weight: bold;"><a
            href="http://bittorrent.org/index.html" style="color: rgb(51, 68, 85); text-decoration: none; border-bottom: 1px solid rgb(238, 238, 238);">Home</a></li>
        <span>&nbsp;</span>
        <li style="margin-left: 1em; padding: 0px; display: inline; font-size: 1.5em; font-weight: bold;"><a
            href="http://bittorrent.org/introduction.html" style="color: rgb(51, 68, 85); text-decoration: none; border-bottom: 1px solid rgb(238, 238, 238);">For
            Users</a></li>
        <span>&nbsp;</span>
        <li style="margin-left: 1em; padding: 0px; display: inline; font-size: 1.5em; font-weight: bold;"><a
            href="http://bittorrent.org/beps/bep_0000.html" style="color: rgb(51, 68, 85); text-decoration: none; border-bottom: 1px solid rgb(238, 238, 238);"><span
              style="color: rgb(255, 102, 0);">For Developers</span></a></li>
        <span>&nbsp;</span>
        <li style="margin-left: 1em; padding: 0px; display: inline; font-size: 1.5em; font-weight: bold;"><a
            href="http://bittorrent.org/mailing_list.html" style="color: rgb(51, 68, 85); text-decoration: none; border-bottom: 1px solid rgb(238, 238, 238);">Developer
            mailing list</a><span>&nbsp;</span></li>
        <li style="margin-left: 1em; padding: 0px; display: inline; font-size: 1.5em; font-weight: bold;"><a
            href="http://forum.bittorrent.org/" style="color: rgb(51, 68, 85); text-decoration: none; border-bottom: 1px solid rgb(238, 238, 238);">Forums
            (archive)</a></li>
      </ul>
    </div>
    <div id="second" style="color: rgb(51, 51, 51); font-family: &quot;Trebuchet MS&quot;, sans-serif; font-size: 10px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: normal; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-style: initial; text-decoration-color: initial;">
      <table class="docinfo" frame="void" rules="none" style="border: 0px; margin-left: 4em;">
        <colgroup><col class="docinfo-name" style="margin: 0px; font-size: 1.2em; text-align: right; vertical-align: middle;"><col
            class="docinfo-content"></colgroup>
        <tbody valign="top">
          <tr class="bep field">
            <th class="docinfo-name" style="margin: 0px; font-size: 1.2em; text-align: right; vertical-align: middle;">BEP:</th>
            <td class="field-body" style="font-size: 9pt; padding: 10px;">44</td>
          </tr>
          <tr class="title field">
            <th class="docinfo-name" style="margin: 0px; font-size: 1.2em; text-align: right; vertical-align: middle;">Title:</th>
            <td class="field-body" style="font-size: 9pt; padding: 10px;">Storing
              arbitrary data in the DHT</td>
          </tr>
          <tr>
            <th class="docinfo-name" style="margin: 0px; font-size: 1.2em; text-align: right; vertical-align: middle;">Version:</th>
            <td style="font-size: 9pt; padding: 10px;">4c187001ec214a60cf86de73ada5a2e53353b9b1</td>
          </tr>
          <tr class="last-modified field">
            <th class="docinfo-name" style="margin: 0px; font-size: 1.2em; text-align: right; vertical-align: middle;">Last-Modified:</th>
            <td class="field-body" style="font-size: 9pt; padding: 10px;">Wed
              Feb 1 09:41:55 2017 -0800</td>
          </tr>
          <tr>
            <th class="docinfo-name" style="margin: 0px; font-size: 1.2em; text-align: right; vertical-align: middle;">Author:</th>
            <td style="font-size: 9pt; padding: 10px;">Arvid Norberg &lt;<a class="reference external"
                href="mailto:arvid%40bittorrent.com" style="color: rgb(102, 119, 136); text-decoration: none; border-bottom: 1px solid rgb(238, 238, 238);">arvid<span>@</span>bittorrent<span>.</span>com</a>&gt;,
              Steven Siloti &lt;<a class="reference external" href="mailto:ssiloti%40bittorrent.com"
                style="color: rgb(102, 119, 136); text-decoration: none; border-bottom: 1px solid rgb(238, 238, 238);">ssiloti<span>@</span>bittorrent<span>.</span>com</a>&gt;</td>
          </tr>
          <tr>
            <th class="docinfo-name" style="margin: 0px; font-size: 1.2em; text-align: right; vertical-align: middle;">Status:</th>
            <td style="font-size: 9pt; padding: 10px;">Draft</td>
          </tr>
          <tr class="type field">
            <th class="docinfo-name" style="margin: 0px; font-size: 1.2em; text-align: right; vertical-align: middle;">Type:</th>
            <td class="field-body" style="font-size: 9pt; padding: 10px;">Standards
              Track</td>
          </tr>
          <tr class="content-type field">
            <th class="docinfo-name" style="margin: 0px; font-size: 1.2em; text-align: right; vertical-align: middle;">Content-Type:</th>
            <td class="field-body" style="font-size: 9pt; padding: 10px;">text/x-rst</td>
          </tr>
          <tr class="created field">
            <th class="docinfo-name" style="margin: 0px; font-size: 1.2em; text-align: right; vertical-align: middle;">Created:</th>
            <td class="field-body" style="font-size: 9pt; padding: 10px;">19-Dec-2014</td>
          </tr>
          <tr class="post-history field">
            <th class="docinfo-name" style="margin: 0px; font-size: 1.2em; text-align: right; vertical-align: middle;">Post-History:</th>
            <td class="field-body" style="font-size: 9pt; padding: 10px;">06-Aug-2016
              (<a class="reference external" href="mailto:the8472.bep%40infinite-source.de"
                style="color: rgb(102, 119, 136); text-decoration: none; border-bottom: 1px solid rgb(238, 238, 238);">the8472<span>.</span>bep<span>@</span>infinite-source<span>.</span>de</a>),
              added backoff algorithm for republishing</td>
          </tr>
        </tbody>
      </table>
      <div class="section" id="abstract">
        <h1 style="margin: 1em 0px 0.1em; font-size: 2em; font-weight: normal; letter-spacing: -1px;">Abstract</h1>
        <p style="font-size: 1.3em; line-height: 1.5em;">This extension enables
          storing and retrieving of arbitrary data in the BitTorrent DHT<span>&nbsp;</span><a
            class="footnote-reference" href="http://bittorrent.org/beps/bep_0044.html#bep-5"
            id="id1" style="color: rgb(102, 119, 136); text-decoration: none; border-bottom: 1px solid rgb(238, 238, 238);">[1]</a>.
          It supports both storing immutable items, where the key is the SHA-1
          hash of the data itself, and mutable items, where the key is the
          public key of the key pair used to sign the data.</p>
      </div>
      <div class="section" id="rationale">
        <h1 style="margin: 1em 0px 0.1em; font-size: 2em; font-weight: normal; letter-spacing: -1px;">Rationale</h1>
        <p style="font-size: 1.3em; line-height: 1.5em;">The DHT as defined by
          BEP 5<span>&nbsp;</span><a class="footnote-reference" href="http://bittorrent.org/beps/bep_0044.html#bep-5"
            id="id2" style="color: rgb(102, 119, 136); text-decoration: none; border-bottom: 1px solid rgb(238, 238, 238);">[1]</a><span>&nbsp;</span>only
          provides the ability to store and retrieve IP addresses associated
          with a hash. However, there are many other types of data which may be
          useful to store in the DHT. This extension defines a protocol which
          enables new features to utilize the DHT as a general purpose key/value
          store.</p>
      </div>
      <div class="section" id="terminology">
        <h1 style="margin: 1em 0px 0.1em; font-size: 2em; font-weight: normal; letter-spacing: -1px;">Terminology</h1>
        <p style="font-size: 1.3em; line-height: 1.5em;">In this document, a<span>&nbsp;</span><em>storage
            node</em><span>&nbsp;</span>refers to the node in the DHT to which
          an item is being announced and stored on. A<span>&nbsp;</span><em>requesting
            node</em><span>&nbsp;</span>refers to a node which makes look-ups in
          the DHT to find the storage nodes, to request items from them, and
          possibly re-announce those items to keep them alive.</p>
      </div>
      <div class="section" id="messages">
        <h1 style="margin: 1em 0px 0.1em; font-size: 2em; font-weight: normal; letter-spacing: -1px;">Messages</h1>
        <p style="font-size: 1.3em; line-height: 1.5em;">The proposed new
          messages<span>&nbsp;</span><tt class="docutils literal">get</tt><span>&nbsp;</span>and<span>&nbsp;</span><tt
            class="docutils literal">put</tt><span>&nbsp;</span>are similar to
          the existing<span>&nbsp;</span><tt class="docutils literal">get_peers</tt><span>&nbsp;</span>and<span>&nbsp;</span><tt
            class="docutils literal">announce_peer</tt>. Responses to<span>&nbsp;</span><tt
            class="docutils literal">get</tt><span>&nbsp;</span>should always
          include<span>&nbsp;</span><tt class="docutils literal">nodes</tt><span>&nbsp;</span>and<span>&nbsp;</span><tt
            class="docutils literal">nodes6</tt>. Those fields have the same
          semantics as in the<span>&nbsp;</span><tt class="docutils literal">get_peers</tt><span>&nbsp;</span>response.
          It should also include a write token,<span>&nbsp;</span><tt class="docutils literal">token</tt>,
          with the same semantics as in<span>&nbsp;</span><tt class="docutils literal">get_peers</tt>.
          The write token MAY be tied specifically to the key which<span>&nbsp;</span><tt
            class="docutils literal">get</tt><span>&nbsp;</span>requested. I.e.
          the<span>&nbsp;</span><tt class="docutils literal">token</tt><span>&nbsp;</span>can
          only be used to store values under that one key. It may also be tied
          to the node ID and IP address of the requesting node.</p>
        <p style="font-size: 1.3em; line-height: 1.5em;">The<span>&nbsp;</span><tt
            class="docutils literal">id</tt><span>&nbsp;</span>field in these
          messages has the same semantics as the standard DHT messages, i.e. the
          node ID of the node sending the message, to maintain the structure of
          the DHT network.</p>
        <p style="font-size: 1.3em; line-height: 1.5em;">The<span>&nbsp;</span><tt
            class="docutils literal">token</tt><span>&nbsp;</span>field also has
          the same semantics as the standard DHT message<span>&nbsp;</span><tt class="docutils literal">get_peers</tt><span>&nbsp;</span>and<span>&nbsp;</span><tt
            class="docutils literal">announce_peer</tt>, when requesting an item
          and to write an item respectively.</p>
        <p style="font-size: 1.3em; line-height: 1.5em;">The<span>&nbsp;</span><tt
            class="docutils literal">k</tt><span>&nbsp;</span>field is the 32
          byte ed25519 public key, which the signature can be authenticated
          with. When looking up a mutable item, the<span>&nbsp;</span><tt class="docutils literal">target</tt><span>&nbsp;</span>field
          MUST be the SHA-1 hash of this key concatenated with the<span>&nbsp;</span><tt
            class="docutils literal">salt</tt>, if present.</p>
        <p style="font-size: 1.3em; line-height: 1.5em;">The distinction between
          storing mutable and immutable items is the inclusion of a public key,
          a sequence number, signature and an optional salt (<tt class="docutils literal">k</tt>,<span>&nbsp;</span><tt
            class="docutils literal">seq</tt>,<span>&nbsp;</span><tt class="docutils literal">sig</tt><span>&nbsp;</span>and<span>&nbsp;</span><tt
            class="docutils literal">salt</tt>).</p>
        <p style="font-size: 1.3em; line-height: 1.5em;"><tt class="docutils literal">get</tt><span>&nbsp;</span>requests
          for mutable items and immutable items may not be distinguishable from
          each other. An implementation can either store mutable and immutable
          items in the same hash table internally, or in separate ones and
          potentially do two lookups for<span>&nbsp;</span><tt class="docutils literal">get</tt><span>&nbsp;</span>requests.</p>
        <p style="font-size: 1.3em; line-height: 1.5em;">The<span>&nbsp;</span><tt
            class="docutils literal">v</tt><span>&nbsp;</span>field is the<span>&nbsp;</span><em>value</em><span>&nbsp;</span>to
          be stored. It is allowed to be any bencoded type (list, dict, string
          or integer). When it's being hashed (for verifying its signature or to
          calculate its key), its flattened, bencoded, form is used. If the
          value in a<span>&nbsp;</span><tt class="docutils literal">put</tt>request
          contains invalid bencoding (e.g. a dictionary with unsorted keys), the
          storing node MUST reject the request and SHOULD return an error
          message with code 203.</p>
        <p style="font-size: 1.3em; line-height: 1.5em;">Storing nodes MAY
          reject<span>&nbsp;</span><tt class="docutils literal">put</tt><span>&nbsp;</span>requests
          where the bencoded form of<span>&nbsp;</span><tt class="docutils literal">v</tt><span>&nbsp;</span>is
          longer than 1000 bytes. In other words, it's not safe to assume
          storing more than 1000 bytes will succeed.</p>
      </div>
      <div class="section" id="immutable-items">
        <h1 style="margin: 1em 0px 0.1em; font-size: 2em; font-weight: normal; letter-spacing: -1px;">Immutable
          Items</h1>
        <p style="font-size: 1.3em; line-height: 1.5em;">Immutable items are
          stored under their SHA-1 hash, and since they cannot be modified,
          there is no need to authenticate the origin of them. This makes
          immutable items simple.</p>
        <p style="font-size: 1.3em; line-height: 1.5em;">A node making a lookup
          SHOULD verify the data it receives from the network, to verify that
          its hash matches the target that was looked up.</p>
        <div class="section" id="put-message">
          <h2 style="margin: 0px; padding: 0px 0px 0.5em; font-size: 1.6em; font-weight: normal; border: 0px;">put
            message</h2>
          <p style="font-size: 1.3em; line-height: 1.5em;">Request:</p>
          <pre class="literal-block" style="margin-left: 4em;">{
    "a":
    {
        "id": <em>&lt;20 byte id of sending node (string)&gt;</em>,
        "token": <em>&lt;write-token (string)&gt;</em>,
        "v": <em>&lt;any bencoded type, whose encoded size &lt;= 1000&gt;</em>
    },
    "t": <em>&lt;transaction-id (string)&gt;</em>,
    "y": "q",
    "q": "put"
}
</pre>
          <p style="font-size: 1.3em; line-height: 1.5em;">Response:</p>
          <pre class="literal-block" style="margin-left: 4em;">{
    "r": { "id": <em>&lt;20 byte id of sending node (string)&gt;</em> },
    "t": <em>&lt;transaction-id (string)&gt;</em>,
    "y": "r",
}
</pre></div>
        <div class="section" id="get-message">
          <h2 style="margin: 0px; padding: 0px 0px 0.5em; font-size: 1.6em; font-weight: normal; border: 0px;">get
            message</h2>
          <p style="font-size: 1.3em; line-height: 1.5em;">Request:</p>
          <pre class="literal-block" style="margin-left: 4em;">{
    "a":
    {
        "id": <em>&lt;20 byte id of sending node (string)&gt;</em>,
        "target": <em>&lt;SHA-1 hash of item (string)&gt;</em>,
    },
    "t": <em>&lt;transaction-id (string)&gt;</em>,
    "y": "q",
    "q": "get"
}
</pre>
          <p style="font-size: 1.3em; line-height: 1.5em;">Response:</p>
          <pre class="literal-block" style="margin-left: 4em;">{
    "r":
    {
        "id": <em>&lt;20 byte id of sending node (string)&gt;</em>,
        "token": <em>&lt;write token (string)&gt;</em>,
        "v": <em>&lt;any bencoded type whose SHA-1 hash matches 'target'&gt;</em>,
        "nodes": <em>&lt;IPv4 nodes close to 'target'&gt;</em>,
        "nodes6": <em>&lt;IPv6 nodes close to 'target'&gt;</em>
    },
    "t": <em>&lt;transaction-id&gt;</em>,
    "y": "r",
}
</pre></div>
      </div>
      <div class="section" id="mutable-items">
        <h1 style="margin: 1em 0px 0.1em; font-size: 2em; font-weight: normal; letter-spacing: -1px;">Mutable
          Items</h1>
        <p style="font-size: 1.3em; line-height: 1.5em;">Mutable items can be
          updated, without changing their DHT keys. To authenticate that only
          the original publisher can update an item, it is signed by a private
          key generated by the original publisher. The target ID mutable items
          are stored under is the SHA-1 hash of the public key (as it appears in
          the<span>&nbsp;</span><tt class="docutils literal">put</tt><span>&nbsp;</span>message).</p>
        <p style="font-size: 1.3em; line-height: 1.5em;">In order to avoid a
          malicious node to overwrite the list head with an old version, the
          sequence number<span>&nbsp;</span><tt class="docutils literal">seq</tt><span>&nbsp;</span>must
          be monotonically increasing for each update, and a node hosting the
          list node MUST not downgrade a list head from a higher sequence number
          to a lower one, only upgrade. The sequence number SHOULD not exceed<span>&nbsp;</span><tt
            class="docutils literal">MAX_INT64</tt>, (i.e.<span>&nbsp;</span><tt
            class="docutils literal">0x7fffffffffffffff</tt>). A client MAY
          reject any message with a sequence number exceeding this. A client MAY
          also reject any message with a negative sequence number.</p>
        <p style="font-size: 1.3em; line-height: 1.5em;">The signature is a 64
          byte ed25519 signature of the bencoded sequence number concatenated
          with the<span>&nbsp;</span><tt class="docutils literal">v</tt><span>&nbsp;</span>key.
          e.g. something like this:</p>
        <pre class="literal-block" style="margin-left: 4em;">3:seqi4e1:v12:Hello world!
</pre>
        <p style="font-size: 1.3em; line-height: 1.5em;">If the<span>&nbsp;</span><tt
            class="docutils literal">salt</tt><span>&nbsp;</span>key is present
          and non-empty, the salt string must be included in what's signed. Note
          that if<span>&nbsp;</span><tt class="docutils literal">salt</tt><span>&nbsp;</span>is
          specified and an empty string, it is as if it was not specified and
          nothing in addition to the sequence number and the data is signed. The
          salt string MUST NOT be longer than 64 bytes.</p>
        <p style="font-size: 1.3em; line-height: 1.5em;">When a salt is included
          in what is signed, the key<span>&nbsp;</span><tt class="docutils literal">salt</tt><span>&nbsp;</span>with
          the value of the key is prepended in its bencoded form. For example,
          if<span>&nbsp;</span><tt class="docutils literal">salt</tt><span>&nbsp;</span>is
          "foobar", the buffer to be signed is:</p>
        <pre class="literal-block" style="margin-left: 4em;">4:salt6:foobar3:seqi4e1:v12:Hello world!
</pre>
        <div class="section" id="id3">
          <h2 style="margin: 0px; padding: 0px 0px 0.5em; font-size: 1.6em; font-weight: normal; border: 0px;">put
            message</h2>
          <p style="font-size: 1.3em; line-height: 1.5em;">Request:</p>
          <pre class="literal-block" style="margin-left: 4em;">{
    "a":
    {
        "cas": <em>&lt;optional expected seq-nr (int)&gt;</em>,
        "id": <em>&lt;20 byte id of sending node (string)&gt;</em>,
        "k": <em>&lt;ed25519 public key (32 bytes string)&gt;</em>,
        "salt": <em>&lt;optional salt to be appended to "k" when hashing (string)&gt;</em>
        "seq": <em>&lt;monotonically increasing sequence number (integer)&gt;</em>,
        "sig": <em>&lt;ed25519 signature (64 bytes string)&gt;</em>,
        "token": <em>&lt;write-token (string)&gt;</em>,
        "v": <em>&lt;any bencoded type, whose encoded size &lt; 1000&gt;</em>
    },
    "t": <em>&lt;transaction-id (string)&gt;</em>,
    "y": "q",
    "q": "put"
}
</pre>
          <p style="font-size: 1.3em; line-height: 1.5em;">Storing nodes
            receiving a<span>&nbsp;</span><tt class="docutils literal">put</tt><span>&nbsp;</span>request
            where<span>&nbsp;</span><tt class="docutils literal">seq</tt><span>&nbsp;</span>is
            lower than or equal to what's already stored on the node, MUST
            reject the request. If the sequence number is equal, and the value
            is also the same, the node SHOULD reset its timeout counter.</p>
          <p style="font-size: 1.3em; line-height: 1.5em;">If the sequence
            number in the<span>&nbsp;</span><tt class="docutils literal">put</tt><span>&nbsp;</span>message
            is lower than the sequence number associated with the currently
            stored value, the storing node MAY return an error message with code
            302 (see error codes below).</p>
          <p style="font-size: 1.3em; line-height: 1.5em;">Note that this
            request does not contain a target hash. The target hash under which
            this blob is stored is implied by the<span>&nbsp;</span><tt class="docutils literal">k</tt>argument.
            The key is the SHA-1 hash of the key (<tt class="docutils literal">k</tt>).</p>
          <p style="font-size: 1.3em; line-height: 1.5em;">In order to support a
            single key being used to store separate items in the DHT, an
            optional<span>&nbsp;</span><tt class="docutils literal">salt</tt><span>&nbsp;</span>can
            be specified in the<span>&nbsp;</span><tt class="docutils literal">put</tt><span>&nbsp;</span>request
            of mutable items.</p>
          <p style="font-size: 1.3em; line-height: 1.5em;">If the salt entry is
            not present, it can be assumed to be an empty string, and its
            semantics should be identical as specifying a salt key with an empty
            string.</p>
          <p style="font-size: 1.3em; line-height: 1.5em;">The salt can be any
            binary string (but probably most conveniently a hash of something).
            This string is appended to the key, as specified in the<span>&nbsp;</span><tt
              class="docutils literal">k</tt><span>&nbsp;</span>field, when
            calculating the key to store the blob under (i.e. the key<span>&nbsp;</span><tt
              class="docutils literal">get</tt><span>&nbsp;</span>requests
            specify to retrieve this data).</p>
          <p style="font-size: 1.3em; line-height: 1.5em;">This lets a single
            entity, with a single key, publish any number of unrelated items,
            with a single key that readers can verify. This is useful if the
            publisher doesn't know ahead of time how many different items are to
            be published. It can distribute a single public key for users to
            authenticate the published blobs.</p>
          <p style="font-size: 1.3em; line-height: 1.5em;">Note that the salt is
            not returned in the response to a<span>&nbsp;</span><tt class="docutils literal">get</tt><span>&nbsp;</span>request.
            This is intentional. When issuing a<span>&nbsp;</span><tt class="docutils literal">get</tt><span>&nbsp;</span>request
            for an item is expected to know what the salt is (because it is part
            of what the target ID that is being looked up is derived from).
            There is no need to repeat it back for bystanders to see.</p>
          <div class="section" id="cas">
            <h3 style="font-size: 1.3em; line-height: 1em;">CAS</h3>
            <p style="font-size: 1.3em; line-height: 1.5em;">CAS is short for<span>&nbsp;</span><em>compare
                and swap</em>, it has similar semantics as CAS CPU instructions.
              It is used to avoid race conditions when multiple nodes are
              writing to the same slot in the DHT.</p>
            <p style="font-size: 1.3em; line-height: 1.5em;">The<span>&nbsp;</span><tt
                class="docutils literal">cas</tt><span>&nbsp;</span>field is
              optional. If present it specifies the sequence number of the data
              blob being overwritten by the put. When present, the storing node
              MUST compare this number to the current sequence number it has
              stored under this key. Only if the<span>&nbsp;</span><tt class="docutils literal">cas</tt><span>&nbsp;</span>matches
              the stored sequence number is the put performed. If it mismatches,
              the store fails and an error MUST be returned. See<span>&nbsp;</span><a
                class="reference internal" href="http://bittorrent.org/beps/bep_0044.html#errors"
                style="color: rgb(102, 119, 136); text-decoration: none; border-bottom: 1px solid rgb(238, 238, 238);">Errors</a><span>&nbsp;</span>below.</p>
            <p style="font-size: 1.3em; line-height: 1.5em;">The<span>&nbsp;</span><tt
                class="docutils literal">cas</tt><span>&nbsp;</span>field only
              applies to mutable puts. If there is no current value, the<span>&nbsp;</span><tt
                class="docutils literal">cas</tt><span>&nbsp;</span>field SHOULD
              be ignored.</p>
            <p style="font-size: 1.3em; line-height: 1.5em;">When sending a<span>&nbsp;</span><tt
                class="docutils literal">put</tt><span>&nbsp;</span>request to a
              node that did not return any data for the<span>&nbsp;</span><tt class="docutils literal">get</tt>,
              the<span>&nbsp;</span><tt class="docutils literal">cas</tt><span>&nbsp;</span>field
              SHOULD NOT be included.</p>
          </div>
        </div>
        <div class="section" id="response">
          <h2 style="margin: 0px; padding: 0px 0px 0.5em; font-size: 1.6em; font-weight: normal; border: 0px;">Response</h2>
          <p style="font-size: 1.3em; line-height: 1.5em;">Response:</p>
          <pre class="literal-block" style="margin-left: 4em;">{
    "r": { "id": <em>&lt;20 byte id of sending node (string)&gt;</em> },
    "t": <em>&lt;transaction-id (string)&gt;</em>,
    "y": "r",
}
</pre></div>
        <div class="section" id="errors">
          <h2 style="margin: 0px; padding: 0px 0px 0.5em; font-size: 1.6em; font-weight: normal; border: 0px;">Errors</h2>
          <p style="font-size: 1.3em; line-height: 1.5em;">If the store fails
            for any reason an error message is returned instead of the message
            template above, i.e. one where "y" is "e" and "e" is a tuple of
            [error-code, message]). Failures include<span>&nbsp;</span><tt class="docutils literal">cas</tt><span>&nbsp;</span>mismatches
            and the sequence number is outdated.</p>
          <p style="font-size: 1.3em; line-height: 1.5em;">The error message (as
            specified by BEP 5<span>&nbsp;</span><a class="footnote-reference" href="http://bittorrent.org/beps/bep_0044.html#bep-5"
              id="id4" style="color: rgb(102, 119, 136); text-decoration: none; border-bottom: 1px solid rgb(238, 238, 238);">[1]</a>)
            looks like this:</p>
          <pre class="literal-block" style="margin-left: 4em;">{
    "e": [ <em>&lt;error-code (integer)&gt;</em>, <em>&lt;error-string (string)&gt;</em> ],
    "t": <em>&lt;transaction-id (string)&gt;</em>,
    "y": "e",
}
</pre>
          <p style="font-size: 1.3em; line-height: 1.5em;">In addition to the
            error codes defined in BEP 5, this specification defines some
            additional error codes.</p>
          <table class="docutils" style="border: 0px; margin-left: 4em;" border="1">
            <colgroup><col width="29%"><col width="71%"></colgroup>
            <thead valign="bottom">
              <tr>
                <th class="head">error-code</th>
                <th class="head">description</th>
              </tr>
            </thead>
            <tbody valign="top">
              <tr>
                <td style="font-size: 9pt; padding: 10px;">205</td>
                <td style="font-size: 9pt; padding: 10px;">message (<tt class="docutils literal">v</tt><span>&nbsp;</span>field)
                  too big.</td>
              </tr>
              <tr>
                <td style="font-size: 9pt; padding: 10px;">206</td>
                <td style="font-size: 9pt; padding: 10px;">invalid signature</td>
              </tr>
              <tr>
                <td style="font-size: 9pt; padding: 10px;">207</td>
                <td style="font-size: 9pt; padding: 10px;">salt (<tt class="docutils literal">salt</tt><span>&nbsp;</span>field)
                  too big.</td>
              </tr>
              <tr>
                <td style="font-size: 9pt; padding: 10px;">301</td>
                <td style="font-size: 9pt; padding: 10px;">the CAS hash
                  mismatched, re-read value and try again.</td>
              </tr>
              <tr>
                <td style="font-size: 9pt; padding: 10px;">302</td>
                <td style="font-size: 9pt; padding: 10px;">sequence number less
                  than current.</td>
              </tr>
            </tbody>
          </table>
          <p style="font-size: 1.3em; line-height: 1.5em;">An implementation
            MUST emit 301 errors if the cas mismatches. This is a critical
            feature in synchronization of multiple agents sharing a mutable
            item.</p>
        </div>
        <div class="section" id="id5">
          <h2 style="margin: 0px; padding: 0px 0px 0.5em; font-size: 1.6em; font-weight: normal; border: 0px;">get
            message</h2>
          <p style="font-size: 1.3em; line-height: 1.5em;">Request:</p>
          <pre class="literal-block" style="margin-left: 4em;">{
    "a":
    {
        "id": <em>&lt;20 byte id of sending node (string)&gt;</em>,
        "seq": <em>&lt;optional sequence number (integer)&gt;</em>,
        "target:" <em>&lt;20 byte SHA-1 hash of public key and salt (string)&gt;</em>
    },
    "t": <em>&lt;transaction-id (string)&gt;</em>,
    "y": "q",
    "q": "get"
}
</pre>
          <p style="font-size: 1.3em; line-height: 1.5em;">The optional<span>&nbsp;</span><tt
              class="docutils literal">seq</tt><span>&nbsp;</span>field
            specifies that an item's value should only be sent if its sequence
            number is greater than the given value. If a stored item exists but
            its sequence number is less than or equal to the<span>&nbsp;</span><tt
              class="docutils literal">seq</tt><span>&nbsp;</span>field then the<span>&nbsp;</span><tt
              class="docutils literal">k</tt>,<span>&nbsp;</span><tt class="docutils literal">v</tt>,
            and<span>&nbsp;</span><tt class="docutils literal">sig</tt><span>&nbsp;</span>fields
            SHOULD be omitted from the response.</p>
          <p style="font-size: 1.3em; line-height: 1.5em;">Response:</p>
          <pre class="literal-block" style="margin-left: 4em;">{
    "r":
    {
        "id": <em>&lt;20 byte id of sending node (string)&gt;</em>,
        "k": <em>&lt;ed25519 public key (32 bytes string)&gt;</em>,
        "nodes": <em>&lt;IPv4 nodes close to 'target'&gt;</em>,
        "nodes6": <em>&lt;IPv6 nodes close to 'target'&gt;</em>,
        "seq": <em>&lt;monotonically increasing sequence number (integer)&gt;</em>,
        "sig": <em>&lt;ed25519 signature (64 bytes string)&gt;</em>,
        "token": <em>&lt;write-token (string)&gt;</em>,
        "v": <em>&lt;any bencoded type, whose encoded size &lt;= 1000&gt;</em>
    },
    "t": <em>&lt;transaction-id (string)&gt;</em>,
    "y": "r",
}
</pre></div>
      </div>
      <div class="section" id="signature-verification">
        <h1 style="margin: 1em 0px 0.1em; font-size: 2em; font-weight: normal; letter-spacing: -1px;">Signature
          Verification</h1>
        <p style="font-size: 1.3em; line-height: 1.5em;">In order to make it
          maximally difficult to attack the bencoding parser, signing and
          verification of the value and sequence number should be done as
          follows:</p>
        <ol class="arabic simple">
          <li style="margin: 0.4em 0px; font-size: 10pt; line-height: 12pt;">Encode
            value and sequence number separately.</li>
          <li style="margin: 0.4em 0px; font-size: 10pt; line-height: 12pt;">Concatenate
            ("4:salt"<span>&nbsp;</span><em>length-of-salt</em><span>&nbsp;</span>":"<span>&nbsp;</span><em>salt</em>)
            "3:seqi"<span>&nbsp;</span><em>seq</em><span>&nbsp;</span>"e1:v"<span>&nbsp;</span><em>len</em><span>&nbsp;</span>":"
            and the encoded value. Sequence number 1 of value "Hello World!"
            would be converted to: "3:seqi1e1:v12:Hello World!". In this way it
            is not possible to convince a node that part of the length is
            actually part of the sequence number even if the parser contains
            certain bugs. Furthermore it is not possible to have a verification
            failure if a bencoding serializer alters the order of entries in the
            dictionary. The salt is in parenthesis because it is optional. It is
            only prepended if a non-empty salt is specified in the<span>&nbsp;</span><tt
              class="docutils literal">put</tt><span>&nbsp;</span>request.</li>
          <li style="margin: 0.4em 0px; font-size: 10pt; line-height: 12pt;">Sign
            or verify the concatenated string.</li>
        </ol>
        <p style="font-size: 1.3em; line-height: 1.5em;">On the storage node,
          the signature MUST be verified before accepting the store command. The
          data MUST be stored under the SHA-1 hash of the public key (as it
          appears in the bencoded dict) and the salt (if present).</p>
        <p style="font-size: 1.3em; line-height: 1.5em;">On the requesting
          nodes, the key they get back from a<span>&nbsp;</span><tt class="docutils literal">get</tt><span>&nbsp;</span>request
          MUST be verified to hash to the target ID the lookup was made for, as
          well as verifying the signature. If any of these fail, the response
          SHOULD be considered invalid.</p>
      </div>
      <div class="section" id="expiration">
        <h1 style="margin: 1em 0px 0.1em; font-size: 2em; font-weight: normal; letter-spacing: -1px;">Expiration</h1>
        <p style="font-size: 1.3em; line-height: 1.5em;">Without
          re-announcement, these items MAY expire in 2 hours. In order to keep
          items alive, they SHOULD be re-announced once an hour.</p>
        <p style="font-size: 1.3em; line-height: 1.5em;">Any node that's
          interested in keeping a blob in the DHT alive may announce it. It
          would simply repeat the signature for a mutable put without having the
          private key. This allows data to persist even when the initial
          publisher goes away or only comes online when replacing it with new
          data.</p>
        <p style="font-size: 1.3em; line-height: 1.5em;">To reduce write traffic
          subscribers do not need to republish the value if all of the following
          conditions are met during a get lookup:</p>
        <ol class="arabic simple">
          <li style="margin: 0.4em 0px; font-size: 10pt; line-height: 12pt;">They
            find more than 8 copies of the data</li>
          <li style="margin: 0.4em 0px; font-size: 10pt; line-height: 12pt;">The
            8 nodes closest to the target key which are eligible for a store all
            have indicated they have the data, either by returning it or through
            the<span>&nbsp;</span><tt class="docutils literal">seq</tt><span>&nbsp;</span>number.</li>
          <li style="margin: 0.4em 0px; font-size: 10pt; line-height: 12pt;">For
            mutable items only nodes holding values with the most recent known
            sequence number count towards meeting these conditions</li>
        </ol>
        <p style="font-size: 1.3em; line-height: 1.5em;">The assumption here is
          that implementation inaccuracies, churn and packet drops lead
          different nodes seeing slightly different sets of closest nodes and
          thus publish to different nodes. Therefore an up-to-date set of
          closest nodes plus an excess of stored values beyond that set
          indicates that there are multiple republishers.</p>
        <p style="font-size: 1.3em; line-height: 1.5em;">Subscribers may also
          persist the values to permanent storage to republish them after
          restarts.</p>
      </div>
      <div class="section" id="test-vectors">
        <h1 style="margin: 1em 0px 0.1em; font-size: 2em; font-weight: normal; letter-spacing: -1px;">Test
          Vectors</h1>
        <div class="section" id="test-1-mutable">
          <h2 style="margin: 0px; padding: 0px 0px 0.5em; font-size: 1.6em; font-weight: normal; border: 0px;">test
            1 (mutable)</h2>
          <p style="font-size: 1.3em; line-height: 1.5em;">value:</p>
          <pre class="literal-block" style="margin-left: 4em;">12:Hello World!
</pre>
          <p style="font-size: 1.3em; line-height: 1.5em;">buffer being signed:</p>
          <pre class="literal-block" style="margin-left: 4em;">3:seqi1e1:v12:Hello World!
</pre>
          <p style="font-size: 1.3em; line-height: 1.5em;">public key:</p>
          <pre class="literal-block" style="margin-left: 4em;">77ff84905a91936367c01360803104f92432fcd904a43511876df5cdf3e7e548
</pre>
          <p style="font-size: 1.3em; line-height: 1.5em;">private key:</p>
          <pre class="literal-block" style="margin-left: 4em;">e06d3183d14159228433ed599221b80bd0a5ce8352e4bdf0262f76786ef1c74d
b7e7a9fea2c0eb269d61e3b38e450a22e754941ac78479d6c54e1faf6037881d
</pre>
          <p style="font-size: 1.3em; line-height: 1.5em;"><strong>target ID</strong>:</p>
          <pre class="literal-block" style="margin-left: 4em;">4a533d47ec9c7d95b1ad75f576cffc641853b750
</pre>
          <p style="font-size: 1.3em; line-height: 1.5em;"><strong>signature</strong>:</p>
          <pre class="literal-block" style="margin-left: 4em;">305ac8aeb6c9c151fa120f120ea2cfb923564e11552d06a5d856091e5e853cff
1260d3f39e4999684aa92eb73ffd136e6f4f3ecbfda0ce53a1608ecd7ae21f01
</pre></div>
        <div class="section" id="test-2-mutable-with-salt">
          <h2 style="margin: 0px; padding: 0px 0px 0.5em; font-size: 1.6em; font-weight: normal; border: 0px;">test
            2 (mutable with salt)</h2>
          <p style="font-size: 1.3em; line-height: 1.5em;">value:</p>
          <pre class="literal-block" style="margin-left: 4em;">12:Hello World!
</pre>
          <p style="font-size: 1.3em; line-height: 1.5em;">salt:</p>
          <pre class="literal-block" style="margin-left: 4em;">foobar
</pre>
          <p style="font-size: 1.3em; line-height: 1.5em;">buffer being signed:</p>
          <pre class="literal-block" style="margin-left: 4em;">4:salt6:foobar3:seqi1e1:v12:Hello World!
</pre>
          <p style="font-size: 1.3em; line-height: 1.5em;">public key:</p>
          <pre class="literal-block" style="margin-left: 4em;">77ff84905a91936367c01360803104f92432fcd904a43511876df5cdf3e7e548
</pre>
          <p style="font-size: 1.3em; line-height: 1.5em;">private key:</p>
          <pre class="literal-block" style="margin-left: 4em;">e06d3183d14159228433ed599221b80bd0a5ce8352e4bdf0262f76786ef1c74d
b7e7a9fea2c0eb269d61e3b38e450a22e754941ac78479d6c54e1faf6037881d
</pre>
          <p style="font-size: 1.3em; line-height: 1.5em;"><strong>target ID</strong>:</p>
          <pre class="literal-block" style="margin-left: 4em;">411eba73b6f087ca51a3795d9c8c938d365e32c1
</pre>
          <p style="font-size: 1.3em; line-height: 1.5em;"><strong>signature</strong>:</p>
          <pre class="literal-block" style="margin-left: 4em;">6834284b6b24c3204eb2fea824d82f88883a3d95e8b4a21b8c0ded553d17d17d
df9a8a7104b1258f30bed3787e6cb896fca78c58f8e03b5f18f14951a87d9a08
</pre></div>
        <div class="section" id="test-3-immutable">
          <h2 style="margin: 0px; padding: 0px 0px 0.5em; font-size: 1.6em; font-weight: normal; border: 0px;">test
            3 (immutable)</h2>
          <p style="font-size: 1.3em; line-height: 1.5em;">value:</p>
          <pre class="literal-block" style="margin-left: 4em;">12:Hello World!
</pre>
          <p style="font-size: 1.3em; line-height: 1.5em;"><strong>target ID</strong>:</p>
          <pre class="literal-block" style="margin-left: 4em;">e5f96f6f38320f0f33959cb4d3d656452117aadb
</pre></div>
      </div>
      <div class="section" id="resources">
        <h1 style="margin: 1em 0px 0.1em; font-size: 2em; font-weight: normal; letter-spacing: -1px;">Resources</h1>
        <p style="font-size: 1.3em; line-height: 1.5em;">This document was
          derived heavily from the documentation of the extension included in
          libtorrent<span>&nbsp;</span><a class="footnote-reference" href="http://bittorrent.org/beps/bep_0044.html#dht-store"
            id="id6" style="color: rgb(102, 119, 136); text-decoration: none; border-bottom: 1px solid rgb(238, 238, 238);">[2]</a>.
          In many places text was simply copied and modified.</p>
        <p style="font-size: 1.3em; line-height: 1.5em;">Libraries that
          implement ed25519 DSA:</p>
        <ul class="simple">
          <li style="margin: 0.4em 0px; font-size: 10pt; line-height: 12pt;"><a
              class="reference external" href="http://nacl.cr.yp.to/" style="color: rgb(102, 119, 136); text-decoration: none; border-bottom: 1px solid rgb(238, 238, 238);">NaCl</a></li>
          <li style="margin: 0.4em 0px; font-size: 10pt; line-height: 12pt;"><a
              class="reference external" href="https://github.com/jedisct1/libsodium"
              style="color: rgb(102, 119, 136); text-decoration: none; border-bottom: 1px solid rgb(238, 238, 238);">libsodium</a></li>
          <li style="margin: 0.4em 0px; font-size: 10pt; line-height: 12pt;"><a
              class="reference external" href="https://github.com/nightcracker/ed25519"
              style="color: rgb(102, 119, 136); text-decoration: none; border-bottom: 1px solid rgb(238, 238, 238);">nightcracker's
              ed25519</a></li>
        </ul>
      </div>
      <div class="section" id="references">
        <h1 style="margin: 1em 0px 0.1em; font-size: 2em; font-weight: normal; letter-spacing: -1px;">References</h1>
        <table class="docutils footnote" frame="void" id="bep-5" rules="none" style="border: 0px; margin-left: 4em;">
          <colgroup><col class="label"><col></colgroup>
          <tbody valign="top">
            <tr>
              <td class="label" style="font-size: 9pt; padding: 10px;">[1]</td>
              <td style="font-size: 9pt; padding: 10px;"><em>(<a class="fn-backref"
                    href="http://bittorrent.org/beps/bep_0044.html#id1" style="color: rgb(102, 119, 136); text-decoration: none; border-bottom: 1px solid rgb(238, 238, 238);">1</a>,<span>&nbsp;</span><a
                    class="fn-backref" href="http://bittorrent.org/beps/bep_0044.html#id2"
                    style="color: rgb(102, 119, 136); text-decoration: none; border-bottom: 1px solid rgb(238, 238, 238);">2</a>,<span>&nbsp;</span><a
                    class="fn-backref" href="http://bittorrent.org/beps/bep_0044.html#id4"
                    style="color: rgb(102, 119, 136); text-decoration: none; border-bottom: 1px solid rgb(238, 238, 238);">3</a>)</em><span>&nbsp;</span>BEP_0005.
                DHT Protocol (<a class="reference external" href="http://www.bittorrent.org/beps/bep_0005.html"
                  style="color: rgb(102, 119, 136); text-decoration: none; border-bottom: 1px solid rgb(238, 238, 238);">http://www.bittorrent.org/beps/bep_0005.html</a>)</td>
            </tr>
          </tbody>
        </table>
        <table class="docutils footnote" frame="void" id="dht-store" rules="none"
          style="border: 0px; margin-left: 4em;">
          <colgroup><col class="label"><col></colgroup>
          <tbody valign="top">
            <tr>
              <td class="label" style="font-size: 9pt; padding: 10px;"><a class="fn-backref"
                  href="http://bittorrent.org/beps/bep_0044.html#id6" style="color: rgb(102, 119, 136); text-decoration: none; border-bottom: 1px solid rgb(238, 238, 238);">[2]</a></td>
              <td style="font-size: 9pt; padding: 10px;">BitTorrent extension
                for arbitrary DHT store, Arvid Norberg (<a class="reference external"
                  href="http://www.libtorrent.org/dht_store.html" style="color: rgb(102, 119, 136); text-decoration: none; border-bottom: 1px solid rgb(238, 238, 238);">http://www.libtorrent.org/dht_store.html</a>)</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="section" id="copyright">
        <h1 style="margin: 1em 0px 0.1em; font-size: 2em; font-weight: normal; letter-spacing: -1px;">Copyright</h1>
        <p style="font-size: 1.3em; line-height: 1.5em;">This document has been
          placed in the public domain.</p>
      </div>
    </div>
    <br class="Apple-interchange-newline">
    <p></p>
  </body>
</html>
